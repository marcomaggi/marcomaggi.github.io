<html lang="en">
<head>
<title>2015 March 20 - Marco's Weblog</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="Marco's Weblog">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="2015.html#g_t2015" title="2015">
<link rel="prev" href="2015-March-24.html#g_t2015-March-24" title="2015 March 24">
<link rel="next" href="2015-March-06-bis.html#g_t2015-March-06-bis" title="2015 March 06 bis">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
Copyright (C) 2015, 2016 by Marco Maggi <marco.maggi-ipsu@poste.it>

     Permission is granted to copy, distribute and/or modify this
     document under the terms of the GNU Free Documentation License,
     Version 1.3 or any later version published by the Free Software
     Foundation; with Invariant Sections being ``GNU Free Documentation
     License'' and ``GNU General Public License'', no Front--Cover
     Texts, and no Back--Cover Texts.  A copy of the license is
     included in the section entitled ``GNU Free Documentation
     License''.
-->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
<link rel="stylesheet" type="text/css" href="weblog.css">
</head>
<body>
<div class="node">
<a name="g_t2015-March-20"></a>
<p>
Next:&nbsp;<a rel="next" accesskey="n" href="2015-March-06-bis.html#g_t2015-March-06-bis">2015 March 06 bis</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="2015-March-24.html#g_t2015-March-24">2015 March 24</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="2015.html#g_t2015">2015</a>
<hr>
</div>

<h3 class="unnumberedsec">Updated <acronym>SRFI</acronym>s and other stuff (2015 March 20)</h3>

<p>I have assimilated into <a href="References.html#References">Vicare</a> the <acronym>SRFI</acronym>s
<a href="http://srfi.schemers.org/srfi-113/srfi-113.html">113</a>,
<a href="http://srfi.schemers.org/srfi-114/srfi-114.html">114</a>.  Quite some work was
needed because, for example, <acronym>SRFI</acronym>-114 has no test suite; also, they are written
thinking to <acronym>R7RS</acronym> implementations and <a href="http://www.call-cc.org/">CHICKEN</a> in
particular.  To assimilate the code to Vicare's style, I had to touch almost all
the procedures definitions.

   <p>While doing this work: I have pushed, in parallel, other development tasks.

<!--  -->
<h4 class="unnumberedsubsec">Fixed Issue 49</h4>

<p>While working on <acronym>SRFI</acronym>-114 assimilation I think I fixed
<a href="https://github.com/marcomaggi/vicare/issues/49">Issue 49</a>.  I feel a bit ashamed
for taking so long to fix this, because it was a very simple mistake in the compiler;
but the cause of error just did not pop up into my mind until now.

   <p>It goes like this, when the source optimiser sees code like:

<pre class="lisp">     (let ((a 1))
       (set! a (do-something))
       2)
</pre>
   <p class="noindent">it recognises that the binding <code>a</code> is referenced only in the assignment form, so
to mutate the binding is useless; the code is transformed to the equivalent:

<pre class="lisp">     (let ((a 1))
       (do-something)
       2)
</pre>
   <p class="noindent">now further optimisations are possible but they do not matter here.  Everything is
fine with local bindings, but what about top level bindings?  If the code is:

<pre class="lisp">     (library (demo)
       (export
         ;... some bindings ...
         a)
       (import (vicare))
       ;;... some definitions ...
       (define a 1)
       (set! a (do-something)))
</pre>
   <p class="noindent">the binding <code>a</code> is referenced in the library body only in the assignment form,
but we <strong>cannot</strong> transform the code to:

<pre class="lisp">     (library (demo)
       (export
         ;... some bindings ...
         a)
       (import (vicare))
       ;;... some definitions ...
       (define a 1)
       (do-something))
</pre>
   <p class="noindent">because the binding is exported.  Even if the code is:

<pre class="lisp">     (library (demo)
       (export
         ;... some bindings ...
         )
       (export)
       (import (vicare))
       ;;... some definitions ...
       (define a 1)
       (set! a (do-something)))
</pre>
   <p class="noindent">where <code>a</code> is not exported, we <strong>cannot</strong> transform the code because some
macro might create a non&ndash;hygienic reference to the binding.

   <p>In general, Vicare's compiler has no way to detect when a top level binding is
referenced in the code or not, so top level bindings can be neither removed nor
subject to this kind of source optimisation.  But this is exactly what was happening.

   <p>When code like the following is expanded:

<pre class="lisp">     (library (demo)
       (export make-record record?)
       (import (vicare))
       (define-record-type record))
</pre>
   <p class="noindent">a definition for <code>make-record</code> is created:

<pre class="lisp">     (define make-record ...)
</pre>
   <p class="noindent">then the compiler processes the library body and transforms the top level binding
definitions according to the selected <code>letrec</code> and <code>letrec*</code>
optimisation policy; the code is transformed to an equivalent of:

<pre class="lisp">     (letrec* ((make-record (void))
               ...)
       (set! make-record ...))
</pre>
   <p class="noindent">where the <code>letrec*</code> bindings are top level; then the source optimiser is
applied to it.  If <code>make-record</code> is never used in the body other than in the
assignment form: the assignment <strong>cannot</strong> be removed, but this was happening. 
Hence the error.

<!--  -->
<h4 class="unnumberedsubsec">More vector core primitives</h4>

<p>Some of the &ldquo;fold left&rdquo; and &ldquo;fold right&rdquo; functions from the library
<code>(vicare containers vectors)</code> have been moved into the boot image, becoming
core primitives; some other primitives were added.  In the boot image we now have:

<pre class="example">     vector-map
     vector-for-each
     vector-find
     vector-for-all
     vector-exists
     vector-fold-left
     vector-fold-right
</pre>
   <p class="noindent">which constitute a decent base for vector iteration.

<!--  -->
<h4 class="unnumberedsubsec">More hash tables primitives</h4>

<p>Inspired by the functions in <acronym>SRFI</acronym>-113 I have added the following core primitives
to <code>(vicare)</code>:

<pre class="example">     hashtable-for-each-key
     hashtable-for-each-entry
     hashtable-for-all-keys
     hashtable-for-all-entries
     hashtable-exists-key
     hashtable-exists-entry
     hashtable-find-key
     hashtable-find-entry
     hashtable-fold-keys
     hashtable-fold-entries
     hashtable-&gt;alist
     alist-&gt;hashtable!
</pre>
   <p class="noindent">and inspired by the functions in <acronym>SRFI</acronym>-114 I have extended the suite of hash
functions to:

<pre class="example">     string-hash             string-ci-hash
     symbol-hash             bytevector-hash
     equal-hash
     fixnum-hash             exact-integer-hash
     flonum-hash             number-hash
     char-hash               char-ci-hash
     boolean-hash            void-hash
     eof-object-hash         would-block-hash
     struct-hash             record-hash
     object-hash
</pre>
   <p class="noindent">not all of these are quality functions.

<!--  -->
<h4 class="unnumberedsubsec">No more &ldquo;last revision&rdquo; identifier</h4>

<p>For some time, when starting the <acronym>REPL</acronym>, the identifier of the last commit was
included in the greetings screen:

<pre class="example">     $ vicare
     Vicare Scheme version 0.4d0, 64-bit
     Revision master/84506e3ba00414bd689a87e4890076e4fedd9f56
     Build 2015-03-06
     
     Copyright (c) 2006-2010 Abdulaziz Ghuloum and contributors
     Copyright (c) 2011-2015 Marco Maggi
     
     vicare&gt;
</pre>
   <p class="noindent">now I have removed it:

<pre class="example">     $ vicare
     Vicare Scheme version 0.4d0, 64-bit
     Build 2015-03-11
     
     Copyright (c) 2006-2010 Abdulaziz Ghuloum and contributors
     Copyright (c) 2011-2015 Marco Maggi and contributors
     
     vicare&gt;
</pre>
   <p>To include the &ldquo;last revision&rdquo; identifier: after every commit and every branch
merge the branch and commit checksum were saved into a file included in the next
Vicare build.  This meant that after every commit and merge everything needed to
be rebuilt, even when no actual code was modified.  This annoyed me.

   <p>Also, I failed multiple times in keeping in sync the registered revision with the
build distributed in tarballs.

   <p>For this reasons I nuked this feature.  We can live without.

<!-- page -->
   </body></html>

