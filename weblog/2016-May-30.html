<html lang="en">
<head>
<title>2016 May 30 - Marco's Weblog</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="Marco's Weblog">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="2016.html#g_t2016" title="2016">
<link rel="prev" href="2016-Jun-18.html#g_t2016-Jun-18" title="2016 Jun 18">
<link rel="next" href="2016-May-25.html#g_t2016-May-25" title="2016 May 25">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
Copyright (C) 2015, 2016 by Marco Maggi <marco.maggi-ipsu@poste.it>

     Permission is granted to copy, distribute and/or modify this
     document under the terms of the GNU Free Documentation License,
     Version 1.3 or any later version published by the Free Software
     Foundation; with Invariant Sections being ``GNU Free Documentation
     License'' and ``GNU General Public License'', no Front--Cover
     Texts, and no Back--Cover Texts.  A copy of the license is
     included in the section entitled ``GNU Free Documentation
     License''.
-->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
<link rel="stylesheet" type="text/css" href="weblog.css">
</head>
<body>
<div class="node">
<a name="g_t2016-May-30"></a>
<p>
Next:&nbsp;<a rel="next" accesskey="n" href="2016-May-25.html#g_t2016-May-25">2016 May 25</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="2016-Jun-18.html#g_t2016-Jun-18">2016 Jun 18</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="2016.html#g_t2016">2016</a>
<hr>
</div>

<h3 class="unnumberedsec">Expander warnings and overloaded functions</h3>

<div align="center">Posted on May 30, 2016</div>

   <p>More work in the &lsquo;<samp><span class="samp">typed-language</span></samp>&rsquo;
<a href="https://github.com/marcomaggi/vicare/tree/typed-language.marcomaggi-2015-11-18">branch</a> of <a href="References.html#References">Vicare</a>, for both the expander and the built&ndash;in types
infrastructure.  Some more type propagation stuff is implemented for built&ndash;in
primitives.

   <p>Everything I discuss here is relative to code in the head of the
&lsquo;<samp><span class="samp">typed-language</span></samp>&rsquo; branch.

<!--  -->
<h4 class="unnumberedsubsec">Expander warnings</h4>

<p>Since some commits ago I started adding new command line options to enable/disable
warnings at expand&ndash;time.  I want Vicare's command line interface to feel like the
<acronym>GCC</acronym>'s one, so there is a command line option <samp><span class="option">-Wall</span></samp> that will
enable all the warnings.  Here some other options:

     <dl>
<dt><samp><span class="option">-Wlogic-constants</span></samp><dt><samp><span class="option">-Wno-logic-constants</span></samp><dd>Enable or disable raising a <code>&amp;warning</code> exception when an operand in a logic
expression (<code>if</code> test, <code>and</code>, <code>or</code>, et cetera) always returns
false or non&ndash;false.  By default this warning is disabled.  As example, the following
code:

     <pre class="lisp">          (and #t (read))
</pre>
     <p class="noindent">will cause the following warning at expand&ndash;time:

     <pre class="example">          *** Vicare: warning:
           Condition components:
             1. &amp;expand-time-type-signature-warning
             2. &amp;who: and
             3. &amp;message: "expression used as operand in logic predicate is \
                           typed as always returning non-false"
             4. &amp;syntax:
                 form: #[syntax expr=(and #t (read))
                            line=8 column=3 source="demo.sps"]
                 subform: #[syntax expr=#t line=8 column=9 source="demo.sps"]
             5. &amp;type-signature: #[signature (&lt;true&gt;)]
</pre>
     <br><dt><samp><span class="option">-Wnot-returning</span></samp><dt><samp><span class="option">-Wno-not-returning</span></samp><dd>Enable or disable raising a <code>&amp;warning</code> exception when an operand evaluated
for its return values is typed as not returning.  By default this warning is
disabled.  As example, the following code:

     <pre class="lisp">          (define (operand)
            (error #f "bad behaviour"))
          
          (define (operator rand)
            (display rand))
          
          (operator (operand))
</pre>
     <p class="noindent">will cause the following warning at expand&ndash;time:

     <pre class="example">          *** Vicare: warning:
           Condition components:
             1. &amp;expand-time-type-signature-warning
             2. &amp;who: chi-closure-object-application
             3. &amp;message: "expression used as operand in procedure application \
                          is typed as not returning"
             4. &amp;syntax:
                 form: #[syntax expr=(operator (operand))
                            line=15 column=3 source="demo.sps"]
                 subform: #[syntax expr=(operand)
                               line=15 column=13 source="demo.sps"]
             5. &amp;application-operand-signature: #[signature &lt;no-return&gt;]
</pre>
     <br><dt><samp><span class="option">-Wunused-variables</span></samp><dt><samp><span class="option">-Wno-unused-variables</span></samp><dd>Enable or disable raising a <code>&amp;warning</code> exception when a local lexical
variable is defined but never used.  By default this warning is disabled.  As
example, the following code:

     <pre class="lisp">          (let ((a 1)
                (b 2)
                (c 3))
            (list a c))
</pre>
     <p class="noindent">will cause the following warning at expand&ndash;time:

     <pre class="example">          *** Vicare: warning:
           Condition components:
             1. &amp;warning-unused-lexical-variable
             2. &amp;who: let/checked
             3. &amp;message: "unused lexical syntactic binding"
             4. &amp;syntactic-identifier: #[id b line=9 column=10 source="demo.sps"]
</pre>
     </dl>

   <p>We need to know that a <code>&amp;warning</code> exception will not stop expansion and
compilation, but we must handle it correctly when, for example, we expand code using
<code>eval</code>; this is a way of doing it:

<pre class="lisp">     (with-exception-handler
         (lambda (E)
           (unless (warning? E)
             (raise-continuable E)))
       (lambda ()
         (eval <var>?sexp</var> <var>?env</var>)))
</pre>
   <p class="noindent">Should <code>eval</code> block <code>&amp;warning</code> exceptions automatically?  With a
configurable run&ndash;time option?  Maybe.  And maybe, in future, it will.

<!--  -->
<h4 class="unnumberedsubsec">Experimental overloaded functions</h4>

<p>Overloaded functions are an expand&ndash;time aggregation of functions linked to the same
name and having different number and type of arguments.  For example, in the code:

<pre class="lisp">     (define/overload (fun {O &lt;fixnum&gt;})
       (list 'fixnum O))
     
     (define/overload (fun {O &lt;string&gt;})
       (list 'string O))
     
     (define/overload (fun {A &lt;vector&gt;} {B &lt;vector&gt;})
       (list 'vectors (vector-append A B)))
     
     (fun 123)               &rArr; (fixnum 123)
     (fun "ciao")            &rArr; (string "ciao")
     (fun '#(1) '#(2))       &rArr; (vectors #(1 2))
</pre>
   <p class="noindent">an overloaded function named <code>fun</code> is defined by the first use of
<code>define/overload</code>; subsequent uses add new specialisations to the same
function.  We can use overloaded functions only with the &ldquo;canonical&rdquo; function
application syntax:

<pre class="lisp">     (<var>?fun</var> <var>?operand</var> ...)
</pre>
   <p class="noindent">using <code>apply</code> will cause an expand&ndash;time syntax violation.

   <p>Overloaded functions are also partially supported by records, using the
<code>method/overload</code> clause:

<pre class="lisp">     (define-record-type &lt;duo&gt;
       (fields one two)
       (method/overload (doit {O &lt;duo&gt;})
         (+ (.one O) (.two O)))
       (method/overload (doit {O &lt;duo&gt;} {C &lt;number&gt;})
         (* C (+ (.one O) (.two O)))))
     
     (define O
       (new &lt;duo&gt; 1 2))
     
     (.doit O)       &rArr; 1
     (.doit O 3)     &rArr; 9
</pre>
   <p class="noindent">Being an expand&ndash;time thing: overloaded methods are <strong>not</strong> available for late
binding; that is why support is only partial.  This is an important limitation: it
makes it harder to implement interfaces (which will require late binding).

   <p>At present, only a basic implementation of overloaded functions is available.  There
are two main reasons:

     <ul>
<li>There is <strong>no</strong> ranking of applicable specialisations; when the overloaded
function is applied: the list of specialisations is traversed starting from the last,
and the first that matches is inserted in the code.

     <li>Once overloaded functions are available: we obviously want full support for them in
record&ndash;types; this means having them available for late binding. 
</ul>

   <p>Now, Vicare already has some sort of solution for these problems: it is
implemented by multimethods from the library <code>(vicare language-extensions
multimethods)</code>.  There are problems though:

     <ul>
<li>Multimethods perform ranking of methods, but such ranking requires the argument types
to be object type identifiers; it means the type annotation operators <code>or</code>,
<code>and</code>, <code>not</code>, et cetera cannot be used.

     <li>Multimethods perform run&ndash;time dispatching, so they would be available for late
binding.  But the machinery is complex: is it fine to include it in the already huge
boot image? 
</ul>

   <p>Solving these problems is one of the things I think of these days<small class="dots">...</small>

<!-- page -->
   </body></html>

