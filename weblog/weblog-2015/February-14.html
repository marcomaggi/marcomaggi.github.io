<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Copyright (C) 2015, 2016, 2017 by Marco Maggi marco.maggi-ipsu@poste.it

Permission is granted to copy, distribute and/or modify this document under the terms
of the gnu Free Documentation License, Version 1.3 or any later version published
by the Free Software Foundation; with Invariant Sections being "gnu Free
Documentation License" and "gnu General Public License", no Front-Cover Texts,
and no Back-Cover Texts.  A copy of the license is included in the section entitled
"gnu Free Documentation License". -->
<!-- Created by GNU Texinfo 6.5, http://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>February 14 (Marco&rsquo;s 2015 Weblog)</title>

<meta name="description" content="February 14 (Marco&rsquo;s 2015 Weblog)">
<meta name="keywords" content="February 14 (Marco&rsquo;s 2015 Weblog)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html#Top" rel="start" title="Top">
<link href="concept-index.html#concept-index" rel="index" title="concept index">
<link href="concept-index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="index.html#Top" rel="up" title="Top">
<link href="February-13-bis.html#February-13-bis" rel="next" title="February 13 bis">
<link href="February-14-bis.html#February-14-bis" rel="prev" title="February 14 bis">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
blockquote.smallindentedblock {margin-right: 0em; font-size: smaller}
blockquote.smallquotation {font-size: smaller}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
div.smalldisplay {margin-left: 3.2em}
div.smallexample {margin-left: 3.2em}
div.smalllisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
pre.smalldisplay {font-family: inherit; font-size: smaller}
pre.smallexample {font-size: smaller}
pre.smallformat {font-family: inherit; font-size: smaller}
pre.smalllisp {font-size: smaller}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="weblog.css">


</head>

<body lang="en">
<a name="February-14"></a>
<div class="header">
<p>
Next: <a href="February-13-bis.html#February-13-bis" accesskey="n" rel="next">February 13 bis</a>, Previous: <a href="February-14-bis.html#February-14-bis" accesskey="p" rel="prev">February 14 bis</a>, Up: <a href="index.html#Top" accesskey="u" rel="up">Top</a> &nbsp; [<a href="concept-index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="concept-index.html#concept-index" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<a name="On-errors-and-close_002d_002don_002d_002dexec-ports-_00282015-February-14_0029"></a>
<h2 class="unnumbered">On errors and close&ndash;on&ndash;exec ports (2015 February 14)</h2>


<p>Error handling is hard.  Error handling is ugly.  Somebody has to do error handling.
I try to have <a href="References.html#References">Vicare</a> do something about it.
</p>
<p><acronym>posix</acronym> specifies an interesting feature: automatically close file descriptors when
a process calls <code>execv()</code> or similar function.  This feature is disabled by
default and it is enabled by setting the flag <code>FD_CLOEXEC</code> for the file
descriptor:
</p>
<div class="example">
<pre class="example">int   fd    = ...;
int   flags = fcntl(fd, F_GETFD, 0);
assert(0 &lt;= flags);
flags |= FD_CLOEXEC;
fcntl(<var>fd</var>, F_SETFD, flags);
</pre></div>

<p>The library <code>(vicare posix)</code> interfaces this facility with the function
<code>fd-set-close-on-exec-mode!</code>.  Standard Scheme port objects also have this
feature through a mechanism implemented by <code>(vicare posix)</code>: a weak hashtable
is used to register ports for close&ndash;on&ndash;exec with
<code>port-set-close-on-exec-mode!</code>; then we can use
<code>flush-ports-in-close-on-exec-mode</code> and
<code>close-ports-in-close-on-exec-mode</code>.
</p>
<p>Problem: what should happen when flushing or closing such ports fails?  This is a
difficult problem; whatever the language and technology we use, what should happen
when flushing or closing an input/output port fails?  Was the data written?  Was the
file corrupted?  Should the software ignore the error and tell the user to go on the
beach to take a sunbath?
</p>
<p>I have no answer.  Vicare has no answer.  The best I can think is this:
</p>
<ol>
<li> It is possible to hand an error handler to <code>flush-ports-in-close-on-exec-mode</code>
and <code>close-ports-in-close-on-exec-mode</code>.

</li><li> Before applying <code>flush-output-port</code> or <code>close-port</code> to a close&ndash;on&ndash;exec
port: the error handler is installed.

</li><li> If applying <code>flush-output-port</code> or <code>close-port</code> to a close&ndash;on&ndash;exec port
raises an exception: the error handler is applied to the raised object.

</li><li> If the error handler itself raises an exception: such second exception is blocked and
discarded.
</li></ol>

<p>this &ldquo;solution&rdquo; is now
<a href="https://github.com/marcomaggi/vicare/commit/d41445c7c334e443880800918a1793a22fad41ff">implemented</a> in the <code>master</code> branch.  It is a pitiful solution.  Maybe custom
&ldquo;flush handlers&rdquo; and &ldquo;close handlers&rdquo; would be better; maybe in the future I will
add them.
</p>

<a name="Some-examples"></a>
<h3 class="unnumberedsec">Some examples</h3>

<p>Let&rsquo;s imagine the following program prelude, in which <code>make-test-port</code> is just a
wrapper for the standard <code>open-string-output-port</code> allowing us to raise an
exception when data is written:
</p>
<div class="example">
<pre class="example">#!vicare
(import (vicare)
  (prefix (vicare posix) px.)
  (only (vicare checks)
        with-result
        add-result))

;;Select the output buffer size for the port created
;;by MAKE-CUSTOM-TEXTUAL-OUTPUT-PORT.
(string-port-buffer-size 16)

(define (trace template . args)
  (when #t
    (apply fprintf (current-error-port) template args)))

(define error-on-write
  (make-parameter #f))

(define (make-test-port)
  ;;Create a port that wraps the one created by OPEN-STRING-OUTPUT-PORT.
  ;;
  (receive (subport extract)
      (open-string-output-port)

   (define (write! src.str src.start count)
      (trace &quot;writing ~a chars\n&quot; count)
      (when (error-on-write)
        (error __who__ &quot;error writing characters&quot; count))
      (do ((i 0 (+ 1 i)))
          ((= i count)
           count)
        (put-char subport (string-ref src.str (+ i src.start)))))

    (define (get-position)
      (port-position subport))

    (define (set-position! new-position)
      (set-port-position! subport new-position))

    (define (close)
      #f)

    (values (make-custom-textual-output-port
             &quot;*test-port*&quot; write! get-position set-position! close)
            extract)))

(define-constant the-string-len
  (* 4 (string-port-buffer-size)))

(define-constant the-string
  (make-string the-string-len #\A))
</pre></div>

<p>we can simulate an error when flushing with:
</p>
<div class="example">
<pre class="example">(parametrise ((error-on-write #t))
  (flush-output-port port))
</pre></div>

<p>and an error when closing with:
</p>
<div class="example">
<pre class="example">(parametrise ((error-on-write #t))
  (close-port port))
</pre></div>

<p>We can test the port with the following code, no error, no close&ndash;on&ndash;exec:
</p>
<div class="example">
<pre class="example">(let-values (((port extract) (make-test-port)))
  (trace &quot;writing ~a chars\n&quot; the-string-len)
  (display the-string port)
  (trace &quot;flushing output\n&quot;)
  (flush-output-port port)
  (trace &quot;closing\n&quot;)
  (close-port port)
  (receive-and-return (rv)
      (extract)
    (trace &quot;full contents: ~s\n&quot; rv)))
-| writing 64 chars
-| writing 16 chars
-| writing 16 chars
-| writing 16 chars
-| flushing output
-| writing 16 chars
-| closing
-| full contents: &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;
</pre></div>

<p>We can simulate error&ndash;on&ndash;flushing with the following code:
</p>
<div class="example">
<pre class="example">(with-result
  (let-values (((port extract) (make-test-port)))
    (px.port-set-close-on-exec-mode! port)
    (trace &quot;writing ~a chars\n&quot; the-string-len)
    (add-result 'writing)
    (display the-string port)
    (trace &quot;flushing output\n&quot;)
    (add-result 'flushing)
    (parametrise ((error-on-write #t))
      (px.flush-ports-in-close-on-exec-mode (lambda (E)
                                              (trace &quot;flush exception: ~s\n&quot; E))))
    (trace &quot;closing\n&quot;)
    (add-result 'closing)
    (px.close-ports-in-close-on-exec-mode port)
    (receive-and-return (rv)
        (string-length (extract))
      (trace &quot;full contents: ~s\n&quot; rv))))
&rArr; (48 (writing flushing closing))
-| writing 64 chars
-| writing 16 chars
-| writing 16 chars
-| writing 16 chars
-| flushing output
-| writing 16 chars
-| flush exception: #[r6rs-record: compound-condition
  components=(#[r6rs-record: &amp;error]
              #[r6rs-record: &amp;who who=write!]
              #[r6rs-record: &amp;message message=&quot;error writing characters&quot;]
              #[r6rs-record: &amp;irritants irritants=(16)])]
-| closing
-| full contents: 48
</pre></div>

<p>when <code>flush-ports-in-close-on-exec-mode</code> applies <code>flush-output-port</code> on the
port: the given error handler is called.
</p>
<p>We can simulate error&ndash;on&ndash;closing with the following code:
</p>
<div class="example">
<pre class="example">(with-result
  (let-values (((port extract) (make-test-port)))
    (px.port-set-close-on-exec-mode! port)
    (trace &quot;writing ~a chars\n&quot; the-string-len)
    (add-result 'writing)
    (display the-string port)
    (trace &quot;closing\n&quot;)
    (add-result 'closing)
    (parametrise ((error-on-write #t))
      (px.close-ports-in-close-on-exec-mode (lambda (E)
                                              (trace &quot;close exception: ~s\n&quot; E))))
    (receive-and-return (rv)
        (string-length (extract))
      (trace &quot;full contents: ~s\n&quot; rv))))
&rArr; (48 (writing closing))
-| writing 64 chars
-| writing 16 chars
-| writing 16 chars
-| writing 16 chars
-| closing
-| writing 16 chars
-| close exception: #[r6rs-record: compound-condition
   components=(#[r6rs-record: &amp;error]
               #[r6rs-record: &amp;who who=write!]
               #[r6rs-record: &amp;message message=&quot;error writing characters&quot;]
               #[r6rs-record: &amp;irritants irritants=(16)])]
-| full contents: 48
</pre></div>

<p>when <code>close-ports-in-close-on-exec-mode</code> applies <code>close-port</code> on the port:
the given error handler is called.
</p>
<hr>
<div class="header">
<p>
Next: <a href="February-13-bis.html#February-13-bis" accesskey="n" rel="next">February 13 bis</a>, Previous: <a href="February-14-bis.html#February-14-bis" accesskey="p" rel="prev">February 14 bis</a>, Up: <a href="index.html#Top" accesskey="u" rel="up">Top</a> &nbsp; [<a href="concept-index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="concept-index.html#concept-index" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
