<html lang="en">
<head>
<title>2015 January 29 - Marco's Weblog</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="Marco's Weblog">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="2015.html#g_t2015" title="2015">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
Copyright (C) 2015 by Marco Maggi <marco.maggi-ipsu@poste.it>

     Permission is granted to copy, distribute and/or modify this
     document under the terms of the GNU Free Documentation License,
     Version 1.3 or any later version published by the Free Software
     Foundation; with Invariant Sections being ``GNU Free Documentation
     License'' and ``GNU General Public License'', no Front--Cover
     Texts, and no Back--Cover Texts.  A copy of the license is
     included in the section entitled ``GNU Free Documentation
     License''.
-->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
<link rel="stylesheet" type="text/css" href="weblog.css">
</head>
<body>
<div class="node">
<a name="g_t2015-January-29"></a>
<p>
Up:&nbsp;<a rel="up" accesskey="u" href="2015.html#g_t2015">2015</a>
<hr>
</div>

<h3 class="unnumberedsec">On the implementation of <code>unwind-protect</code></h3>

<p>The macro <code>unwind-protect</code> has the purpose of releasing resources that must be
allocated synchronously with respect to a chunk of code; its syntax is:

<pre class="example">     (unwind-protect
         <var>?body</var>
       <var>?clean-up0</var>
       <var>?clean-up</var>
       ...)
</pre>
   <p class="noindent">and it can be used as:

<pre class="example">     #!vicare
     (let ((port (open-file-output-port "file.ext")))
       (unwind-protect
           (put-bytevector port '#ve(ascii "ciao"))
         (close-output-port port)))
</pre>
   <p class="noindent">first we allocate a resource (in this case the <var>port</var>); then we use it in the
<var>?body</var> form; finally we release it in the <var>?clean-up</var> forms.  The
<var>?clean-up</var> forms are executed whether <var>?body</var> performs a normal return or
raises an exception.  When <var>?body</var> returns: the return value of
<code>unwind-protect</code> is the return value of <var>?body</var>.

   <p>It is clear that <code>unwind-protect</code> is a very useful operator: in a way or the
other, a language <strong>must</strong> provide a way to release synchronous resources.  We
might be tempted to rely on the garbage collector finalisers (under <a href="References.html#References">Vicare</a>:
guardians), but:

     <ul>
<li>At present, there is no guarantee that a guarded object is finalised before the end
of the process.

     <li>Some resources have a complex finalisation procedure that may fail; so we need to
integrate this procedure in the application's operations and, when needed, have the
application ask for user intervention.  User interaction requires sharing context
between parts of the program: something that is more complex to set up with a
guardian's handler. 
</ul>

   <p>There have been
<a href="http://www.nhplace.com/kent/PFAQ/unwind-protect-vs-continuations-original.html">plenty</a> <a href="http://repository.readscheme.org/ftp/papers/sw2003/Unwind.pdf">of</a>
<a href="http://compgroups.net/comp.lang.lisp/continuations-in-common-lisp-with-apologies/698239">discussions</a> about how to implement <code>unwind-protect</code> in Scheme and some
<a href="http://www.ccs.neu.edu/home/will/UWESC/uwesc.sch">proposals</a>; none of them
provided a definitive solution (where <em>definitive</em> means: problem solved and
syntax included in the standard language).  At
<a href="https://github.com/marcomaggi/vicare/commit/68cac65a460b8f419f724721b94a6b85a0f5eac6">present</a>, <a href="References.html#References">Vicare</a>'s <a href="References.html#References">master branch</a> branch implements an unwind protection mechanism
that, at its core, is available through the built&ndash;in macro
<code>with-unwind-protection</code> exported by the library <code>(vicare)</code>; the syntax
is:

<pre class="example">     (with-unwind-protection <var>?clean-up</var> <var>?thunk</var>)
</pre>
   <p class="noindent">where <var>?thunk</var> performs the job and the procedure <var>?clean-up</var> releases
resources.

   <p>The above example would be implemented as:

<pre class="example">     #!vicare
     (let ((port (open-file-output-port "file.ext")))
       (with-unwind-protection
           (lambda (why)
             (close-output-port port))
         (lambda ()
           (put-bytevector port '#ve(ascii "ciao")))))
</pre>
   <p>The built&ndash;in macro <code>unwind-protect</code> is still available as simple wrapper
around <code>with-undind-protection</code>:

<pre class="example">     (unwind-protect <var>?body</var> <var>?cleanup0</var> <var>?cleanup</var> ...)
     ==&gt; (with-unwind-protection
             (lambda (dummy) <var>?cleanup0</var> <var>?cleanup</var> ...)
           (lambda () <var>?body</var>))
</pre>
   <p>The built&ndash;in macros <code>try</code> and <code>with-compensations</code>

<!-- page -->
<!--  -->
<!-- Appendices. -->
<!--  -->
   </body></html>

