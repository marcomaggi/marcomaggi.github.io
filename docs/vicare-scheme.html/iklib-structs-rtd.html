<html lang="en">
<head>
<title>iklib structs rtd - Vicare Scheme</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="Vicare Scheme">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="iklib-structs.html#iklib-structs" title="iklib structs">
<link rel="next" href="iklib-structs-using.html#iklib-structs-using" title="iklib structs using">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
This document describes version 0.3d6 of Vicare Scheme, an
R6RS compliant native compiler for the Scheme language, producing
single threaded programs running on Intel x86 32-bit processors, with
experimental support for 64-bit machines.  _Vicare_ is pronounced
the etruscan way.

The package, including its documentation, is distributed under the terms
of the GNU General Public License (GPL) and can be downloaded
from:

        `http://sourceforge.net/projects/vicare-scheme/files/'


the home page of the project is at:

              `http://marcomaggi.github.com/vicare.html'


development takes place at:

                `http://github.com/marcomaggi/vicare/'


and, as a backup, at:

                     `http://gitorious.org/vicare'


and at:

           `http://sourceforge.net/projects/vicare-scheme/'


this project has a mailing list:

             `http://groups.google.com/group/vicare-users'


Copyright (C) 2010-2013 by Marco Maggi.

Copyright (C) 2006-2010 by Abdulaziz Ghuloum.

Copyright (C) Michael Sperber, R. Kent Dybvig, Matthew Flatt and Anton Van Straaten.

This document is derived from the original Ikarus documentation by the
Vicare Scheme contributors, see the ``History'' appendix for details.

The documentation of IrRegex is Copyright (C) 2005-2012 Alex
Shinn.  All rights reserved.

The documentation of Pregexp is Copyright (C) 1999-2005 Dorai
Sitaram.  All rights reserved.

The documentation of the library `(vicare formations)' is derived
from the documentation of Guile.  Copyright (C) 1996-2005,
2009-2013 Free Software Foundation.

     This program is free software: you can redistribute it and/or
     modify it under the terms of the GNU General Public License
     version 3 as published by the Free Software Foundation.

     This program is distributed in the hope that it will be useful, but
     WITHOUT ANY WARRANTY; without even the implied warranty of
     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
     General Public License for more details.

     You should have received a copy of the GNU General Public License
     along with this program.  If not, see
     `http://www.gnu.org/licenses/'.

Trademarks used herein are the property of their respective owners.-->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<a name="iklib-structs-rtd"></a>
<p>
Next:&nbsp;<a rel="next" accesskey="n" href="iklib-structs-using.html#iklib-structs-using">iklib structs using</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="iklib-structs.html#iklib-structs">iklib structs</a>
<hr>
</div>

<h4 class="subsection">6.12.1 Structure type descriptors</h4>

<p>The following bindings are exported by the library <code>(vicare)</code>.

<div class="defun">
&mdash; Syntax: <b>define-struct</b><var> ?name </var>(<var>?field ...</var>)<var><a name="index-define_002dstruct-1273"></a></var><br>
<blockquote><p>Define a new data structure type.  This macro is embedded in the
expander.

        <p><var>?name</var> must be a symbol representing the name of the structure; it
is used to build names for the constructor, predicate, field accessors
and mutators.  The <var>?field</var> values must be symbols representing the
names of the fields; they are used to build names for the accessors and
mutators.

        <p>The following definition:

     <pre class="example">          (define-struct color
            (red green blue))
</pre>
        <p class="noindent">expands to the definition of the following bindings:

          <dl>
<dt><code>color</code><dd>A keyword bound to a pair whose car is the symbol &lsquo;<samp><span class="samp">$rtd</span></samp>&rsquo; and whose
cdr is the return value of <code>make-struct-type</code> applied to the name
of the structure and the list of fields.

          <br><dt><code>make-color </code><var>red</var> <var>green</var> <var>blue</var><dd>A structure constructor accepting as much arguments as there are fields. 
The constructor makes use of the <code>$struct</code> low level operation.

          <br><dt><code>color? </code><var>obj</var><dd>A predicate to distinguish between references to <code>color</code> structures
and other values.  This predicate makes use of the <code>$struct/rtd?</code>
low level operation.

          <br><dt><code>color-red </code><var>stru</var><dt><code>color-green </code><var>stru</var><dt><code>color-blue </code><var>stru</var><dd>Accessor functions for the fields of the structure.  These accessors
make use of the <code>$struct/rtd?</code> low level operation to validate the
argument and if successful they use <code>$struct-ref</code> to extract the
value; if the argument is of invalid type: an assertion violation is
raised.

          <br><dt><code>set-color-red! </code><var>stru</var> <var>red</var><dt><code>set-color-green! </code><var>stru</var> <var>green</var><dt><code>set-color-blue! </code><var>stru</var> <var>blue</var><dd>Mutator functions for the fields of the structure.  These mutators make
use of the <code>$struct/rtd?</code> low level operation to validate the
argument <var>stru</var> and if successful they use <code>$struct-set!</code> to
set the value; if the argument <var>stru</var> is of invalid type: an
assertion violation is raised.

          <br><dt><code>$color-red </code><var>stru</var><dt><code>$color-green </code><var>stru</var><dt><code>$color-blue </code><var>stru</var><dd>Unsafe accessor syntaxes for the fields of the structure.  These
accessors do not validate the arguments and expand directly to a use of
<code>$struct-ref</code> to extract the value; if the argument is invalid: the
behaviour is undefined.

          <br><dt><code>$set-color-red! </code><var>stru</var> <var>red</var><dt><code>$set-color-green! </code><var>stru</var> <var>green</var><dt><code>$set-color-blue! </code><var>stru</var> <var>blue</var><dd>Unsafe mutator syntaxes for the fields of the structure.  These mutators
do not validate the arguments and expand directly to a use of
<code>$struct-set!</code> to set the value; if the argument <var>stru</var> is
invalid: the behaviour is undefined. 
</dl>
        </p></blockquote></div>

<div class="defun">
&mdash; Function: <b>make-struct-type</b><var> name fields<a name="index-make_002dstruct_002dtype-1274"></a></var><br>
&mdash; Function: <b>make-struct-type</b><var> name fields uid<a name="index-make_002dstruct_002dtype-1275"></a></var><br>
<blockquote><p>Build and return a new structure type descriptor.  <var>name</var> must be a
string representing the type name.  <var>fields</var> must be a list of
symbols representing the field names.

        <p>The optional <var>uid</var> argument must be a symbol uniquely identifying
this type; when not supplied, a symbol is automatically generated.  The
<code>$symbol-value</code> field of <var>uid</var> is set to the newly created
<acronym>RTD</acronym>; if <var>uid</var> already has a symbol value: such value must be a
struct descriptor equal to the newly created <acronym>RTD</acronym>. 
</p></blockquote></div>

<div class="defun">
&mdash; Syntax: <b>type-descriptor</b><var> ?name<a name="index-type_002ddescriptor-1276"></a></var><br>
<blockquote><p>Evaluate to the type descriptor of the data structure <var>?name</var>, which
must be the first argument to a previous use of <code>define-struct</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Function: <b>struct-type-name</b><var> rtd<a name="index-struct_002dtype_002dname-1277"></a></var><br>
<blockquote><p>Return a string represnting the name of structures of type <var>rtd</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Function: <b>struct-type-symbol</b><var> rtd<a name="index-struct_002dtype_002dsymbol-1278"></a></var><br>
<blockquote><p>Return a symbol uniquely identifying the data structure type <var>rtd</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Function: <b>struct-type-field-names</b><var> rtd<a name="index-struct_002dtype_002dfield_002dnames-1279"></a></var><br>
<blockquote><p>Return a list of symbols representing the names of fields in structures
of type <var>rtd</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Function: <b>struct-type-destructor</b><var> rtd<a name="index-struct_002dtype_002ddestructor-1280"></a></var><br>
<blockquote><p>Return <code>#f</code> or a procedure being the destructor for instances of
<var>rtd</var>.  The destructor is registered in a structure type descriptor
with <code>set-rtd-destructor!</code>. 
</p></blockquote></div>

<!--  -->
<div class="defun">
&mdash; Function: <b>set-rtd-printer!</b><var> rtd printer<a name="index-set_002drtd_002dprinter_0021-1281"></a></var><br>
<blockquote><p>Select the procedure <var>printer</var> as printer for data structures of
type <var>rtd</var>; return unspecified values.  The printer accepts 3
arguments: the structure to be printed, the port to which write a string
represention of the structure with <code>display</code>, a function to be
optionally applied to the field values to print them. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Automatic finalisation of structures</h5>

<p><a name="index-Automatic-finalisation-of-structures-1282"></a><a name="index-Structures_002c-automatic-finalisation-1283"></a><a name="index-Structures_002c-destructors-1284"></a><a name="index-Data-structures_002c-automatic-finalisation-1285"></a><a name="index-Data-structures_002c-destructors-1286"></a><a name="index-Finalisation-of-data-structures-1287"></a><a name="index-Destructors-for-data-structures-1288"></a>

<div class="defun">
&mdash; Function: <b>set-rtd-destructor!</b><var> rtd destructor<a name="index-set_002drtd_002ddestructor_0021-1289"></a></var><br>
<blockquote><p>Select the procedure <var>destructor</var> as destructor for data structures
of type <var>rtd</var>; return unspecified values.  The destructor accepts a
single argument being the structure instance to finalise; the destructor
can return unspecified values.

        <p>After a destructor is registered in <var>rtd</var>: new instances of this
structure type are registered, upon creation, into an internal guardian,
<a href="iklib-guardians.html#iklib-guardians">iklib guardians</a> for details; whenever such structures are garbage
collected: the guardian applies <var>destructor</var> to them.

        <p>Exceptions raised by <var>destructor</var> are catched with <code>guard</code> and
discarded: destructor functions should take care of exceptions by
themselves. 
</p></blockquote></div>

<div class="defun">
&mdash; Parameter: <b>struct-guardian-logger</b><var><a name="index-struct_002dguardian_002dlogger-1290"></a></var><br>
<blockquote><p>Select data structure destruction logging mode for debugging purposes. 
When a structure is finalised by the garbage collector, using the
destructor registered in the <acronym>RTD</acronym>:

          <ul>
<li>If this parameter is set to <code>#f</code>: no additional actions are
performed.

          <li>If this parameter is set to <code>#t</code>: the function
<code>struct-guardian-log</code> is used to log the operations to the textual
output port returned by <code>current-error-port</code>.

          <li>If this parameter is set to a procedure: such procedure is used to log
the operations in a user selected way. 
</ul>

        <p>See the documentation of <code>struct-guardian-log</code> for the calling
protocol of the logger functions. 
</p></blockquote></div>

<div class="defun">
&mdash; Function: <b>struct-guardian-log</b><var> struct exception action<a name="index-struct_002dguardian_002dlog-1291"></a></var><br>
<blockquote><p>Built in logger function to be used to log data structure finalisation
operations by the garbage collector.  <var>struct</var> is the structure to
be finalised; <var>exception</var> is <code>#f</code> or an object raised by the
structure destructor; <var>action</var> is one of the symbols:
<code>before-destruction</code>, <code>after-destruction</code>, <code>exception</code>.

        <p>When this function is used as value for the parameter
<code>struct-guardian-logger</code>:

          <ul>
<li>The function is called whenever a data structure is registered for
destruction with <var>action</var> set to the symbol <code>registration</code> and
<var>exception</var> set to <code>#f</code>.

          <li>The function is called just before the structure is finalised with
<var>action</var> set to the symbol <code>before-destruction</code> and
<var>exception</var> set to <code>#f</code>.

          <li>The function is called right after the structure has been finalised with
<var>action</var> set to the symbol <code>after-destruction</code> and
<var>exception</var> set to <code>#f</code>.

          <li>If an exception is raised by the destructor: such exception is catched
and this function is called with <var>action</var> set to <code>exception</code>
and <var>exception</var> set to the raised object. 
</ul>

        <p>The current implementation is the following:

     <pre class="smallexample">          (define (struct-guardian-log S E action)
            (case action
              ((registration)
               (fprintf (current-error-port)
                        "*** Vicare debug: struct guardian: registered struct:\n\
                         ***\t~s\n" S))
              ((before-destruction)
               (fprintf (current-error-port)
                 "*** Vicare debug: struct guardian: before destruction:\n\
                  ***\t~s\n" S))
              ((after-destruction)
               (fprintf (current-error-port)
                 "*** Vicare debug: struct guardian: after destruction:\n\
                  ***\t~s\n" S))
              ((exception)
               (fprintf (current-error-port)
                 "*** Vicare debug: struct guardian: exception:\n\
                  ***\t~s\n\
                  ***\t~s\n" S E))
              (else
               (assertion-violation 'struct-guardian-log
                 "invalid action in struct destruction process" S action))))
</pre>
        </blockquote></div>

<!-- page -->
   </body></html>

