<html lang="en">
<head>
<title>Useless TCL Packages</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="Useless TCL Packages">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="top" href="#Top">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
This document describes version 4.0a0 of UTP, a
collection of packages for TCL.  The project home page of UTP is
at:

                `http://marcomaggi.github.com/utp.html'


development of UTP takes place at:

                  `http://github.com/marcomaggi/utp/'


Copyright (C) 2002-2006, 2011 by Marco Maggi.

     Permission is granted to copy, distribute and/or modify this
     document under the terms of the GNU Free Documentation License,
     Version 1.3 or any later version published by the Free Software
     Foundation; with no Invariant Sections being ``GNU Free
     Documentation License'' and ``GNU General Public License'', no
     Front--Cover Texts, and no Back--Cover Texts.  A copy of the
     license is included in the section entitled ``GNU Free
     Documentation License''.
   -->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<h1 class="settitle">Useless TCL Packages</h1>
<div class="node">
<a name="Top"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#overview">overview</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#dir">(dir)</a>

</div>

<h2 class="unnumbered">Useless TCL Packages</h2>

<p class="noindent">This document describes version 4.0a0 of <acronym>UTP</acronym>, a
collection of packages for <acronym>TCL</acronym>.  The project home page of <acronym>UTP</acronym> is
at:

<div align="center"><a href="http://marcomaggi.github.com/utp.html">http://marcomaggi.github.com/utp.html</a></div>

<p class="noindent">development of <acronym>UTP</acronym> takes place at:

<div align="center"><a href="http://github.com/marcomaggi/utp/">http://github.com/marcomaggi/utp/</a></div>

<p class="noindent">Copyright &copy; 2002-2006, 2011 by Marco Maggi.

   <blockquote>
Permission is granted to copy, distribute and/or modify this document
under the terms of the <acronym>GNU</acronym> Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with no
Invariant Sections being &ldquo;<acronym>GNU</acronym> Free Documentation License&rdquo; and
&ldquo;<acronym>GNU</acronym> General Public License&rdquo;, no Front&ndash;Cover Texts, and no
Back&ndash;Cover Texts.  A copy of the license is included in the section
entitled &ldquo;<acronym>GNU</acronym> Free Documentation License&rdquo;. 
</blockquote>

<ul class="menu">
<li><a accesskey="1" href="#overview">overview</a>:                     Overview of the package. 
<li><a accesskey="2" href="#preprocessor">preprocessor</a>:                 Preprocessing <acronym>UTP</acronym> source files. 
<li><a accesskey="3" href="#typedef">typedef</a>:                      Declaring data types. 
<li><a accesskey="4" href="#struct">struct</a>:                       Declaring structures.

</li></ul>
<p>Main package

</p>
<ul class="menu">
<li><a accesskey="5" href="#token">token</a>:                        Managing global symbols to store data. 
<li><a accesskey="6" href="#dynamic">dynamic</a>:                      Handling dynamic environment. 
<li><a accesskey="7" href="#containers">containers</a>:                   Collecting data. 
<li><a accesskey="8" href="#events">events</a>:                       Handling the event loop. 
<li><a accesskey="9" href="#user-interface">user interface</a>:               Interfacing with the user. 
<li><a href="#design">design</a>:                       Packages implementing design strategies. 
<li><a href="#file">file</a>:                         File related packages. 
<li><a href="#parsers">parsers</a>:                      Parsing languages and files. 
<li><a href="#main">main</a>:                         Command line script infrastructure. 
<li><a href="#misc">misc</a>:                         Miscellaneous procedures.

</li></ul>
<p>External Packages

</p>
<ul class="menu">
<li><a href="#layout">layout</a>:                       Managing directory layouts. 
<li><a href="#hoco">hoco</a>:                         The homogeneous coordinates package. 
<li><a href="#wireframe">wireframe</a>:                    Wireframe objects. 
<li><a href="#wireframetk">wireframetk</a>:                  TK wireframe objects visualiser.

</li></ul>
<p>Appendices

</p>
<ul class="menu">
<li><a href="#Package-License">Package License</a>:              <acronym>GNU</acronym> General Public License. 
<li><a href="#Documentation-License">Documentation License</a>:        <acronym>GNU</acronym> Free Documentation License. 
<li><a href="#References">References</a>:                   Bibliography and references.

</li></ul>
<p>Indexes

</p>
<ul class="menu">
<li><a href="#Concept-Index">Concept Index</a>:                An entry for each concept. 
<li><a href="#Function-Index">Function Index</a>:               An entry for each procedure. 
<li><a href="#Variable-Index">Variable Index</a>:               An entry for each variable. 
<li><a href="#Type-Index">Type Index</a>:                   An entry for each type.

</li></ul>
<p>--- The Detailed Node Listing ---

<p>Introduction to <acronym>UTP</acronym>

</p>
<ul class="menu">
<li><a href="#overview-error">overview error</a>: 		Philosophy of error handling.

</li></ul>
<p>Preprocessing <acronym>UTP</acronym> source files

</p>
<ul class="menu">
<li><a href="#preprocessor-overview">preprocessor overview</a>:        Overview of preprocessing. 
<li><a href="#preprocessor-usage">preprocessor usage</a>:           How to use the preprocessor. 
<li><a href="#preprocessor-commands">preprocessor commands</a>:        What's evaluated by the preprocessor. 
<li><a href="#preprocessor-expansion">preprocessor expansion</a>:       Processing by regular expressions.

</li></ul>
<p>What's evaluated by the preprocessor

</p>
<ul class="menu">
<li><a href="#preprocessor-commands-special">preprocessor commands special</a>
<li><a href="#preprocessor-commands-types">preprocessor commands types</a>
<li><a href="#preprocessor-commands-procedures">preprocessor commands procedures</a>
<li><a href="#preprocessor-commands-struct">preprocessor commands struct</a>

</li></ul>
<p>Declaring data types

</p>
<ul class="menu">
<li><a href="#typedef-overview">typedef overview</a>:             Overview of the type system. 
<li><a href="#typedef-string">typedef string</a>:               String based types. 
<li><a href="#typedef-objects">typedef objects</a>:              <acronym>TCL</acronym> objects types. 
<li><a href="#typedef-number">typedef number</a>:               Number base types. 
<li><a href="#typedef-misc">typedef misc</a>:                 Miscellaneous values.

</li></ul>
<p>Declaring structures

</p>
<ul class="menu">
<li><a href="#struct-vars">struct vars</a>:                  Structure variables. 
<li><a href="#struct-usage">struct usage</a>:                 Using <acronym>UTP</acronym> structures. 
<li><a href="#struct-procs">struct procs</a>:                 Defining and declaring structures.

</li></ul>
<p>Managing global symbols to store data

</p>
<ul class="menu">
<li><a href="#token-explicit">token explicit</a>:               Using explicit token variables. 
<li><a href="#token-implicit">token implicit</a>:               Using implicit token variables. 
<li><a href="#token-map">token map</a>:                    Storing tokens in an associative array.

</li></ul>
<p>Collecting data

</p>
<ul class="menu">
<li><a href="#stack">stack</a>:                        List as stack. 
<li><a href="#queue">queue</a>:                        List as queue.

</li></ul>
<p>Handling the event loop

</p>
<ul class="menu">
<li><a href="#event-source">event source</a>:                 Event sources. 
<li><a href="#periodic-scripts">periodic scripts</a>:             Evaluating scripts periodically. 
<li><a href="#timeouts">timeouts</a>:                     Setting timeouts.

</li></ul>
<p>Evaluating scripts periodically

</p>
<ul class="menu">
<li><a href="#periodic-scripts-diagram">periodic scripts diagram</a>

</li></ul>
<p>Interfacing with the user

</p>
<ul class="menu">
<li><a href="#getopts">getopts</a>:                      Parsing options from the command line. 
<li><a href="#ini-files">ini files</a>:                    Parsing <code>.INI</code> configuration files. 
<li><a href="#channel-message">channel message</a>:              Writing messages into a channel. 
<li><a href="#dialog">dialog</a>:                       Asking questions.

</li></ul>
<p>Parsing options from the command line

</p>
<ul class="menu">
<li><a href="#getopts-intro">getopts intro</a>:                The format of recognised options. 
<li><a href="#getopts-basic">getopts basic</a>:                Low level procedures. 
<li><a href="#getopts-parser">getopts parser</a>:               Options declaration and parsing. 
<li><a href="#getopts-help">getopts help</a>:                 Building the help screen.

</li></ul>
<p>Writing messages into a channel

</p>
<ul class="menu">
<li><a href="#channel-message-init">channel message init</a>:         Initialisation. 
<li><a href="#channel-message-config">channel message config</a>:       Configuration. 
<li><a href="#channel-message-write">channel message write</a>:        Writing messages.

</li></ul>
<p>Packages implementing design strategies

</p>
<ul class="menu">
<li><a href="#iterator">iterator</a>:                     Iteration procedures. 
<li><a href="#observer">observer</a>:                     One to many relation. 
<li><a href="#task">task</a>:                         Handling job private variables. 
<li><a href="#factory">factory</a>:                      Object factory. 
<li><a href="#cache">cache</a>:                        Caching objects. 
<li><a href="#workers">workers</a>:                      Using a pool of worker items. 
<li><a href="#sm">sm</a>:                           Managing state machines. 
<li><a href="#option">option</a>:                       Handling tables of options.

</li></ul>
<p>Handling job private variables

</p>
<ul class="menu">
<li><a href="#task-token">task token</a>:                   Token handling
<li><a href="#task-interface">task interface</a>:               Interface procedures. 
<li><a href="#task-examples">task examples</a>:                Usage examples.

</li></ul>
<p>File related packages

</p>
<ul class="menu">
<li><a href="#channel">channel</a>:                      Chennel related procedures. 
<li><a href="#file-procs">file procs</a>:                   File related procedures. 
<li><a href="#lock-files">lock files</a>:                   Creating lock files.

</li></ul>
<p>Chennel related procedures

</p>
<ul class="menu">
<li><a href="#channel-basic">channel basic</a>:                Basic channel operations. 
<li><a href="#channel-other">channel other</a>:                Other non--basic operations. 
<li><a href="#channel-events">channel events</a>:               Event handlers for channel events. 
<li><a href="#channel-configure">channel configure</a>:            Configuring a channel. 
<li><a href="#channel-seeking">channel seeking</a>:              Moving the pointer.

</li></ul>
<p>File related procedures

</p>
<ul class="menu">
<li><a href="#file-rw">file rw</a>:                      Reading and writing. 
<li><a href="#file-inspect">file inspect</a>:                 Inspection. 
<li><a href="#file-norm">file norm</a>:                    Normalisation. 
<li><a href="#file-load">file load</a>:                    Loading input files. 
<li><a href="#file-output">file output</a>:                  Output files. 
<li><a href="#file-misc">file misc</a>:                    Miscellaneous.

</li></ul>
<p>Parsing languages and files

</p>
<ul class="menu">
<li><a href="#xmlpp">xmlpp</a>:                        A simple <acronym>XML</acronym> parser.

</li></ul>
<p>Command line script infrastructure

</p>
<ul class="menu">
<li><a href="#main-usage">main usage</a>:                   How to use the module. 
<li><a href="#main-options">main options</a>:                 Predefined options. 
<li><a href="#main-infos">main infos</a>:                   Script meta informations. 
<li><a href="#main-interface">main interface</a>:               Module interface. 
<li><a href="#main-variables">main variables</a>:               Script state variables. 
<li><a href="#main-loop">main loop</a>:                    Event loop interaction. 
<li><a href="#main-exit">main exit</a>:                    Main function exit codes.

</li></ul>
<p>Miscellaneous procedures

</p>
<ul class="menu">
<li><a href="#misc-base">misc base</a>:                    Basic procedures. 
<li><a href="#misc-error">misc error</a>:                   Error procedures. 
<li><a href="#misc-procedures">misc procedures</a>:              Handling procedures. 
<li><a href="#misc-list">misc list</a>:                    List procedures. 
<li><a href="#misc-regexps">misc regexps</a>:                 Handling regular expressions. 
<li><a href="#misc-math">misc math</a>:                    Mathematical procedures.

</li></ul>
<p>The homogeneous coordinates package

</p>
<ul class="menu">
<li><a href="#hoco-transform">hoco transform</a>:               Format of a transformation list. 
<li><a href="#hoco-procs">hoco procs</a>:                   Transformation procedures. 
<li><a href="#hoco-dynamic">hoco dynamic</a>:                 Dynamic transformations.

</li></ul>
<p>Format of a transformation list

</p>
<ul class="menu">
<li><a href="#hoco-transform-elem">hoco transform elem</a>:          Elementary transformation matrices. 
<li><a href="#hoco-transform-modeling">hoco transform modeling</a>:      Modeling templates. 
<li><a href="#hoco-transform-format">hoco transform format</a>:        Transform format.

</li></ul>
<p>Transformation procedures

</p>
<ul class="menu">
<li><a href="#hoco-procs-core">hoco procs core</a>:              Core procedures. 
<li><a href="#hoco-procs-matrix">hoco procs matrix</a>:            Basic matrices. 
<li><a href="#hoco-procs-transform">hoco procs transform</a>:         Basic transforms. 
<li><a href="#hoco-procs-params">hoco procs params</a>:            Transforms from parameters.

</li></ul>
<p>Wireframe objects

</p>
<ul class="menu">
<li><a href="#wireframe-intro">wireframe intro</a>:              Introduction to graphics model. 
<li><a href="#wireframe-element">wireframe element</a>:            Format of the elements list. 
<li><a href="#wireframe-ops">wireframe ops</a>:                Operations upon elements. 
<li><a href="#wireframe-templates">wireframe templates</a>:          Element coordinates templates. 
<li><a href="#wireframe-basic">wireframe basic</a>:              Basic elements. 
<li><a href="#wireframe-aggregate">wireframe aggregate</a>:          Aggregate elements.

</li></ul>
<p>Introduction to graphics model

</p>
<ul class="menu">
<li><a href="#wireframe-intro-preamble">wireframe intro preamble</a>:     Scripts preamble and tail. 
<li><a href="#wireframe-intro-canvas">wireframe intro canvas</a>:       Drawing on a canvas widget. 
<li><a href="#wireframe-intro-plane">wireframe intro plane</a>:        Drawing on a plane. 
<li><a href="#wireframe-intro-world">wireframe intro world</a>:        Drawing a world. 
<li><a href="#wireframe-intro-moving">wireframe intro moving</a>:       Drawing a in a moving frame. 
<li><a href="#wireframe-intro-media">wireframe intro media</a>:        Separating media commands. 
<li><a href="#wireframe-intro-coords">wireframe intro coords</a>:       Better coordinates handling.

</li></ul>
<p>TK wireframe objects visualiser

</p>
<ul class="menu">
<li><a href="#wireframetk-struct">wireframetk struct</a>:           Visualiser structure. 
<li><a href="#wireframetk-populate">wireframetk populate</a>:         Populating a canvas with objects. 
<li><a href="#wireframetk-update">wireframetk update</a>:           Updating a canvas. 
<li><a href="#wireframetk-misc">wireframetk misc</a>:             Miscellaneous procedures.

   </ul>

<!-- page -->
<div class="node">
<a name="overview"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#preprocessor">preprocessor</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Top">Top</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">1 Introduction to <acronym>UTP</acronym></h2>

<p><acronym>UTP</acronym> is a collection of packages for the <em>Tool Command
Language</em> (<acronym>TCL</acronym>); they provide a miscellaneous set of features.  To
load the main package:

<pre class="example">     package require UTP
</pre>
   <p><acronym>UTP</acronym> makes use of the <code>utp_</code> prefix for procedures,
variables, value types and structure names.  To know the version numbers
of packages coming with a <acronym>UTP</acronym> distribution we have to inspect the
installed <samp><span class="file">pkgIndex.tcl</span></samp> file.

   <p>Unless explicitly stated, all the procedure names are composed of three
parts: the <code>utp</code> prefix, the module name as a single string, the
procedure action as one or more strings; strings are joined with an
underscore (<code>_</code>) character.  Global variable names are prefixed
with <code>utp</code>.  Example of procedure name of the <code>message</code>
module: <code>[utp_message_error]</code>.

   <p>The <code>utp_script_</code> prefix is special: <acronym>UTP</acronym> may declare
some procedures in it, but all of them are intended as redefinable by
the user (although this may require the user to inspect the
<acronym>UTP</acronym> source code before).

<ul class="menu">
<li><a accesskey="1" href="#overview-error">overview error</a>: 		Philosophy of error handling. 
</ul>

<!-- page -->
<div class="node">
<a name="overview-error"></a>
<p><hr>
Up:&nbsp;<a rel="up" accesskey="u" href="#overview">overview</a>

</div>

<h3 class="section">1.1 Philosophy of error handling</h3>

<p>When organising the structure of a module, usually one makes use of some
design patterns, like Mediator or Object Factory: this is designing &ldquo;in
the large&rdquo;.  Local coding style affects the design &ldquo;in the small&rdquo; and
error handling is part of it.  Error handling affects the usability of
the code: whether it will be easy for the programmer to use the
interface exposed by a module.

   <p>In the following: the expression &ldquo;returning with an error condition&rdquo;
means to use a command like <code>[error ...]</code> or <code>[return -code
error]</code>, while the expression &ldquo;returning with an error code&rdquo; means to
use <code>[return $errcode]</code> where the returned value is known by the
caller of the procedure to signal error.

<!--  -->
<h4 class="subheading">What happens when an error occurs</h4>

<p>When an error occurs: how can we react to it?  There are two
possibilities: we know how to circumvent the condition and go on, we do
not know.  In the former case the condition is not a &ldquo;real&rdquo; error:
it's a thing that may happen.  In the latter case there's nothing we can
do other than to abort the operation.

   <p>In all the programs there's a point were we &ldquo;begin&rdquo; an operation.

     <ul>
<li>In a simple, one&ndash;shot, command line interface (<acronym>CLI</acronym>) program:
we first parse command line arguments and build an internal
representation of the requested operation's initial condition, then we
start to do it.

     <li>In a graphical user interface (<acronym>GUI</acronym>) program: whenever the user
requests an operation by clicking on some widget, an event handler is
invoked and this procedure is the starting point. 
</ul>

   <p>If an error occurs: the stack must be rewind and all the resources freed
until we reach the point in which the operation was started.  Then we
can choose to abort the program (like in most <acronym>CLI</acronym> scripts) or
go on as nothing has happened (like in most <acronym>GUI</acronym> programs).

   <p>In the local context of a procedure the simpler thing that we can do is
return with an error condition or code:

<pre class="example">     proc a { } {
         if { [an_error_occurs] } {
             return -code error "error message"
         }
     }
     proc b { } {
         if { [an_error_occurs] } {
             return $errcode
         }
     }
</pre>
   <p>In some cases we have to free some resources before returning; we can do
it at the point in which we have detected the error (the <code>[if]</code>
body in the example):

<pre class="example">     proc a { } {
         if { [catch {
             if { [an_error_occurs]} {
                 free_resources
                 error "error message"
             }
         } errmsg] } {
             return -code error $errmsg
         }
     }
</pre>
   <p class="noindent">or we can jump to the end of the procedure and do it there:

<pre class="example">     proc a { } {
         if { [catch {
             if { [an_error_occurs]} {
                 error "error message"
             }
         } errmsg] } {
             free_resources
             return -code error $errmsg
         }
     }
</pre>
   <p>The latter is, more or less, the same scheme adopted for exception
handling in languages like C++, and it may be implemented in the C
language using <code>goto</code> instructions that jumps to labels at the end
of the function.

   <p>While rewinding the stack after an error, whenever we reach the
procedure that started the operation, we can exit the program:

<pre class="example">     proc main { } {
         set exit_code 0
     
         if { [catch {
             do_step_one
             do_step_two
             do_step_three
         } errmsg] } {
             puts stderr $errmsg
             set exit_code 1
         }
         exit $exit_code
     }
</pre>
   <p class="noindent">or just do nothing:

<pre class="example">     proc gui_event_handler { } {
         if { [catch {
             do_step_one
             do_step_two
             do_step_three
         } errmsg] } {
             after 0 [list message_dialog $errmsg]
         }
     }
</pre>
   <!--  -->
<h4 class="subheading">Error conditions or error codes</h4>

<p>The decision between returning with error condition or returning an
error code is mostly a matter of taste.

     <ul>
<li><acronym>TCL</acronym> can use &ldquo;output variables&rdquo; to return values: a procedure can
store values in variables in the scope of the caller, so returning a
code is always an option.

     <pre class="example">          proc a { arg1 arg2  resultvar } {
              upvar $resultvar result
          
              if { [an_error_occurred] } { return 1 }
              set result ...
              return 0
          }
</pre>
     <li>The interface of a module may seem easier to use if the procedures
return error codes, because the caller is free to throw an exeption
itself if required.  But in the end there's not much difference between
writing:

     <pre class="example">          switch { [a] } {
              0 {
                  # no error
              }
              1 {
                  # error type one
              }
              2 {
                  # error type two
              }
          }
</pre>
     <p class="noindent">and:

     <pre class="example">          if { [catch { a } errmsg] } {
              switch -match glob -- $::errorCode {
                  "LOGIC *"    { ... }
                  "RUNTIME *"  { ... }
              }
          }
</pre>
     </ul>

   <p>But: an important difference is that <acronym>TCL</acronym> makes use of global
variables (<code>errorCode</code> and <code>errorInfo</code>) to report errors,
so sometimes, in an event driven script, the &ldquo;concurrent&rdquo; evaluation
of event handlers may show interference in accessing them.  We have to
be careful.

<!--  -->
<h4 class="subheading">Is it an error?</h4>

<p>One has to ask himself: what's an error condition?  A possible answer
is: a condition that prevents us from completing an operation.  Examples
are: the vanishing of a file that we are supposed to write; the
unexpected closure of a socket by the remote host; an argument of a
procedure that's not in the set of correct values.

   <p>Some conditions may be treated as errors, or not, depending on the point
of view adopted by the programmer.  Example: is bad input from the user
an error condition?  It can be, but it can also be treated as a &ldquo;thing
that may happen&rdquo;.

   <p>In the event handler of a <acronym>GUI</acronym> program, the reaction to bad
user input may be:

<pre class="example">     proc event_handler { } {
         set user_input [...]
         if { [bad_input $user_input] } {
             message_dialog "bad input"
             return
         }
     
         ...
     }
</pre>
   <p class="noindent">no need to throw an exception.

   <p>Would it be correct to deal with bad input with the same mechanism that
we use for other errors?  If we code a predicate function that tests the
correctness of the input and returns a boolean value, we can embed its
invocation in a list (using the Command design pattern) and pass it
around to the point in which the script acquires the data: that way we
validate input in place (example: in the event handler of the
<kbd>Return</kbd> key press) and warn the user immediately, not after nesting
procedure invocations to the module that makes use of the data.

   <p>With this model we open a sort of transaction with the user, and only
when correct data is acquired we close it.  This is not a new concept.

   <p>One of the results we achieve is to separate causes of errors; if we
write code like this we find that many procedures do not need to return
an error at all.  There are sections of code in which we can test a set
of preconditions, and only if they succeed we proceed with the
allocation of resources.

<pre class="example">     set value ...
     if { ! [test_value $value] } {
         # abort the operation
     }
     set resource ...
     use_the_value $value $resource
</pre>
   <p>Different modules may view the same condition in different modes: a
thing that may happen in a module, may be seen as an error in an uplevel
module because it doesn't permit the completion of the operation.

<!--  -->
<h4 class="subheading">Types of error</h4>

<p>There are two types of error: logic and runtime.  The former appears
when a condition occurs that could have been avoided when writing the
program; the latter manifests itself as an unexpected condition.

<h5 class="subsubheading">Logic errors</h5>

<p>Examples of logic errors are: syntax errors, invalid value of a
procedure's argument, execution of an operation on data that's not ready
for it.

   <p>A logic error should cause the termination of the program: we can't be
sure that the internal state of the program is still correct and we
don't know what operations can be carried out by the script without
doing damage.

   <p>We could insert in the code a command that tests the error condition in
the same way the <code>assert()</code> C language macro does.  That way when
testing the program we see if some procedures do the wrong things.  This
is not a mechanism to react to the error at runtime, it's just a way to
signal the error to the programmer.

   <p>Ideally when the program is released the assertions should be removed. 
If we choose this way we try to avoid these errors through adequate
testing.

<h5 class="subsubheading">Runtime errors</h5>

<p>We should code the program in such a way that runtime errors are reduced
to errors in the synchronisation with external software entities, like
the file system or another process.  The interface of a module should
make all the other errors become logic errors, or be treated as &ldquo;things
that may happen&rdquo;.  All the runtime errors may be seen as &ldquo;things that
may happen&rdquo;.

   <p>When we need to synchronise two software entities, an error can always
happen.  In such cases we invoke a command and it may return an error
even if the program is 100% correct.

   <p>The only way to deal with such errors is to surround these commands in a
<code>[catch]</code> body.

<!--  -->
<h4 class="subheading">Liveness of the program</h4>

<p>There are cases in which we have to keep the program running anyway, so
we can't just print an error message and exit.  This is a problem, but
also a possibility.  With C language programs we can't just &ldquo;try to go
on&rdquo; as reaction to many errors (like uninitialised pointers), but with
scripting languages like <acronym>TCL</acronym> we can.

   <p>In this case the assertion procedures should not abort the program, they
should just return an error condition.

   <p>The <acronym>TCL</acronym> interpreter sets the <code>::errorCode</code> variable to the empty
string when a syntax error is detected or an invalid parameter is used;
so we can choose to leave it empty for all the errors that are detected
by our code and should be catched only in the case that we have to keep
the script alive.  All the other errors that we signal have to be
associated to a value in the global variable.

   <p>After a logic error we can't be sure that the internal state of the
program is still correct; so if we have to keep the program alive we
have to isolate as much as possible the environment in which the
operation is performed.  Creating multiple interpreters is a
possibility: when the operation begins, we create a new interpreter and
give to it read&ndash;only access to the program state; in case of error we
delete the interpreter and can be reasonably sure that the state of the
program outside of it is safe.

<!-- page -->
<div class="node">
<a name="preprocessor"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#typedef">typedef</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#overview">overview</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">2 Preprocessing <acronym>UTP</acronym> source files</h2>

<p><acronym>UTP</acronym> code is not <acronym>TCL</acronym> code: it has language extensions that must be
processed and converted to valid <acronym>TCL</acronym> code.  A special package is
included and installed with the <acronym>UTP</acronym> distribution, to load it:

<pre class="example">     package require UTP::preprocessor
</pre>
   <p class="noindent">it sets up the <acronym>TCL</acronym> interpreter to process <acronym>UTP</acronym> code and accumulate
and output <acronym>TCL</acronym> code; there are three steps:

     <ol type=1 start=1>
<li>Evaluate the code in the file that sourced the package and accumulate
the result in an internal variable, as intermediate code.

     <li>Filter the intermediate code with regular expressions to remove some
part and expand some other.

     <li>Print the final result to the standard output channel, or save it in a
file.
        </ol>

   <p>The preprocessor is a standalone package: it does not require other
<acronym>UTP</acronym> packages.

<ul class="menu">
<li><a accesskey="1" href="#preprocessor-overview">preprocessor overview</a>:        Overview of preprocessing. 
<li><a accesskey="2" href="#preprocessor-usage">preprocessor usage</a>:           How to use the preprocessor. 
<li><a accesskey="3" href="#preprocessor-commands">preprocessor commands</a>:        What's evaluated by the preprocessor. 
<li><a accesskey="4" href="#preprocessor-expansion">preprocessor expansion</a>:       Processing by regular expressions. 
</ul>

<!-- page -->
<div class="node">
<a name="preprocessor-overview"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#preprocessor-usage">preprocessor usage</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#preprocessor">preprocessor</a>

</div>

<h3 class="section">2.1 Overview of preprocessing</h3>

<p>The purposes of the preprocessor are:

     <ul>
<li>To allow the removal of comments and useless blanks from the script:
comments in the source code are kept in memory by the <acronym>TCL</acronym>
interpreter, so it's useful to have a way do discard them from the final
distributed package.

     <p>A drawback of this is that line numbers in error messages from processed
code, are different from the ones in the source code.

     <li>To allow the automatic construction of pieces of source code: after the
preprocessor package has been loaded in a <acronym>TCL</acronym> interpreter, only a
subset of the ordinary <acronym>TCL</acronym> commands will produce commands in the
output: <code>[proc]</code>, <code>[namespace]</code>, <code>[package]</code>; the other
<acronym>TCL</acronym> code is evaluated in the context of the preprocessor and can be
used to build code.

     <li>To allow the definition and usage of typed procedure parameters and
aggregate data types (C language like structures). 
</ul>

   <p>The philosophy of <acronym>UTP</acronym> preprocessing is to accept automatically
generated code duplication in different processed modules, to enhance
the production of independent code:

     <ul>
<li>If a module does not use the <acronym>UTP</acronym> data types and procedures, after
processing it can be used without loading the <acronym>UTP</acronym> package.

     <li>If a module only uses <acronym>UTP</acronym> data types but no procedures, it can be
used by in a program with direct inclusion of the file <samp><span class="file">types.tcl</span></samp>
from the <acronym>UTP</acronym> distribution. 
</ul>

<!--  -->
<h5 class="subsubheading">A note on comments removal</h5>

<p>It is done with regular expressions: the <code>#</code> characters at the
beginning of lines are identified and removed; it is not possible to
distinguish between comment delimiters and &ldquo;data characters&rdquo;, so we
have to be careful to quote with a backslash <code>\</code> all the <code>#</code>
characters that begin a line and that must be left in the code.

<!--  -->
<h5 class="subsubheading">A note on blanks removal</h5>

<p>It is done with regular expressions; all the blank lines and the blank
characters at the beginning of lines are removed: if we want to keep a
blank we have to quote the first character of the line with a backslash.

<!-- page -->
<div class="node">
<a name="preprocessor-usage"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#preprocessor-commands">preprocessor commands</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#preprocessor-overview">preprocessor overview</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#preprocessor">preprocessor</a>

</div>

<h3 class="section">2.2 How to use the preprocessor</h3>

<p>By convention a <acronym>UTP</acronym> source file should have the <code>.utp</code> file
extension; an example of <acronym>UTP</acronym> source follows:

<pre class="example">     # example.utp --
     
     package require UTP::preprocessor 1
     package require Tcl 8.4
     package require needed 2.4
     package provide mine 1.3
     
     proc my { } { ... }
     proc yours { } { ... }
     proc our { } { ... }
     proc their { } { ... }
     
     ### end of file
</pre>
   <p class="noindent">all the code before the line:

<pre class="example">     package require UTP::preprocessor 1
</pre>
   <p class="noindent">is processed according to the ordinary <acronym>TCL</acronym> rules; all the code after
that line is processed according to the preprocessor rules.

   <p>If we need to load a package to use it to produce some code in the
preprocessor context, we have to do it before loading the preprocessor
package:

<pre class="example">     package require my_preprocessor
     package require UTP::preprocessor 1
</pre>
   <p class="noindent">all the procedure and global variable names of the preprocessor are
prefixed with the string <code>utp_preprocessor</code>; all the special
commands are prefixed with <code>utp_</code>.

   <p>The preprocessor package file contains its own line of the form:

<pre class="example">     package require Tcl ...
</pre>
   <!--  -->
<h5 class="subsubheading">Processing a file from the command line</h5>

<p>To process the <samp><span class="file">example.utp</span></samp> file we can do this from the prompt of
a shell:

<pre class="example">     $ tclsh example.utp &gt;example.tcl
</pre>
   <p class="noindent">or:

<pre class="example">     $ tclsh example.utp --output=example.tcl
</pre>
   <p class="noindent"><samp><span class="command">tclsh</span></samp> puts all the command line parameters after the source
file name into the <code>argv</code> global variable, and they are processed
by the preprocessor upon the <code>[package require]</code> command
execution, unless previously evaluated code resets the <acronym>TCL</acronym> built in
<code>argv</code> global variable.

   <p>If one feels the need to do so: it is possible to put arguments directly
in the <code>argv</code> variable in the file:

<pre class="example">     set argv { --output=example.tcl }
     package require UTP::preprocessor 1
</pre>
   <!--  -->
<h5 class="subsubheading">Selecting path to packages</h5>

<p>It is possible to select the path to the preprocessor file:

<pre class="example">     $ TCLLIBPATH=/path/to/preprocessor tclsh example.utp &gt;example.tcl
</pre>
   <p class="noindent">a regular <samp><span class="file">pkgIndex.tcl</span></samp> file must be present in
<samp><span class="file">/path/to/preprocessor</span></samp>.  <samp><span class="command">tclsh</span></samp> will prepend the contents
of <samp><span class="env">TCLLIBPATH</span></samp> to the default value of the <code>auto_path</code> built
in global variable (see the <code>[pkg_mkIndex]</code> manual page in the
<acronym>TCL</acronym> distribution).

<!--  -->
<h5 class="subsubheading">Processing a file from a Makefile</h5>

<p>The following works with <acronym>GNU</acronym> Make (preprocessed by <acronym>GNU</acronym> Autoconf):

<pre class="example">     TCLSH           = @TCLSH@
     PP_ENV          = TCLLIBPATH=/path/to/preprocessor
     PREPROCESS      = $(PP_ENV) $(TCLSH)
     
     vpath   %.utp   /path/to/sources
     
     %.tcl: %.utp
             $(PREPROCESS) $(&lt;) --output=$(@)
</pre>
   <p>If <acronym>UTP</acronym> is installed in a standard location on the system one can
avoid setting the <samp><span class="env">TCLLIBPATH</span></samp> variable.

<!--  -->
<h5 class="subsubheading">Command line options</h5>

<p>The synopsis of source evaluation is:

<pre class="example">     tclsh INFILE OTHERFILE ... [options] &gt;OUTFILE
     tclsh INFILE OTHERFILE ... [options] --output=OUTFILE
</pre>
   <p class="noindent">the <code>INFILE</code> argument is the main source file, all the
<code>OTHERFILE</code> files are sourced (with <code>[source]</code>) upon
preprocessor package loading (so before the code in <code>INFILE</code> is
evaluated).

   <p>The following specific command line options are supported:

     <dl>
<dt><code>--output=FILE</code><dd>Selects <code>FILE</code> as output file, instead of writing to standard
output; if <code>FILE</code> equals <code>-</code>: writes to standard output;

     <br><dt><code>--add-preamble</code><dd>Prepends to the output a line of the form:

     <pre class="example">          set preamble [format "\#!%s\n" [info nameofexecutable]]
</pre>
     <br><dt><code>--directory=DIR</code><dd>Appends <code>DIR</code> to the <code>auto_path</code> global variable.

     <br><dt><code>--verbose</code><dd>Enables verbose messages.

     <br><dt><code>--expand-accessors</code><dt><code>--dont-expand-accessors</code><dd>Enables or disables the expansion of structure accessors.

     <br><dt><code>--drop-comments</code><dt><code>--dont-drop-comments</code><dd>Enables or disables the removal of comments.

     <br><dt><code>--drop-blanks</code><dt><code>--dont-drop-blanks</code><dd>Enables or disables the removal of blank lines.

     <br><dt><code>--evaluate</code><dd>Evaluates the output in a not safe subinterpreter; the preprocessor does
not output anything.

     <br><dt><code>--with-enter-trace</code><dt><code>--without-enter-trace</code><dd>Enables or disables usage of execution traces to validate procedure
arguments; the default is to disable (the fastest). 
</dl>

<!-- page -->
<div class="node">
<a name="preprocessor-commands"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#preprocessor-expansion">preprocessor expansion</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#preprocessor-usage">preprocessor usage</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#preprocessor">preprocessor</a>

</div>

<h3 class="section">2.3 What's evaluated by the preprocessor</h3>

<p>After the preprocessor package has been evaluated in an interpreter: the
only <acronym>TCL</acronym> built in commands at the global level that are sent
unchanged (with all the arguments) to the output file are:
<code>[package]</code>, <code>[namespace]</code>.  All the other commands are
evaluated in the context of the preprocessor.

   <p>The <code>[package]</code> command takes its arguments and appends itself to
the output file, so it's impossible to load packages in the context of
the preprocessor after the line:

<pre class="example">     package require UTP::preprocessor
</pre>
   <p class="noindent">has been evaluated.  However, the <code>[source]</code> command and the
<code>env</code> global variable are available to include and evaluate
files.

<ul class="menu">
<li><a accesskey="1" href="#preprocessor-commands-special">preprocessor commands special</a>
<li><a accesskey="2" href="#preprocessor-commands-types">preprocessor commands types</a>
<li><a accesskey="3" href="#preprocessor-commands-procedures">preprocessor commands procedures</a>
<li><a accesskey="4" href="#preprocessor-commands-struct">preprocessor commands struct</a>
</ul>

<!-- page -->
<div class="node">
<a name="preprocessor-commands-special"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#preprocessor-commands-types">preprocessor commands types</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#preprocessor-commands">preprocessor commands</a>

</div>

<h4 class="subsection">2.3.1 Some special commands</h4>

<p>The following is the list of special commands provided by the
preprocessor.

<div class="defun">
&mdash; Proc: <b>utp_verbatim</b><var> string<a name="index-utp_005fverbatim-1"></a></var><br>
<blockquote><p>Includes <var>string</var> as is in the output file.  Remember that placing
commands in the global namespace is often a bad idea.  Beyond the
obvious usage of this (to declare global variables) it's possible to
include in that way a preamble of the file: a comment with the copyright
notice, etc. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_verb</b><var> ARG <small class="dots">...</small><a name="index-utp_005fverb-2"></a></var><br>
<blockquote><p>Like <code>[utp_verbatim]</code> but appends all the arguments (by
stringyfying the <code>args</code> argument). 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_macro</b><var> name args body<a name="index-utp_005fmacro-3"></a></var><br>
<blockquote><p>This is the real <code>[proc]</code> command: it creates a procedure in the
preprocessor context, that can be used to automatically generate code. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_include</b><var> file file <small class="dots">...</small><a name="index-utp_005finclude-4"></a></var><br>
<blockquote><p>Load each of the selected files and append their content to the output,
as is. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_maybe_main</b><var><a name="index-utp_005fmaybe_005fmain-5"></a></var><br>
<blockquote><p>Append <code>utp_maybe_main</code> to the output (see <a href="#main">main</a> for details). 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_alias</b><var> alias true <small class="dots">...</small><a name="index-utp_005falias-6"></a></var><br>
<blockquote><p>A short wrapper for <code>[interp alias]</code>, append to the output the
alias definition; it is equivalent to:

     <pre class="example">          interp alias {} <var>alias</var> {} <var>true</var> ...
</pre>
        </blockquote></div>

<!-- page -->
<div class="node">
<a name="preprocessor-commands-types"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#preprocessor-commands-procedures">preprocessor commands procedures</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#preprocessor-commands-special">preprocessor commands special</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#preprocessor-commands">preprocessor commands</a>

</div>

<h4 class="subsection">2.3.2 Types definition</h4>

<p class="noindent">Types definition is explained in detail in another chapter
(see <a href="#typedef">typedef</a>).

<div class="defun">
&mdash; Proc: <b>utp_typedef</b><var> name expression<a name="index-utp_005ftypedef-7"></a></var><br>
<blockquote><p>Declares a new data type called <var>name</var>; the string <var>name</var> must
end with the characters <code>_t</code> (this may be seen as a useless
restriction, but you have the code).

        <p><var>expression</var> is an expression for <code>[expr]</code> that references the
variable <code>value</code> (and no other automatic variable) and evaluates to
<strong>false</strong> if its value is correct for the type. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="preprocessor-commands-procedures"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#preprocessor-commands-struct">preprocessor commands struct</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#preprocessor-commands-types">preprocessor commands types</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#preprocessor-commands">preprocessor commands</a>

</div>

<h4 class="subsection">2.3.3 Typed procedures</h4>

<h5 class="subsubheading">Typed arguments</h5>

<p>Types are used to add parameter validation to procedures; there are two
ways to do this: with and without execution traces (see the
<code>[trace]</code> manual page in the <acronym>TCL</acronym> distribution and
<a href="#preprocessor-usage">preprocessor usage</a> for the <samp><span class="option">--with-enter-trace</span></samp> command
line option).  The default is to do it without the execution traces,
which is faster.

<div class="defun">
&mdash; Proc: <b>proc</b><var> name args body<a name="index-proc-8"></a></var><br>
<blockquote><p>Creates a procedure in the output file.  Basically, it is the same as
the default <code>[proc]</code>, the only difference is special handling of
the arguments list.

        <p>If an element in <var>args</var> ends with the chars <code>_t</code> or <code>_l</code>,
it is treated as a type name for the next parameter; a procedure with
this name is invoked first in the procedure body. 
</p></blockquote></div>

   <p>For example, the following procedure declaration:

<pre class="example">     proc func { a b c } {
         ...
     }
</pre>
   <p class="noindent">is appended as is to the output.  Without execution traces: the
following procedure declaration:

<pre class="example">     proc func { one_t a two_t b c } {
         ...
     }
</pre>
   <p class="noindent">produces the output:

<pre class="example">     proc func { a b c } {
         one_t_variable_is a
         two_t_variable_is b
         ...
     }
</pre>
   <p class="noindent">and the following:

<pre class="example">     proc func { one_t a two_t {b 1} } {
         ...
     }
</pre>
   <p class="noindent">produces the output:

<pre class="example">     proc func { a {b 1} } {
         one_t_variable_is a
         two_t_variable_is b
         ...
     }
</pre>
   <p>The script must define somewhere the <code>one_t</code> and <code>two_t</code>
data types; the type definition is not required at the time of the
<code>[proc]</code> command evaluation.

   <p>Notice that these transformations change the line number of commands in
the procedure, and this will show when error messages are displayed.

   <p>With execution traces: the following procedure declaration:

<pre class="example">     proc func { one_t a two_t b c } {
         ...
     }
</pre>
   <p class="noindent">produces the output:

<pre class="example">     proc func { a b c } {
         ...
     }
     proc utp_T_func { string op } {
         foreach {command a b c} $string {
             one_t_variable_is a
             two_t_variable_is b
             break
         }
     }
     trace add execution func enter utp_T_enter_func
</pre>
   <p class="noindent">notice that the original procedure body is left unchanged, so the line
numbers in error messages will be correct.  The cost of trace invocation
will slow down the execution.

<!--  -->
<h5 class="subsubheading">Typed return values</h5>

<p>It is done by the preprocessor using the <code>[unknown]</code> mechanism (see
the <code>[unknown]</code> manual page in the <acronym>TCL</acronym> distribution) and
execution traces.

   <p>Whenever an undefined command is found at the top execution level if the
command ends with the characters <code>_t</code> or <code>_l</code>, it is treated
as the type declaration for a procedure return value.

   <p>Examples: the following declaration:

<pre class="example">     utp_integer_t func { a b c } {
         ...
     }
</pre>
   <p class="noindent">expands to:

<pre class="example">     proc func { a b c } {
         ...
     }
     proc utp_return_value_func { string code retval op } {
         if { !$code } {
             utp_integer_t_value_is $retval
         }
     }
     trace add execution func leave utp_return_value_func
</pre>
   <p>The procedure declaration is handed to the <code>[proc]</code> preprocessor
command, so the typed parameters are processed as described above.

<!-- page -->
<div class="node">
<a name="preprocessor-commands-struct"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#preprocessor-commands-procedures">preprocessor commands procedures</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#preprocessor-commands">preprocessor commands</a>

</div>

<h4 class="subsection">2.3.4 Structure definition</h4>

<p>The definition of aggregate data types (structures) is explained in
detail in another chapter (see <a href="#struct">struct</a>).

<div class="defun">
&mdash; Proc: <b>utp_struct</b><var> name body<a name="index-utp_005fstruct-9"></a></var><br>
<blockquote><p>Define a new aggregate data type named <var>name</var>; the string <var>name</var>
must end with the chars <code>_t</code>. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="preprocessor-expansion"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#preprocessor-commands">preprocessor commands</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#preprocessor">preprocessor</a>

</div>

<h3 class="section">2.4 Processing by regular expressions</h3>

<p>A special substitution is done on tokens prefixed with a double dollar
sign <code>$$</code>:

<pre class="example">     $$self.red.green
</pre>
   <p class="noindent">becomes:

<pre class="example">     [set $self.red.green]
</pre>
   <p class="noindent">this is convenient when reading values of data structure fields
(see <a href="#struct">struct</a>).

   <p>It is possible to use the curly braces to group a variable name, the
following:

<pre class="example">     $${self.red}.green
</pre>
   <p class="noindent">becomes:

<pre class="example">     [set $self.red].green
</pre>
   <p><strong>Warning</strong>: at present the double dollar substitution
implementation is only &ldquo;good enough&rdquo;: it will parse correctly the
following tokens:

<pre class="example">     $$self.a(wo)
     $$self.a($wo)
     $$self.a($wo:wa)
     $$self.a($wo:$wa)
</pre>
   <p class="noindent">but not the following:

<pre class="example">     $$self.a($wo(wa))
</pre>
   <p class="noindent">because there are nested parentheses.

<!-- page -->
<div class="node">
<a name="typedef"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#struct">struct</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#preprocessor">preprocessor</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">3 Declaring data types</h2>

<p><acronym>UTP</acronym> adds type checking to <acronym>TCL</acronym> for procedure parameters and return
values, simple and aggregate variables.  A set of types is predefined in
the <samp><span class="file">types.utp</span></samp> module of the distribution.

<ul class="menu">
<li><a accesskey="1" href="#typedef-overview">typedef overview</a>:             Overview of the type system. 
<li><a accesskey="2" href="#typedef-string">typedef string</a>:               String based types. 
<li><a accesskey="3" href="#typedef-objects">typedef objects</a>:              <acronym>TCL</acronym> objects types. 
<li><a accesskey="4" href="#typedef-number">typedef number</a>:               Number base types. 
<li><a accesskey="5" href="#typedef-misc">typedef misc</a>:                 Miscellaneous values. 
</ul>

<!-- page -->
<div class="node">
<a name="typedef-overview"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#typedef-string">typedef string</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#typedef">typedef</a>

</div>

<h3 class="section">3.1 Overview of the type system</h3>

<p>The procedure <code>[utp_typedef]</code> is evaluated by the preprocessor.

<div class="defun">
&mdash; Proc: <b>utp_typedef</b><var> name expression<a name="index-utp_005ftypedef-10"></a></var><br>
<blockquote><p>Declare a new data type called <var>name</var>; the string <var>name</var> must
end with the characters <code>_t</code> (this may be seen as a useless
restriction, but you have the code).

        <p><var>expression</var> is an expression for <code>[expr]</code> that references the
variable <code>value</code> (and no other automatic variable) and evaluates to
<strong>false</strong> if its value is correct for the type. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Implementation</h5>

<p>All the type procedures declare and initialise a typed variable; the
validation is done with variable traces.  For example, the following
command declares an integer variable named <code>i</code> and initialises it
to 123:

<pre class="example">     utp_integer_t i 123
</pre>
   <p class="noindent">the following command validates a value as integer:

<pre class="example">     set i 123
     utp_integer_t_value_is $i
</pre>
   <p class="noindent">the following command validates the value of a variable:

<pre class="example">     set i 123
     utp_integer_t_variable_is i
</pre>
   <p>If we define a type <code>name_t</code> using the following command:

<pre class="example">     utp_typedef_t name_t <var>some-expression</var>
</pre>
   <p class="noindent">the following procedures are defined.

<div class="defun">
&mdash; Proc: <b>name_t</b><var> variable_name ?value?<a name="index-name_005ft-11"></a></var><br>
<blockquote><p>Declare and initialise <var>variable_name</var> as of type <code>name_t</code>,
which must have been the first argument to a previous call to
<code>[utp_typedef]</code>.  <var>value</var> is an optional argument used to
initialise the variable; if not used it defaults to the empty
string/list, <strong>overwriting the old value</strong>, if any. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>name_t_value_is</b><var> value<a name="index-name_005ft_005fvalue_005fis-12"></a></var><br>
<blockquote><p>Return an error if <var>value</var> is not of type <code>name_t</code>, which must
have been the first argument to a previous call to <code>[utp_typedef]</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>name_t_variable_is</b><var> variable_name<a name="index-name_005ft_005fvariable_005fis-13"></a></var><br>
<blockquote><p>Return an error if the value of <var>variable_name</var> is not of type
<code>name_t</code>, which must have been the first argument to a previous
call to <code>[utp_typedef]</code>. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Lists of values</h5>

<p>With the exception of <code>utp_array_t</code>: types declared by
<code>utp_typedef</code> are associated to another type used to validate lists
of values; the list type is constructed from the value type by
substituting <code>_t</code> with <code>_l</code>, example:

<pre class="example">     utp_integer_t -&gt; utp_integer_l
</pre>
   <p>The list types have a set of procedures identical to the one of the
value types.

<!--  -->
<h5 class="subsubheading">Procedure parameters and return values</h5>

<p>The arguments are validated by invoking the <code>*_variable_is</code>
procedure and the return values by invoking the <code>*_value_is</code> one,
but in the declaration of the procedure we use the <code>*_t</code> string:

<pre class="example">     utp_integer_t max { utp_integer_t a utp_integer_t b } {
         expr { ($a &gt; $b)? $a : $b }
     }
</pre>
   <!-- page -->
<div class="node">
<a name="typedef-string"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#typedef-objects">typedef objects</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#typedef-overview">typedef overview</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#typedef">typedef</a>

</div>

<h3 class="section">3.2 String based types</h3>

<p>A type definition is implemented for all the classes of the
<code>[string is ...]</code> <acronym>TCL</acronym> built in.

<div class="defun">
&mdash; UTP type: <b>utp_alnum_t</b><var><a name="index-utp_005falnum_005ft-14"></a></var><br>
&mdash; UTP type: <b>utp_alpha_t</b><var><a name="index-utp_005falpha_005ft-15"></a></var><br>
&mdash; UTP type: <b>utp_ascii_t</b><var><a name="index-utp_005fascii_005ft-16"></a></var><br>
&mdash; UTP type: <b>utp_boolean_t</b><var><a name="index-utp_005fboolean_005ft-17"></a></var><br>
&mdash; UTP type: <b>utp_control_t</b><var><a name="index-utp_005fcontrol_005ft-18"></a></var><br>
&mdash; UTP type: <b>utp_digit_t</b><var><a name="index-utp_005fdigit_005ft-19"></a></var><br>
&mdash; UTP type: <b>utp_double_t</b><var><a name="index-utp_005fdouble_005ft-20"></a></var><br>
&mdash; UTP type: <b>utp_graph_t</b><var><a name="index-utp_005fgraph_005ft-21"></a></var><br>
&mdash; UTP type: <b>utp_integer_t</b><var><a name="index-utp_005finteger_005ft-22"></a></var><br>
&mdash; UTP type: <b>utp_lower_t</b><var><a name="index-utp_005flower_005ft-23"></a></var><br>
&mdash; UTP type: <b>utp_upper_t</b><var><a name="index-utp_005fupper_005ft-24"></a></var><br>
&mdash; UTP type: <b>utp_wordchar_t</b><var><a name="index-utp_005fwordchar_005ft-25"></a></var><br>
&mdash; UTP type: <b>utp_xdigit_t</b><var><a name="index-utp_005fxdigit_005ft-26"></a></var><br>
<blockquote><p>Types of the <code>string is</code> class, using the <code>-strict</code> option. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_zalnum_t</b><var><a name="index-utp_005fzalnum_005ft-27"></a></var><br>
&mdash; UTP type: <b>utp_zalpha_t</b><var><a name="index-utp_005fzalpha_005ft-28"></a></var><br>
&mdash; UTP type: <b>utp_zascii_t</b><var><a name="index-utp_005fzascii_005ft-29"></a></var><br>
&mdash; UTP type: <b>utp_zboolean_t</b><var><a name="index-utp_005fzboolean_005ft-30"></a></var><br>
&mdash; UTP type: <b>utp_zcontrol_t</b><var><a name="index-utp_005fzcontrol_005ft-31"></a></var><br>
&mdash; UTP type: <b>utp_zdigit_t</b><var><a name="index-utp_005fzdigit_005ft-32"></a></var><br>
&mdash; UTP type: <b>utp_zdouble_t</b><var><a name="index-utp_005fzdouble_005ft-33"></a></var><br>
&mdash; UTP type: <b>utp_zgraph_t</b><var><a name="index-utp_005fzgraph_005ft-34"></a></var><br>
&mdash; UTP type: <b>utp_zinteger_t</b><var><a name="index-utp_005fzinteger_005ft-35"></a></var><br>
&mdash; UTP type: <b>utp_zlower_t</b><var><a name="index-utp_005fzlower_005ft-36"></a></var><br>
&mdash; UTP type: <b>utp_zupper_t</b><var><a name="index-utp_005fzupper_005ft-37"></a></var><br>
&mdash; UTP type: <b>utp_zwordchar_t</b><var><a name="index-utp_005fzwordchar_005ft-38"></a></var><br>
&mdash; UTP type: <b>utp_zxdigit_t</b><var><a name="index-utp_005fzxdigit_005ft-39"></a></var><br>
<blockquote><p>Types of the <code>string is</code> class, without the <code>-strict</code> option. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_int_t</b><var><a name="index-utp_005fint_005ft-40"></a></var><br>
<blockquote><p>An alias for <code>utp_integer_t</code>. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="typedef-objects"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#typedef-number">typedef number</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#typedef-string">typedef string</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#typedef">typedef</a>

</div>

<h3 class="section">3.3 <acronym>TCL</acronym> object types</h3>

<p>The following procedures declare and initialise a typed variable.

<div class="defun">
&mdash; UTP type: <b>utp_any_t</b><var><a name="index-utp_005fany_005ft-41"></a></var><br>
&mdash; UTP type: <b>utp_string_t</b><var><a name="index-utp_005fstring_005ft-42"></a></var><br>
&mdash; UTP type: <b>utp_list_t</b><var><a name="index-utp_005flist_005ft-43"></a></var><br>
<blockquote><p>Any value. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_array_t</b><var><a name="index-utp_005farray_005ft-44"></a></var><br>
<blockquote><p>Array variable. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_channel_t</b><var><a name="index-utp_005fchannel_005ft-45"></a></var><br>
<blockquote><p><acronym>TCL</acronym> channel. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_script_t</b><var><a name="index-utp_005fscript_005ft-46"></a></var><br>
<blockquote><p>A complete script: the validation is performed with <code>[info
complete]</code>; a script can be the empty string. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_reference_t</b><var><a name="index-utp_005freference_005ft-47"></a></var><br>
<blockquote><p>A global variable name. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_proc_t</b><var><a name="index-utp_005fproc_005ft-48"></a></var><br>
<blockquote><p>A procedure name; the test is done with <code>[info procs]</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_interp_t</b><var><a name="index-utp_005finterp_005ft-49"></a></var><br>
<blockquote><p>A <acronym>TCL</acronym> interpreter name. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="typedef-number"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#typedef-misc">typedef misc</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#typedef-objects">typedef objects</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#typedef">typedef</a>

</div>

<h3 class="section">3.4 Number based types</h3>

<p>The following procedures declare and initialise a typed variable.

<div class="defun">
&mdash; UTP type: <b>utp_positive_t</b><var><a name="index-utp_005fpositive_005ft-50"></a></var><br>
<blockquote><p>A strictly positive number. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_negative_t</b><var><a name="index-utp_005fnegative_005ft-51"></a></var><br>
<blockquote><p>A strictly negative number. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_pinteger_t</b><var><a name="index-utp_005fpinteger_005ft-52"></a></var><br>
&mdash; UTP type: <b>utp_pint_t</b><var><a name="index-utp_005fpint_005ft-53"></a></var><br>
<blockquote><p>A strictly positive integer. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_pzinteger_t</b><var><a name="index-utp_005fpzinteger_005ft-54"></a></var><br>
&mdash; UTP type: <b>utp_pzint_t</b><var><a name="index-utp_005fpzint_005ft-55"></a></var><br>
&mdash; UTP type: <b>utp_unsigned_t</b><var><a name="index-utp_005funsigned_005ft-56"></a></var><br>
<blockquote><p>A positive integer or zero. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_ninteger_t</b><var><a name="index-utp_005fninteger_005ft-57"></a></var><br>
&mdash; UTP type: <b>utp_zint_t</b><var><a name="index-utp_005fzint_005ft-58"></a></var><br>
<blockquote><p>A strictly negative integer. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_nzinteger_t</b><var><a name="index-utp_005fnzinteger_005ft-59"></a></var><br>
&mdash; UTP type: <b>utp_nzint_t</b><var><a name="index-utp_005fnzint_005ft-60"></a></var><br>
<blockquote><p>A negative integer or zero. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_pdouble_t</b><var><a name="index-utp_005fpdouble_005ft-61"></a></var><br>
<blockquote><p>A strictly positive double. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_pzdouble_t</b><var><a name="index-utp_005fpzdouble_005ft-62"></a></var><br>
<blockquote><p>A positive double or zero. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_ndouble_t</b><var><a name="index-utp_005fndouble_005ft-63"></a></var><br>
<blockquote><p>A strictly negative double. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_nzdouble_t</b><var><a name="index-utp_005fnzdouble_005ft-64"></a></var><br>
<blockquote><p>A negative double or zero. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="typedef-misc"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#typedef-number">typedef number</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#typedef">typedef</a>

</div>

<h3 class="section">3.5 Miscellaneous values</h3>

<p>The following procedures declare and initialise a typed variable.

<div class="defun">
&mdash; UTP type: <b>utp_program_t</b><var><a name="index-utp_005fprogram_005ft-65"></a></var><br>
<blockquote><p>An executable file, found with <code>[auto_execok]</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_fraction_t</b><var><a name="index-utp_005ffraction_005ft-66"></a></var><br>
<blockquote><p>A double value between zero and one, inclusive. 
</p></blockquote></div>

<div class="defun">
&mdash; UTP type: <b>utp_range_t</b><var><a name="index-utp_005frange_005ft-67"></a></var><br>
<blockquote><p>A list of two doubles. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="struct"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#token">token</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#typedef">typedef</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">4 Declaring structures</h2>

<!-- A structure type is ``defined'', a structure instance is ``declared''. -->
<p><acronym>UTP</acronym> structures are similar to <acronym>GNU</acronym> Octave structures, although they
were developed independently; a number of people implemented structures
in the same way, some of them have written about it at the <acronym>TCL</acronym>'ers
Wiki<a rel="footnote" href="#fn-1" name="fnd-1"><sup>1</sup></a>, but no code in <acronym>UTP</acronym> comes
from the Wiki (with the exception of code written from the <acronym>UTP</acronym>
author).

<ul class="menu">
<li><a accesskey="1" href="#struct-vars">struct vars</a>:                  Structure variables. 
<li><a accesskey="2" href="#struct-usage">struct usage</a>:                 Using <acronym>UTP</acronym> structures. 
<li><a accesskey="3" href="#struct-procs">struct procs</a>:                 Defining and declaring structures. 
</ul>

<!-- page -->
<div class="node">
<a name="struct-vars"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#struct-usage">struct usage</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#struct">struct</a>

</div>

<h3 class="section">4.1 Structure variables</h3>

<p>A structure instance is identified by a fully qualified variable name:
the &ldquo;token&rdquo;; the structure itself is a set of variables: one has name
equal to the token; the other have names equal to the token with a dot
and a field name appended.

   <p>For example, let's say that a structure type exists with field names
<code>a</code>, <code>b</code>, <code>c</code>; <code>a</code> and <code>b</code> are defined as
variables, while <code>c</code> is defined as nested structure.

     <ul>
<li>The main variable could be <code>::123</code>; the value of this variable is
reserved.

     <li>For each field defined as variable: a global variable is created:
<code>::123.a</code>, <code>::123.b</code>; the value of these variables is the
value of the field; if the field is defined as array, the variable is an
array.

     <li>For each field defined as nested structure: a global variable is
created: <code>::123.c</code>; the value of this variable is reserved.

     <li>The fields of the nested structure are implemented as global variables
with names such as: <code>::123.c.d</code>. 
</ul>

   <p>Structures can be nested at will.

   <p>A trace is registered for the structure variable so that, when it is
unset, some cleanup is done: all the global variables associated to the
structure are removed from the interpreter.

   <p>One may see this as a clumsy design, but the whole code for it is really
small.

<!-- page -->
<div class="node">
<a name="struct-usage"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#struct-procs">struct procs</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#struct-vars">struct vars</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#struct">struct</a>

</div>

<h3 class="section">4.2 Using <acronym>UTP</acronym> structures</h3>

<p>Variable names in dollar indirection, in <acronym>TCL</acronym>, cannot contain dot
characters, unless the whole name is quoted inside braces:

<pre class="example">     set a 1
     set a.b 2
     puts $a.b   ; # prints '1.b'
     puts ${a.b} ; # prints '2'
</pre>
   <p class="noindent">this allows us to build names for <acronym>TK</acronym> widgets with code like:

<pre class="example">     set w $toplevel.$frame.$entry
</pre>
   <p class="noindent">the same trick is used to build <acronym>UTP</acronym> structure field names.  If the
main variable of an <acronym>UTP</acronym> structure is stored in a variable named
<code>self</code>:

<pre class="example">     set self ::123
</pre>
   <p class="noindent">the following two lines are equivalent:

<pre class="example">     set ::123.a "this is a string"
     set $self.a "this is a string"
</pre>
   <p class="noindent">both of them set a string value inside the structure field <code>a</code>;
the field value can be retrieved with:

<pre class="example">     set value [set $self.a]
</pre>
   <p>If the field is defined as array:

<pre class="example">     set $self.a(fruit) apple
     set fruit [set $self.a(fruit)]
</pre>
   <p class="noindent">if the field is in a nested structure:

<pre class="example">     set $self.c.d 123
     set value [set $self.a.d]
</pre>
   <p class="noindent">if the main variable is used as procedure argument:

<pre class="example">     proc something { self value } {
         set $self.a $value
         puts [format "new value for 'a': %s" [set $self.a]]
     }
     something $self
</pre>
   <p>There is absolutely no problem in linking a structure field to a local
variable:

<pre class="example">     proc something { self } {
         upvar    $self.a.b.c.d.e.f.g g
         ...
     }
</pre>
   <p>Setting new values in fields has a nice syntax; that is not true for
retrieving the value from a field.  That is why the <acronym>UTP</acronym> preprocessor
scans the code looking for field retrieval requests and processes them
(see <a href="#preprocessor-expansion">preprocessor expansion</a>).  The preprocessor interprets double
dollar signs <code>$$</code> as a double indirection operator, so:

<pre class="example">     set value $$self.a
</pre>
   <p class="noindent">is converted to:

<pre class="example">     set value [set $self.a]
</pre>
   <!-- page -->
<div class="node">
<a name="struct-procs"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#struct-usage">struct usage</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#struct">struct</a>

</div>

<h3 class="section">4.3 Defining and declaring structures</h3>

<p>A preprocessor command is used to define new structure types.

<div class="defun">
&mdash; Proc: <b>utp_struct</b><var> name body<a name="index-utp_005fstruct-68"></a></var><br>
<blockquote><p>Define a new aggregate data type named <var>name</var>; the string <var>name</var>
must end with the chars <code>_t</code>. 
</p></blockquote></div>

   <p>The definition is expanded in a set of procedures used to declare
instances and validate values as structure main variables.  Example:

<pre class="example">     utp_struct colors_t {
         utp_integer_t   green       23
         utp_integer_t   white       45
         utp_integer_t   red         67
     }
</pre>
   <!--  -->
<h5 class="subsubheading">Declaring a structure</h5>

<p>Two procedures are declared with the purpose of declaring new instances:
one has the same name as the structure type (<code>colors_t</code> in the
example) and it requires a fully qualified variable name as argument:

<pre class="example">     color_t ::a
     puts $::a.green     ; # prints 23
     set  ::a.white 250
</pre>
   <p class="noindent">the other has a star appended and it automatically creates a variable:

<pre class="example">     colors_t* self
     
     puts $$self.green     ; # prints 23
     set  $self.white 250
     
     puts $self            ; # prints the main variable,
                           ; # a fully qualified name
</pre>
   <p>It is possible to instantiate multiple structures with a single command:

<pre class="example">     colors_t* one two three
</pre>
   <!--  -->
<h5 class="subsubheading">Body of structure definition</h5>

<p>It is correct to think of the body of a structure definition as a <acronym>TCL</acronym>
script; each line has two or three elements: a type name, a field name,
an optional default value.  If a default value is not used it defaults
to the empty string; beware that some <acronym>UTP</acronym> data types do not accept
the empty string as value.

<!--  -->
<h5 class="subsubheading">Nesting structures and references</h5>

<p>Nested structures are defined and declared like this:

<pre class="example">     utp_struct inner_t {
         utp_double_t number
     }
     utp_struct outer_t {
         inner_t   inner
     }
     
     outer_t* self
     set  $self.inner.number 123
     puts $$self.inner.number
</pre>
   <p class="noindent">the type name is used to define the field as structure.

<!--  -->
<h5 class="subsubheading">Type validation</h5>

<p>A structure type is like a type declared with <code>[utp_typedef]</code> in
that it can be used for procedure arguments and return value validation;
example:

<pre class="example">     utp_struct colors_t {
         utp_integer_t   green       23
         utp_integer_t   white       45
         utp_integer_t   red         67
     }
     
     colors_t colors_init { } {
         colors_t* self
         return $self
     }
     proc colors_set_red { colors_t self red } {
         set $self.red $red
     }
     
     set self [colors_init]
     colors_set_red $self 200
</pre>
   <p>Additionally: a special type is created to validate references to
structures: variables that hold the name of the main structure variable. 
The name of the special type is the structure type with <code>&amp;</code>
appended; its main use is as structure field:

<pre class="example">     utp_struct flag_t {
         colors_t&amp;     colors
     }
     
     colors_t* colors
     flag_t*   flag
     
     set $flag.colors $colors
</pre>
   <!--  -->
<h5 class="subsubheading">Struct methods</h5>

<p>A special type specifier is supported: <code>utp_method_t</code>, a field with
this specifier defines a struct method, which is an interpreter alias
which invokes a procedure to the struct's token and additional
arguments.  The following declaration:

<pre class="example">     utp_struct g_t {
         utp_integer_t   a 0
         utp_integer_t   b 1
         utp_method_t    alpha the_alpha
         utp_method_t    beta  the_beta
     }
     
     proc the_alpha { self } {
         set $self.a
     }
     proc the_beta { self p q } {
         expr {$$self.b + $p + $q}
     }
</pre>
   <p class="noindent">can be used as follows:

<pre class="example">     g_t*  S
     puts [$S.alpha]
     puts [$S.beta 2 3]
     unset $S
</pre>
   <p>The specification of a <code>utp_method_t</code> line must have as third
argument an expression evaluating to a procedure name, possibly
qualified with a namespace qualifier.

   <p>Whenever the struct's instance is finalised, the interpreter alias is
removed.

<!--  -->
<h5 class="subsubheading">Finalising structures</h5>

<p>To finalise a structure we just unset its main variable:

<pre class="example">     colors_t* italian_flag
     ...
     unset $italian_flag
</pre>
   <p class="noindent">this triggers a variable trace that unsets the field variables.  Before
the cleanup takes place a finalisation procedure is invoked: a default
version of it is created with empty body, but it can be redefined to do
structure specific finalisation.  The name of the procedure is built by
appending <code>_final</code> to the structure type; for the <code>color_t</code>
type the default finaliser is:

<pre class="example">     proc color_t_final { self } {}
</pre>
   <p>To redefine the finaliser we have to declare the procedure after the
<code>[utp_struct]</code> invocation:

<pre class="example">     utp_struct colors_t {
         utp_integer_t   green       23
         utp_integer_t   white       45
         utp_integer_t   red         67
     }
     
     proc colors_t_final { self } {
         puts "the green level was: $$self.green"
     }
</pre>
   <!--  -->
<h5 class="subsubheading">Handling structures</h5>

<div class="defun">
&mdash; Proc: <b>utp_struct_copy</b><var> src dst<a name="index-utp_005fstruct_005fcopy-69"></a></var><br>
<blockquote><p>Duplicate the values of the fields in the struct <var>src</var> into the
fields of the struct <var>dst</var>.  Both <var>src</var> and <var>dst</var> must be
tokens of structures of the same type (that is: already initialised). 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_struct_duplicate</b><var> src dstvar<a name="index-utp_005fstruct_005fduplicate-70"></a></var><br>
<blockquote><p>Like <code>[utp_struct_copy]</code> but declare a structure of the correct
type and duplicates the fields; the new structure main variable is
stored in the variable <var>dstvar</var>. 
</p></blockquote></div>

   <p>Examples:

<pre class="example">     colors_t* src
     colors_t* dst
     
     utp_struct_copy $src $dst
     utp_struct_duplicate $src other
</pre>
   <!-- page -->
<div class="node">
<a name="token"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#dynamic">dynamic</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#struct">struct</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">5 Managing global symbols to store data</h2>

<p>Usually, in <acronym>TCL</acronym> lexicon, the &ldquo;token&rdquo; is a global variable used by a
module to store data.  It plays the role that, in an object system, is
assigned to the <code>this</code> data structure; <acronym>TCL</acronym> uses this model in
the <code>http</code> package.

<ul class="menu">
<li><a accesskey="1" href="#token-explicit">token explicit</a>:               Using explicit token variables. 
<li><a accesskey="2" href="#token-implicit">token implicit</a>:               Using implicit token variables. 
<li><a accesskey="3" href="#token-map">token map</a>:                    Storing tokens in an associative array. 
</ul>

<!-- page -->
<div class="node">
<a name="token-explicit"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#token-implicit">token implicit</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#token">token</a>

</div>

<h3 class="section">5.1 Using explicit token variables</h3>

<p>With the explicit token model we allocate a global variable to hold
instance specific values:

<pre class="example">     set token [allocate_fully_qualified_unique_tcl_name]
     associate_values_to_token $token
     use_token $token
     destroy_token $token
</pre>
   <p class="noindent">we can see an explicit token in the same way we see a pointer to a
dinamically allocated structure when using the C language.

   <p>A C pointer value (the memory location, not the data stored in memory)
is a number and we could mess with numbers and pointers to do evil; but
we do not do it.  In the same way: a token value is a global <acronym>TCL</acronym>
symbol accessible to every procedure, but we do not want to mess with
it; we just store the token in a variable and hand it to the correct
procedures.

   <p>The drawback of this model is that we have to use the token as parameter
to functions, that is: the script must be organised to share contexts.

<!-- page -->
<div class="node">
<a name="token-implicit"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#token-map">token map</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#token-explicit">token explicit</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#token">token</a>

</div>

<h3 class="section">5.2 Using implicit token variables</h3>

<p>In the implicit token model use a global variable<a rel="footnote" href="#fn-2" name="fnd-2"><sup>2</sup></a>, with a well known name, to
store a token; once the &ldquo;current token&rdquo; is selected: the procedures of
a module access it using <code>[global]</code> or, better, <code>[upvar]</code>;
that way they do not need the token as parameter.

   <p>Example:

<pre class="example">     utp_alias color_access_token    upvar ::color_token self
     utp_alias color_switch_token    set   ::color_token
     
     utp_struct_t colors_t {
         utp_string_t first
         utp_string_t second
         utp_string_t third
     }
     utp_alias color_first        p_color_select first
     utp_alias color_second       p_color_select second
     utp_alias color_third        p_color_select third
     proc p_color_select { field level } {
         color_access_token
         set $self.$field $level
     }
     
     colors_t* italian_flag french_flag
     
     color_switch_token $italian_flag
     color_first  green
     color_second white
     color_third  red
     
     color_switch_token $french_flag
     color_first  blue
     color_second white
     color_third  red
     
     unset $italian_flag $french_flag
</pre>
   <p class="noindent">here the name of the global symbol is <code>color_token</code>, it is
always prefixed with the global namespace qualifier <code>::</code>; the user
code selects a token by storing it in the global symbol and then invokes
the module's methods.

   <p>This model presents <strong>the</strong> disadvantage: we have to remember to
invoke the switch command to select a token before using the module
procedures; notice the following:

     <ul>
<li>This is not a problem with multithreading: in the <acronym>TCL</acronym> apartment
model: each interpreter is associated to one thread, so a token, being a
variable, belongs to one interpreter and cannot be shared between
threads.

     <li>It is unfriendly when we use two instances in the same procedure, we
have to use code like this:

     <pre class="example">          color_switch_token $italian_flag
          color_first green
          color_switch_token $french_flag
          color_second white
          color_switch_token $italian_flag
          color_third red
</pre>
     <p class="noindent">which is ugly.

     <li>Care must be taken when scheduling, in the event loop, a script that
accesses the token: the script must include code to activate the token,
but, while the script is waiting, the token may have been destroyed. 
</ul>

   <p>More insight for the latter consideration: suppose the queue of
scheduled scripts looks like the following:

<pre class="example">      -
     |scheduled script 1
     |
     |   color_switch_token french_flag
     |   color_first blue
      --
      --
     |scheduled script 2
     |
     |   color_switch_token $italian_flag
     |   color_second white
     |   unset $italian_flag
      --
      --
     |scheduled script 3
     |
     |   color_switch_token $italian_flag
      --
</pre>
   <p class="noindent">let's see what happens:

     <ol type=1 start=1>
<li>When script 1 is evaluated: it selects the first token and does
something.

     <li>When script 2 is evaluated: it selects the second token, does something
and then destroys the second token.

     <li>When script 3 is evaluated: it selects the second token, which by this
time is invalid.
        </ol>

   <p>To avoid this situation: we have to associate an event source to the
token, so that when the token is destroyed the event source is also
finalised; if the queued script is executed after the token has been
destroyed the event source module will take care to drop it
(see <a href="#event-source">event source</a>).

   <p>Note that this problem is always present when using &ldquo;asynchronous&rdquo;
data, in this case the token.

<!-- page -->
<div class="node">
<a name="token-map"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#token-implicit">token implicit</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#token">token</a>

</div>

<h3 class="section">5.3 Storing tokens in an associative array</h3>

<p>The following procedures allow a module to organise tokens in a map: the
token is still a variable with a unique global name, but the user of the
module references it with a human usable identifier; the module defines
a namespace of identifiers.

   <p>In some way this is what <acronym>TCL</acronym> does with channel identifiers: the
nicknames <code>stdin</code>, <code>stdout</code> and <code>stderr</code> are references
to internal data structures; when we use them with the channel commands
(<code>[puts]</code>, <code>[read]</code>, etc.) they have a special meaning.

   <p>With this model three modules are involved: the token manager (that is:
the procedures described here); the declaring module; the user
module.

<pre class="example">                  -----------------------------
                 | token manager (part of UTP) |
                  -----------------------------
                                |
               -----------------------------------
              | declaring module (you write this) |
               -----------------------------------
                 |              |              |
      ---------------    ---------------    ---------------
     | user module 1 |  | user module 2 |  | user module 3 |
      ---------------    ---------------    ---------------
</pre>
   <div class="defun">
&mdash; Proc: <b>utp_token_map_declare</b><var> namespace identifier token<a name="index-utp_005ftoken_005fmap_005fdeclare-71"></a></var><br>
<blockquote><p>Register <var>identifier</var> as alias for <var>token</var> in <var>namespace</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_token_map_forget</b><var> namespace identifier ?identifier <small class="dots">...</small>?<a name="index-utp_005ftoken_005fmap_005fforget-72"></a></var><br>
<blockquote><p>Remove an identifier/token pair from the map; the token is left
untouched. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_token_map_access</b><var> namespace identifier local_varname<a name="index-utp_005ftoken_005fmap_005faccess-73"></a></var><br>
<blockquote><p>Store the token associated to <var>identifier</var> in the variable
<var>local_varname</var> in the scope of the caller. 
</p></blockquote></div>

   <p>All these procedures accept the namespace as first argument, so it is
useful to declare a set of interpreter aliases to wrap them with names
associated to the specific declaring module.

<div class="defun">
&mdash; Proc: <b>utp_token_map_aliases</b><var> prefix namespace<a name="index-utp_005ftoken_005fmap_005faliases-74"></a></var><br>
<blockquote><p>Create a set of interpreter aliases: one for each &lsquo;<samp><span class="samp">utp_token_map_*</span></samp>&rsquo;
procedure.  The names of the aliases is obtained by joining <var>prefix</var>
with the name of the operation (<code>declare</code>, <code>forget</code>,
<code>access</code>). 
</p></blockquote></div>

   <p>Example:

<pre class="example">     # Creates aliases: color_declare, color_forget, color_access.
     utp_token_map_aliases color_ color_namespace
     
     utp_struct colors_t {
         utp_string_t first
         utp_string_t second
         utp_string_t third
     }
     
     utp_alias color_first        p_color_select first
     utp_alias color_second       p_color_select second
     utp_alias color_third        p_color_select third
     proc p_color_level { field id level } {
         color_access $id self
         set $self.$field $level
     }
     
     colors_t* italian_flag french_flag
     color_declare italian $italian_flag
     color_declare french  $french_flag
     
     color_first  french  blue
     color_second italian white
     
     color_forget italian french
     unset $italian_flag $french_flag
</pre>
   <!-- page -->
<div class="node">
<a name="dynamic"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#containers">containers</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#token">token</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">6 Handling dynamic environment</h2>

<div class="defun">
&mdash; Proc: <b>dynamic_wind</b><var> in_guard body out_guard<a name="index-dynamic_005fwind-75"></a></var><br>
<blockquote><p>Evaluate a <acronym>TCL</acronym> script making sure that cleanup code is evaluated
after it.  All the arguments must be valid <acronym>TCL</acronym> scripts.

        <p><var>in_guard</var> is always evaluated first; if it fails neither <var>body</var>
nor <var>out_guard</var> are evaluated.  <var>body</var> is evaluated second;
whether it fails or not, <var>out_guard</var> is evaluated after it.  Return
the return value of <var>body</var> or return with the condition with which
<var>body</var> returned.

        <p>Example, the following script:

     <pre class="example">          puts [dynamic_wind {
              set b 1
          } {
              puts $b
              expr 2
          } {
              set b 0
          }
          puts $b
</pre>
        <p class="noindent">prints <code>1</code>, <code>2</code>, <code>0</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>unwind_protect</b><var> body out_guard<a name="index-unwind_005fprotect-76"></a></var><br>
<blockquote><p>Like <code>[dynamic_wind]</code>, but without the <var>in_guard</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_parameter</b><var> name init<a name="index-utp_005fparameter-77"></a></var><br>
&mdash; Proc: <b>utp_parameter</b><var> name init converter<a name="index-utp_005fparameter-78"></a></var><br>
<blockquote><p>Define a new parameter procedure which is associated to a variable
containing the value returned by <code>[</code><var>converter</var> <var>init</var><code>]</code>. 
If <var>converter</var> is not specified, the identity procedure is used
instead.

        <p>The parameter object is a procedure which accepts zero or one argument. 
When it is called with no argument, the content of the variable
associated to this parameter object in the current dynamic environment
is returned.  When it is called with one argument, the content of the
variable is set to the result of the call <code>[</code><var>converter</var>
<var>arg</var><code>]</code>, where <var>arg</var> is the argument passed to the parameter
procedure, and an unspecified value is returned.

        <p>Examples:

     <pre class="example">          utp_parameter ciao 1
          
          puts [ciao]     -| 1
          ciao 2
          puts [ciao]     -| 2
</pre>
        </blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_parametrise</b><var> bindings body<a name="index-utp_005fparametrise-79"></a></var><br>
<blockquote><p>Temporarily set a list of parameters to new values as specified in
<var>bindings</var>, evaluate <var>body</var>, restore the old parameter values. 
The <var>bindings</var> argument must be a list with the format:

     <pre class="example">          { <var>parameter</var> <var>expr</var> ... }
</pre>
        <p class="noindent">in which <var>parameter</var> must be names of parameter defined with
<code>[utp_parameter]</code> and <var>expr</var> must be expressions for
<code>[expr]</code>; <var>body</var> must be a proper <acronym>TCL</acronym> script.

        <p>The <var>expr</var> expressions are evaluated in the given order and their
result stored in the associated parameters; then <var>body</var> is
evaluated; finally the previous values of the parameters is restored.

        <p>If the body or the expressions rename or redefine the parameter
procedures: the behaviour is undefined.

        <p>For example:

     <pre class="example">          utp_parameter ciao  1
          utp_parameter ohayo 10
          
          list [ciao] [ohayo]             &rArr; { 1 10 }
          
          utp_parametrise { ciao 2 ohayo 20 } {
              list [ciao] [ohayo]         &rArr; { 2 20 }
          
              utp_parametrise { ciao 3 ohayo 30 } {
                  list [ciao] [ohayo]     &rArr; { 3 30 }
              }
          
              list [ciao] [ohayo]         &rArr; { 2 20 }
          }
          
          list [ciao] [ohayo]             &rArr; { 1 10 }
</pre>
        </blockquote></div>

<!-- page -->
<div class="node">
<a name="containers"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#events">events</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#dynamic">dynamic</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">7 Collecting data</h2>

<ul class="menu">
<li><a accesskey="1" href="#stack">stack</a>:                        List as stack. 
<li><a accesskey="2" href="#queue">queue</a>:                        List as queue. 
</ul>

<!-- page -->
<div class="node">
<a name="stack"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#queue">queue</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#containers">containers</a>

</div>

<h3 class="section">7.1 List as stack</h3>

<p>The stack is a special way of accessing a list of items.  All the
procedures accept as first argument the name of a variable, fully
qualified or in the scope of the caller, that holds the stack itself
(that is: a <acronym>TCL</acronym> list)..

<div class="defun">
&mdash; Proc: <b>utp_stack_push</b><var> variable_name arg ?arg <small class="dots">...</small>?<a name="index-utp_005fstack_005fpush-80"></a></var><br>
<blockquote><p>Append all the arguments to the stack in <var>variable_name</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_stack_pop</b><var> variable_name<a name="index-utp_005fstack_005fpop-81"></a></var><br>
<blockquote><p>Remove the last element of the stack in <var>variable_name</var> and return
it. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_stack_top</b><var> variable_name<a name="index-utp_005fstack_005ftop-82"></a></var><br>
<blockquote><p>Return the last element of the stack in <var>variable_name</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_stack_drop</b><var> variable_name ?destructor?<a name="index-utp_005fstack_005fdrop-83"></a></var><br>
<blockquote><p>Remove the last element of the stack in <var>variable_name</var>.  The
optional script <var>destructor</var> is invoked, in the global namespace,
with the element appended; this is to perform some sort of finalisation
on the element.

        <p>For proper resource handling: <var>destructor</var> must not raise errors; if
we are collecting objects with destructors that may fail: we must first
remove an object from the stack, so the stack is clean, and then destroy
it and handle the error. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_stack_size</b><var> variable_name<a name="index-utp_005fstack_005fsize-84"></a></var><br>
&mdash; Proc: <b>utp_stack_length</b><var> variable_name<a name="index-utp_005fstack_005flength-85"></a></var><br>
<blockquote><p>Return the number of items on the stack. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_stack_purge</b><var> variable_name ?destructor?<a name="index-utp_005fstack_005fpurge-86"></a></var><br>
<blockquote><p>Access the stack in <var>variable_name</var> and removes all the items;
<var>destructor</var> is evaluated in the global namespace with each item
appended as argument. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_stack_is_empty</b><var> variable_name<a name="index-utp_005fstack_005fis_005fempty-87"></a></var><br>
<blockquote><p>Return true if the stack is empty. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_stack_is_not_empty</b><var> variable_name<a name="index-utp_005fstack_005fis_005fnot_005fempty-88"></a></var><br>
<blockquote><p>Return true if the stack is not empty. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="queue"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#stack">stack</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#containers">containers</a>

</div>

<h3 class="section">7.2 List as queue</h3>

<p>The queue is a special way of accessing a list of items.  All the
procedures accept as first argument the name of a variable, fully
qualified or in the scope of the caller, that holds the queue itself
(that is: a <acronym>TCL</acronym> list).

<div class="defun">
&mdash; Proc: <b>utp_queue_push</b><var> variable_name arg ?arg <small class="dots">...</small>?<a name="index-utp_005fqueue_005fpush-89"></a></var><br>
<blockquote><p>Append all the arguments to the queue in <var>variable_name</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_queue_pop</b><var> variable_name<a name="index-utp_005fqueue_005fpop-90"></a></var><br>
<blockquote><p>Remove the last element of the queue in <var>variable_name</var> and return
it. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_queue_top</b><var> variable_name<a name="index-utp_005fqueue_005ftop-91"></a></var><br>
<blockquote><p>Return the last element of the queue in <var>variable_name</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_queue_drop</b><var> variable_name ?destructor?<a name="index-utp_005fqueue_005fdrop-92"></a></var><br>
<blockquote><p>Remove the last element of the queue in <var>variable_name</var>.  The
optional script <var>destructor</var> is invoked, in the global namespace,
with the element appended; this is to perform some sort of finalisation
on the element.

        <p>For proper resource handling: <var>destructor</var> must not raise errors; if
we are collecting objects with destructors that may fail: we must first
remove an object from the queue, so the queue is clean, and then destroy
it and handle the error. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_queue_size</b><var> variable_name<a name="index-utp_005fqueue_005fsize-93"></a></var><br>
&mdash; Proc: <b>utp_queue_length</b><var> variable_name<a name="index-utp_005fqueue_005flength-94"></a></var><br>
<blockquote><p>Return the number of items on the queue. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_queue_purge</b><var> variable_name ?destructor?<a name="index-utp_005fqueue_005fpurge-95"></a></var><br>
<blockquote><p>Access the queue in <var>variable_name</var> and removes all the items;
<var>destructor</var> is evaluated in the global namespace with each item
appended as argument. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_queue_is_empty</b><var> variable_name<a name="index-utp_005fqueue_005fis_005fempty-96"></a></var><br>
<blockquote><p>Return true if the queue is empty. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_queue_is_not_empty</b><var> variable_name<a name="index-utp_005fqueue_005fis_005fnot_005fempty-97"></a></var><br>
<blockquote><p>Return true if the queue is not empty. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="events"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#user-interface">user interface</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#containers">containers</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">8 Handling the event loop</h2>

<ul class="menu">
<li><a accesskey="1" href="#event-source">event source</a>:                 Event sources. 
<li><a accesskey="2" href="#periodic-scripts">periodic scripts</a>:             Evaluating scripts periodically. 
<li><a accesskey="3" href="#timeouts">timeouts</a>:                     Setting timeouts. 
</ul>

<!-- page -->
<div class="node">
<a name="event-source"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#periodic-scripts">periodic scripts</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#events">events</a>

</div>

<h3 class="section">8.1 Event sources</h3>

<p>Sometimes we need to queue a script in the event loop, but while the
script is waiting to be evaluated, the resources it has to act upon are
released; in these case the evaluation of the script raises an unwanted
error.

   <p>The event source is a way to queue and evaluate scripts, with
<code>[after]</code>, that associates each script to an &ldquo;event source&rdquo;; if,
while some scripts are queued, we request the finalisation of the
source: the associated scripts are removed with <code>[after cancel]</code>.

   <p>The idea of an event source is somewhat copied from the C source of the
<acronym>TCL</acronym> core.

<div class="defun">
&mdash; Struct Typedef: <b>utp_event_source_t</b><var><a name="index-utp_005fevent_005fsource_005ft-98"></a></var><br>
<blockquote><p>The type of the event source structure.  When the structure is
finalised: all the queued scripts are removed from the event loop. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_event_source_queue</b><var> token delay script<a name="index-utp_005fevent_005fsource_005fqueue-99"></a></var><br>
&mdash; Method on <code>utp_event_source_t</code>: <b>queue</b><var> delay script<a name="index-queue-100"></a></var><br>
<blockquote><p>This procedure is basically a wrapper for the <code>[after]</code> builtin: it
queues <var>script</var> to be evaluated in the global namespace; <var>delay</var>
is the first argument to the invocation of <code>[after]</code> (so it can be
a number of milliseconds or the keyword <code>idle</code>).  The script is
associated to the event source <var>token</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_event_source_cancel</b><var> token script<a name="index-utp_005fevent_005fsource_005fcancel-101"></a></var><br>
&mdash; Method on <code>utp_event_source_t</code>: <b>cancel</b><var> script<a name="index-cancel-102"></a></var><br>
<blockquote><p>Cancel the event associated to <var>script</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_event_source_cancel_all</b><var> token<a name="index-utp_005fevent_005fsource_005fcancel_005fall-103"></a></var><br>
&mdash; Method on <code>utp_event_source_t</code>: <b>cancel_all</b><var><a name="index-cancel_005fall-104"></a></var><br>
<blockquote><p>Cancel all the queued events. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="periodic-scripts"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#timeouts">timeouts</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#event-source">event source</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#events">events</a>

</div>

<h3 class="section">8.2 Evaluating scripts periodically</h3>

<p>This module offers an infrastructure to evaluate a script periodically;
the script is scheduled in the event loop with a call to the
<code>[after]</code> built&ndash;in command.  This module makes use of the event
source to solve the problem of asynchronous scripts (see <a href="#event-source">event source</a>).

<ul class="menu">
<li><a accesskey="1" href="#periodic-scripts-diagram">periodic scripts diagram</a>
</ul>

<div class="defun">
&mdash; Struct Typedef: <b>utp_periodic_script_t</b><var><a name="index-utp_005fperiodic_005fscript_005ft-105"></a></var><br>
<blockquote><p>The type of the periodic script structure. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_periodic_script_init</b><var> tokenvar event_source script<a name="index-utp_005fperiodic_005fscript_005finit-106"></a></var><br>
<blockquote><p>Initialise an already declared periodic script evaluator. 
</p></blockquote></div>

   <p>Upon finalisation of the structure: the periodic script is removed from
the event source, if the source still exists.

<div class="defun">
&mdash; Proc: <b>utp_periodic_script_schedule</b><var> token<a name="index-utp_005fperiodic_005fscript_005fschedule-107"></a></var><br>
&mdash; Method on <code>utp_periodic_script_t</code>: <b>schedule</b><var><a name="index-schedule-108"></a></var><br>
<blockquote><p>Schedule the periodic script, only if it is not already scheduled.  If a
condition script has been registered: it is evaluated in the global
namespace, if its return value is true the periodic script is scheduled,
else it is not. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_periodic_script_set_condition</b><var> token condition<a name="index-utp_005fperiodic_005fscript_005fset_005fcondition-109"></a></var><br>
&mdash; Method on <code>utp_periodic_script_t</code>: <b>set_condition</b><var> condition<a name="index-set_005fcondition-110"></a></var><br>
<blockquote><p>Register a condition script, which will be evaluated in the global
namespace, and must return a boolean value.

        <p>The script is evaluated whenever the module is about to reschedule the
periodic script evaluation, if its return value is true: the script is
scheduled, else it is not and the periodic evaluation is stopped.

        <p>The condition script is evaluated <strong>after</strong> the periodic script
evaluation, that is: (1) the <code>[after]</code> timeout triggers, (2) the
periodic script is evaluated, (3) the condition script is evaluated;
this is to allow the periodic script to change the state of the program
before the evaluation of the condition script. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_periodic_script_set_period</b><var> token milliseconds<a name="index-utp_005fperiodic_005fscript_005fset_005fperiod-111"></a></var><br>
&mdash; Method on <code>utp_periodic_script_t</code>: <b>set_period</b><var> milliseconds<a name="index-set_005fperiod-112"></a></var><br>
<blockquote><p>Configure the period of the evaluation.  The default value is 1000. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_periodic_script_get_period</b><var> token<a name="index-utp_005fperiodic_005fscript_005fget_005fperiod-113"></a></var><br>
&mdash; Method on <code>utp_periodic_script_t</code>: <b>get_period</b><var><a name="index-get_005fperiod-114"></a></var><br>
<blockquote><p>Return the current scheduling period. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="periodic-scripts-diagram"></a>
<p><hr>
Up:&nbsp;<a rel="up" accesskey="u" href="#periodic-scripts">periodic scripts</a>

</div>

<h4 class="subsection">8.2.1 Block diagram</h4>

<pre class="example">                          |
                          v
        ---------------------------------------
       | invocation of the scheduler procedure |&lt;--
        ---------------------------------------    |
                          |                        |
                          v                        |
          ----------------------------------       |
         | the script is already scheduled? |      |
          ----------------------------------       |
                |                   |              |
                |no                 |yes           |
                |                   |              |
                |                 ------           |
                |                | stop |          |
                |                 ------           |
                v                                  |
       -----------------------------------------   |
      | a condition script has been registered? |  |
       -----------------------------------------   |
           |                                |      |
           |yes                             |no    |
           v                                |      |
       --------------------------------     |      |
      | evaluate the condition script: |    |      |
      | the return value is true?      |    |      |
       --------------------------------     |      |
           |                      |         |      |
           |yes                   |no       |      |
           |                    ------      |      |
           |                   | stop |     |      |
           |                    ------      |      |
           |                                |      |
            --------------+-----------------       |
                          |                        |
                          v                        |
          ----------------------------------       |
         | the periodic script is scheduled |      |
          ----------------------------------       |
                          .                        |
                 .....................             |
                : the event loop runs :            |
                 .....................             |
                          .                        |
                          v                        |
                 ...................               |
                : the event happens :              |
                 ...................               |
                          |                        |
                          v                        |
          ----------------------------------       |
         | the periodic script is evaluated |      |
          ----------------------------------       |
                          |                        |
                           ------------------------
</pre>
<!-- page -->
<div class="node">
<a name="timeouts"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#periodic-scripts">periodic scripts</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#events">events</a>

</div>

<h3 class="section">8.3 Setting timeouts</h3>

<div class="defun">
&mdash; Proc: <b>utp_timeout_t</b><var><a name="index-utp_005ftimeout_005ft-115"></a></var><br>
<blockquote><p>The type of timeout structure. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_timeout_init</b><var> token delay script<a name="index-utp_005ftimeout_005finit-116"></a></var><br>
<blockquote><p>Initialise an already declared timeout structure.  <var>delay</var> is the
time in milliseconds after which the timer triggers; <var>script</var> is
evaluated if the timer triggers. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_timeout_start</b><var> token<a name="index-utp_005ftimeout_005fstart-117"></a></var><br>
&mdash; Method on <code>utp_timeout_t</code>: <b>start</b><var><a name="index-start-118"></a></var><br>
<blockquote><p>Start the timer.  It may be invoked multiple times: it will start the
timer if it is not already running. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_timeout_stop</b><var> token<a name="index-utp_005ftimeout_005fstop-119"></a></var><br>
&mdash; Method on <code>utp_timeout_t</code>: <b>stop</b><var><a name="index-stop-120"></a></var><br>
<blockquote><p>Stop a running timer.  It is automatically invoked when the structure is
finalised. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_timeout_running</b><var> token<a name="index-utp_005ftimeout_005frunning-121"></a></var><br>
&mdash; Method on <code>utp_timeout_t</code>: <b>running</b><var><a name="index-running-122"></a></var><br>
<blockquote><p>Return true if the timer is running. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_timeout_triggered</b><var> token<a name="index-utp_005ftimeout_005ftriggered-123"></a></var><br>
&mdash; Method on <code>utp_timeout_t</code>: <b>triggered</b><var><a name="index-triggered-124"></a></var><br>
<blockquote><p>Return true if the timer has triggered and the script has been
evaluated. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_timeout_reinit</b><var> token<a name="index-utp_005ftimeout_005freinit-125"></a></var><br>
&mdash; Method on <code>utp_timeout_t</code>: <b>reinit</b><var><a name="index-reinit-126"></a></var><br>
<blockquote><p>Reinitialise the state of the instance so that both
<code>[utp_timeout_running]</code> and <code>[utp_timeout_triggered]</code> return
false.  It is an error to reinitialise a running timer. 
</p></blockquote></div>

   <p>If we do not care about testing the state: we can avoid the
reinitialisation of the timer, that is do not call
<code>[utp_timeout_reinit]</code>.

<!-- page -->
<div class="node">
<a name="user-interface"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#design">design</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#events">events</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">9 Interfacing with the user</h2>

<ul class="menu">
<li><a accesskey="1" href="#getopts">getopts</a>:                      Parsing options from the command line. 
<li><a accesskey="2" href="#ini-files">ini files</a>:                    Parsing <code>.INI</code> configuration files. 
<li><a accesskey="3" href="#channel-message">channel message</a>:              Writing messages into a channel. 
<li><a accesskey="4" href="#dialog">dialog</a>:                       Asking questions. 
</ul>

<!-- page -->
<div class="node">
<a name="getopts"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#ini-files">ini files</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#user-interface">user interface</a>

</div>

<h3 class="section">9.1 Parsing options from the command line</h3>

<p>All the procedure and variable names in this module are prefixed with
<code>utp_getopts</code> or <code>utp_p_getopts</code>.  In the following the term
&ldquo;token&rdquo; is used in the parser context, not in the global variable one.

<ul class="menu">
<li><a accesskey="1" href="#getopts-intro">getopts intro</a>:                The format of recognised options. 
<li><a accesskey="2" href="#getopts-basic">getopts basic</a>:                Low level procedures. 
<li><a accesskey="3" href="#getopts-parser">getopts parser</a>:               Options declaration and parsing. 
<li><a accesskey="4" href="#getopts-help">getopts help</a>:                 Building the help screen. 
</ul>

<!-- page -->
<div class="node">
<a name="getopts-intro"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#getopts-basic">getopts basic</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#getopts">getopts</a>

</div>

<h4 class="subsection">9.1.1 The format of recognised options</h4>

<p>The procedures in this moduule can parse tokens of the form:

     <dl>
<dt><code>-a</code><dd>A single brief option.

     <br><dt><code>--alpha</code><dd>A single long option.

     <br><dt><code>-a123</code><dd>The option <code>a</code> with the value <code>123</code>, an option/value pair.

     <br><dt><code>--alpha=123</code><dd>The option <code>alpha</code> with the value <code>123</code>, an option/value pair.

     <br><dt><code>--</code><dd>The separator, after this all the tokens are treated as arguments. 
</dl>

   <p>Tokens that do not match these are treated as arguments.

   <p>A brief option name must match the regular expression
<code>[a-zA-Z0-9]</code>; but if a brief option has an argument, the regular
expression is <code>[a-zA-Z]</code>.  This is to avoid the ugly <code>-0123</code>
tokens (ugliness is in the eyes of the author, etc. etc.).

   <p>A long option name must match the regular expression
<code>[a-zA-Z0-9][a-zA-Z0-9\-_]*</code>.  Long options with arguments not
attached with an equal sign (<code>=</code>) are not supported.

<!-- page -->
<div class="node">
<a name="getopts-basic"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#getopts-parser">getopts parser</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#getopts-intro">getopts intro</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#getopts">getopts</a>

</div>

<h4 class="subsection">9.1.2 Low level procedures</h4>

<div class="defun">
&mdash; Proc: <b>utp_getopts_parse_token</b><var> input tokenvar1 tokenvar2 classvar<a name="index-utp_005fgetopts_005fparse_005ftoken-127"></a></var><br>
<blockquote><p>Parse a single token from a list of command line options.  Arguments:

          <dl>
<dt><var>input</var><dd>The input string.

          <br><dt><var>tokenvar1</var><dd>The name of a variable that will hold the first output token.

          <br><dt><var>tokenvar2</var><dd>The name of a variable that will hold the second output token.

          <br><dt><var>classvar</var><dd>The name of a variable that will hold the token class. 
</dl>

        <p>If the input string is a single brief option, <var>tokenvar1</var> is set to
the option letter and <var>classvar</var> is set to <code>BRIEF_OPTION</code>.

        <p>If the input string is a single long option, <var>tokenvar1</var> is set to
the option string and <var>classvar</var> is set to <code>LONG_OPTION</code>

        <p>If the input string is a brief option/value pair, <var>tokenvar1</var> is set
to the option letter, <var>tokenvar2</var> is set to the option value and
<var>classvar</var> is set to <code>BRIEF_PAIR</code>.

        <p>If the input string is a long option/value pair, <var>tokenvar1</var> is set
to the option string, <var>tokenvar2</var> is set to the option value and
<var>classvar</var> is set to <code>LONG_PAIR</code>.

        <p>If the input string is the <code>--</code> separator, <var>classvar</var> is set to
<code>SEPARATOR</code>.

        <p>If none of the above, <var>tokenvar1</var> is set to the input string and
<var>classvar</var> is set to <code>ARGUMENT</code>. 
</p></blockquote></div>

   <p>Examples:

<pre class="example">     utp_getopts_parse_token -a one two cls
     # $one = a , $two = undefined, $cls = BRIEF_OPTION
     
     utp_getopts_parse_token --alpha one two cls
     # $one = alpha , $two = undefined, $cls = LONG_OPTION
     
     utp_getopts_parse_token -a123 one two cls
     # $one = a , $two = 123, $cls = BRIEF_PAIR
     
     utp_getopts_parse_token --alpha=123 one two cls
     # $one = alpha , $two = 123, $cls = LONG_PAIR
     
     utp_getopts_parse_token -- one two cls
     # $one = undefined , $two = undefined, $cls = SEPARATOR
     
     utp_getopts_parse_token beta one two cls
     # $one = beta , $two = undefined, $cls = ARGUMENT
</pre>
   <div class="defun">
&mdash; Proc: <b>utp_getopts_parse_list</b><var> argv noargvar withargvar argsvar<a name="index-utp_005fgetopts_005fparse_005flist-128"></a></var><br>
<blockquote><p>Parse a list of command line options, using
<code>[utp_getopts_parse_token]</code>.  Arguments:

          <dl>
<dt><var>argv</var><dd>The list of tokens to parse.

          <br><dt><var>noargvar</var><dd>The name of a variable that will hold the list of options with no
arguments, both brief and long.

          <br><dt><var>withargvar</var><dd>The name of a variable that will hold the list of options with
arguments pairs, both brief and long.

          <br><dt><var>argsvar</var><dd>The name of a variable that will hold the list of arguments. 
</dl>

        <p>As a special exception: if a long option with no argument named
<code>encoded-args</code> is parsed, all the subsequent arguments and option
values are interpreted as hexadecimal encoded strings and so they are
decoded with the code:

     <pre class="example">          binary scan \
              [string toupper $value] \
              H[expr {[string length $value]*2}] \
              value
</pre>
        <p>There can't be any error in this procedure if encoding is off. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="getopts-parser"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#getopts-help">getopts help</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#getopts-basic">getopts basic</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#getopts">getopts</a>

</div>

<h4 class="subsection">9.1.3 Options declaration and parsing</h4>

<div class="defun">
&mdash; Proc: <b>utp_getopts_declare</b><var> declaration keyword defvalue brief long hasarg description<a name="index-utp_005fgetopts_005fdeclare-129"></a></var><br>
<blockquote><p>Declare a command line option; the data is stored in a variable in the
scope of the caller, the name of the variable is <var>declaration</var>.

        <p>Other arguments description follows.

          <dl>
<dt><var>keyword</var><dd>A string used to uniquely identify the option.

          <br><dt><var>defvalue</var><dd>The default value associated with the option.  For options with no
argument: it must be a boolean value; for options with argument it can
be any value.

          <br><dt><var>brief</var><dd>The brief option selector: a list of single characters.  Any of them can
be used to select the option.

          <br><dt><var>long</var><dd>The long option selector: a list of strings.  Any of them can be used to
select the option.

          <br><dt><var>hasarg</var><dd>A boolean value indicating if the option requires argument (<code>yes</code>)
or not (<code>no</code>).

          <br><dt><var>description</var><dd>A one line description used to automatically build the help screen for
the script. 
</dl>
        </p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_getopts_parse</b><var> declaration valuesvar argsvar argv<a name="index-utp_005fgetopts_005fparse-130"></a></var><br>
<blockquote><p>Parser for command line arguments.  Arguments description follows.

          <dl>
<dt><var>declaration</var><dd>The name of a variable in the scope of the caller that has been
initialised with <code>[utp_getopts_declare]</code>.

          <br><dt><var>valuesvar</var><dd>The name of a variable in the scope of the caller that will be
initialised as an array: the keys are the option keywords, the values
are the default values for the options.  After that: the option values
found in <var>argv</var> are stored in it, overriding the defaults.

          <br><dt><var>argsvar</var><dd>The name of a variable in the scope of the caller that will hold the
non&ndash;option arguments found in <var>argv</var>.

          <br><dt><var>argv</var><dd>The list of tokens to be parsed. 
</dl>

        <p>When an option is recognised: a procedure is invoked to let the script
update its state.  The name of the procedure is built with the following
code:

     <pre class="example">          [format "utp_script_option_update_%s" $keyword]
</pre>
        <p class="noindent">and it is executed by invoking <code>[utp_invoke_script_procedure]</code> with
the option as single argument.  At the time of the procedure invocation:
the value of the option (if any) has already been stored in the values
variable. 
</p></blockquote></div>

   <p>Example:

<pre class="example">     foreach decl {
         { alpha    no      {a A} {alpha ALPHA} no  "enable alpha" }
         { beta     no      {}    beta          no  "enable beta" }
         { delta    123     {d D} {delta DELTA} yes "delta option" }
         { gamma    456     {}    gamma         yes "gamma option" }
     } {
         eval { utp_getopts_declare declaration } $decl
     }
     
     set argv { --alpha one two --delta=abc }
     utp_getopts_parse declaration values arguments $argv
     # [array get values] = {
     #     alpha       yes
     #     beta        no
     #     delta       abc
     #     gamma       456
     # }
     # $arguments = { one two }
</pre>
   <!-- page -->
<div class="node">
<a name="getopts-help"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#getopts-parser">getopts parser</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#getopts">getopts</a>

</div>

<h4 class="subsection">9.1.4 Building the help screen</h4>

<div class="defun">
&mdash; Proc: <b>utp_getopts_make_usage_string</b><var> declaration<a name="index-utp_005fgetopts_005fmake_005fusage_005fstring-131"></a></var><br>
<blockquote><p>Build and return the help screen: the one that command line programs
should print when the <code>--help</code> option is used.  <var>declaration</var>
is the name of a variable in the scope of the caller that has been
initialised with <code>[utp_getopts_declare]</code>. 
</p></blockquote></div>

   <p>Example:

<pre class="example">     foreach decl {
         { alpha    no      {a A} {alpha ALPHA} no  "enable alpha" }
         { beta     no      {}    beta          no  "enable beta" }
         { delta    123     {d D} {delta DELTA} yes "delta option" }
         { gamma    456     {}    gamma         yes "gamma option" }
     } {
         eval { utp_getopts_declare declaration } $decl
     }
     
     utp_getopts_make_usage_string declaration
     # \t-a, -A, --alpha, --ALPHA
     # \t\tenable alpha
     # \t--beta
     # \t\tenable beta
     # \t-dVALUE, -DVALUE, --delta=VALUE, --DELTA=VALUE
     # \t\tdelta option
     # \t--gamma=VALUE
     # \t\tgamma option
</pre>
   <div class="defun">
&mdash; Proc: <b>utp_getopts_get_long_options</b><var> declaration<a name="index-utp_005fgetopts_005fget_005flong_005foptions-132"></a></var><br>
<blockquote><p>Return the list of long options (with leading double dash);
<var>declaration</var> is the name of a variable in the scope of the caller
that has been initialised with <code>[utp_getopts_declare]</code>.  This is
useful, for example, for programmable command line completion from the
prompt of shells like the <acronym>GNU</acronym> <samp><span class="command">bash</span></samp>. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="ini-files"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#channel-message">channel message</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#getopts">getopts</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#user-interface">user interface</a>

</div>

<h3 class="section">9.2 Parsing <code>.INI</code> configuration files</h3>

<p>A <code>.INI</code> file is (typically) a configuration file with a format
like this:

<pre class="example">     [Section Name]
     option_name1 = option_value1
     option_name2 = option_value2
     
     [Another Section]
     another_option = another_value
</pre>
   <p>In the following the term &ldquo;token&rdquo; is used in the parser context, not
in the global variable one.

   <p>Lines starting with <code>#</code> are ignored;
lines full of blank characters (spaces and tabs) are ignored; option
assignment lines can be of the forms:

<pre class="example">     option_name = option_value
     option_name = "option value"
     option_name = 'option value'
</pre>
   <p class="noindent">Any number of blank characters can be used to separate words, they are
ignored if not between quotes.  Line continuation with <code>\</code> is
<strong>not</strong> supported, but nothing prevents us from preprocessing the
input lines and adjust this.

   <p>Options that are found before the first section opening, are considered
part of a section whose title is the empty string.

   <p>The parsing of a <code>.INI</code> file with this module is just the
transformation of the input lines in a <acronym>TCL</acronym> list of triplets: one that
can be traversed with code like this:

<pre class="example">     foreach { section option value } $triplets {
         ...
     }
</pre>
   <p class="noindent">no check for correctness is done by this module: if we have to validate
the section titles, the option names and values, we have to do this on
our own.

<div class="defun">
&mdash; Proc: <b>utp_ini_parse_line</b><var> line tokenvar1 tokenvar2 class<a name="index-utp_005fini_005fparse_005fline-133"></a></var><br>
<blockquote><p>Parse a single line from a <code>.INI</code> file.  Arguments are:

          <dl>
<dt><var>line</var><dd>The line to be parsed.

          <br><dt><var>tokenvar1</var><dd>The name of a variable that will hold the first output token.

          <br><dt><var>tokenvar2</var><dd>The name of a variable that will hold the second output token.

          <br><dt><var>classvar</var><dd>The name of a variable that will hold the token's class: <code>COMMENT</code>,
<code>SECTION</code>, <code>ASSIGNMENT</code>, <code>SYNTAX_ERROR</code>. 
</dl>

        <p>If the line is a blank or a comment: the output token variables are
untouched, <var>classvar</var> is set to <code>COMMENT</code>.

        <p>If the line is a section opening: the first output token variable will
hold the section title, the second will be left untouched,
<var>classvar</var> is set to <code>SECTION</code>.

        <p>If the line is an option assignment: the first output variable holds the
option name, the second the option value, <var>classvar</var> is set to
<code>ASSIGNMENT</code>.

        <p>In all the other cases: the output token variables are left untouched,
<var>classvar</var> is set to <code>SYNTAX_ERROR</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_ini_parse_string</b><var> inputvar statevar outputvar<a name="index-utp_005fini_005fparse_005fstring-134"></a></var><br>
<blockquote><p>Parse lines of a <code>.INI</code> file reading them from an input string. 
Arguments:

          <dl>
<dt><var>inputvar</var><dd>The name of the variable holding the input string.

          <br><dt><var>statevar</var><dd>The name of the variable holding the parser state.

          <br><dt><var>outputvar</var><dd>The name of the variable holding the output list. 
</dl>

        <p>Lines are taken from the input string and parsed with
<code>[utp_ini_parse_line]</code>.  Section/option/value triplets are stored
as a list in a variable in the scope of the caller.

        <p>If an error occurs the return value is true, else it's false.  It's
possible to resume the parsing from the next line by just invoking again
the procedure.

        <p>When all the lines have been parsed, the procedure returns. 
</p></blockquote></div>

   <p>Care must be taken when deciding to resume the parsing after an error:
if the error is in a section opening, the code will assume that the
following options are part of the previous section.  This can lead to
unpredictable results when the options are used in the program.

<div class="defun">
&mdash; Proc: <b>utp_ini_make_string</b><var> input outputvar<a name="index-utp_005fini_005fmake_005fstring-135"></a></var><br>
<blockquote><p>Build a <code>.INI</code> file string representing a configuration array. 
<var>input</var> is a list of section/option/value triplets.  <var>outputvar</var>
is the name of the variable that will hold the result.

        <p>The input list is interpreted as a sequence of section, option, value
triplets.  Option assignments are appended to the output string one
after the other, and when a change in the section is found, a section
opening is inserted. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="channel-message"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#dialog">dialog</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#ini-files">ini files</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#user-interface">user interface</a>

</div>

<h3 class="section">9.3 Writing messages into a channel</h3>

<p>This module provides an interface to output messages into a channel, for
example: to the user at the console.  It is responsibility of the user
code to open a channel, with write mode enabled, and close it when it's
no longer needed.

   <p>The module makes use of a state variable allocated in the global
namespace.  The variable is accessed by the procedures by accessing the
global symbol <code>utp_message_token</code>: a variable that must hold the
token of a structure.

   <p>A usage example:

<pre class="example">     utp_message_t* ::utp_message_token
     utp_message_init stdout
     utp_message_set_prefix $program_name
     utp_message_set_verbosity $program_options(VERBOSITY)
     utp_message_configure_enable_debugging
     
     # writes "$program_name: this is a message\n" to "stdout"
     utp_message_string "this is a message"
     
     unset $::utp_message_token
</pre>
   <p class="noindent">the module offers a procedure to switch token:

<pre class="example">     utp_message_t* token
     
     # equivalent to: set ::utp_message_token $token
     utp_message_switch_token $token
     
     utp_message_init stdout
     ...
</pre>
   <ul class="menu">
<li><a accesskey="1" href="#channel-message-init">channel message init</a>:         Initialisation. 
<li><a accesskey="2" href="#channel-message-config">channel message config</a>:       Configuration. 
<li><a accesskey="3" href="#channel-message-write">channel message write</a>:        Writing messages. 
</ul>

<!-- page -->
<div class="node">
<a name="channel-message-init"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#channel-message-config">channel message config</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#channel-message">channel message</a>

</div>

<h4 class="subsection">9.3.1 Initialisation and finalisation</h4>

<div class="defun">
&mdash; Struct: <b>utp_message_t</b><var><a name="index-utp_005fmessage_005ft-136"></a></var><br>
<blockquote><p>The type of the message interface. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_message_switch_token</b><var> token<a name="index-utp_005fmessage_005fswitch_005ftoken-137"></a></var><br>
<blockquote><p>Select <var>token</var> as current message interface. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_message_init</b><var> channel ?channel <small class="dots">...</small>?<a name="index-utp_005fmessage_005finit-138"></a></var><br>
<blockquote><p>Initialise the current message interface.  At least one channel must be
selected, more than one channel can be selected.

        <p>Default values: normal messages are enabled; debugging messages are
disabled; the verbosity level is zero (no messages). 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_message_add_channel</b><var> channel<a name="index-utp_005fmessage_005fadd_005fchannel-139"></a></var><br>
&mdash; Proc: <b>utp_message_drop_channel</b><var> channel<a name="index-utp_005fmessage_005fdrop_005fchannel-140"></a></var><br>
<blockquote><p>Add/remove an output channel. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_message_replace_channel</b><var> old_channel new_channel<a name="index-utp_005fmessage_005freplace_005fchannel-141"></a></var><br>
<blockquote><p>Replace a registered channel. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="channel-message-config"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#channel-message-write">channel message write</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#channel-message-init">channel message init</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#channel-message">channel message</a>

</div>

<h4 class="subsection">9.3.2 Configuration</h4>

<div class="defun">
&mdash; Interp Alias: <b>utp_message_enable_messages</b><var><a name="index-utp_005fmessage_005fenable_005fmessages-142"></a></var><br>
&mdash; Interp Alias: <b>utp_message_disable_messages</b><var><a name="index-utp_005fmessage_005fdisable_005fmessages-143"></a></var><br>
<blockquote><p>Enable/disable message output. 
</p></blockquote></div>

<div class="defun">
&mdash; Interp Alias: <b>utp_message_enable_debugging</b><var><a name="index-utp_005fmessage_005fenable_005fdebugging-144"></a></var><br>
&mdash; Interp Alias: <b>utp_message_disable_debugging</b><var><a name="index-utp_005fmessage_005fdisable_005fdebugging-145"></a></var><br>
<blockquote><p>Enable/disable debug message output (the ones output with
<code>utp_message_debug</code>). 
</p></blockquote></div>

<div class="defun">
&mdash; Interp Alias: <b>utp_message_enable_verbose</b><var> token<a name="index-utp_005fmessage_005fenable_005fverbose-146"></a></var><br>
&mdash; Interp Alias: <b>utp_message_disable_verbose</b><var> token<a name="index-utp_005fmessage_005fdisable_005fverbose-147"></a></var><br>
<blockquote><p>Enable/disable verbose message output (the one output with
<code>utp_message_verbose</code>). 
</p></blockquote></div>

<div class="defun">
&mdash; Interp Alias: <b>utp_message_set_prefix</b><var> prefix<a name="index-utp_005fmessage_005fset_005fprefix-148"></a></var><br>
&mdash; Interp Alias: <b>utp_message_get_prefix</b><var><a name="index-utp_005fmessage_005fget_005fprefix-149"></a></var><br>
<blockquote><p>Select/retrieve the prefix for messages. 
</p></blockquote></div>

<div class="defun">
&mdash; Interp Alias: <b>utp_message_set_verbosity</b><var> level<a name="index-utp_005fmessage_005fset_005fverbosity-150"></a></var><br>
&mdash; Interp Alias: <b>utp_message_get_verbosity</b><var><a name="index-utp_005fmessage_005fget_005fverbosity-151"></a></var><br>
<blockquote><p>Select/retrieve the verbosity level. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="channel-message-write"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#channel-message-config">channel message config</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#channel-message">channel message</a>

</div>

<h4 class="subsection">9.3.3 Writing messages</h4>

<div class="defun">
&mdash; Proc: <b>utp_message_write</b><var> string<a name="index-utp_005fmessage_005fwrite-152"></a></var><br>
<blockquote><p>Write a string, as is, to all the channels. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_message_error</b><var> string<a name="index-utp_005fmessage_005ferror-153"></a></var><br>
<blockquote><p>Print an error string on the output channels.  The string is composed
by: the current prefix, a space, the string <code>error:</code>, a space,
<var>string</var> and a newline.  Return the empty string. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_message_errorinfo</b><var> string<a name="index-utp_005fmessage_005ferrorinfo-154"></a></var><br>
<blockquote><p>Print an error string on the output channels.  The behaviour is the same
of <code>[utp_message_error]</code>, but if the global variable
<code>errorInfo</code> is not empty, the first line of its value is appended
to the output message, preceded by a colon and a space.  Return the
empty string. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_message_warning</b><var> string<a name="index-utp_005fmessage_005fwarning-155"></a></var><br>
<blockquote><p>Print a warning string on the output channels.  The string is composed
by: the current prefix, a space, the string <code>warning:</code>, a space,
<var>string</var> and a newline.  Return the empty string. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_message_debug</b><var> string ?arg <small class="dots">...</small>?<a name="index-utp_005fmessage_005fdebug-156"></a></var><br>
<blockquote><p>If <code>debugging</code> is true, print a string on the output channels.  The
string is composed by: the current prefix, a space, the string
<code>debug:</code>, a space, <var>string</var> and a newline.  Return the empty
string.

        <p>The optional arguments are used to build the string with
<code>[format]</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_message_verbose</b><var> string ?verbosity?<a name="index-utp_005fmessage_005fverbose-157"></a></var><br>
<blockquote><p>If <var>verbosity</var> is greater than or equal to the current verbosity
level, a string is printed on the output channels.  The string is
composed by: the current prefix, a space and <var>string</var>. 
<var>verbosity</var> defaults to 1.  Return the empty string. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_message_string</b><var> string<a name="index-utp_005fmessage_005fstring-158"></a></var><br>
<blockquote><p>Print a string on the output channels; return the empty string. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_message_switch_error_code</b><var> string ?requestErrorInfo?<a name="index-utp_005fmessage_005fswitch_005ferror_005fcode-159"></a></var><br>
<blockquote><p>If <code>errorCode</code> is <code>LOGIC</code> or <code>RUNTIME</code>: invoke
<code>[utp_message_error]</code> with the same arguments; else invoke
<code>[utp_message_errorinfo]</code> with the same arguments.

        <p>If <var>requestErrorInfo</var> is given and true: always use
<code>[utp_message_errorinfo]</code>. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="dialog"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#channel-message">channel message</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#user-interface">user interface</a>

</div>

<h3 class="section">9.4 Asking questions</h3>

<div class="defun">
&mdash; Struct: <b>utp_dialog_t</b><var><a name="index-utp_005fdialog_005ft-160"></a></var><br>
<blockquote><p>The dialog interface. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_dialog_init</b><var> token progname inchan outchan<a name="index-utp_005fdialog_005finit-161"></a></var><br>
<blockquote><p>Initialise an already allocated interface structure.  <var>progname</var> is
the program name to use as prefix for messages; <var>inchan</var> is the
channel used to read input from the user; <var>outchan</var> is the channel
used to send messages to the user. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_dialog_question_yes_or_no</b><var> token question_string<a name="index-utp_005fdialog_005fquestion_005fyes_005for_005fno-162"></a></var><br>
<blockquote><p>Ask a question to the user, expecting a <code>yes</code> or <code>no</code> answer. 
<var>question_string</var> is text of the question, without a trailing
question mark.

        <p>Write the message to the registered output channel and blocks until a
line is read from the registered input channel.  If the line is
<code>yes</code> or <code>no</code> (case insensitive) return true or false
respectively; else output again the question and read another answer. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_dialog_notify</b><var> token message_string<a name="index-utp_005fdialog_005fnotify-163"></a></var><br>
<blockquote><p>Notify a message to the user.  Output the text on the registered output
channel and block until a line is written to the registered input
channel.  The line is discarded. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="design"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#file">file</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#user-interface">user interface</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">10 Packages implementing design strategies</h2>

<ul class="menu">
<li><a accesskey="1" href="#iterator">iterator</a>:                     Iteration procedures. 
<li><a accesskey="2" href="#observer">observer</a>:                     One to many relation. 
<li><a accesskey="3" href="#task">task</a>:                         Handling job private variables. 
<li><a accesskey="4" href="#factory">factory</a>:                      Object factory. 
<li><a accesskey="5" href="#cache">cache</a>:                        Caching objects. 
<li><a accesskey="6" href="#workers">workers</a>:                      Using a pool of worker items. 
<li><a accesskey="7" href="#sm">sm</a>:                           Managing state machines. 
<li><a accesskey="8" href="#option">option</a>:                       Handling tables of options. 
</ul>

<!-- page -->
<div class="node">
<a name="iterator"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#observer">observer</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#design">design</a>

</div>

<h3 class="section">10.1 Iteration procedures</h3>

<p>The argument named <var>self</var> in the following descriptions is the token
of a <code>utp_iterator_t</code> structure.

<div class="defun">
&mdash; Struct Type: <b>utp_iterator_t</b><var><a name="index-utp_005fiterator_005ft-164"></a></var><br>
<blockquote><p>Holds the data of the iterator. 
</p></blockquote></div>

   <p>Typically, the user code will do:

<pre class="example">     utp_iterator_t* iterator
     iterator_initialisation_procedure $iterator ...
     
     while { [utp_iterator_next $iterator out] } {
         # do something with $out
     }
     unset $iterator
</pre>
   <p>The iterator initialiser is specific for a type of iteration, the
procedure that advances the iteration can act on any iterator.  The
iterators presented here cannot fail.  It's easy to write a couple of
iterator procedures that store an error code in the iterator variable,
so that it can be checked that way:

<pre class="example">     utp_iterator_t* iterator
     iterator_initialisation_procedure $iterator ...
     
     while { [utp_iterator_next $iterator out] } {
         # do something with $out
     }
     if { [iterator_specific_error $iterator] } {
         # handle the error
     }
     unset $iterator
</pre>
   <p class="noindent">when the iteration fails: <code>[utp_iterator_next]</code> can return zero and
we check for the error.  Raising an error with <code>[error]</code> or
<code>[return -code error]</code> is also good.

<div class="defun">
&mdash; Proc: <b>utp_iterator_next</b><var> self outvar ?<small class="dots">...</small>?<a name="index-utp_005fiterator_005fnext-165"></a></var><br>
<blockquote><p>Advance an iteration to the next element.  Return true if a new element
was extracted from the sequence, false otherwise.  In the former case
the element is stored in the variable <var>outvar</var> in the scope of the
caller.  It's possible for a specific iterator to require more than a
single output variable. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_iterator_list</b><var> self list<a name="index-utp_005fiterator_005flist-166"></a></var><br>
<blockquote><p>Initialise an iteration over a <var>list</var>.  The iterator will visit all
the elements from the first to the last. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_iterator_array</b><var> self arrayvar<a name="index-utp_005fiterator_005farray-167"></a></var><br>
<blockquote><p>Initialise an iteration over an array.  <var>arrayvar</var> is the name of
the array variable; the array must be a static variable if we use this
iterator as source for a higher level iterator.  The iterator will visit
all the keys in the array in no predefined order.

        <p>If we don't go till the end of the iteration, a resource leakage will
result: this is because the builtin <acronym>TCL</acronym> array iterator
requires the invocation of <code>[array donesearch]</code>, this is done only
when the iteration ends.

        <p>It is always possible to iterate over the element of an array extracting
the keys with <code>[array names]</code> and treating them as a common list. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Set iterators</h5>

<p>The following iteration procedures will join two iterators to provide
some sort of composition between two sequences of elements.  The
sequences provided by the two input iterators must be ordered: the
elements of a sequence must be visited in such a way that:

<pre class="example">     string compare $previous $current
</pre>
   <p class="noindent">returns <code>-1</code>.  At present, no sophisticated comparison is possible
(the full power of <code>[lsort]</code> is not used).  We have to be careful
with this because, for example, the string <code>8</code> is greater than the
string <code>10</code>, while the string <code>08</code> is lesser than the string
<code>10</code>.

   <p>All the procedures accept as arguments <var>one</var> and <var>two</var>: two
already initialised iterators.

<div class="defun">
&mdash; Proc: <b>utp_iterator_union</b><var> self one two<a name="index-utp_005fiterator_005funion-168"></a></var><br>
<blockquote><p>Initialise a union iterator; the resulting iterator will visit all the
elements from both the sequences, sorted. 
</p></blockquote></div>

   <p>Examples of union:

<!-- *NOTE* the misalignment of the horizontal lines is due to the -->
<!-- quoting of the braces! In the output it goes away. -->
<pre class="example">          { 1 2 3 } +     { 1   3   5 } +
          { 1 2 3 } =     {   2   4   } =
     ----------------     ---------------
     { 1 1 2 2 3 3}       { 1 2 3 4 5 }
</pre>
   <div class="defun">
&mdash; Proc: <b>utp_iterator_intersection</b><var> self one two<a name="index-utp_005fiterator_005fintersection-169"></a></var><br>
<blockquote><p>Initialise an intersection iterator; the resulting iterator will visit
all the elements that are in both sequences. 
</p></blockquote></div>

   <p>Examples of intersection:

<!-- *NOTE* the misalignment of the horizontal lines is due to the -->
<!-- quoting of the braces! In the output it goes away. -->
<pre class="example">     { 1 2   4 5 } *     { 1 1 2 2 3 3 } *
     {   2 3 4   } =     { 1   2   3   } =
     ---------------     -----------------
     {   2   4   }       { 1   2   3   }
</pre>
   <div class="defun">
&mdash; Proc: <b>utp_iterator_difference</b><var> self one two<a name="index-utp_005fiterator_005fdifference-170"></a></var><br>
<blockquote><p>Initialise a difference iterator; the resulting iterator will visit all
the elements from <var>one</var> that are not present in <var>two</var>.  If an
element from <var>two</var> matches multiple elements in <var>one</var>: only one
element of <var>one</var> is removed. 
</p></blockquote></div>

   <p>Examples of difference:

<!-- *NOTE* the misalignment of the horizontal lines is due to the -->
<!-- quoting of the braces! In the output it goes away. -->
<pre class="example">     { 1 2 3 4 5 } -     { 1 1 2 2 3 3 } -      { 1 2 2 2 3 } -
     { 1 2 3     } =     { 1   2   3   } =      { 1 2     3 } =
     ---------------     -----------------      ---------------
     {       4 5 }       {   1   2   3 }        {     2 2   }
</pre>
   <div class="defun">
&mdash; Proc: <b>utp_iterator_complintersect</b><var> self one two<a name="index-utp_005fiterator_005fcomplintersect-171"></a></var><br>
<blockquote><p>Initialise a complementary intersection iterator; the resulting iterator
will visit all the elements from the two sequences that are not common
to both of them. 
</p></blockquote></div>

   <p>Examples of complementary intersection:

<!-- *NOTE* the misalignment of the horizontal lines is due to the -->
<!-- quoting of the braces! In the output it goes away. -->
<pre class="example">     { 1 2   4 5 } *     { 1 1 2 2 3 3 } *
     {   2 3 4   } =     { 1   2   3   } =
     ---------------     -----------------
     { 1   3   5 }       {   1   2   3 }
</pre>
   <!--  -->
<h5 class="subsubheading">Composition</h5>

<p>It is possible to compose iterators to realise complex set operations,
for example: the following code intersects an iterator with a union
iterator:

<pre class="example">     utp_iterator_t* one two three four five
     
     utp_iterator_list $one    { 0   2   4     7   9    }
     utp_iterator_list $two    {   1   3   5     8   10 }
     utp_iterator_list $three  {         4   6 7        }
     
     utp_iterator_union $four $one $two
     utp_iterator_intersection $five $four $three
     
     set elms {}
     while { [utp_iterator_next $five out } {
         lappend elms $out
     }
     # elms -&gt; { 4 7 }
</pre>
   <!-- page -->
<div class="node">
<a name="observer"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#task">task</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#iterator">iterator</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#design">design</a>

</div>

<h3 class="section">10.2 The Observer design pattern</h3>

<p>This module provides the ability to handle one&ndash;to&ndash;many notification
relations.  It works with two entities: the subject and the observer. 
The subject is a data type instance whose state changes must be notified
to a set of observers.

   <p>The subject is identified by a <acronym>TCL</acronym> symbol, the observer is identified
by a procedure or command.

<div class="defun">
&mdash; Struct Type: <b>utp_observer_t</b><var><a name="index-utp_005fobserver_005ft-172"></a></var><br>
<blockquote><p>Data structure used to store the state of an observer relation. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_observer_init</b><var> self subject ?observer_script <small class="dots">...</small>?<a name="index-utp_005fobserver_005finit-173"></a></var><br>
<blockquote><p>Initialise an already declared observer structure.  Register the
<var>subject</var> and a list of <var>observer_scripts</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_observer_attach</b><var> self observer_script<a name="index-utp_005fobserver_005fattach-174"></a></var><br>
&mdash; Method on <code>utp_observer_t</code>: <b>attach</b><var> observer_script<a name="index-attach-175"></a></var><br>
<blockquote><p>Attach an observer to the subject. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_observer_detach</b><var> self observer_script<a name="index-utp_005fobserver_005fdetach-176"></a></var><br>
&mdash; Method on <code>utp_observer_t</code>: <b>detach</b><var> observer_script<a name="index-detach-177"></a></var><br>
<blockquote><p>Detach an observer from the subject. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_observer_notify</b><var> self ?arg <small class="dots">...</small>?<a name="index-utp_005fobserver_005fnotify-178"></a></var><br>
&mdash; Method on <code>utp_observer_t</code>: <b>notify</b><var> ?arg <small class="dots">...</small>?<a name="index-notify-179"></a></var><br>
<blockquote><p>Evaluate all the registered observer scripts in the global namespace;
the subject is appended to the script as argument.

        <p>Optional arguments can be appended to the invocation of this procedure,
but they are ignored: this is to allow the procedure to be used as
command in variable traces. 
</p></blockquote></div>

   <p>Example:

<pre class="example">     set state 0
     
     proc bushwhacker { subject } {
         ...
     }
     
     utp_observer_t* o
     utp_observer_init $o ::state { bushwhacker }
     # the following invokes: [bushwhacker ::state]
     $o.notify
     unset $o
</pre>
   <!--  -->
<h5 class="subsubheading">Pushing or pulling notifications</h5>

<p>There's choice in selecting which one between the subject and the
observer will trigger the notification, that is: which one will invoke
<code>[utp_observer_notify]</code>.  This is especially relevant when the
observed state is complex.

   <p>If the subject does it: small changes to the state will trigger the
invocation of all the observer scripts; observers not interested in
changes will be notified.  If an observer does it: all the observers
will be notified, not only the requesting one.

   <p>These problems can be solved by mapping parts of the observed state to
multiple symbols, and creating a one&ndash;to&ndash;many relation for each of
them.  This results in many observer objects allocations.

<!--  -->
<h5 class="subsubheading">Describing state changes</h5>

<p>The notification operation provides no direct way to inform the
observers about which state change has occurred.  One way to simplify
this problem is to use a <acronym>UTP</acronym> struct as state and allocate a field in
it to signal the last change, that is: the last transition from one
state to another (see <a href="#sm">sm</a>).

<!--  -->
<h5 class="subsubheading">Detaching observers</h5>

<p>It is not safe to simply destroy a relation without notifying all the
observers.  Avoiding the notification to the subject may be safe,
though.

   <p>The best method is to let the observers detach themselves.  For example
when the subject is destroyed, it can set its state to <code>finalised</code>
and then invoke <code>[utp_observer_notify]</code>: each observer recognises
the state and detaches itself with <code>[utp_observer_detach]</code>.

<!-- page -->
<div class="node">
<a name="task"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#factory">factory</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#observer">observer</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#design">design</a>

</div>

<h3 class="section">10.3 Handling job private variables</h3>

<p>This module provides the ability to create a set of variables and
restrict access to them to a set of procedures.  This is similar to the
creation of structure or a namespace used to hold instance private
variables.  This module makes use of the implicit token model
(see <a href="#token-implicit">token implicit</a>).

<ul class="menu">
<li><a accesskey="1" href="#task-token">task token</a>:                   Token handling
<li><a accesskey="2" href="#task-interface">task interface</a>:               Interface procedures. 
<li><a accesskey="3" href="#task-examples">task examples</a>:                Usage examples. 
</ul>

<!-- page -->
<div class="node">
<a name="task-token"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#task-interface">task interface</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#task">task</a>

</div>

<h4 class="subsection">10.3.1 Token hanling</h4>

<div class="defun">
&mdash; Struct: <b>utp_task_t</b><var><a name="index-utp_005ftask_005ft-180"></a></var><br>
<blockquote><p>The type of task structure.  Two fields are private and their names
should not be used as task variable names: <code>__vars</code>,
<code>working_directory</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Variable: <b>utp_task_token</b><var><a name="index-utp_005ftask_005ftoken-181"></a></var><br>
<blockquote><p>The global variable used to store the currently selected task token. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_task_switch_token</b><var> self<a name="index-utp_005ftask_005fswitch_005ftoken-182"></a></var><br>
<blockquote><p>Store <var>self</var> in <code>utp_task_token</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_task_switch_command</b><var><a name="index-utp_005ftask_005fswitch_005fcommand-183"></a></var><br>
<blockquote><p>Return a script that, if evaluated in the global namespace, activates
the current token. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="task-interface"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#task-examples">task examples</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#task-token">task token</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#task">task</a>

</div>

<h4 class="subsection">10.3.2 Interface procedures</h4>

<div class="defun">
&mdash; Proc: <b>utp_task_init</b><var> local_name ?local_name <small class="dots">...</small>?<a name="index-utp_005ftask_005finit-184"></a></var><br>
<blockquote><p>Initialiase the currently selected task.  The arguments are variable
names that are linked to the scope of the caller.  This procedure
behaves exactly like <code>[global]</code>: variables are not created, just
linked to the current scope.

        <p><var>local_name</var> is the public name of the variable, the real name is the
one of a variable in a private namespace. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_task_alloc_switch_init</b><var> selfvar local_name ?local_name <small class="dots">...</small>?<a name="index-utp_005ftask_005falloc_005fswitch_005finit-185"></a></var><br>
<blockquote><p>Allocate a new task, select it as current and initialise it with the
given arguments.  The task token is stored in <var>selfvar</var> in the scope
of the caller. 
</p></blockquote></div>

   <p>After initialisation: the caller must assign a value, even the empty
string, or create the array so that the variables are really created;
failure in doing this will cause an error when trying to access the
variable with <code>[utp_task_global]</code>.

<div class="defun">
&mdash; Proc: <b>utp_task_global</b><var> local_name ?local_name <small class="dots">...</small>?<a name="index-utp_005ftask_005fglobal-186"></a></var><br>
<blockquote><p>Link task&ndash;specific variables in the scope of the caller.  This
procedure behaves exactly like <code>[global]</code>: variables are not
created, just linked to the current scope.  Each <var>local_name</var> must
be one of the names declared in the invocation of
<code>[utp_task_init]</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_task_globname</b><var> local_name<a name="index-utp_005ftask_005fglobname-187"></a></var><br>
<blockquote><p>Return the real global name of a task variable; this name is prefixed
with <code>::</code>, so it can be used directly to access the variable. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_task_vwait</b><var> local_name<a name="index-utp_005ftask_005fvwait-188"></a></var><br>
<blockquote><p>Invoke <code>[vwait]</code> on the real variable associated with
<var>local_name</var>.  The procedure can be resumed by setting a value into
<var>local_name</var>.  Return the empty string. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_task_cd</b><var> ?directory?<a name="index-utp_005ftask_005fcd-189"></a></var><br>
<blockquote><p>Change directory, with <code>[cd]</code>, to the one associated to the task. 
<var>directory</var> becomes the new task directory; before using it: it is
normalised with respect to the current task directory. 
</p></blockquote></div>

   <p>The following two procedures are good to create aliases.

<div class="defun">
&mdash; Proc: <b>utp_task_globset</b><var> local_name value<a name="index-utp_005ftask_005fglobset-190"></a></var><br>
<blockquote><p>Store a new value in a non&ndash;array variable.  This procedure allows
access to task variables without linking them to the current scope. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_task_globget</b><var> local_name<a name="index-utp_005ftask_005fglobget-191"></a></var><br>
<blockquote><p>Return the value in a non&ndash;array variable.  This procedure allows access
to task variables without linking them to the current scope. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="task-examples"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#task-interface">task interface</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#task">task</a>

</div>

<h4 class="subsection">10.3.3 Usage examples</h4>

<p>A usage example:

<pre class="example">     utp_task_t* task
     utp_task_switch_token $task
     utp_task_init red blue
     
     proc one {} {
         utp_task_global red blue
         set red abc
         set blue def
     }
     proc this {} {
         that
     }
     proc that {} {
         utp_task_global blue
     
         puts "value: $blue"
     }
     
     one
     this
     that
     unset $task
</pre>
   <!-- page -->
<div class="node">
<a name="cache"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#workers">workers</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#factory">factory</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#design">design</a>

</div>

<h3 class="section">10.4 Caching objects</h3>

<p>This module implements a cache: a stack of values that can be: acquired,
used, reinitialised, and finally put back on the cache.  A cache offers
hysteresis in the creation and destruction operations: objects are
created only when the cache is empty and destroyed only when the cache
is full.  A configurable watermark can be used to fill the cache to a
required level.

<!--  -->
<h5 class="subsubheading">Initialisation and finalisation</h5>

<div class="defun">
&mdash; Struct: <b>utp_cache_t</b><var><a name="index-utp_005fcache_005ft-192"></a></var><br>
<blockquote><p>The type of cache structures. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_init</b><var> cache factory<a name="index-utp_005fcache_005finit-193"></a></var><br>
<blockquote><p>Initialise an already allocated cache structure.  <var>factory</var> is the
object factory used to build and destroy objects (see <a href="#factory">factory</a>). 
</p></blockquote></div>

   <p>Upon finalisation: all the objects are destroyed; the factory is
<strong>not</strong> finalised.

<!--  -->
<h5 class="subsubheading">Configuration</h5>

<div class="defun">
&mdash; Struct: <b>utp_cache_config_t</b><var><a name="index-utp_005fcache_005fconfig_005ft-194"></a></var><br>
<blockquote><p>Cache configuration structure.  Public fields:

          <dl>
<dt><code>utp_pinteger_t watermark</code><dd>The watermark level

          <br><dt><code>utp_pinteger_t maximum</code><dd>The maximum level. 
</dl>
        </p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_config_init</b><var> config cache<a name="index-utp_005fcache_005fconfig_005finit-195"></a></var><br>
<blockquote><p>Initialise and already allocated configuration structure from
<var>cache</var>; store the cache configuration values in <var>config</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_config_commit</b><var> config<a name="index-utp_005fcache_005fconfig_005fcommit-196"></a></var><br>
&mdash; Method on <code>utp_cache_config_t</code>: <b>commit</b><var><a name="index-commit-197"></a></var><br>
<blockquote><p>Update the current configuration of the cache according to the values in
<var>config</var>.  Changes:

          <ul>
<li>If the number of objects in the cache is above the maximum: the objects
in excess are destroyed. 
</ul>
        </p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_config_set_watermark</b><var> config watermark<a name="index-utp_005fcache_005fconfig_005fset_005fwatermark-198"></a></var><br>
&mdash; Proc: <b>utp_cache_config_get_watermark</b><var> config<a name="index-utp_005fcache_005fconfig_005fget_005fwatermark-199"></a></var><br>
<blockquote><p>Set/get the watermark level. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_config_set_maximum</b><var> config maximum<a name="index-utp_005fcache_005fconfig_005fset_005fmaximum-200"></a></var><br>
&mdash; Proc: <b>utp_cache_config_get_maximum</b><var> config<a name="index-utp_005fcache_005fconfig_005fget_005fmaximum-201"></a></var><br>
<blockquote><p>Set/get the maximum number of objects. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_config_validate</b><var> config<a name="index-utp_005fcache_005fconfig_005fvalidate-202"></a></var><br>
&mdash; Method on <code>utp_cache_config_t</code>: <b>validate</b><var><a name="index-validate-203"></a></var><br>
<blockquote><p>Validate the values in <var>config</var>. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Filling</h5>

<div class="defun">
&mdash; Proc: <b>utp_cache_fill_to_watermark</b><var> cache<a name="index-utp_005fcache_005ffill_005fto_005fwatermark-204"></a></var><br>
&mdash; Method on <code>utp_cache_t</code>: <b>fill_to_watermark</b><var><a name="index-fill_005fto_005fwatermark-205"></a></var><br>
<blockquote><p>Fill or purge the cache until it is at the watermark level. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_fill_to_maximum</b><var> cache<a name="index-utp_005fcache_005ffill_005fto_005fmaximum-206"></a></var><br>
&mdash; Method on <code>utp_cache_t</code>: <b>fill_to_maximum</b><var><a name="index-fill_005fto_005fmaximum-207"></a></var><br>
<blockquote><p>Fill or purge the cache until it is at the configured maximum. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_purge</b><var> cache<a name="index-utp_005fcache_005fpurge-208"></a></var><br>
&mdash; Method on <code>utp_cache_t</code>: <b>purge</b><var><a name="index-purge-209"></a></var><br>
<blockquote><p>Destroy all the objects in the cache, leaving it emtpy. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_put</b><var> cache<a name="index-utp_005fcache_005fput-210"></a></var><br>
&mdash; Method on <code>utp_cache_t</code>: <b>put</b><var><a name="index-put-211"></a></var><br>
<blockquote><p>If the cache is not full: put a new object on the cache. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_drop</b><var> cache<a name="index-utp_005fcache_005fdrop-212"></a></var><br>
&mdash; Method on <code>utp_cache_t</code>: <b>drop</b><var><a name="index-drop-213"></a></var><br>
<blockquote><p>If the cache is not emtpy: remove an object from cache and destroy it. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Acquire and dismiss</h5>

<div class="defun">
&mdash; Proc: <b>utp_cache_acquire</b><var> cache<a name="index-utp_005fcache_005facquire-214"></a></var><br>
&mdash; Method on <code>utp_cache_config_t</code>: <b>acquire</b><var><a name="index-acquire-215"></a></var><br>
<blockquote><p>Return an object from the cache; if the cache is empty: build a new
object and return it. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_dismiss</b><var> cache object<a name="index-utp_005fcache_005fdismiss-216"></a></var><br>
&mdash; Method on <code>utp_cache_config_t</code>: <b>dismiss</b><var> object<a name="index-dismiss-217"></a></var><br>
<blockquote><p>Put <var>object</var> on the cache; if the cache is full: destroy the object. 
The factory is invoked to reinitialise the object (see <a href="#factory">factory</a> for
details on the reinitialisation script). 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Inspection</h5>

<div class="defun">
&mdash; Proc: <b>utp_cache_is_empty</b><var> self<a name="index-utp_005fcache_005fis_005fempty-218"></a></var><br>
&mdash; Method on <code>utp_cache_config_t</code>: <b>is_empty</b><var><a name="index-is_005fempty-219"></a></var><br>
<blockquote><p>Return true if the cache is empty. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_is_not_empty</b><var> self<a name="index-utp_005fcache_005fis_005fnot_005fempty-220"></a></var><br>
&mdash; Method on <code>utp_cache_config_t</code>: <b>is_not_empty</b><var><a name="index-is_005fnot_005fempty-221"></a></var><br>
<blockquote><p>Return true if the cache is not empty. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_is_full</b><var> self<a name="index-utp_005fcache_005fis_005ffull-222"></a></var><br>
&mdash; Method on <code>utp_cache_config_t</code>: <b>is_full</b><var><a name="index-is_005ffull-223"></a></var><br>
<blockquote><p>Return true if the cache is full. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_is_not_full</b><var> self<a name="index-utp_005fcache_005fis_005fnot_005ffull-224"></a></var><br>
&mdash; Method on <code>utp_cache_config_t</code>: <b>is_not_full</b><var><a name="index-is_005fnot_005ffull-225"></a></var><br>
<blockquote><p>Return true if the cache is not full. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_is_below_watermark</b><var> self<a name="index-utp_005fcache_005fis_005fbelow_005fwatermark-226"></a></var><br>
&mdash; Method on <code>utp_cache_config_t</code>: <b>is_below_watermark</b><var><a name="index-is_005fbelow_005fwatermark-227"></a></var><br>
<blockquote><p>Return true if the cache level is below watermark. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_is_above_watermark</b><var> self<a name="index-utp_005fcache_005fis_005fabove_005fwatermark-228"></a></var><br>
&mdash; Method on <code>utp_cache_config_t</code>: <b>is_above_watermark</b><var><a name="index-is_005fabove_005fwatermark-229"></a></var><br>
<blockquote><p>Return true if the cache level is above watermark. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_is_at_watermark_level</b><var> self<a name="index-utp_005fcache_005fis_005fat_005fwatermark_005flevel-230"></a></var><br>
&mdash; Method on <code>utp_cache_config_t</code>: <b>is_at_watermark_level</b><var><a name="index-is_005fat_005fwatermark_005flevel-231"></a></var><br>
<blockquote><p>Return true if the cache is at watermark level. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_cache_is_not_at_watermark_level</b><var> self<a name="index-utp_005fcache_005fis_005fnot_005fat_005fwatermark_005flevel-232"></a></var><br>
&mdash; Method on <code>utp_cache_config_t</code>: <b>is__not_at_watermark_level</b><var><a name="index-is_005f_005fnot_005fat_005fwatermark_005flevel-233"></a></var><br>
<blockquote><p>Return true if the cache is not watermark level. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="factory"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#cache">cache</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#task">task</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#design">design</a>

</div>

<h3 class="section">10.5 Object factory</h3>

<p>This module implements a very simple object factory.  Three scripts are
used to build, destroy and reinitialise objects; they should not raise
errors; as an example the thread commands provided by the Thread
extension: <code>[thread::create]</code>, <code>[thread::release]</code> can be used
as constructor and destructor scripts; another example are the commands
<code>[interp create]</code> and <code>[interp delete]</code>.

<div class="defun">
&mdash; Struct Typedef: <b>utp_factory_t</b><var><a name="index-utp_005ffactory_005ft-234"></a></var><br>
<blockquote><p>The type of the factory structure. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_factory_init</b><var> factory constructor destructor ?reset?<a name="index-utp_005ffactory_005finit-235"></a></var><br>
<blockquote><p>Initialise an already declared factory.  The reset script is optional
and can be the empty string. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_factory_build_object</b><var> factory ?arg <small class="dots">...</small>?<a name="index-utp_005ffactory_005fbuild_005fobject-236"></a></var><br>
&mdash; Method on <code>utp_factory_t</code>: <b>build_object</b><var> ?arg <small class="dots">...</small>?<a name="index-build_005fobject-237"></a></var><br>
<blockquote><p>Build a new object by invoking the constructor script in the global
namespace; all the optional arguments are appended to the script. 
Return the return value of the script, which should be an object
identifier or the object itself. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_factory_destroy_object</b><var> factory object ?arg <small class="dots">...</small>?<a name="index-utp_005ffactory_005fdestroy_005fobject-238"></a></var><br>
&mdash; Method on <code>utp_factory_t</code>: <b>destroy_object</b><var> ?arg <small class="dots">...</small>?<a name="index-destroy_005fobject-239"></a></var><br>
<blockquote><p>Destroy an object by invoking the destructor script in the global
namespace; all the optional arguments are appended to the script.  The
first argument should be the identifier of the object, or the object
itself. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_factory_reset_object</b><var> factory object ?arg <small class="dots">...</small>?<a name="index-utp_005ffactory_005freset_005fobject-240"></a></var><br>
&mdash; Method on <code>utp_factory_t</code>: <b>reset_object</b><var> ?arg <small class="dots">...</small>?<a name="index-reset_005fobject-241"></a></var><br>
<blockquote><p>Reinitialise an object to its initial state by invoking the reset script
in the global namespace; all the optional arguments are appended to the
script.  The first argument should be the identifier of the object, or
the object itself.

        <p>Return the return value of the script, which should be an object
identifier or the object itself.  If the factory has no reset script:
the object is returned unchanged. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="workers"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#sm">sm</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#cache">cache</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#design">design</a>

</div>

<h3 class="section">10.6 Using a pool of worker items</h3>

<p>The workers module is a wrapper around the cache module (see <a href="#cache">cache</a>)
implementing automatic construction and destruction of cached objects
through a periodic script.  This allows a cache to dinamically fill
itself to keep the number of objects around the configured watermark
level.  This module works with the event loop; if the loop is not
entered it will not work correctly.

   <p>The behaviour of a workers factory is controlled by the following rules:

     <ul>
<li>Upon initialisation the cache is filled to the watermark level.

     <li>Upon finalisation the cache is left untouched.

     <li>Acquisition and dismissal of objects follows the same rules of the
cache.

     <li>After a worker is acquired or released: if the number of entities left
in the cache is different from the watermark level, a procedure is
scheduled in the event loop to be evaluated after a selected period of
time; when it is evaluated, the procedure tests the number of workers in
the cache:

          <ul>
<li>If it's above the watermark level: it destroys a worker and reschedules
itself.

          <li>If it's below the watermark level: it creates a worker and reschedules
itself.

          <li>If it's equal to the watermark level: it does nothing and does not
reschedule itself. 
</ul>
     </ul>

<!--  -->
<h5 class="subsubheading">Interface</h5>

<div class="defun">
&mdash; Struct: <b>utp_workers_t</b><var><a name="index-utp_005fworkers_005ft-242"></a></var><br>
<blockquote><p>Workers cache structure. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_workers_init</b><var> workers cache<a name="index-utp_005fworkers_005finit-243"></a></var><br>
<blockquote><p>Initialise an already allocated workers cache; <var>cache</var> must be the
token of an already initialised cache. 
</p></blockquote></div>

   <p>Upon finalisation: the cache is left untouched.

<div class="defun">
&mdash; Proc: <b>utp_workers_acquire</b><var> workers<a name="index-utp_005fworkers_005facquire-244"></a></var><br>
&mdash; Method on <code>utp_workers_t</code>: <b>acquire</b><var><a name="index-acquire-245"></a></var><br>
<blockquote><p>Acquire one of the workers in the pool or create a new worker; return
the identifier of the new worker.  If the number of workers in the cache
is different from the watermark number: the hysteresis procedure is
scheduled. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_workers_release</b><var> workers worker<a name="index-utp_005fworkers_005frelease-246"></a></var><br>
&mdash; Method on <code>utp_workers_t</code>: <b>release</b><var> worker<a name="index-release-247"></a></var><br>
<blockquote><p>Release a worker.  If the number of workers in the cache is greater than
the selected maximum number: the worker is destroyed; else it is stored
in the cache.  If the number of workers in the cache is different from
the watermark number: the hysteresis procedure is scheduled. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Configuration</h5>

<div class="defun">
&mdash; Struct Typedef: <b>utp_workers_config_t</b><var><a name="index-utp_005fworkers_005fconfig_005ft-248"></a></var><br>
<blockquote><p>Configuration structure of a workers cache.  Public fields:

          <dl>
<dt><code>utp_pzinteger_t period</code><dd>The scheduling period. 
</dl>
        </p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_workers_config_init</b><var> config workers<a name="index-utp_005fworkers_005fconfig_005finit-249"></a></var><br>
<blockquote><p>Create a new configuration structure from <var>workers</var>; store the
configuration token in <var>config</var>, which must be an already allocated
config structure. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_workers_config_commit</b><var> config<a name="index-utp_005fworkers_005fconfig_005fcommit-250"></a></var><br>
&mdash; Method on <code>utp_workers_config_t</code>: <b>commit</b><var><a name="index-commit-251"></a></var><br>
<blockquote><p>Update the configuration. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_workers_config_set_period</b><var> config period<a name="index-utp_005fworkers_005fconfig_005fset_005fperiod-252"></a></var><br>
<blockquote><p>Configure the scheduling period of the hysteresis script. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_workers_config_get_period</b><var> config<a name="index-utp_005fworkers_005fconfig_005fget_005fperiod-253"></a></var><br>
<blockquote><p>Return the current value of the scheduling period of the hysteresis
script. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="sm"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#option">option</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#workers">workers</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#design">design</a>

</div>

<h3 class="section">10.7 Managing state machines</h3>

<p>The state machine module offers an infrastructure to store the structure
of simple state machines.  A state machine is an oriented graph: states
are represented by nodes, transitions by links.  When a node is entered:
a script is evaluated; when a node is left: a script is evaluated.

<div class="defun">
&mdash; Struct: <b>utp_sm_t</b><var><a name="index-utp_005fsm_005ft-254"></a></var><br>
<blockquote><p>State machine structure. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_sm_register_node</b><var> sm name value enter leave<a name="index-utp_005fsm_005fregister_005fnode-255"></a></var><br>
<blockquote><p>Register a new node in the <var>sm</var> state machine; <var>sm</var> must be the
token of a <code>utp_sm_t</code> structure.

        <p><var>name</var> is the identifier of the node: it can be any string without
colon (<code>:</code>) characters in it; it is better to choose meaningful
node names.  If a node already exists with the selected name: it is
overwritten.

        <p><var>value</var> is the node's value: any value we want to associate to the
node; it can be the empty string.

        <p><var>enter</var> and <var>leave</var> are scripts evaluated, as they are, in the
global namespace whenever the node is entered or left.  The scripts can
return with an error condition, but should not add/remove nodes or
transitions; the scripts can be the empty string. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_sm_register_transition</b><var> sm from to value travel<a name="index-utp_005fsm_005fregister_005ftransition-256"></a></var><br>
<blockquote><p>Register a transition between the nodes <var>from</var> and <var>to</var> in the
<var>sm</var> state machine; <var>sm</var> must be the token of a <code>utp_sm_t</code>
structure.

        <p><var>value</var> is the transition's value: any value we want to associate to
it; it can be the empty string.

        <p><var>travel</var> is a script evaluated, as it is, in the global namespace
whenever the transition is performed.  The script can return with error
condition, but should not modify the state machine; the script can be
the empty string. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_sm_set_current</b><var> sm node_name<a name="index-utp_005fsm_005fset_005fcurrent-257"></a></var><br>
<blockquote><p>Select a node to be the current state.  This procedure does not invoke
the node's scripts. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_sm_enter_current</b><var> sm<a name="index-utp_005fsm_005fenter_005fcurrent-258"></a></var><br>
<blockquote><p>Evaluate the enter script for the current node.  Useful to start a state
machine. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_sm_get_current</b><var> sm<a name="index-utp_005fsm_005fget_005fcurrent-259"></a></var><br>
<blockquote><p>Return the name of the current node. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_sm_transition</b><var> sm to<a name="index-utp_005fsm_005ftransition-260"></a></var><br>
<blockquote><p>Execute a transition from the current node to <var>to</var>; the transition
must exist.  The following operations are performed:

          <ol type=1 start=1>
<li>The leave script of the old current node is evaluated.

          <li>The travel script of the transition is evaluated.

          <li>The enter script of the <var>to</var> node is evaluated.

          <li>The <var>to</var> node is registered as current.
             </ol>

        <p>If a script returns with an error condition: the subsequent scripts are
not evaluated and the current node is not changed. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_sm_node_value</b><var> sm name<a name="index-utp_005fsm_005fnode_005fvalue-261"></a></var><br>
<blockquote><p>Return the value of a node. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_sm_transition_value</b><var> sm from to<a name="index-utp_005fsm_005ftransition_005fvalue-262"></a></var><br>
<blockquote><p>Return the value of a transition between two nodes. 
</p></blockquote></div>

   <p>By using the event loop we may enter the execution of state machine
scripts and leave only when some condition occurs; to do this we should
schedule scripts in the event loop from the enter/leave scripts of the
nodes.

<!-- page -->
<div class="node">
<a name="option"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#sm">sm</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#design">design</a>

</div>

<h3 class="section">10.8 Handling tables of options</h3>

<p>This module organises the search upon an array in a way suitable to
handle a table of options, similarly to the one handled by the
<code>[option]</code> command of <acronym>TK</acronym>.  This module uses the implicit token
model (see <a href="#token-implicit">token implicit</a>).  Examples:

<pre class="example">     utp_option_db_t* db
     utp_option_switch_token $db
     
     utp_option_set text 1 One Two Three
     utp_option_set text 2 Two Three
     utp_option_set text 3 Three
     utp_option_set text 9
     
     utp_option_get text One Two Three    ;# -&gt; 1
     utp_option_get text Two Three        ;# -&gt; 2
     utp_option_get text Three            ;# -&gt; 3
     utp_option_get text Four             ;# -&gt; 9
</pre>
   <div class="defun">
&mdash; Struct: <b>utp_option_db_t</b><var><a name="index-utp_005foption_005fdb_005ft-263"></a></var><br>
<blockquote><p>Option database. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_option_switch_token</b><var> db<a name="index-utp_005foption_005fswitch_005ftoken-264"></a></var><br>
<blockquote><p>Select <var>db</var> as the current option database. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_option_set</b><var> name value ?class <small class="dots">...</small>?<a name="index-utp_005foption_005fset-265"></a></var><br>
<blockquote><p>Register <var>value</var> for the option <var>name</var>, associating it to the
option <var>class</var>.  Any number of classes can be given; if no class is
selected the option is associated to the special class <code>*</code>, which
is used to select default values. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_option_get</b><var> name ?class <small class="dots">...</small>?<a name="index-utp_005foption_005fget-266"></a></var><br>
<blockquote><p>Return the value of the option <var>name</var> associated to the selected
classes.  If the selected classes do not exist: the value associated to
the special class <code>*</code> is tried.  If no value is found: return the
empty string. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="file"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#parsers">parsers</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#design">design</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">11 File related packages</h2>

<ul class="menu">
<li><a accesskey="1" href="#channel">channel</a>:                      Chennel related procedures. 
<li><a accesskey="2" href="#file-procs">file procs</a>:                   File related procedures. 
<li><a accesskey="3" href="#lock-files">lock files</a>:                   Creating lock files. 
</ul>

<!-- page -->
<div class="node">
<a name="channel"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#file-procs">file procs</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#file">file</a>

</div>

<h3 class="section">11.1 Chennel related procedures</h3>

<ul class="menu">
<li><a accesskey="1" href="#channel-basic">channel basic</a>:                Basic channel operations. 
<li><a accesskey="2" href="#channel-other">channel other</a>:                Other non--basic operations. 
<li><a accesskey="3" href="#channel-events">channel events</a>:               Event handlers for channel events. 
<li><a accesskey="4" href="#channel-configure">channel configure</a>:            Configuring a channel. 
<li><a accesskey="5" href="#channel-seeking">channel seeking</a>:              Moving the pointer. 
</ul>

<!-- page -->
<div class="node">
<a name="channel-basic"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#channel-other">channel other</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#channel">channel</a>

</div>

<h4 class="subsection">11.1.1 Basic channel operations</h4>

<p>The following functions differ from the <acronym>TCL</acronym> built-ins by error
handling: if an error occurs they return with an error condition of code
<code>RUNTIME</code>.

<div class="defun">
&mdash; Proc: <b>utp_channel_open</b><var> filename mode<a name="index-utp_005fchannel_005fopen-267"></a></var><br>
<blockquote><p>Open the file named <var>filename</var>, with mode <var>mode</var> return the
channel identifier. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_channel_close</b><var> channel<a name="index-utp_005fchannel_005fclose-268"></a></var><br>
<blockquote><p>Close the channel whose identifier is <var>channel</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_channel_write</b><var> channel data<a name="index-utp_005fchannel_005fwrite-269"></a></var><br>
<blockquote><p>Write <var>data</var> in an output channel, with no newline appended. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_channel_read</b><var> channel<a name="index-utp_005fchannel_005fread-270"></a></var><br>
<blockquote><p>Read all the data from the <var>channel</var> and return it. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="channel-other"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#channel-events">channel events</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#channel-basic">channel basic</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#channel">channel</a>

</div>

<h4 class="subsection">11.1.2 Other non&ndash;basic operations</h4>

<p>The following functions differ from the <acronym>TCL</acronym> built-ins by error
handling: if an error occurs they return with an error condition of code
<code>RUNTIME</code>.

<div class="defun">
&mdash; Proc: <b>utp_channel_readnum</b><var> channel num<a name="index-utp_005fchannel_005freadnum-271"></a></var><br>
<blockquote><p>Read <var>num</var> bytes of data from the <var>channel</var> and return them. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_channel_gets</b><var> channel<a name="index-utp_005fchannel_005fgets-272"></a></var><br>
<blockquote><p>Read a line from the <var>channel</var> and return it. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_channel_flush</b><var> channel<a name="index-utp_005fchannel_005fflush-273"></a></var><br>
<blockquote><p>Flush all the buffered data for <var>channel</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_channel_eof</b><var> channel<a name="index-utp_005fchannel_005feof-274"></a></var><br>
<blockquote><p>Return true if the channel is in <acronym>EOF</acronym>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_channel_write_and_flush</b><var> channel data<a name="index-utp_005fchannel_005fwrite_005fand_005fflush-275"></a></var><br>
<blockquote><p>Write <var>data</var>, with no newline appended, and flush the channel. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="channel-events"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#channel-configure">channel configure</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#channel-other">channel other</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#channel">channel</a>

</div>

<h4 class="subsection">11.1.3 Event handlers for channel events</h4>

<div class="defun">
&mdash; Proc: <b>utp_channel_readable_event</b><var> channel script<a name="index-utp_005fchannel_005freadable_005fevent-276"></a></var><br>
<blockquote><p>Register a script for the readable event. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_channel_writable_event</b><var> channel script<a name="index-utp_005fchannel_005fwritable_005fevent-277"></a></var><br>
<blockquote><p>Register a script for the writable event. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_channel_reset_event_handlers</b><var> channel<a name="index-utp_005fchannel_005freset_005fevent_005fhandlers-278"></a></var><br>
<blockquote><p>Reset both the readable and writable event handlers to the empty string;
that is: ignore the events. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="channel-configure"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#channel-seeking">channel seeking</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#channel-events">channel events</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#channel">channel</a>

</div>

<h4 class="subsection">11.1.4 Configuring a channel</h4>

<div class="defun">
&mdash; Proc: <b>utp_channel_configure</b><var> channel arg <small class="dots">...</small><a name="index-utp_005fchannel_005fconfigure-279"></a></var><br>
<blockquote><p>Configure a channel. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_channel_fcopy_configure</b><var> channel<a name="index-utp_005fchannel_005ffcopy_005fconfigure-280"></a></var><br>
<blockquote><p>Reset the event handlers and configure the channel for binary transfer. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="channel-seeking"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#channel-configure">channel configure</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#channel">channel</a>

</div>

<h4 class="subsection">11.1.5 Moving the pointer</h4>

<div class="defun">
&mdash; Proc: <b>utp_channel_seek</b><var> channel position<a name="index-utp_005fchannel_005fseek-281"></a></var><br>
<blockquote><p>Seek a channel cursor. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_channel_tell</b><var> channel<a name="index-utp_005fchannel_005ftell-282"></a></var><br>
<blockquote><p>Return the current position of the channel cursor. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="file-procs"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#lock-files">lock files</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#channel">channel</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#file">file</a>

</div>

<h3 class="section">11.2 File related procedures</h3>

<ul class="menu">
<li><a accesskey="1" href="#file-rw">file rw</a>:                      Reading and writing. 
<li><a accesskey="2" href="#file-inspect">file inspect</a>:                 Inspection. 
<li><a accesskey="3" href="#file-norm">file norm</a>:                    Normalisation. 
<li><a accesskey="4" href="#file-load">file load</a>:                    Loading input files. 
<li><a accesskey="5" href="#file-output">file output</a>:                  Output files. 
<li><a accesskey="6" href="#file-misc">file misc</a>:                    Miscellaneous. 
</ul>

<!-- page -->
<div class="node">
<a name="file-rw"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#file-inspect">file inspect</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#file-procs">file procs</a>

</div>

<h4 class="subsection">11.2.1 Reading and writing</h4>

<div class="defun">
&mdash; Proc: <b>utp_file_create</b><var> filename ?permissions?<a name="index-utp_005ffile_005fcreate-283"></a></var><br>
<blockquote><p>Create a file; if the file already exists an error is returned. 
Permissions are set to <var>permissions</var> (which defaults to
<code>0600</code>). 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_file_read</b><var> filename ?bufvar?<a name="index-utp_005ffile_005fread-284"></a></var><br>
<blockquote><p>Load and return the contents of <var>filename</var>.  If <var>bufvar</var> is
used: a variable with that name is created in the scope of the caller
and set to the file contents. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_file_write</b><var> filename data<a name="index-utp_005ffile_005fwrite-285"></a></var><br>
<blockquote><p>Write <var>data</var> in <var>filename</var> overwriting previous contents.  It's
an error if the file does not exist. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_file_append</b><var> filename data<a name="index-utp_005ffile_005fappend-286"></a></var><br>
<blockquote><p>Append <var>data</var> to <var>filename</var>.  It's an error if the file does not
exist. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="file-inspect"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#file-norm">file norm</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#file-rw">file rw</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#file-procs">file procs</a>

</div>

<h4 class="subsection">11.2.2 Inspection</h4>

<div class="defun">
&mdash; Proc: <b>utp_file_size</b><var> filename<a name="index-utp_005ffile_005fsize-287"></a></var><br>
<blockquote><p>Return the file size. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_file_issubdir</b><var> parent child<a name="index-utp_005ffile_005fissubdir-288"></a></var><br>
<blockquote><p>Return true if <var>child</var> is a subdirectory of <var>parent</var>.  The two
directories need not exist at the time of the call, the test is done on
the directory pathnames only.  Relative pathnames are treated as
relative to the current directory. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_file_is_owned_writable_directory</b><var> pathname<a name="index-utp_005ffile_005fis_005fowned_005fwritable_005fdirectory-289"></a></var><br>
<blockquote><p>Return true if <var>pathname</var> is a writable directory owned by the user
to which the process belongs. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_file_is_owned_writable_file</b><var> pathname<a name="index-utp_005ffile_005fis_005fowned_005fwritable_005ffile-290"></a></var><br>
<blockquote><p>Return true if <var>pathname</var> is a writable file owned by the user to
which the process belongs. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_file_is_owned_readable_directory</b><var> pathname<a name="index-utp_005ffile_005fis_005fowned_005freadable_005fdirectory-291"></a></var><br>
<blockquote><p>Return true if <var>pathname</var> is a readable directory owned by the user
to which the process belongs. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_file_is_owned_readable_file</b><var> pathname<a name="index-utp_005ffile_005fis_005fowned_005freadable_005ffile-292"></a></var><br>
<blockquote><p>Return true if <var>pathname</var> is a writable directory owned by the user
to which the process belongs. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="file-norm"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#file-load">file load</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#file-inspect">file inspect</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#file-procs">file procs</a>

</div>

<h4 class="subsection">11.2.3 Normalisation</h4>

<div class="defun">
&mdash; Proc: <b>utp_file_normalise</b><var> directory pathname<a name="index-utp_005ffile_005fnormalise-293"></a></var><br>
<blockquote><p>Normalise a pathname.  If <var>pathname</var> is relative, prepend to it the
given <var>directory</var>.  This is useful to treat pathnames relative to a
directory different from the current process directory, eliminating the
need of <code>[cd]</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_file_normalise_link</b><var> directory pathname<a name="index-utp_005ffile_005fnormalise_005flink-294"></a></var><br>
<blockquote><p>Normalise a pathname.  If <var>pathname</var> is relative, prepend to it the
given <var>directory</var>.  This is useful to treat pathnames relative to a
directory different from the current process directory, eliminating the
need of <code>[cd]</code>.

        <p>If the <var>pathname</var> is a symbolic link, the referenced pathname is
normalised and returned. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="file-load"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#file-output">file output</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#file-norm">file norm</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#file-procs">file procs</a>

</div>

<h4 class="subsection">11.2.4 Loading input files</h4>

<div class="defun">
&mdash; Proc: <b>utp_file_update_search_path</b><var> path_list envvar<a name="index-utp_005ffile_005fupdate_005fsearch_005fpath-295"></a></var><br>
<blockquote><p>Update a search path for files.  <var>path_list</var> is a predefined list of
directories.

        <p><var>envvar</var> is the name of a <acronym>TCL</acronym> variable in the scope of the caller
which, if it exists, must hold a colon&ndash;separated list of directories or
the empty string.  A way of setting this variable is to make it an alias
of an element in the <code>env</code> built in array:

     <pre class="example">          upvar ::env(MY_SEARCH_PATH) search_path
          utp_file_update_search_path { . } search_path
</pre>
        <p>All the directories are checked for existance and readability, then
normalised with respect to the current directory (<code>[pwd]</code>).  The
returned value is a list of valid and normalised directories. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_file_find_in_search_path</b><var> file_list search_path<a name="index-utp_005ffile_005ffind_005fin_005fsearch_005fpath-296"></a></var><br>
<blockquote><p>Search all the file names in <var>file_list</var> verifying existence and
readability; if a file does not exist or it is not readable: an error is
returned.  File names that are not relative to the current directory are
searched in each of the directories in <var>search_path</var>.  Return the
list of normalised file names.

        <p>As a special case: if <code>-</code> is in <var>file_list</var>, it is left in. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_file_load_input_files</b><var> command_line_arguments<a name="index-utp_005ffile_005fload_005finput_005ffiles-297"></a></var><br>
<blockquote><p>Treat its argument as a list of file names, with <code>-</code> meaning the
standard input of the process, and read all of them.  The file contents
are appended to a list that's returned if no error occurs.  The standard
input is read only once: if <code>-</code> is used more than once an error is
returned. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="file-output"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#file-misc">file misc</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#file-load">file load</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#file-procs">file procs</a>

</div>

<h4 class="subsection">11.2.5 Output files</h4>

<div class="defun">
&mdash; Proc: <b>utp_file_write_output</b><var> file_name buffer<a name="index-utp_005ffile_005fwrite_005foutput-298"></a></var><br>
<blockquote><p>Write an output file.  If <var>file_name</var> is <code>-</code> or the empty
string, then <var>buffer</var> is written to the standard output channel
(<code>stdout</code>).  Else <var>file_name</var> is checked for existence and
writability: if it does not exists, a file is written; if it exists and
is writable: it is backed up with <code>[utp_file_backup]</code> and
overwritten.

        <p>This procedure does not overwrite read&ndash;only files. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="file-misc"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#file-output">file output</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#file-procs">file procs</a>

</div>

<h4 class="subsection">11.2.6 Miscellaneous</h4>

<div class="defun">
&mdash; Proc: <b>utp_file_backup</b><var> filename keep_number ?directory?<a name="index-utp_005ffile_005fbackup-299"></a></var><br>
<blockquote><p>Do backup copies of a file.  The original file is never deleted nor
renamed, only copies are created.

        <p><var>filename</var> is the file to backup.  <var>keep_number</var> is the count of
numbered copies to keep.  <var>directory</var> is the pathname of the
directory in which backup copies must be created, if not given it
defaults to the directory in which the original file resides.

        <p>The sequence of backup copies will be rotated with names like:

     <pre class="example">          source       -&gt; source~
          source~      -&gt; source.~1~
          source.~1~   -&gt; source.~2~
          source.~2~   -&gt; source.~3~
</pre>
        <p>If, for example, <samp><span class="file">source.~1~</span></samp> doesn't exist, <samp><span class="file">"source.~2~</span></samp>
isn't renamed to <samp><span class="file">source.~3~</span></samp> because there's no need to purge this
copy.

        <p>Return true if an error occurs rotating the copies; otherwise return
false.

        <p>At present nothing is done to prevent conflicting file names to cause a
mess when using the <var>directory</var> argument.  If we use the same
directory to store copies of files from different directories nasty
things can happen if two files have the same name.  Maybe a wrapper for
this procedure could map source directories to subdirectories of the
backup files repository. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_file_tmpname</b><var> ?directory?<a name="index-utp_005ffile_005ftmpname-300"></a></var><br>
<blockquote><p>Build and return a temporary pathname; the optional argument
<var>directory</var> is the parent directory of the temporary name, it
defaults to the current directory. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_file_find</b><var> topdirs ?arg <small class="dots">...</small>?<a name="index-utp_005ffile_005ffind-301"></a></var><br>
<blockquote><p>A <acronym>TCL</acronym> implementation of <acronym>GNU</acronym> <samp><span class="command">find</span></samp>.  Select pathnames from
a list of directories.  <var>topdirs</var> is the list of top directories
into which perform the file search, <var>arg</var>s are options.  Return the
list of found files/directories.

        <p>Supported options:

          <dl>
<dt><code>-name PATTERN</code><dt><code>-iname PATTERN</code><dd>Accept a pathname if it's tail matches the <code>[string match]</code>
pattern, for <code>-iname</code> the match is case&ndash;insensitive.

          <br><dt><code>-maxdepth INTEGER</code><dd>Visit at most <code>INTEGER</code> (a positive number or zero) levels of
subdirectory.

          <br><dt><code>-mindepth INTEGER</code><dd>Start the search when reaching the <code>INTEGER</code> (a positive number or
zero) level of subdirectory.

          <br><dt><code>-path PATTERN</code><dt><code>-ipath PATTERN</code><dd>Accept a pathname if it matches the <code>[string match]</code> pattern, for
<code>-ipath</code> the match is case&ndash;insensitive.

          <br><dt><code>-perm PERM</code><dd>Accept a pathname if its access permissions matches the selected ones;
<code>PERM</code> must be given in octal form, with only the read, write,
execute values (examples: <code>755</code>, <code>644</code>).

          <br><dt><code>-regexp REX</code><br><dt><code>-iregexp REX</code><dd>Accept a pathname if it matches the given regular expression, for
<code>-iregexp</code> the match is case&ndash;insensitive.

          <br><dt><code>-strip PREFIX</code><dd>Strip the given string from all the selected pathnames; it is meant to
be used to strip the pathname of a directory; if a selected pathname
does not begin with <code>PREFIX</code>, that pathname is returned as is.

          <br><dt><code>-type TYPELIST</code><dd>Accept a pathname if it matches all the types in the list, these are all
the <code>[glob]</code> <code>-types</code> values.

          <br><dt><code>-tail BOOLEAN</code><dd>If true, return only the file tails of all the selected pathnames; this
will have precedence over <code>-strip</code>.

          <br><dt><code>-test EXPR</code><dd>Test <code>EXPR</code>, if true the condition is satisfied.  The expression
may access the file name being tested throught a variable named
<var>filename</var>. 
</dl>

        <p>The options <code>-name</code>, <code>-iname</code>, <code>-path</code>, <code>-ipath</code>,
<code>-regexp</code>, <code>-iregexp</code> can be given multiple times. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="lock-files"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#file-procs">file procs</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#file">file</a>

</div>

<h3 class="section">11.3 Creating lock files</h3>

<p>The lock file module provides procedures to create, delete and test the
existence of lock files.

   <p>Example:

<pre class="example">     utp_lockfile_t* lockfile
     utp_lockfile_init $lockfile $name $directory $entity
     
     utp_lockfile_create $lockfile
     ...
     if { [utp_lockfile_exists $lockfile] } {
         ...
     }
     ...
     unset $lockfile
</pre>
   <div class="defun">
&mdash; Struct: <b>utp_lockfile_t</b><var><a name="index-utp_005flockfile_005ft-302"></a></var><br>
<blockquote><p>Type of lock file structures. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_lockfile_init</b><var> self name directory entity<a name="index-utp_005flockfile_005finit-303"></a></var><br>
<blockquote><p>Initialise an already allocated structure.

          <dl>
<dt><var>name</var><dd>It is the unqualified base name of the lock file, whithout the extension
that this module appends to it; it can be, for example, the script name.

          <br><dt><var>directory</var><dd>It is the (fully qualified) pathname of the directory in which the lock
file will be created; it must exist and it must be writable by the owner
of the process.

          <br><dt><var>entity</var><dd>A string that is written in the lock file. 
</dl>
        </p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_lockfile_create</b><var> self<a name="index-utp_005flockfile_005fcreate-304"></a></var><br>
<blockquote><p>Create the lock file. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_lockfile_delete</b><var> self<a name="index-utp_005flockfile_005fdelete-305"></a></var><br>
<blockquote><p>Delete the lock file.  This procedure is automatically invoked upon
finalisation of the structure. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_lockfile_exists</b><var> self<a name="index-utp_005flockfile_005fexists-306"></a></var><br>
<blockquote><p>Return true if the lock file exists, it's owned by the user running the
process and contains the entity string. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="parsers"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#main">main</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#file">file</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">12 Parsing languages and files</h2>

<ul class="menu">
<li><a accesskey="1" href="#xmlpp">xmlpp</a>:                        A simple <acronym>XML</acronym> parser. 
</ul>

<!-- page -->
<div class="node">
<a name="xmlpp"></a>
<p><hr>
Up:&nbsp;<a rel="up" accesskey="u" href="#parsers">parsers</a>

</div>

<h3 class="section">12.1 A simple <acronym>XML</acronym> parser</h3>

<p>The parser uses a set of regular expressions to extract elements from an
input string.  It is <strong>not</strong> a full <acronym>XML</acronym> parser.

<!--  -->
<h5 class="subsubheading">Parsing the prolog</h5>

<p>A procedure is provided to parse the <acronym>XML</acronym> prolog markup: it allows
the initial setup of the enconding.  Example of parsing of a prolog
markup:

<pre class="example">     set input {&lt;?xml version="1.0" standalone="yes" ?&gt;&lt;!DOCTYPE}
     set index 0
     
     utp_xmlpp_parse_prolog $input index attributes
     #   [string index $input $index end] -&gt; &lt;!DOCTYPE
     #   $attributes -&gt; {version 1.0 standalone yes}
</pre>
   <div class="defun">
&mdash; Proc: <b>utp_xmlpp_parse_prolog</b><var> input indexvar attribvar<a name="index-utp_005fxmlpp_005fparse_005fprolog-307"></a></var><br>
<blockquote><p>Parse the prolog of an <acronym>XML</acronym> document.  Check if the input string
begins with the <acronym>XML</acronym> prolog <code>&lt;?xml ...?&gt;</code>:

     <pre class="example">          &lt;?xml version="1.0" ...?&gt;
          &lt;?xml version='1.0' ...?&gt;
</pre>
        <p>The first characters in the input string must be <code>&lt;?xml</code> followed
by at least one space.  The characters in the prolog markup are the same
no matter what the encoding of the document is.

        <p>The attributes recognised in the markup are:

          <dl>
<dt><code>version</code><dd>Mandatory, the version of the <acronym>XML</acronym> specification this document
complies to.

          <br><dt><code>encoding</code><dd>The encoding of the document.

          <br><dt><code>standalone</code><dd><code>yes</code> or <code>no</code>, whether the document has the definition of the
<acronym>DTD</acronym> embedded in it and does not require external stuff. 
</dl>

        <p>Arguments:

          <dl>
<dt><var>input</var><dd>The document's string.

          <br><dt><var>indexvar</var><dd>The name of a variable that holds the index of the next non&ndash;blank
character to be parsed in the input string.

          <br><dt><var>attribvar</var><dd>The name of a variable that, after the call, will hold the list of
prolog markup attributes. 
</dl>

        <p>The prolog markup is parsed and verified.  The attributes are stored in
the output variable in a list of key/value pairs; the attribute's and
value's strings are duplicated and stored in the output variables.

        <p>The first character to be parsed is selected by the integer in the index
argument; if the uplevel variable does not exist it is initialised with
the value zero.  After the invocation: the variable <code>indexvar</code> will
hold the index of the next non&ndash;space character in the input string.

        <p>Return the empty string. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Declaration</h5>

<p>A procedure is provided to parse the document declaration: it allows a
setup step in which we select what to do with the markups.  Example of
parsing of a DOCTYPE markup:

<pre class="example">     set input {&lt;!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 4.0//EN"&gt;&lt;html&gt;}
     set index 0
     
     utp_xmlpp_parse_doctype $input index name type desc decl
     #   [string index $input $index end] -&gt; &lt;html&gt;
     #   $name -&gt; HTML
     #   $type -&gt; PUBLIC
     #   $desc -&gt; -//IETF//DTD HTML 4.0//EN
     #   $decl -&gt; {}
</pre>
   <p class="noindent">another example:

<pre class="example">     set input {&lt;!DOCTYPE HTML [
     &lt;!ELEMENT html&gt;
     ]&gt;&lt;html&gt;}
     set index 0
     
     utp_xmlpp_parse_doctype $input index name type desc decl
     #   [string index $input $index end] -&gt; &lt;html&gt;
     #   $name -&gt; HTML
     #   $type -&gt; {}
     #   $desc -&gt; {}
     #   [eval { string range $input } $decl] -&gt; {
     #&lt;!ELEMENT html&gt;
     #}
</pre>
   <div class="defun">
&mdash; Proc: <b>utp_xmlpp_parse_doctype</b><var> input indexvar namevar typevar descvar declvar<a name="index-utp_005fxmlpp_005fparse_005fdoctype-308"></a></var><br>
<blockquote><p>Parse the &lsquo;<samp><span class="samp">DOCTYPE</span></samp>&rsquo; markup; this procedure may be invoked right
after <code>[parse_prolog]</code>.  Check that the input string has one of the
forms:

     <pre class="example">          &lt;!DOCTYPE &lt;name&gt; PUBLIC "..." [...]&gt;
          &lt;!DOCTYPE &lt;name&gt; PUBLIC "..."&gt;
          &lt;!DOCTYPE &lt;name&gt; SYSTEM "..."&gt;
          &lt;!DOCTYPE &lt;name&gt; SYSTEM "..." [...]&gt;
          &lt;!DOCTYPE &lt;name&gt; [...]&gt;
</pre>
        <p class="noindent">where: <code>&lt;name&gt;</code> is the name of the <acronym>DTD</acronym>; the strings
<code>PUBLIC</code> and <code>SYSTEM</code> are the &ldquo;type&rdquo; attribute of the
<acronym>DTD</acronym>; the string in double quotes is the <acronym>DTD</acronym>
description; the stuff in brackets is the local definition of the
<acronym>DTD</acronym>.

        <p>Arguments:

          <dl>
<dt><var>input</var><dd>The document's string.

          <br><dt><var>indexvar</var><dd>The name of a variable that:

               <ul>
<li>As input argument, holds the index of the first character of the the
<code>DOCTYPE</code> markup (the <code>&lt;</code>).

               <li>As output value, will hold the index of the next non&ndash;blank character to
be parsed. 
</ul>

          <br><dt><var>namevar</var><dd>The name of a variable that will hold the <acronym>DTD</acronym> name.

          <br><dt><var>typevar</var><dd>The name of a variable that will hold the <acronym>DTD</acronym> type
(<code>SYSTEM</code>, <code>PUBLIC</code>, the empty string).

          <br><dt><var>descvar</var><dd>The name of a variable that will hold the <acronym>DTD</acronym> description.

          <br><dt><var>declvar</var><dd>The name of a variable that will hold a list of two indexes selecting
the <code>DOCTYPE</code> definition in the input string, if any. 
</dl>

        <p>The prolog markup is parsed and verified.  The data from the
<code>DOCTYPE</code> markup is duplicated and stored in the output variables;
only the local <acronym>DTD</acronym> definitions, if present, are not
duplicated.

        <p>The first character to be parsed is selected by the integer in the index
argument; if the uplevel variable does not exist it is initialised with
the value zero.

        <p>Return the empty string. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Body</h5>

<p>The parsing of the document's body follows the iterator design pattern:
we initialise an opaque structure with the data required and enter a
loop, processing markups and text until the end of the document.  A
quick example:

<pre class="example">     set input {&lt;body foreground="black" background='white'&gt;}
     set index 0
     
     utp_xmlpp_iterator_body iterator $input $index
     set e [utp_iterator_next iterator  class name attributes data]
     # $e          -&gt; 1
     # $class      -&gt; OTAG
     # $name       -&gt; body
     # $attributes -&gt; {foreground black background white}
     # $data       -&gt; {}
</pre>
   <p class="noindent">we see that the procedure <code>[utp_iterator_next]</code> is required
(see <a href="#iterator">iterator</a> for an explanation of <acronym>UTP</acronym>'s iterators).  The
iterator defined by <code>[utp_xmlpp_iterator_body]</code> requires more than
one output variable.

   <p>The tokens are recognised through their classes:

     <dl>
<dt><code>OTAG</code><dd>A start markup (example: <code>&lt;html&gt;</code>).

     <br><dt><code>CTAG</code><dd>An end markup (example: <code>&lt;/html&gt;</code>).

     <br><dt><code>ETAG</code><dd>An empty markup (example: <code>&lt;img/&gt;</code>).

     <br><dt><code>TEXT</code><dd>The text between two markups.

     <br><dt><code>QTAG</code><dd>Those weird markups with question marks (example: <code>&lt;? ... ?&gt;</code>).

     <br><dt><code>COMMENT</code><dd>A comment markup (example: <code>&lt;!-- comment --&gt;</code>). 
</dl>

<div class="defun">
&mdash; Proc: <b>utp_xmlpp_iterator_body</b><var> iterator input index<a name="index-utp_005fxmlpp_005fiterator_005fbody-309"></a></var><br>
<blockquote><p>Initialise an iterator for the body of an <acronym>XML</acronym> document.  Arguments:

          <dl>
<dt><var>iterator</var><dd>The name of the variable holding the iterator state.

          <br><dt><var>input</var><dd>The body of the document.

          <br><dt><var>index</var><dd>The first character to be parsed in <var>input</var>. 
</dl>

        <p>Return the empty string. 
</p></blockquote></div>

   <p>When the procedure <code>[utp_iterator_next]</code> is invoked, the call is
tranferred to the procedure <code>[utp_xmlpp_iterator_body_next]</code>.

<div class="defun">
&mdash; Proc: <b>utp_xmlpp_iterator_body_next</b><var> iterator classvar namevar attvar datavar<a name="index-utp_005fxmlpp_005fiterator_005fbody_005fnext-310"></a></var><br>
<blockquote><p>Advance the body iterator.  The first characters from the input string
are classified by the application of a set of regular expressions. 
Arguments:

          <dl>
<dt><var>iterator</var><dd>The name of the iterator variable.

          <br><dt><var>classvar</var><dd>The name of a variable that will hold the token's class: <code>OTAG</code>,
<code>CTAG</code>, <code>ETAG</code>, <code>TEXT</code>, <code>QTAG</code>, <code>COMMENT</code>.

          <br><dt><var>namevar</var><dd>The name of a variable that will hold the markup's name if the token's
class is: <code>OTAG</code>, <code>CTAG</code>, <code>ETAG</code>, <code>QTAG</code>.

          <br><dt><var>attvar</var><dd>The name of a variable that will hold the attributes list if the token's
class is: <code>OTAG</code>, <code>ETAG</code>, <code>QTAG</code>.

          <br><dt><var>datavar</var><dd>The name of a variable that will hold the cdata if the tokens's class is
<code>TEXT</code>. 
</dl>

        <p>Return true if a token was found; return false when the whole input
string has been parsed or an error occurred.  If a match is found: the
output variables are filled with duplicates of the input string
portions. 
</p></blockquote></div>

   <p>An example of full parsing:

<pre class="example">     set index 0
     set input {... XML document ...}
     
     utp_xmlpp_parse_prolog  $input index attributes
     utp_xmlpp_parse_doctype $input index name type data declaration
     
     utp_xmlpp_iterator_body iterator $input $index
     while { [utp_iterator_next iterator class name attributes data] } {
         switch $class {
             OTAG - ETAG - QTAG { ... }
             CTAG               { ... }
             COMMENT            { ... }
             TEXT               { ... }
         }
     }
</pre>
   <p>This is more or less what <code>[utp_xmlpp_parse0]</code> does.

<div class="defun">
&mdash; Proc: <b>utp_xmlpp_parse0</b><var> input outputvar<a name="index-utp_005fxmlpp_005fparse0-311"></a></var><br>
<blockquote><p>Transform an input <acronym>XML</acronym> string in an output <acronym>TCL</acronym> script. 
<var>input</var> is the string to parse, <var>outputvar</var> is the name of the
output variable.

        <p>Store in the output variable a <acronym>TCL</acronym> script that can be evaluated in an
interpreter.  The procedures are:

          <dl>
<dt><code>prolog &lt;attlist&gt;</code><dd>Deals with the list of attributes in the <code>&lt;?xml ...&gt;</code> markup.

          <br><dt><code>doctype &lt;name&gt; (PUBLIC|SYSTEM) &lt;description&gt; &lt;declaration&gt;</code><dd>Deal with the <acronym>DTD</acronym> specification.

          <br><dt><code>otag &lt;name&gt; &lt;attlist&gt;</code><dd>Deal with start markups.

          <br><dt><code>ctag &lt;name&gt;</code><dd>Deal with end markups.

          <br><dt><code>etag &lt;name&gt; &lt;attlist&gt;</code><dd>Deal with empty markups.

          <br><dt><code>qtag &lt;name&gt; &lt;attlist&gt;</code><dd>Deal with &ldquo;question&rdquo; markups.

          <br><dt><code>comment &lt;string&gt;</code><dd>Deal with comments.

          <br><dt><code>text &lt;string&gt;</code><dd>Deal with text. 
</dl>

        <p>Return the empty string. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="main"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#misc">misc</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#parsers">parsers</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">13 Command line script infrastructure</h2>

<p><acronym>UTP</acronym> implements an infrastructure to organise command line interface
(<acronym>CLI</acronym>) scripts; it includes: a set of predefined command line
arguments; initialisation and finalisation model for reentrant scripts;
automatic initialisation and usage of <acronym>UTP</acronym> modules like channel
messages and getopts.

   <p>A reentrant script is an ordinary <acronym>TCL</acronym> script that is loaded in a
slave interpreter and can be executed multiple times by invoking a main
function; at each invocation &ldquo;command line arguments&rdquo; may be selected
to configure it.

   <p>The advantages over the execution of a script in a one&ndash;time slave
interpreter are:

     <ul>
<li>Required <acronym>TCL</acronym>&ndash;only packages are loaded only once.

     <li>Required C coded extensions are initialised only once for the
interpreter (loading them only once is default behaviour for <acronym>TCL</acronym>). 
</ul>

<p class="noindent">of course required packages must be &ldquo;reentrant&rdquo; too.

   <p>The infrastructure follows the template design pattern, that is: choices
were made.  If it does not fit your needs: just ignore it.

<ul class="menu">
<li><a accesskey="1" href="#main-usage">main usage</a>:                   How to use the module. 
<li><a accesskey="2" href="#main-options">main options</a>:                 Predefined options. 
<li><a accesskey="3" href="#main-infos">main infos</a>:                   Script meta informations. 
<li><a accesskey="4" href="#main-interface">main interface</a>:               Module interface. 
<li><a accesskey="5" href="#main-variables">main variables</a>:               Script state variables. 
<li><a accesskey="6" href="#main-loop">main loop</a>:                    Event loop interaction. 
<li><a accesskey="7" href="#main-exit">main exit</a>:                    Main function exit codes. 
</ul>

<!-- page -->
<div class="node">
<a name="main-usage"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#main-options">main options</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#main">main</a>

</div>

<h3 class="section">13.1 How to use the module</h3>

<p>The best way is to customise the example script under the
<samp><span class="file">examples</span></samp> directory of the distribution source tree.  Basically a
script should look like the following:

<pre class="example">     # script-name.tcl --
     
     package require UTP::preprocessor
     package require UTP
     
     utp_struct script_data_t {
         utp_int_t    my_value    123
     }
     
     proc script_before_parsing_options {} {
         utp_main_set_progname "script-name.tcl"
         utp_main_set_author "Marco Maggi"
         utp_main_set_copyright_years "2011"
         utp_main_set_version 0.1.0
         utp_main_set_usage "usage: @PROGNAME@ \[options\] ..."
     
         utp_main_access_task task
         utp_task_alloc_switch_init task data
         script_data_t* data
     }
     proc main {} {
         utp_task_global data
     
         # Do something involving the '$data' structure.
         ...
     
         utp_main_exit
     }
     
     # script procedures
     ...
     
     utp_maybe_main
     
     # end of file
</pre>
   <!-- page -->
<div class="node">
<a name="main-options"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#main-infos">main infos</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#main-usage">main usage</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#main">main</a>

</div>

<h3 class="section">13.2 Predefined options</h3>

<p>A description of the predefined options follows.  The options associated
to <acronym>UTP</acronym> modules are linked to them with the update procedures: we are
free to redefine those procedure, altough this will give us the
responsibility to link the option appropriately.

     <dl>
<dt><samp><span class="option">-v</span></samp><dt><samp><span class="option">--verbose</span></samp><dd>Turn on verbose messages: the ones printed with
<code>[utp_message_verbose]</code>.  It is an option with no argument, which
defaults to <code>no</code>: verbose messages disabled.  The link to the
message module is done by invoking:

     <pre class="example">          proc utp_script_option_update_utp_verbosity { option } {
              utp_message_enable_verbose
          }
</pre>
     <br><dt><samp><span class="option">--silent</span></samp><dt><samp><span class="option">--quiet</span></samp><dd>Turn off verbose messages.  It is an option with no argument, which
defaults to <code>no</code>: verbose messages are allowed.  The link to the
message module is done by invoking:

     <pre class="example">          proc utp_script_option_update_utp_silently { option } {
              utp_message_disable_verbose
          }
</pre>
     <br><dt><samp><span class="option">--debug</span></samp><dd>Turn on debug messages: the ones printed with
<code>[utp_message_debug]</code>.  It is an option with no argument, which
defaults to <code>no</code>: debug messages disabled.  The link to the message
module is done by invoking:

     <pre class="example">          proc utp_script_option_update_utp_debugging { option } {
              utp_message_enable_debugging
          }
</pre>
     <br><dt><samp><span class="option">--no-debug</span></samp><dd>Turn off debug messages: the ones printed with
<code>[utp_message_debug]</code>.  It is an option with no argument, which
defaults to <code>yes</code>: debug messages disabled.  The link to the
message module is done by invoking:

     <pre class="example">          proc utp_script_option_update_utp_no_debugging { option } {
              utp_message_disable_debugging
          }
</pre>
     <br><dt><samp><span class="option">--test</span></samp><dd>Turn on test mode: a mode in which a script should do nothing, just
print messages about what it could have done.  It is an option with no
argument, which defaults to <code>no</code>: test mode disabled.  The state of
this option may be queried with <code>[utp_main_option_testing]</code>.

     <br><dt><samp><span class="option">-i</span></samp><dt><samp><span class="option">--interactive</span></samp><dd>Turn on interactive mode: ask the user before dangerous operations.  It
is an option with no argument, which defaults to <code>no</code>: interactive
mode disabled.  The state of this option may be queried with
<code>[utp_main_option_interactive]</code>.

     <br><dt><samp><span class="option">-f</span></samp><dt><samp><span class="option">--force</span></samp><dd>Turn off interactive mode: do <strong>not</strong> ask the user before dangerous
operations.  It is an option with no argument, which defaults to
<code>yes</code>: interactive mode disabled.  The state of this option may be
queried with <code>[utp_main_option_interactive]</code>.

     <br><dt><samp><span class="option">--encoded-args</span></samp><dd>After this option is parsed: option values and arguments are considered
to be encoded in hex format, and so they are decoded prior storing them
in the values array.  It is an option with no argument, which defaults
to <code>no</code>: arguments not encoded.

     <p>Encoding an argument is useful to avoid quoting problems when invoking a
program from a shell (see <a href="#getopts-basic">getopts basic</a>).

     <br><dt><samp><span class="option">-h</span></samp><dt><samp><span class="option">--help</span></samp><dt><samp><span class="option">--usage</span></samp><dd>Print the help screen then exit.  The link to the execution code is done
by invoking <code>utp_script_option_update_utp_help</code>.

     <br><dt><samp><span class="option">-H</span></samp><dt><samp><span class="option">--brief-help</span></samp><dt><samp><span class="option">--brief-usage</span></samp><dd>Print a brief help screen then exit.  The brief help screen describes
only the program specific options, not the predefined ones; example: it
will not display <code>--verbose</code>.  The link to the execution code is
done by invoking <code>utp_script_option_update_utp_brief_help</code>.

     <br><dt><samp><span class="option">--version</span></samp><dd>Print version informations then exit.  The link to the execution code is
done by invoking <code>utp_script_option_update_utp_version</code>.

     <br><dt><samp><span class="option">--version-only</span></samp><dd>Print only the version number then exit.  The link to the execution
module is done by invoking
<code>utp_script_option_update_utp_version_only</code>.

     <br><dt><samp><span class="option">--license</span></samp><dd>Print license informations then exits.  The link to the execution code
is done by invoking <code>utp_script_option_update_utp_license</code>.

     <br><dt><samp><span class="option">--print-options</span></samp><dd>Print the list of long options.  This is useful for programmable command
line completion at the shell prompt. 
</dl>

   <p>A description of option&ndash;related procedures follows.

<div class="defun">
&mdash; Proc: <b>utp_main_option_testing</b><var><a name="index-utp_005fmain_005foption_005ftesting-312"></a></var><br>
<blockquote><p>Return true if the <samp><span class="option">--test</span></samp> option was used, return false
otherwise. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_option_interactive</b><var><a name="index-utp_005fmain_005foption_005finteractive-313"></a></var><br>
<blockquote><p>Test whether <samp><span class="option">--interactive</span></samp> and/or <samp><span class="option">--force</span></samp> options were
used on the command line.  Return true if <samp><span class="option">--interactive</span></samp> was
last used, return false if <samp><span class="option">--force</span></samp> was last used; if none were
used return false. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_option_debugging</b><var><a name="index-utp_005fmain_005foption_005fdebugging-314"></a></var><br>
<blockquote><p>Return true if the <samp><span class="option">--debug</span></samp> option was used, return false
otherwise. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="main-infos"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#main-interface">main interface</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#main-options">main options</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#main">main</a>

</div>

<h3 class="section">13.3 Script meta informations</h3>

<p>A set of values must be selected to allow the script to print meaningful
messages to the console user.  Briefly, the script must contain a block
of code like the following:

<pre class="example">     utp_main_set_progname "script.tcl"
     utp_main_set_author "Marco Maggi"
     utp_main_set_copyright_years "2011"
     utp_main_set_version 0.1.0
     utp_main_set_usage "usage: @PROGNAME@ \[options\] ..."
</pre>
   <p>Meta informations are stored in an internal array and can be substituted
into predefined messages through a set of symbols; the values are
<strong>not</strong> subject to editing by the module.  The symbols are:

     <dl>
<dt><code>@PROGNAME@</code><dd>A string selecting the name of the program.

     <br><dt><code>@AUTHOR@</code><dd>A string selecting the name or names of the program's authors.

     <br><dt><code>@COPYRIGHT_YEARS@</code><dd>A comma+space separated list of copyright years.

     <br><dt><code>@VERSION@</code><dd>The program version number.

     <br><dt><code>@USAGE@</code><dd>The first line of the usage message, a string that can embed any of the
meta symbols.

     <br><dt><code>@STDIN@</code><dt><code>@STDOUT@</code><dt><code>@STDERR@</code><dd>The standard channels: these are optional and defaults to the common values. 
</dl>

   <p>Each symbol has a procedure that can be used to set it.

<div class="defun">
&mdash; Proc: <b>utp_main_set_progname</b><var> progname<a name="index-utp_005fmain_005fset_005fprogname-315"></a></var><br>
<blockquote><p>Select the program name. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_set_author</b><var> author<a name="index-utp_005fmain_005fset_005fauthor-316"></a></var><br>
<blockquote><p>Select the author. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_set_copyright_years</b><var> years<a name="index-utp_005fmain_005fset_005fcopyright_005fyears-317"></a></var><br>
<blockquote><p>Select the copyright years. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_set_version</b><var> version<a name="index-utp_005fmain_005fset_005fversion-318"></a></var><br>
<blockquote><p>Select the version string. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_set_usage</b><var> usage<a name="index-utp_005fmain_005fset_005fusage-319"></a></var><br>
<blockquote><p>Select the usage string. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_set_stdin</b><var> channel<a name="index-utp_005fmain_005fset_005fstdin-320"></a></var><br>
&mdash; Proc: <b>utp_main_set_stdout</b><var> channel<a name="index-utp_005fmain_005fset_005fstdout-321"></a></var><br>
&mdash; Proc: <b>utp_main_set_stderr</b><var> channel<a name="index-utp_005fmain_005fset_005fstderr-322"></a></var><br>
<blockquote><p>Select a standard channel.  These procedures may be used to configure
different channels for each run of the script; the channels are stored
in the internal state of the script (see <a href="#main-variables">main variables</a>). 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="main-interface"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#main-variables">main variables</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#main-infos">main infos</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#main">main</a>

</div>

<h3 class="section">13.4 Interface procedures</h3>

<p>When the script is loaded in the interpreter, directly by <acronym>TCL</acronym> or via
the <code>[source]</code> command, all the code is evaluated.  The model
adopted by <acronym>UTP</acronym> scripts is to place almost everything inside
procedures; that way, to really start a script, we have to invoke a
procedure; usually this invocation is the last line of code in the
script.

<div class="defun">
&mdash; Proc: <b>utp_maybe_main</b><var><a name="index-utp_005fmaybe_005fmain-323"></a></var><br>
<blockquote><p>A wrapper for <code>[utp_main]</code>; if the global variable
<code>I_am_running_in_a_slave_interp</code> is defined: nothing happens; else
<code>[utp_main]</code> is invoked with the right arguments.  The global
variable <var>argv</var> is accessed as list of command line arguments. 
</p></blockquote></div>

   <p>The purpose of <code>[utp_maybe_main]</code> is to let the script be loaded in
a slave interpreter without triggering its execution.  This is done by
defining the global variable <code>I_am_running_in_a_slave_interp</code> in
the interpreter before evaluating the code.  The script should be
explicitly started by invoking <code>[utp_main]</code>.

   <p>To use the procedure the script should look like:

<pre class="example">     # beginning of file
     
     package require UTP
     ...
     
     proc ...
     proc ...
     proc ...
     
     utp_maybe_main $argv
     
     # enf of file
</pre>
   <p class="noindent">if this script is loaded in an interpreter, it will be run immediately;
to avoid this:

<pre class="example">     set interp [interp create]
     interp eval $interp {set I_am_running_in_a_slave_interp yes}
     interp eval $interp {source script.tcl}
</pre>
   <p class="noindent">and to really start the script:

<pre class="example">     set argv { --myoption=myvalue one two three }
     interp eval $interp [list utp_main $argv]
</pre>
   <div class="defun">
&mdash; Proc: <b>utp_main</b><var> argv<a name="index-utp_005fmain-324"></a></var><br>
<blockquote><p>The template main procedure.  <var>argv</var> is the list of command line
arguments.  This procedure should be invoked at the end of the script
code or through <code>[utp_maybe_main]</code>.

        <p>A description of the steps follows.

          <ol type=1 start=1>
<li>Declare and activate a new task used to hold the script's state
(see <a href="#task">task</a> for details about tasks) (see <a href="#main-variables">main variables</a> for a
description of initialised variables).

          <li>Invoke a procedure named <code>[script_before_parsing_options]</code> with no
arguments, using <code>[utp_invoke_script_procedure]</code>; this procedure
can setup its state and declare additional options and meta values.

          <li>Declare a set of predefined options; the declaration variable is a
<code>utp_main_t</code> structure field named <code>options_declaration</code>; the
predefined options are declared after
<code>[script_before_parsing_options]</code> is invoked, so the custom script
options will be processed before the predefined ones.

          <li>Parse command line options in <var>argv</var>.  While parsing the message
module is configured with requested flags (debugging, verbosity).

          <li>Invoke a procedure named <code>[script_after_parsing_options]</code> with no
arguments, using <code>[utp_invoke_script_procedure]</code>.

          <li>Invoke the script action command.
             </ol>
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_exit</b><var><a name="index-utp_005fmain_005fexit-325"></a></var><br>
<blockquote><p>Exit the main task doing the following.

          <ol type=1 start=1>
<li>Invoke a procedure named <code>[script_before_termination]</code> with no
arguments, using <code>[utp_invoke_script_procedure]</code>.

          <li>Finalise the task created in the first step and exit the script.
             </ol>

        <p>The script is terminated by invoking <code>[exit]</code>: this command may not
end the script, in which case the procedure returns the value returned
by <code>[exit]</code>.

        <p>This procedure must be invoked by the user script action command or by a
scheduled event script. 
</p></blockquote></div>

   <p>The action command is the name of a procedure that can be stored in the
<code>utp_main_t</code> structure field <code>main_script_procedure</code>; it is
responsibility of the script command line option procedures to select an
appropriate value.  If the variable is not set, the default value is
used: <code>[main]</code>.

<!-- page -->
<div class="node">
<a name="main-variables"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#main-loop">main loop</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#main-interface">main interface</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#main">main</a>

</div>

<h3 class="section">13.5 Script state variables</h3>

<div class="defun">
&mdash; Struct: <b>utp_main_t</b><var><a name="index-utp_005fmain_005ft-326"></a></var><br>
<blockquote><p>The type of structure used to store main states.  It has the following
public fields:

          <dl>
<dt><code>utp_message_t message</code><dd>A token for the message module (see <a href="#channel-message">channel message</a>).

          <br><dt><code>utp_array_t meta</code><dd>Array of meta informations (see <a href="#main-infos">main infos</a>).

          <br><dt><code>utp_any_t main_script_procedure</code><dd>Name of the user command main procedure, defaults to <code>main</code>.

          <br><dt><code>utp_list_t option_declaration</code><dd>Holds the declaration of command line options; this variable has to be
used as first argument to <code>[utp_getopts_parse]</code>.

          <br><dt><code>utp_array_t option_values</code><dd>Parsed command line option values; this variable has to be used as second
argument to <code>[utp_getopts_parse]</code>.

          <br><dt><code>utp_list_t command_line_arguments</code><dd>Parsed non&ndash;options command line arguments; this variable has to be used
as third argument to <code>[utp_getopts_parse]</code>.

          <br><dt><code>utp_array_t environment_snapshot</code><dd>A snapshot of the <code>env</code> <acronym>TCL</acronym> built in global variable at the time
of <code>[utp_main]</code> invocation.

          <br><dt><code>utp_string_t process_working_directory</code><dd>The value returned by <code>[pwd]</code> at the time of <code>[utp_main]</code>
invocation.

          <br><dt><code>utp_pzinteger_t exit_code</code><dd>The exit code to use as <code>[exit]</code> argument when exiting from
<code>[utp_main]</code>; defaults to zero.

          <br><dt><code>utp_script_t exit_trigger</code><dd>A variable used by <code>[utp_main_enter_loop]</code> as argument to
<code>[vwait]</code>, to enter the event loop.

          <br><dt><code>utp_task_t&amp; task</code><dd>A reference to a task token that can be created by
<code>[script_before_parsing_options]</code> to hold task specific data.

          <br><dt><code>utp_event_source_t event_source</code><dd>An event source to be used for task scripts. 
</dl>

        <p>A structure of this type is create every time <code>[utp_main]</code> is
executed
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Task selection procedures</h5>

<div class="defun">
&mdash; Variable: <b>utp_main_token</b><var><a name="index-utp_005fmain_005ftoken-327"></a></var><br>
<blockquote><p>A global variable holding the name of the currently selected instance of
<code>utp_main_t</code>.  When <code>[utp_main]</code> creates a new instance of the
structure, the reference to it is stored in <code>utp_main_token</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_access_token</b><var> varname<a name="index-utp_005fmain_005faccess_005ftoken-328"></a></var><br>
<blockquote><p>Create a local variable named <var>varname</var> holding the name of the
instance of the currently selected <code>utp_main_t</code>.  It is an alias
for:

     <pre class="example">          upvar ::utp_main_token <var>varname</var>
</pre>
        </blockquote></div>

   <p>The pair currently&ndash;selected <code>utp_main_token</code> and its <code>task</code>
field value is called &ldquo;main task&rdquo;.

<div class="defun">
&mdash; Proc: <b>utp_main_switch_token</b><var> self<a name="index-utp_005fmain_005fswitch_005ftoken-329"></a></var><br>
<blockquote><p>Select a new <code>utp_main_t</code> instance to become the currently selected
one.  It does the following:

          <ul>
<li><var>self</var> is stored in <code>utp_main_token</code>.

          <li>The message token in the structure is selected as current, so it will be
used by the message module procedures.

          <li>If the <code>task</code> field of the structure is not the empty string, it is
interpreted as a task token and that token is selected as current task
with <code>[utp_task_switch_token]</code>. 
</ul>
        </p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Field access procedures</h5>

<div class="defun">
&mdash; Proc: <b>utp_main_access_options</b><var> varname<a name="index-utp_005fmain_005faccess_005foptions-330"></a></var><br>
<blockquote><p>Create a local variable linked to the <code>option_values</code> field of the
currently selected <code>utp_main_t</code> structure. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_access_arguments</b><var> varname<a name="index-utp_005fmain_005faccess_005farguments-331"></a></var><br>
<blockquote><p>Create a local variable linked to the <code>command_line_arguments</code>
field of the currently selected <code>utp_main_t</code> structure. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_access_env</b><var> varname<a name="index-utp_005fmain_005faccess_005fenv-332"></a></var><br>
<blockquote><p>Create a local variable linked to the <code>environment_snapshot</code> field
of the currently selected <code>utp_main_t</code> structure. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_access_pwd</b><var> varname<a name="index-utp_005fmain_005faccess_005fpwd-333"></a></var><br>
<blockquote><p>Create a local variable linked to the <code>process_working_directory</code>
field of the currently selected <code>utp_main_t</code> structure. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_access_task</b><var> varname<a name="index-utp_005fmain_005faccess_005ftask-334"></a></var><br>
<blockquote><p>Create a local variable linked to the <code>task</code> field of the currently
selected <code>utp_main_t</code> structure. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="main-loop"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#main-exit">main exit</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#main-variables">main variables</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#main">main</a>

</div>

<h3 class="section">13.6 Event loop interaction</h3>

<p>We need a special interface to the event loop to make sure that, when an
event script is evaluated, the correct main task is activated.

<div class="defun">
&mdash; Proc: <b>utp_main_after</b><var> delay script<a name="index-utp_005fmain_005fafter-335"></a></var><br>
<blockquote><p>A wrapper for the <code>[after]</code> <acronym>TCL</acronym> built&ndash;in using the current main
task event source.  Before evaluating <var>script</var> the
<code>[utp_main_switch_token]</code> is used to activate the current main
task. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_exit_trigger</b><var><a name="index-utp_005fmain_005fexit_005ftrigger-336"></a></var><br>
<blockquote><p>Return a script to be queued in the event loop to exit the main task. 
When the script is evaluated: the current main task is activated and
<code>[utp_main_exit]</code> is invoked. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_main_enter_loop</b><var><a name="index-utp_005fmain_005fenter_005floop-337"></a></var><br>
<blockquote><p>Enter the event loop invoking <code>[vwait]</code> on the <code>exit_trigger</code>
field of the currently selected <code>utp_main_t</code> structure. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="main-exit"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#main-loop">main loop</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#main">main</a>

</div>

<h3 class="section">13.7 Exit codes</h3>

<p>After normal termination of the script action procedure: the execution
should go back to <code>[utp_main]</code>.  If an error occurs and the stack
is rewind to <code>[utp_main]</code> the <code>errorCode</code> <acronym>TCL</acronym> built&ndash;in
variable is used to select an exit code:

     <dl>
<dt><code>RUNTIME</code><dd>The exit code will be 1.

     <br><dt><code>LOGIC</code><dd>The exit code will be 2.

     <br><dt><code>...</code><dd>The exit code will be 3. 
</dl>

<!-- page -->
<div class="node">
<a name="misc"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#layout">layout</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#main">main</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">14 Miscellaneous procedures</h2>

<ul class="menu">
<li><a accesskey="1" href="#misc-base">misc base</a>:                    Basic procedures. 
<li><a accesskey="2" href="#misc-error">misc error</a>:                   Error procedures. 
<li><a accesskey="3" href="#misc-procedures">misc procedures</a>:              Handling procedures. 
<li><a accesskey="4" href="#misc-list">misc list</a>:                    List procedures. 
<li><a accesskey="5" href="#misc-regexps">misc regexps</a>:                 Handling regular expressions. 
<li><a accesskey="6" href="#misc-math">misc math</a>:                    Mathematical procedures. 
</ul>

<!-- page -->
<div class="node">
<a name="misc-base"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#misc-error">misc error</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#misc">misc</a>

</div>

<h3 class="section">14.1 Basic procedures</h3>

<div class="defun">
&mdash; Proc: <b>utp_eval_script</b><var> script ?arg <small class="dots">...</small>?<a name="index-utp_005feval_005fscript-338"></a></var><br>
&mdash; Proc: <b>utp_script_eval</b><var> script ?arg <small class="dots">...</small>?<a name="index-utp_005fscript_005feval-339"></a></var><br>
<blockquote><p>Evaluate <var>script</var> in the global namespace; <var>script</var> can be the
empty string, in which case this procedure does nothing.  Optional
<var>arg</var> values are appended to the script, as arguments.

        <p>If <var>script</var> is not the empty string: the default definition of this
procedure does:

     <pre class="example">          uplevel #0 [concat $<var>script</var> $args]
</pre>
        <p class="noindent">but it may be redefined by the application to do whatever required.

        <p>This procedure should be used in all <acronym>UTP</acronym> modules to evaluate callback
scripts. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_alias</b><var> alias command ?arg <small class="dots">...</small>?<a name="index-utp_005falias-340"></a></var><br>
<blockquote><p>Create an alias from the current interpreter to the current interpreter. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="misc-procedures"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#misc-list">misc list</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#misc-error">misc error</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#misc">misc</a>

</div>

<h3 class="section">14.2 Handling procedures</h3>

<div class="defun">
&mdash; Proc: <b>utp_invoke_script_procedure</b><var> procname ?arg <small class="dots">...</small>?<a name="index-utp_005finvoke_005fscript_005fprocedure-341"></a></var><br>
<blockquote><p>If a procedure named <var>procname</var> exists, invoke it with all the
optional arguments; else do nothing. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_script_or_true</b><var> script<a name="index-utp_005fscript_005for_005ftrue-342"></a></var><br>
<blockquote><p>If <var>script</var> is not the empty string: it is interpreted as a script
and evaluated in the global namespace, its return value becomes the
return value of this procedure; else: nothing happens and the return
value is true. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_script_or_false</b><var> script<a name="index-utp_005fscript_005for_005ffalse-343"></a></var><br>
<blockquote><p>If <var>script</var> is not the empty string: it is interpreted as a script
and evaluated in the global namespace, its return value becomes the
return value of this procedure; else: nothing happens and the return
value is false. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_delete_proc</b><var> procname ?procname <small class="dots">...</small>?<a name="index-utp_005fdelete_005fproc-344"></a></var><br>
<blockquote><p>Delete all the procedures on the command line. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_save_excursion</b><var> script ?script <small class="dots">...</small>?<a name="index-utp_005fsave_005fexcursion-345"></a></var><br>
<blockquote><p>Save the current directory in an automatic variable, then evaluate all
the <var>script</var> in the scope of the caller.  If an error occurs:
restore the saved directory, then return the error. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="misc-list"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#misc-regexps">misc regexps</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#misc-procedures">misc procedures</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#misc">misc</a>

</div>

<h3 class="section">14.3 List procedures</h3>

<div class="defun">
&mdash; Proc: <b>utp_list_build</b><var> count ?char?<a name="index-utp_005flist_005fbuild-346"></a></var><br>
<blockquote><p>Build a list of <var>count</var> elements equal to <var>char</var>; <var>char</var>
defaults to <code>a</code>.  This command is a place&ndash;holder for a builtin
<acronym>TCL</acronym> command that may appear in the future. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_list_remove_duplicates</b><var> list<a name="index-utp_005flist_005fremove_005fduplicates-347"></a></var><br>
<blockquote><p>Removes duplicates from a list.  This procedure preserves the original
order of the elements.  If an element is duplicated the second instance
is removed.  Return the new list. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_list_variable_append_item_if_unique</b><var> listvar item<a name="index-utp_005flist_005fvariable_005fappend_005fitem_005fif_005funique-348"></a></var><br>
<blockquote><p>Append <var>item</var> to the list in the variable <var>listvar</var>, but only if
the element is not already there. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_list_variable_delete_item</b><var> listvar item<a name="index-utp_005flist_005fvariable_005fdelete_005fitem-349"></a></var><br>
<blockquote><p>Remove <var>item</var> from the list in <var>listvar</var>; if the element is not
in the list: nothing happens. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_list_variable_delete_range</b><var> listvar start end<a name="index-utp_005flist_005fvariable_005fdelete_005frange-350"></a></var><br>
<blockquote><p>Remove from the list in the variable <var>listvar</var> the range of elements
between <var>start</var> and <var>end</var>, inclusive. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_list_variable_map</b><var> script listvar<a name="index-utp_005flist_005fvariable_005fmap-351"></a></var><br>
<blockquote><p>Replace the elements of <var>listvar</var> with the result of the evaluation
of <var>script</var> with the element appended. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_list_map</b><var> script list<a name="index-utp_005flist_005fmap-352"></a></var><br>
<blockquote><p>The same as <code>[utp_list_variable_map]</code>, but operates on a list and
return the result. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_list_completion</b><var> list curselvar matchvar nomatchvar<a name="index-utp_005flist_005fcompletion-353"></a></var><br>
<blockquote><p>Complete a string from a list.  Arguments:

          <dl>
<dt><var>list</var><dd>The source list.

          <br><dt><var>curselvar</var><dd>The name of a variable containing the current string to complete; after
the invocation: the string to complete extended as much as possible.

          <br><dt><var>matchvar</var><dd>The name of a variable that, after the invocation, will hold the list of
items in <var>list</var> that match the current selection.

          <br><dt><var>nomatchvar</var><dd>The name of a variable that, after the invocation, will hold the list of
items in <var>list</var> that didn't match the current selection. 
</dl>

        <p>Return the empty string. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="misc-regexps"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#misc-math">misc math</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#misc-list">misc list</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#misc">misc</a>

</div>

<h3 class="section">14.4 Handling regular expressions</h3>

<div class="defun">
&mdash; Proc: <b>utp_regexp_array</b><var> rexesvar token keyvar ?fieldname <small class="dots">...</small>?<a name="index-utp_005fregexp_005farray-354"></a></var><br>
<blockquote><p>Given a set of regular expressions: find the one matching a given token;
set a variable holding the identifier of the regexp; set a variable for
each field in the regexp; return true or false to signal if a match was
found.

        <p><var>rexesvar</var> is the name of an array holding, as values, the
regular expressions to test against <var>token</var>; the keys of the array
are the identifiers of the associated regexp.

        <p>The regexps are tested in the order in which the keys are returned by
<code>[array names]</code>.

        <p>When a match is found the key in the array is stored in the variable
named <var>keyvar</var> and all the fields in the regexp are assigned to the
optional variables whose names are given as <var>fieldname</var>.  The return
value is true.

        <p>If no match is found: <var>keyvar</var> is set to the empty string; all the
<var>fieldname</var>s are set to the empty string; the return value is false. 
</p></blockquote></div>

   <p>Example for <code>[utp_regexp_array]</code>:

<pre class="example">     array set rexes { key1 a key2 b key3 c }
     utp_regexp_array rexes "b" key
     # now: $key = "key2"
</pre>
   <p class="noindent">another example for <code>[utp_regexp_array]</code>:

<pre class="example">     array set rexes {
        key1 {a(b)(c)}
        key2 {d(e)(f)}
        key3 {g(h)(i)}
     }
     utp_regexp_array rexes "def" key field1 field2
     # now: $key = "key2"; $field1 = e; $field2 = f
</pre>
   <!-- page -->
<div class="node">
<a name="misc-error"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#misc-procedures">misc procedures</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#misc-base">misc base</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#misc">misc</a>

</div>

<h3 class="section">14.5 Error procedures</h3>

<div class="defun">
&mdash; Alias: <b>utp_error_logic</b><var> error_message<a name="index-utp_005ferror_005flogic-355"></a></var><br>
<blockquote><p>An alias for <code>[return -code error -errorcode LOGIC]</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Alias: <b>utp_error_runtime</b><var> error_message<a name="index-utp_005ferror_005fruntime-356"></a></var><br>
<blockquote><p>An alias for <code>[return -code error -errorcode RUNTIME]</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_error_catch_logic</b><var> script<a name="index-utp_005ferror_005fcatch_005flogic-357"></a></var><br>
&mdash; Proc: <b>utp_error_catch_runtime</b><var> script<a name="index-utp_005ferror_005fcatch_005fruntime-358"></a></var><br>
<blockquote><p>Evaluate the script in the scope of the caller and, in case of error,
return the error condition with code <code>LOGIC</code> or <code>RUNTIME</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_error_test_runtime</b><var> expr error_message<a name="index-utp_005ferror_005ftest_005fruntime-359"></a></var><br>
&mdash; Proc: <b>utp_error_test_logic</b><var> expr error_message<a name="index-utp_005ferror_005ftest_005flogic-360"></a></var><br>
<blockquote><p>Evaluate the expression in the scope of the caller and, if true, return
the error condition with code <code>LOGIC</code> or <code>RUNTIME</code> and the
error message. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="misc-math"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#misc-regexps">misc regexps</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#misc">misc</a>

</div>

<h3 class="section">14.6 Mathematical procedures</h3>

<div class="defun">
&mdash; Proc: <b>utp_math_deg2rad</b><var> angle<a name="index-utp_005fmath_005fdeg2rad-361"></a></var><br>
<blockquote><p>Return <var>angle</var> expressed in radians converting it from degrees. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_math_rad2deg</b><var> angle<a name="index-utp_005fmath_005frad2deg-362"></a></var><br>
<blockquote><p>Return <var>angle</var> expressed in degrees converting it from radians. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_math_sin_cos</b><var> angle nickname<a name="index-utp_005fmath_005fsin_005fcos-363"></a></var><br>
<blockquote><p>Compute the sine and cosine of <var>angle</var> (expressed in radians) and
store the values in two variables in the scope of the caller; the
variable names are built by appending <var>nickname</var> to the strings:
<code>sin_</code> and <code>cos_</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_eval_expr_list</b><var> expr_list<a name="index-utp_005feval_005fexpr_005flist-364"></a></var><br>
<blockquote><p>Evaluate a list of expressions in the scope of the caller, using the
<code>[expr]</code> command, and return the resulting list. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_math_max</b><var> list ?list <small class="dots">...</small>?<a name="index-utp_005fmath_005fmax-365"></a></var><br>
<blockquote><p>Return the maximum number in all of the <var>list</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_math_min</b><var> list ?list <small class="dots">...</small>?<a name="index-utp_005fmath_005fmin-366"></a></var><br>
<blockquote><p>Return the minimum number in all of the <var>list</var>. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="layout"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#hoco">hoco</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#misc">misc</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">15 Managing directory layouts</h2>

<p>The <code>UTP::layout</code> package allows us to store, configure and expand
parametrised directory layouts.  This module can be viewed as a wrapper
around an associative array whose values contain particular strings that
can be substituted with other values.

   <p>This module is obviously inspired by the <acronym>GNU</acronym> Autoconf symbols
management.  A set of predefined layouts can be used as base to compose
our layouts.

   <p>The first argument of most of the procedures is <var>tokenvar</var>: the name
of the instance array.  When passed to the constructor, it must be an
empty or unexistent array.  There is no destructor: once the it's no
longer needed, the instance array can be simply <code>[unset]</code>.

   <p>Keys of the array are the option names supported by
<code>[utp_layout_configure]</code>.

<div class="defun">
&mdash; Proc: <b>utp_layout_init</b><var> tokenvar base<a name="index-utp_005flayout_005finit-367"></a></var><br>
<blockquote><p>Initialise a new directory layout.  <var>base</var> is the name of the
predefined layout upon which the current one is based, one among:
<code>default</code>, <code>gnu</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_layout_configure</b><var> tokenvar arg <small class="dots">...</small><a name="index-utp_005flayout_005fconfigure-368"></a></var><br>
<blockquote><p>Configure a layout.  Supported options:

          <dl>
<dt><code>-prefix</code><dd>The prefix for all the directories.

          <br><dt><code>-execprefix</code><dd>The prefix for architecture&ndash;dependent directories.

          <br><dt><code>-bindir</code><dd>Executables directory.

          <br><dt><code>-sbindir</code><dd>System executables directory.

          <br><dt><code>-datadir</code><dd>Read&ndash;only machine&ndash;independent director.

          <br><dt><code>-includedir</code><dd>Header files directory.

          <br><dt><code>-libdir</code><dd>Libraries directory.

          <br><dt><code>-libexecdir</code><dd>Executables that other programs run.

          <br><dt><code>-pkgdir</code><dd>Architecture&ndash;independent packages.

          <br><dt><code>-localstatedir</code><dd>Read&ndash;only machine&ndash;dependent directory.

          <br><dt><code>-mandir</code><dd>Man page documentation directory.

          <br><dt><code>-infodir</code><dd>Info documentation directory.

          <br><dt><code>-docdir</code><dd>Documentation directory.

          <br><dt><code>-htmldir</code><dd><acronym>HTML</acronym> documentation directory. 
</dl>

        <p>Return the empty string. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_layout_expand</b><var> tokenvar specific outvar<a name="index-utp_005flayout_005fexpand-369"></a></var><br>
<blockquote><p>Expand directories in the layout and store the result in the array named
<var>outvar</var>.  Each element of the layout is processed substituting the
<code>@...@</code> strings with the corresponding element in the layout
itself.  Example: <code>@DATADIR@</code> is replaced with the
<code>-datadir</code> element of the layout array.

        <p>Additionally the string <code>@SPECIFIC@</code> is substituted with the
provided argument.

        <p>At present loops are not detected. 
</p></blockquote></div>

   <p>Predefined base layouts:

   <p><table summary=""><tr align="left"><td valign="top">Option </td><td valign="top"><code>default</code> </td><td valign="top"><code>gnu</code>
<br></td></tr><tr align="left"><td valign="top"></td><td valign="top"></td><td valign="top">
<br></td></tr><tr align="left"><td valign="top">prefix </td><td valign="top">/usr/local </td><td valign="top">/usr/local
<br></td></tr><tr align="left"><td valign="top">execprefix </td><td valign="top">@PREFIX@ </td><td valign="top">@PREFIX@
<br></td></tr><tr align="left"><td valign="top">bindir </td><td valign="top">@EXECPREFIX@/bin </td><td valign="top">@EXECPREFIX@/bin
<br></td></tr><tr align="left"><td valign="top">sbindir </td><td valign="top">@EXECPREFIX@/sbin </td><td valign="top">@EXECPREFIX@/sbin
<br></td></tr><tr align="left"><td valign="top">datadir </td><td valign="top">@PREFIX@/share </td><td valign="top">@PREFIX@/share
<br></td></tr><tr align="left"><td valign="top">includedir </td><td valign="top">@PREFIX@/include </td><td valign="top">@PREFIX@/include
<br></td></tr><tr align="left"><td valign="top">libdir </td><td valign="top">@EXECPREFIX@/lib </td><td valign="top">@EXECPREFIX@/lib
<br></td></tr><tr align="left"><td valign="top">libexecdir </td><td valign="top">@EXECPREFIX@/libexec </td><td valign="top">@EXECPREFIX@/libexec
<br></td></tr><tr align="left"><td valign="top">pkgdir </td><td valign="top">@DATADIR@/@SPECIFIC@ </td><td valign="top">@DATADIR@/@SPECIFIC@
<br></td></tr><tr align="left"><td valign="top">localstatedir </td><td valign="top">@PREFIX@/etc </td><td valign="top">@PREFIX@/etc
<br></td></tr><tr align="left"><td valign="top">mandir </td><td valign="top">@DATADIR@/man </td><td valign="top">@PREFIX@/man
<br></td></tr><tr align="left"><td valign="top">infodir </td><td valign="top">@DATADIR@/info </td><td valign="top">@PREFIX@/info
<br></td></tr><tr align="left"><td valign="top">docdir </td><td valign="top">@DATADIR@/doc/@SPECIFIC@ </td><td valign="top">@PREFIX@/doc/@SPECIFIC@
<br></td></tr><tr align="left"><td valign="top">htmldir </td><td valign="top">@DOCDIR@/HTML </td><td valign="top">@DOCDIR@/HTML
<br></td></tr><tr align="left"><td valign="top">exampledir </td><td valign="top">@DOCDIR@/examples </td><td valign="top">@DOCDIR@/examples
   <br></td></tr></table>

<!-- page -->
<div class="node">
<a name="hoco"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframe">wireframe</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#layout">layout</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">16 The homogeneous coordinates package</h2>

<p>The package <code>UTP::hoco</code> implements homogeneous coordinates
transformations.

<ul class="menu">
<li><a accesskey="1" href="#hoco-transform">hoco transform</a>:               Format of a transformation list. 
<li><a accesskey="2" href="#hoco-procs">hoco procs</a>:                   Transformation procedures. 
<li><a accesskey="3" href="#hoco-dynamic">hoco dynamic</a>:                 Dynamic transformations. 
</ul>

<!-- page -->
<div class="node">
<a name="hoco-transform"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#hoco-procs">hoco procs</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#hoco">hoco</a>

</div>

<h3 class="section">16.1 Format of a transformation list</h3>

<p>A transformation is the product between a vector of homogeneous
coordinates and a matrix of homogeneous coefficients; the product has
the form:

<pre class="example">      - -   -                 -  - -
     | x'| |a_11 a_12 a_13 a_14|| x |
     | y'| |a_21 a_22 a_23 a_24|| y |
     | z'|=|a_31 a_32 a_33 a_34|| z |
     | r'| |a_41 a_42 a_43 a_44|| r |
      - -   -                 -  - -
</pre>
   <p class="noindent">and represents a rototranslation in the tridimensional space.  To
transform homogeneous coordinates to cartesian ones we should do:

<pre class="example">      - -
     | x |                    - -
     | y |     X = x/r       | X |
     | z | -&gt;  Y = y/r    -&gt; | Y |
     | r |     Z = z/r       | Z |
      - -                     - -
</pre>
   <p class="noindent">this is a non-linear transformation that cannot be represented with a
matrix&ndash;vector or vector&ndash;vector product.

<ul class="menu">
<li><a accesskey="1" href="#hoco-transform-elem">hoco transform elem</a>:          Elementary transformation matrices. 
<li><a accesskey="2" href="#hoco-transform-modeling">hoco transform modeling</a>:      Modeling templates. 
<li><a accesskey="3" href="#hoco-transform-format">hoco transform format</a>:        Transform format. 
</ul>

<!-- page -->
<div class="node">
<a name="hoco-transform-elem"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#hoco-transform-modeling">hoco transform modeling</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#hoco-transform">hoco transform</a>

</div>

<h4 class="subsection">16.1.1 Elementary transformation matrices</h4>

<p>Following are examples matrices representing useful transformations:

     <dl>
<dt><strong>identity</strong><dd>
     <pre class="example">           -     -
          |1 0 0 0|
          |0 1 0 0|
          |0 0 1 0|
          |0 0 0 1|
           -     -
</pre>
     <br><dt><strong>translation</strong><dd>
     <pre class="example">           -      -
          |1 0 0 dx|
          |0 1 0 dy|
          |0 0 1 dz|
          |0 0 0  1|
           -      -
</pre>
     <br><dt><strong>scaling</strong><dd>
     <pre class="example">           -     -
          |s 0 0 0|
          |0 s 0 0|
          |0 0 s 0|
          |0 0 0 1|
           -     -
</pre>
     <br><dt><strong>rotation around X axis</strong><dd>
     <pre class="example">           -                      -
          |1    0         0       0|
          |0 cos(rotX) -sin(rotX) 0|
          |0 sin(rotX)  cos(rotX) 0|
          |0    0         0       1|
           -                      -
</pre>
     <br><dt><strong>rotation around Y axis</strong><dd>
     <pre class="example">           -                              -
          |cos(rotY)    0      sin(rotY)  0|
          |   0         1         0       0|
          |-sin(rotY)   0      cos(rotY)  0|
          |   0         0         0       1|
           -                              -
</pre>
     <br><dt><strong>rotation around Z axis</strong><dd>
     <pre class="example">           -                            -
          |cos(rotZ)  -sin(rotZ)   0    0|
          |sin(rotZ)   cos(rotZ)   0    0|
          |   0            0       1    0|
          |   0            0       0    1|
           -                            -
</pre>
     <br><dt><strong>perspective projection</strong><dd>
     <pre class="example">           -        -
          |1 0   0  0|
          |0 1   0  0|
          |0 0   1  0|
          |0 0 -1/D 1|
           -        -
</pre>
     </dl>

   <p>A transformation matrix is built by premultiplicating and
postmultiplicating elementary (fundamental) matrices to the identity
matrix:

<pre class="example">     [w] = [A][B][1][C] [v] = [T] [v]
</pre>
   <p class="noindent">in this example the transformed vector (<code>[w]</code>) is obtained from the
original vector (<code>[v]</code>) by multiplication with a matrix
(<code>[T]</code>); the transformation matrix is built by premultiplicating
the identity matrix (<code>[1]</code>) by <code>[A]</code> and <code>[B]</code> and
postmultiplicating by <code>[C]</code>.

   <p>Premultiplication and postmultiplication have a geometrical meaning:
consult a good book about homogeneous coordinates (some books dealing
with robotics will do) or search the Internet.

<!-- page -->
<div class="node">
<a name="hoco-transform-modeling"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#hoco-transform-format">hoco transform format</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#hoco-transform-elem">hoco transform elem</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#hoco-transform">hoco transform</a>

</div>

<h4 class="subsection">16.1.2 Modeling templates</h4>

<p>Scaling transformations are used to model a graphic element from a
template; lets look at this line:

<pre class="example">           ^ y
           |
      P    |    Q
     --====+====--&gt; x
      -1   |   +1
           |
           |
</pre>
   <p class="noindent">of length 2: the first point, <code>P</code>, has coordinates (-1, 0), the
second point, <code>Q</code>, has coordinates (1, 0); the homogeneous
coordinates of the points <code>P</code> and <code>Q</code> are:

<pre class="example">      - -   - -      - -   - -
     |x_P| |-1 |    |x_Q| | 1 |
     |y_P| | 0 |    |y_Q| | 0 |
     |z_P|=| 0 |    |z_Q|=| 0 |
     |r_P| | 1 |    |r_Q| | 1 |
      - -   - -      - -   - -
</pre>
   <p class="noindent">by left&ndash;applying a scaling matrix with parameter <code>s = 100</code> to both
the vectors, we obtain:

<pre class="example">      - -   -  -      - -   - -
     |x_P| |-100|    |x_Q| |100|
     |y_P| |  0 |    |y_Q| | 0 |
     |z_P|=|  0 |    |z_Q|=| 0 |
     |r_P| |  1 |    |r_Q| | 1 |
      - -   -  -      - -   - -
</pre>
   <p class="noindent">that is: we have elongated the template line, now it is of length 200;
now we can rototranslate it in the tridimensional space to place it in
the desired position: we do this by multiplicating both vectors by a
rototranslation matrix.

   <p><code>UTP::hoco</code> implements procedures to do this kind of operations; to
use them we organise the points' coordinates in a list: for the line
template:

<pre class="example">     { -1 0 0 1  1 0 0 1 }
</pre>
   <p class="noindent">and after the scaling transformation the list is:

<pre class="example">     { -100 0 0 1  100 0 0 1 }
</pre>
   <p>Lists of points can have any length.

<!-- page -->
<div class="node">
<a name="hoco-transform-format"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#hoco-transform-modeling">hoco transform modeling</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#hoco-transform">hoco transform</a>

</div>

<h4 class="subsection">16.1.3 Transform format</h4>

<p>In the <code>UTP::hoco</code> package lexicon: a &ldquo;transform&rdquo; is a list of
the form:

<pre class="example">     {
       { premultiplication_boolean { a11 a12 a13 ... a44 } }
       { premultiplication_boolean { b11 b12 b13 ... b44 } }
       { premultiplication_boolean { c11 c12 c13 ... c44 } }
       ...
     }
</pre>
   <p class="noindent">the premultiplication boolean tells the package if the matrix must be
pre&ndash; or post&ndash;multiplied; it must be an integer <code>1</code> or <code>0</code>
because it is used in a call to <code>[lsort]</code> with the <code>-index 0
-integer</code> options.

   <p>Matrix coefficients appear in line order and in column order inside each
line:

<pre class="example">     { { 1 { a11 a12 a13 a14
             a21 a22 a23 a24
             a31 a32 a33 a34
             a41 a42 a43 a44 } } }
</pre>
   <p>Matrices are applied to the identity matrix in the same order in which
they appear in the list, example:

<pre class="example">     { { 1 { a11 ... } }
       { 1 { b11 ... } }
       { 0 { c11 ... } }
       { 1 { d11 ... } }
       { 0 { e11 ... } } }
</pre>
   <p class="noindent">represents:

<pre class="example">     [w] = [D][B][A][1][C][E] [v]
</pre>
   <p>Transform lists are lists: they can be manipulated with the standard
<acronym>TCL</acronym> commands for lists; in particular they can be joined with
<code>[concat]</code>; examples:

<pre class="example">     set transform { { 1 { a11 ... } }
                     { 1 { b11 ... } }
                     { 0 { c11 ... } }
                     { 1 { d11 ... } }
                     { 0 { e11 ... } } }
     
     # extracting a reference to the matrix at index position
     lindex $transform 2 1           ;# -&gt; { c11 ... }
     # extracting the premultiplication boolean at index position
     lindex $transform 2 0           ;# -&gt; 0
     # replacing a matrix
     lset transform 2 1 { f11 ... }
</pre>
   <!-- page -->
<div class="node">
<a name="hoco-procs"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#hoco-dynamic">hoco dynamic</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#hoco-transform">hoco transform</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#hoco">hoco</a>

</div>

<h3 class="section">16.2 Transformation procedures</h3>

<ul class="menu">
<li><a accesskey="1" href="#hoco-procs-core">hoco procs core</a>:              Core procedures. 
<li><a accesskey="2" href="#hoco-procs-matrix">hoco procs matrix</a>:            Basic matrices. 
<li><a accesskey="3" href="#hoco-procs-transform">hoco procs transform</a>:         Basic transforms. 
<li><a accesskey="4" href="#hoco-procs-params">hoco procs params</a>:            Transforms from parameters. 
</ul>

<!-- page -->
<div class="node">
<a name="hoco-procs-core"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#hoco-procs-matrix">hoco procs matrix</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#hoco-procs">hoco procs</a>

</div>

<h4 class="subsection">16.2.1 Core procedures</h4>

<p><code>[utp_hoco_transform_coords]</code> is the core procedure of the package:
it is used to do every transformation of points.

<div class="defun">
&mdash; Proc: <b>utp_hoco_transform_coords</b><var> transform coords<a name="index-utp_005fhoco_005ftransform_005fcoords-370"></a></var><br>
<blockquote><p>Transform a vector of coordinates according to a list of
transformations; return the transformed vector.  <a href="#hoco-transform-format">hoco transform format</a> for the format of <var>transform</var>; <var>coords</var> is a list of
points' homogeneous coordinates:

     <pre class="example">          { x1 y1 z1 r1  x2 y2 z2 r2  x3 y3 z3 r3  ... }
</pre>
        </blockquote></div>

   <p>The last step required before putting points on a bidimensional canvas
is the homogeneous&ndash;to&ndash;cartesian transformation.  Usually the <code>r</code>
parameter is set to one, so the homogeneous values of the X and
Y coordinates is the same in cartesian form; this is not true if
we use a perspective transform to represent depth.  It is safer and
convenient, though, to always apply this procedures before drawing;
note, for example, that the vector of coordinates returned by
<code>[utp_hoco_to_canvas]</code> is already in the format accepted by the
<acronym>TK</acronym> canvas commands.

<div class="defun">
&mdash; Proc: <b>utp_hoco_to_canvas</b><var> coords<a name="index-utp_005fhoco_005fto_005fcanvas-371"></a></var><br>
<blockquote><p>Transform a vector of coordinates from homogeneous to cartesian dropping
the <code>z</code> coordinate; return the transformed vector in the form:

     <pre class="example">          { x1 y1  x2 y2  ... }
</pre>
        </blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_to_cartesian</b><var> coords<a name="index-utp_005fhoco_005fto_005fcartesian-372"></a></var><br>
<blockquote><p>Transform a vector of coordinates from homogeneous to cartesian; return
the transformed vector in the form:

     <pre class="example">          { x1 y1 z1  x2 y2 z2  ... }
</pre>
        </blockquote></div>

<!-- page -->
<div class="node">
<a name="hoco-procs-matrix"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#hoco-procs-transform">hoco procs transform</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#hoco-procs-core">hoco procs core</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#hoco-procs">hoco procs</a>

</div>

<h4 class="subsection">16.2.2 Basic matrices</h4>

<div class="defun">
&mdash; Proc: <b>utp_hoco_matrix_identity</b><var><a name="index-utp_005fhoco_005fmatrix_005fidentity-373"></a></var><br>
<blockquote><p>Return an identity matrix.  This can be used as base to build other
transformations or as a &ldquo;nil&rdquo; transformation. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_matrix_null</b><var><a name="index-utp_005fhoco_005fmatrix_005fnull-374"></a></var><br>
<blockquote><p>Return a matrix of zeros with a single 1 in position 44. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_matrix_translation</b><var> dx dy dz<a name="index-utp_005fhoco_005fmatrix_005ftranslation-375"></a></var><br>
<blockquote><p>Return a translation matrix. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_matrix_scale</b><var> s<a name="index-utp_005fhoco_005fmatrix_005fscale-376"></a></var><br>
<blockquote><p>Return a scaling matrix with scale factor <var>s</var>; it can be used to
zoom a scene or to augment all the dimensions of an element. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_matrix_shaping</b><var> a b c<a name="index-utp_005fhoco_005fmatrix_005fshaping-377"></a></var><br>
<blockquote><p>Return a &ldquo;shaping&rdquo; matrix with scale factors <var>a</var> for X,
<var>b</var> for Y and <var>c</var> for Z.  This matrix is a scaling
matrix with different scaling factors along the X, Y and
Z directions; it is used to &ldquo;shape&rdquo; the template for a
tridimensional element.

        <p>Example: the template for a cube can be shaped into any parallelepiped. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_matrix_perspective</b><var> p<a name="index-utp_005fhoco_005fmatrix_005fperspective-378"></a></var><br>
<blockquote><p>Return a perspective matrix with parameter <var>p</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_matrix_rotation_around_x</b><var> rotX<a name="index-utp_005fhoco_005fmatrix_005frotation_005faround_005fx-379"></a></var><br>
&mdash; Proc: <b>utp_hoco_matrix_rotation_around_y</b><var> rotY<a name="index-utp_005fhoco_005fmatrix_005frotation_005faround_005fy-380"></a></var><br>
&mdash; Proc: <b>utp_hoco_matrix_rotation_around_z</b><var> rotZ<a name="index-utp_005fhoco_005fmatrix_005frotation_005faround_005fz-381"></a></var><br>
<blockquote><p>Return a rotation matrix representing rotation around an axis. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_matrix_canvas</b><var> x y rotZ<a name="index-utp_005fhoco_005fmatrix_005fcanvas-382"></a></var><br>
<blockquote><p>Return a matrix that represents a translation and a rotation in the
plane; the rotation is around the perpendicular axis.  This matrix can
be used to place points on the <acronym>TK</acronym> canvas, which has: the origin in
the upper left corner, X axis directed toward the right, Y
axis directed torward the bottom.  With this transformation the origin
can be placed at an offset from the upper left corner and the Y
axis direction is inverted. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_matrix_dh</b><var> d theta a alpha<a name="index-utp_005fhoco_005fmatrix_005fdh-383"></a></var><br>
<blockquote><p>Return a rototranslation matrix parameterised with Denavit&ndash;Hartenberg
coordinates. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_matrix_homogeneous</b><var> rotZ rotX rotY x y z<a name="index-utp_005fhoco_005fmatrix_005fhomogeneous-384"></a></var><br>
<blockquote><p>Return a rototranslation matrix parameterised with translation offset
and rotation angles around axis; it is the premultiplication of:
rotation around Z, rotation around X, rotation around
Y, translation. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="hoco-procs-transform"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#hoco-procs-params">hoco procs params</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#hoco-procs-matrix">hoco procs matrix</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#hoco-procs">hoco procs</a>

</div>

<h4 class="subsection">16.2.3 Basic transforms</h4>

<p>All these procedures accept as last argument an optional boolean
representing the premultiplication; it defaults to <code>1</code>:
premultiplication.  The arguments have the same meaning of the
corresponding ones in the matrix procedures.

<div class="defun">
&mdash; Proc: <b>utp_hoco_transform_identity</b><var> ?premultiply?<a name="index-utp_005fhoco_005ftransform_005fidentity-385"></a></var><br>
<blockquote><p>Return an identity transform. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_transform_scale</b><var> s ?premultiply?<a name="index-utp_005fhoco_005ftransform_005fscale-386"></a></var><br>
<blockquote><p>Return a scale transform. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_transform_shaping</b><var> a b c<a name="index-utp_005fhoco_005ftransform_005fshaping-387"></a></var><br>
<blockquote><p>Return a shaping transform. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_transform_translation</b><var> x y z ?premultiply?<a name="index-utp_005fhoco_005ftransform_005ftranslation-388"></a></var><br>
<blockquote><p>Return a translation transform. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_transform_rotation</b><var> axis angle ?premultiply?<a name="index-utp_005fhoco_005ftransform_005frotation-389"></a></var><br>
<blockquote><p>Return a rotation transform.  <var>axis</var> can be: <code>x</code>, <code>y</code>,
<code>z</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_transform_perspective</b><var> p ?premultiply?<a name="index-utp_005fhoco_005ftransform_005fperspective-390"></a></var><br>
<blockquote><p>Return a perspective transform. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_transform_dh</b><var> d theta a alpha premultiply<a name="index-utp_005fhoco_005ftransform_005fdh-391"></a></var><br>
<blockquote><p>Return a Denavit&ndash;Hartenberg transform. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_transform_homogeneous</b><var> rotZ rotX rotY x y z ?premultiply?<a name="index-utp_005fhoco_005ftransform_005fhomogeneous-392"></a></var><br>
<blockquote><p>Return a rototranslation built with fundamental parameters. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_transform_canvas</b><var> x y rotZ ?premultiply?<a name="index-utp_005fhoco_005ftransform_005fcanvas-393"></a></var><br>
<blockquote><p>Return a transformation that can be used to put points onto a canvas,
right before the invocation of <code>[utp_hoco_to_cartesian]</code>. 
</p></blockquote></div>

   <p>These procedures may be used to build complex transforms by
concatenating the returned values; for example, the homogeneous
rototranslation could have been obtained by doing (actually it is not
implemented this way):

<pre class="example">     concat \
         [utp_hoco_transform_rotation z $rotZ] \
         [utp_hoco_transform_rotation y $rotY] \
         [utp_hoco_transform_rotation x $rotX] \
         [utp_hoco_transform_translation $x $y $z]
</pre>
   <!-- page -->
<div class="node">
<a name="hoco-procs-params"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#hoco-procs-transform">hoco procs transform</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#hoco-procs">hoco procs</a>

</div>

<h4 class="subsection">16.2.4 Transforms from parameters</h4>

<p>There are helper procedures that are used by the <code>UTP::hoco</code>
package internally and, probably, are not useful to a user.  They allow
to disentagle the order of parameters to the transform building
procedures from the code that invokes them.

   <p>The <var>parms</var> argument is an association list of parameters names and
values.  Examples:

<pre class="example">     { x 1.0 y 1.0 rotZ 0.0 }
     { d 1.0 a 1.0 theta 3.2 alpha 1.1 }
     { rotY 1.1 rotX 1.1 rotZ 0.3 }
</pre>
   <p>If some parameter is missing from the association list, it will get a
default value: scaling factors are set to <code>1.0</code>; rotation angles to
<code>0.0</code>; translation offsets are set to <code>0.0</code>; the perspective
parameter to <code>1.0</code>.

   <p>These procedures allow the invocation by reference of the transform
building procs:

<pre class="example">     set cmd utp_hoco_transform_scale
     set parms { s 100 }
     
     $cmd $parms
</pre>
   <div class="defun">
&mdash; Proc: <b>utp_hoco_parameters_to_transform_canvas</b><var> parms<a name="index-utp_005fhoco_005fparameters_005fto_005ftransform_005fcanvas-394"></a></var><br>
<blockquote><p>Return a canvas transform. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_parameters_to_transform_homogeneous</b><var> parms<a name="index-utp_005fhoco_005fparameters_005fto_005ftransform_005fhomogeneous-395"></a></var><br>
<blockquote><p>Return a rototranslation built from with fundamental parameters. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_parameters_to_transform_workspace</b><var> parms<a name="index-utp_005fhoco_005fparameters_005fto_005ftransform_005fworkspace-396"></a></var><br>
<blockquote><p>Return a rotation transform built from parameters: <code>rotX</code>,
<code>rotY</code>.  It is the sequence of a rotation around the Y axis
(<code>rotY</code>) and a rotation around the X axis (<code>rotX</code>). 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_parameters_to_transform_dh</b><var> parms<a name="index-utp_005fhoco_005fparameters_005fto_005ftransform_005fdh-397"></a></var><br>
<blockquote><p>Return a rototranslation transform built from Denavit&ndash;Hartenberg
parameters. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_parameters_to_transform_perspective</b><var> parms<a name="index-utp_005fhoco_005fparameters_005fto_005ftransform_005fperspective-398"></a></var><br>
<blockquote><p>Return a perspective transform. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_parameters_to_transform_scale</b><var> parms<a name="index-utp_005fhoco_005fparameters_005fto_005ftransform_005fscale-399"></a></var><br>
<blockquote><p>Return a scale transform. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_parameters_to_transform_shaping</b><var> parms<a name="index-utp_005fhoco_005fparameters_005fto_005ftransform_005fshaping-400"></a></var><br>
<blockquote><p>Return a shaping transform. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="hoco-dynamic"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#hoco-procs">hoco procs</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#hoco">hoco</a>

</div>

<h3 class="section">16.3 Dynamic transformations</h3>

<p>Dynamic transforms are instances of <acronym>UTP</acronym> structures used to hold
informations about transforms, so that the matrices can be recomputed
dynamically after some parameter has been updated.  A computed matrix is
cached in the structure.

<!--  -->
<h5 class="subsubheading">Dynamic transform types</h5>

<p>Following is the list of predefined dynamic transform types.  The
structures are instantiated and accessed directly like all <acronym>UTP</acronym>
structures.  A set of fields is common to all the transform types and
can be accessed safely before the first call to
<code>[utp_hoco_dynamic_make]</code>:

     <dl>
<dt><code>utp_list_t parms</code><dd>The list of reconfigurable parameters; by default all the parameters in
a transform are reconfigurable, but one may reset the list to exclude
some.

     <br><dt><code>utp_boolean_t premultiply</code><dd>A boolean used to selec pre- or postmultiplication; the default is
<code>1</code>, premultiplication. 
</dl>

<div class="defun">
&mdash; Struct: <b>utp_hoco_transform_canvas_t</b><var><a name="index-utp_005fhoco_005ftransform_005fcanvas_005ft-401"></a></var><br>
<blockquote><p>Parameter names: <code>rotZ</code>, <code>x</code>, <code>y</code>.  It is meant to be
used to put points on a canvas. 
</p></blockquote></div>

<div class="defun">
&mdash; Struct: <b>utp_hoco_transform_homogeneous_t</b><var><a name="index-utp_005fhoco_005ftransform_005fhomogeneous_005ft-402"></a></var><br>
<blockquote><p>Parameter names: <code>rotZ</code>, <code>rotY</code>, <code>rotX</code>, <code>x</code>,
<code>y</code>, <code>z</code>.  A homogeneous coordinates transformation. 
</p></blockquote></div>

<div class="defun">
&mdash; Struct: <b>utp_hoco_transform_workspace_t</b><var><a name="index-utp_005fhoco_005ftransform_005fworkspace_005ft-403"></a></var><br>
<blockquote><p>Parameter names: <code>rotY</code>, <code>rotX</code>.  A homogeneous coordinates
transformation meant to be used to rotate a workspace; example: the
volume in which 3D functions are plotted. 
</p></blockquote></div>

<div class="defun">
&mdash; Struct: <b>utp_hoco_transform_dh_t</b><var><a name="index-utp_005fhoco_005ftransform_005fdh_005ft-404"></a></var><br>
<blockquote><p>Parameter names: <code>d</code>, <code>theta</code>, <code>a</code>, <code>alpha</code>.  A
homogeneous transformation parameterised with Denavit&ndash;Hartenberg
coordinates. <code>d</code> is the translation along the fixed Z axis;
<code>theta</code> the rotation around the fixed Z axis; <code>a</code> the
translation along the moving X axis; <code>alpha</code> the rotation
around the moving X axis. 
</p></blockquote></div>

<div class="defun">
&mdash; Struct: <b>utp_hoco_transform_scale_t</b><var><a name="index-utp_005fhoco_005ftransform_005fscale_005ft-405"></a></var><br>
<blockquote><p>Parameter names: <code>s</code>.  It is meant to scale the coordinates. 
</p></blockquote></div>

<div class="defun">
&mdash; Struct: <b>utp_hoco_transform_perspective_t</b><var><a name="index-utp_005fhoco_005ftransform_005fperspective_005ft-406"></a></var><br>
<blockquote><p>Parameter names: <code>p</code>.  It is meant to project points on a plane. 
</p></blockquote></div>

<div class="defun">
&mdash; Struct: <b>utp_hoco_transform_shaping_t</b><var><a name="index-utp_005fhoco_005ftransform_005fshaping_005ft-407"></a></var><br>
<blockquote><p>Parameter names: <code>a</code>, <code>b</code>, <code>c</code>.  Scales the dimensions
with different scale factors. 
</p></blockquote></div>

<div class="defun">
&mdash; Struct: <b>utp_hoco_transform_view_t</b><var><a name="index-utp_005fhoco_005ftransform_005fview_005ft-408"></a></var><br>
<blockquote><p>Parameter names: <code>rotZ</code>, <code>rotY</code>, <code>rotX</code>, <code>x</code>,
<code>y</code>, <code>z</code>, <code>p</code>.  Combines a homogeneous transform with a
perspective projection. 
</p></blockquote></div>

<div class="defun">
&mdash; Struct: <b>utp_hoco_transform_translation_t</b><var><a name="index-utp_005fhoco_005ftransform_005ftranslation_005ft-409"></a></var><br>
<blockquote><p>Parameter names: <code>x</code>, <code>y</code>, <code>z</code>.  Translates points in
space. 
</p></blockquote></div>

<div class="defun">
&mdash; Struct: <b>utp_hoco_transform_rotation_x_t</b><var><a name="index-utp_005fhoco_005ftransform_005frotation_005fx_005ft-410"></a></var><br>
<blockquote><p>Parameter names: <code>rotX</code>.  Rotates points around the X axis. 
</p></blockquote></div>

<div class="defun">
&mdash; Struct: <b>utp_hoco_transform_rotation_y_t</b><var><a name="index-utp_005fhoco_005ftransform_005frotation_005fy_005ft-411"></a></var><br>
<blockquote><p>Parameter names: <code>rotY</code>.  Rotates points around the Y axis. 
</p></blockquote></div>

<div class="defun">
&mdash; Struct: <b>utp_hoco_transform_rotation_z_t</b><var><a name="index-utp_005fhoco_005ftransform_005frotation_005fz_005ft-412"></a></var><br>
<blockquote><p>Parameter names: <code>rotZ</code>.  Rotates points around the Z axis. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Procedures</h5>

<div class="defun">
&mdash; Proc: <b>utp_hoco_dynamic_update</b><var> self parms<a name="index-utp_005fhoco_005fdynamic_005fupdate-413"></a></var><br>
<blockquote><p>Update parameters in the <var>self</var> structure.

        <p><var>parms</var> must be an associative list of key/value pairs, the key
being the string selecting a parameter field in the structure.  It is
possible to update only a subset of the parameters.

        <p>Example: to update a workspace structure <var>parms</var> can be <code>{rotX
0.4 rotY 0.2}</code>, but also <code>{rotX 0.4}</code> to update only <code>rotX</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_dynamic_make</b><var> self<a name="index-utp_005fhoco_005fdynamic_005fmake-414"></a></var><br>
<blockquote><p>Return the transform in <var>self</var>.  If it is required the matrix is
recomputed. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_hoco_dynamic_set</b><var> self transform<a name="index-utp_005fhoco_005fdynamic_005fset-415"></a></var><br>
<blockquote><p>Set the internal transform of <var>self</var> to <var>transform</var>.  Care must
be take when using this function because no validation is performed on
<var>transform</var>. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="wireframe"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframetk">wireframetk</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#hoco">hoco</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">17 Wireframe objects</h2>

<p>The <code>UTP::wireframe</code> package is based upon the <code>UTP::hoco</code>
package and implements computations for wire frame vector graphics.  It
is an &ldquo;abstract&rdquo; module, because it implements procedures to put
graphics elements on an unspecified graphics media.

<ul class="menu">
<li><a accesskey="1" href="#wireframe-intro">wireframe intro</a>:              Introduction to graphics model. 
<li><a accesskey="2" href="#wireframe-element">wireframe element</a>:            Format of the elements list. 
<li><a accesskey="3" href="#wireframe-ops">wireframe ops</a>:                Operations upon elements. 
<li><a accesskey="4" href="#wireframe-templates">wireframe templates</a>:          Element coordinates templates. 
<li><a accesskey="5" href="#wireframe-basic">wireframe basic</a>:              Basic elements. 
<li><a accesskey="6" href="#wireframe-aggregate">wireframe aggregate</a>:          Aggregate elements. 
</ul>

<!-- page -->
<div class="node">
<a name="wireframe-intro"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframe-element">wireframe element</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframe">wireframe</a>

</div>

<h3 class="section">17.1 Introduction to graphics model</h3>

<p>The <code>UTP::wireframe</code> package is an &ldquo;abstract&rdquo; module, because it
implements procedures to put graphics elements on an unspecified
graphics media; in this section we develop the package model using the
<acronym>TK</acronym> canvas widget as concrete output device.

   <blockquote>
The code in this section is executable in the <samp><span class="file">play-intro.tcl</span></samp>
script under the <samp><span class="file">./proofs</span></samp> directory in the <acronym>UTP</acronym> distribution;
it is a pure <acronym>TCL</acronym>/<acronym>TK</acronym> script, making no use of the <acronym>UTP</acronym> packages. 
</blockquote>

<ul class="menu">
<li><a accesskey="1" href="#wireframe-intro-preamble">wireframe intro preamble</a>:     Scripts preamble and tail. 
<li><a accesskey="2" href="#wireframe-intro-canvas">wireframe intro canvas</a>:       Drawing on a canvas widget. 
<li><a accesskey="3" href="#wireframe-intro-plane">wireframe intro plane</a>:        Drawing on a plane. 
<li><a accesskey="4" href="#wireframe-intro-world">wireframe intro world</a>:        Drawing a world. 
<li><a accesskey="5" href="#wireframe-intro-moving">wireframe intro moving</a>:       Drawing a in a moving frame. 
<li><a accesskey="6" href="#wireframe-intro-media">wireframe intro media</a>:        Separating media commands. 
<li><a accesskey="7" href="#wireframe-intro-coords">wireframe intro coords</a>:       Better coordinates handling. 
</ul>

<!-- page -->
<div class="node">
<a name="wireframe-intro-preamble"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframe-intro-canvas">wireframe intro canvas</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframe-intro">wireframe intro</a>

</div>

<h4 class="subsection">17.1.1 Scripts preamble and tail</h4>

<p>We assume that all the scripts below have the following preamble:

<pre class="example">     package require Tcl 8.4
     package require Tk  8.4
     
     set canvas_width  500
     set canvas_height 500
     
     wm withdraw .
     wm geometry . +10+10
     . configure -background gray
     canvas .canvas             \
         -background white      \
         -width  $canvas_width  \
         -height $canvas_height
     grid .canvas -sticky news -padx 10 -pady 10
</pre>
   <p class="noindent">and the following tail:

<pre class="example">     bind . &lt;Escape&gt; { set ::exit_trigger 1 }
     update idletasks
     wm deiconify .
     tkwait visibility .
     vwait ::exit_trigger
     exit 0
</pre>
   <p class="noindent">so that we can comfortably run the script, see the graphics display and
finally press &lt;Escape&gt; to exit.

<!-- page -->
<div class="node">
<a name="wireframe-intro-canvas"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframe-intro-plane">wireframe intro plane</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframe-intro-preamble">wireframe intro preamble</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframe-intro">wireframe intro</a>

</div>

<h4 class="subsection">17.1.2 Drawing on a canvas widget</h4>

<p>What do we do to draw a single line on a <acronym>TK</acronym> canvas widget?  The
following single command suffices:

<pre class="example">     .canvas create line 10 40 180 150
</pre>
   <p class="noindent">at first, to make the code simpler in the examples: we avoid introducing
abstractions to handle coordinates as vectors, and instead act
individually upon point coordinates; we can highlight the fact that a
line is drawn from point A to point B as follows:

<pre class="example">     set XA 10
     set YA 40
     set XB 180
     set YB 150
     .canvas create line $XA $YA $XB $YB
</pre>
   <p>The canvas widget's coordinates frame of reference, the <dfn>canvas
frame</dfn>, has: the origin in the upper left corder of the widget, X
coordinate on a horizontal axis increasing from left to right, Y
coordinate on a vertical axis increasing from top to bottom; we can draw
it with the following procedure:

<pre class="example">     proc draw_canvas_frame {} {
         global	canvas_width canvas_height
         .canvas create line 1 0 1 $canvas_width  -tag Xaxis
         .canvas create line 0 1 $canvas_height 1 -tag Yaxis
     }
</pre>
   <p class="noindent">in which the axes are drawn one pixel inside to make them more visible;
at the end of the script (after the <code>[draw_canvas_frame]</code> procedure
has been called) we must include:

<pre class="example">     .canvas itemconfigure Xaxis -arrow last -fill green
     .canvas itemconfigure Yaxis -arrow last -fill red
</pre>
   <p>From now on we assume that the <code>[draw_canvas_frame]</code> procedure is
included in the scripts' preamble.

<!-- page -->
<div class="node">
<a name="wireframe-intro-plane"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframe-intro-world">wireframe intro world</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframe-intro-canvas">wireframe intro canvas</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframe-intro">wireframe intro</a>

</div>

<h4 class="subsection">17.1.3 Drawing on a plane</h4>

<p>The canvas frame is good for widget drawing from the point of view of
<acronym>TK</acronym>, but not exactly user friendly; let's adopt a reference frame,
called <dfn>plane frame</dfn>, having: origin at the center of the widget,
X coordinate on a horizontal axis increasing from left to right,
Y coordinate on a vertical axis increasing from bottom to top. 
The following procedure converts plane coordinates to canvas coordinates
in pixels:

<pre class="example">     proc plane2canvas { x_plane      y_plane
                         x_canvas_var y_canvas_var } {
         global  canvas_width canvas_height
         upvar $x_canvas_var x_canvas $y_canvas_var y_canvas
         set x_canvas \
             [expr {int(double($canvas_width) /2.0+$x_plane)}]
         set y_canvas \
             [expr {int(double($canvas_height)/2.0-$y_plane)}]
     }
</pre>
   <p class="noindent">and the following procedure draws the plane reference frame:

<pre class="example">     proc draw_plane_frame {} {
         global      canvas_width canvas_height
     
         set half_width      [expr {double($canvas_width) /2.0}]
         set half_height     [expr {double($canvas_height)/2.0}]
     
         set neg_half_width  [expr {-($half_width)}]
         set neg_half_height [expr {-($half_height)}]
     
         plane2canvas $neg_half_width 0  x1 y1
         plane2canvas $half_width     0  x2 y2
         .canvas create line $x1 $y1 $x2 $y2 -tag Xaxis
     
         plane2canvas 0 $neg_half_height x3 y3
         plane2canvas 0 $half_height     x4 y4
         .canvas create line $x3 $y3 $x4 $y4 -tag Yaxis
     }
</pre>
   <p class="noindent">The following script draws the exact same line of the scripts above,
expressing coordinates in the plane frame:

<pre class="example">     draw_canvas_frame
     draw_plane_frame
     
     set XA_plane -90
     set YA_plane +60
     plane2canvas $XA_plane $YA_plane XA_canvas YA_canvas
     
     set XB_plane +80
     set YB_plane -50
     plane2canvas $XB_plane $YB_plane XB_canvas YB_canvas
     
     .canvas create line \
         $XA_canvas $YA_canvas \
         $XB_canvas $YB_canvas
     
     .canvas itemconfigure Xaxis -arrow last -fill green
     .canvas itemconfigure Yaxis -arrow last -fill red
</pre>
   <!--  -->
<h5 class="subsubheading">Refactored drawing on a plane</h5>

<p>In what follows things get more complicated: it is time for a bit of
refactoring to make operations easier.  Rather than putting point
coordinates in individual variables, we store them in arrays; rather
than writing:

<pre class="example">     set XA_plane -90
     set YA_plane +60
</pre>
   <p class="noindent">we write:

<pre class="example">     array set A_plane { X -90 Y +60 }
</pre>
   <p class="noindent">with this change we rewrite the procedures above keeping the exact same
formulas:

<pre class="example">     proc plane2canvas { plane_var canvas_var } {
         global      canvas_width canvas_height
         upvar       $plane_var plane $canvas_var canvas
         set canvas(X) \
             [expr {int(double($canvas_width) /2.0+$plane(X))}]
         set canvas(Y) \
             [expr {int(double($canvas_height)/2.0-$plane(Y))}]
     }
     proc draw_plane_axis { A_plane_var B_plane_var tag } {
         upvar       $A_plane_var A_plane $B_plane_var B_plane
         plane2canvas A_plane A_canvas
         plane2canvas B_plane B_canvas
         .canvas create line \
             $A_canvas(X) $A_canvas(Y)       \
             $B_canvas(X) $B_canvas(Y)       \
             -tag $tag
     }
     proc draw_plane_frame {} {
         global      canvas_width canvas_height
     
         set half_width      [expr {double($canvas_width) /2.0}]
         set half_height     [expr {double($canvas_height)/2.0}]
     
         set neg_half_width  [expr {-($half_width)}]
         set neg_half_height [expr {-($half_height)}]
     
         array set X_axis_A [list X $neg_half_width Y 0]
         array set X_axis_B [list X $half_width     Y 0]
         draw_plane_axis X_axis_A X_axis_B Xaxis
     
         array set Y_axis_A [list X 0 Y $neg_half_width]
         array set Y_axis_B [list X 0 Y $half_width    ]
         draw_plane_axis Y_axis_A Y_axis_B Yaxis
     }
</pre>
   <p class="noindent">from now on we assume that these procedures are included in the script's
preamble.  The same drawing as before can be rewritten as:

<pre class="example">     draw_canvas_frame
     draw_plane_frame
     
     array set A_plane [list X -90 Y +60]
     array set B_plane [list X +80 Y -50]
     
     plane2canvas A_plane A_canvas
     plane2canvas B_plane B_canvas
     
     .canvas create line \
         $A_canvas(X) $A_canvas(Y)       \
         $B_canvas(X) $B_canvas(Y)
     
     .canvas itemconfigure Xaxis -arrow last -fill green
     .canvas itemconfigure Yaxis -arrow last -fill red
</pre>
   <!-- page -->
<div class="node">
<a name="wireframe-intro-world"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframe-intro-moving">wireframe intro moving</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframe-intro-plane">wireframe intro plane</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframe-intro">wireframe intro</a>

</div>

<h4 class="subsection">17.1.4 Drawing a world</h4>

<p>To draw a tridimensional scene we have to express point coordinates as
triplets XYZ and project the points to the plane.  We define a
reference frame, called <dfn>world frame</dfn>, whose coordinates have the
following properties:

     <ul>
<li>The X, Y and Z axes have 90 degrees angles
between them.

     <li>The unit of length measurement of the X, Y and Z
axes is the same.

     <li>A man standing on the XY plane, with the head pointing in the
direction of the increasing Z coordinate, looking in the
direction of the increasing X coordinate, has his left arm
pointing outwards in the direction of the increasing Y
coordinate. 
</ul>

<p class="noindent">here is a drawing of the world frame:

<pre class="example">             Z ^
               |
               |
               |
               |
               o------------&gt; Y
              /
             /
            /
         X v
</pre>
   <p>We define a transformation from world coordinates to plane coordinates
as the following sequence of operations:

     <ol type=1 start=1>
<li>Counterclockwise rotation around the world Z axis; this changes
coordinates from X Y Z to X_1 Y_1 Z_1.

     <li>Counterclockwise rotation around the world Y_1 axis; this changes
coordinates from X_1 Y_1 Z_1 to X_2 Y_2 Z_2.

     <li>Counterclockwise rotation around the world X_2 axis; this changes
coordinates from X_2 Y_2 Z_2 to X_3 Y_3 Z_3.

     <li>Translation of the world frame origin; this changes coordinates from
X_3 Y_3 Z_3 to X_4 Y_4 Z_4.

     <li>Perspective transformation of world coordinates on the plane; this
changes coordinates from X_4 Y_4 Z_4 to X_5 Y_5, in which
X_5 Y_5 are the coordinates on the plane.
        </ol>

<p class="noindent">rotation angles are expressed in radians.  We can code the fundamental
transformations as:

<pre class="example">     proc rotate_X { rotX in_var out_var } {
         upvar       $in_var in $out_var out
         set out(X) $in(X)
         set out(Y) [expr {$in(Y)*cos($rotX)-$in(Z)*sin($rotX)}]
         set out(Z) [expr {$in(Y)*sin($rotX)+$in(Z)*cos($rotX)}]
     }
     proc rotate_Y { rotY in_var out_var } {
         upvar       $in_var in $out_var out
         set out(X) [expr {$in(X)*cos($rotY)+$in(Z)*sin($rotY)}]
         set out(Y) $in(Y)
         set out(Z) [expr {-$in(X)*sin($rotY)+$in(Z)*cos($rotY)}]
     }
     proc rotate_Z { rotZ in_var out_var } {
         upvar       $in_var in $out_var out
         set out(X) [expr {$in(X)*cos($rotZ)-$in(Y)*sin($rotZ)}]
         set out(Y) [expr {$in(X)*sin($rotZ)+$in(Y)*cos($rotZ)}]
         set out(Z) $in(Z)
     }
     proc translate { dX dY dZ in_var out_var } {
         upvar       $in_var in $out_var out
         set out(X) [expr {$in(X)+$dX}]
         set out(Y) [expr {$in(Y)+$dY}]
         set out(Z) [expr {$in(Z)+$dZ}]
     }
     proc rototranslation { parameters in_var out_var } {
         upvar       $parameters P $in_var in $out_var out4
         rotate_Z  $P(rotZ) in   out1
         rotate_Y  $P(rotY) out1 out2
         rotate_X  $P(rotX) out2 out3
         translate $P(dX) $P(dY) $P(dZ) out3 out4
     }
     proc perspective { D world_var plane_var } {
         upvar       $world_var world $plane_var plane
         set rho [expr {1-double($world(Z))/double($D)}]
         set plane(X) [expr {$world(X)/$rho}]
         set plane(Y) [expr {$world(Y)/$rho}]
     }
</pre>
   <p class="noindent">and the world to plane and world to canvas transformations as:

<pre class="example">     array set world2plane_parameters {
         dX          0.0
         dY          0.0
         dZ          0.0
         rotX        0.0
         rotY        0.0
         rotZ        0.0
         D           1700.0
     }
     proc world2plane { P_world_var P_plane_var } {
         global      world2plane_parameters
         upvar       $P_world_var P_world $P_plane_var P_plane
         rototranslation world2plane_parameters P_world P
         perspective $world2plane_parameters(D) P P_plane
     }
     proc world2canvas { P_world_var P_canvas_var } {
         upvar       $P_world_var P_world $P_canvas_var P_canvas
         world2plane  P_world P_plane
         plane2canvas P_plane P_canvas
     }
</pre>
   <p class="noindent">setting the initial rototranslation parameters to 0 makes the
world frame XY axes superimposed to the plane frame XY
axes.

   <p>We can draw the world frame axes with the following procedures:

<pre class="example">     proc draw_world_axis { A_world_var B_world_var tag } {
         upvar       $A_world_var A_world $B_world_var B_world
     
         world2canvas  A_world A_canvas
         world2canvas  B_world B_canvas
     
         .canvas create line \
             $A_canvas(X) $A_canvas(Y)       \
             $B_canvas(X) $B_canvas(Y)       \
             -tag $tag
     }
     proc draw_world_frame {} {
         global      canvas_width canvas_height
         set len \
             [expr {0.4*(($canvas_width&lt;$canvas_height)? \
                             $canvas_width : $canvas_height)}]
         set neg_len [expr {-($len)}]
     
         array set X_axis_A [list X $neg_len Y 0 Z 0]
         array set X_axis_B [list X $len     Y 0 Z 0]
         draw_world_axis X_axis_A X_axis_B Xaxis
     
         array set Y_axis_A [list X 0 Y $neg_len Z 0]
         array set Y_axis_B [list X 0 Y $len     Z 0]
         draw_world_axis Y_axis_A Y_axis_B Yaxis
     
         array set Z_axis_A [list X 0 Y 0 Z $neg_len]
         array set Z_axis_B [list X 0 Y 0 Z $len    ]
         draw_world_axis Z_axis_A Z_axis_B Zaxis
     }
</pre>
   <p class="noindent">finally, we can draw lines in the world frame with the following
procedure:

<pre class="example">     proc draw_world_line { A_world_var B_world_var } {
         upvar       $A_world_var A_world $B_world_var B_world
         world2canvas A_world A_canvas
         world2canvas B_world B_canvas
         .canvas create line \
             $A_canvas(X) $A_canvas(Y)       \
             $B_canvas(X) $B_canvas(Y)
     }
</pre>
   <p class="noindent">from now on we assume that these procedures are part of the script's
preamble.

   <p>To see if the transformation works, we need to draw something more
complicated than a line; the following script draws a cube:

<pre class="example">     array set world2plane_parameters {
         rotX    -0.5
         rotY    -0.1
         rotZ    -1.8
     }
     
     draw_canvas_frame
     draw_plane_frame
     draw_world_frame
     
     # square on the XY world plane
     array set A { X  0 Y  0 Z  0 }
     array set B { X 60 Y  0 Z  0 }
     draw_world_line A B
     array set C { X 60 Y 60 Z  0 }
     draw_world_line B C
     array set D { X  0 Y 60 Z  0 }
     draw_world_line C D
     draw_world_line D A
     
     # square on the parallel to XY world plane
     array set A { X  0 Y  0 Z 60 }
     array set B { X 60 Y  0 Z 60 }
     draw_world_line A B
     array set C { X 60 Y 60 Z 60 }
     draw_world_line B C
     array set D { X  0 Y 60 Z 60 }
     draw_world_line C D
     draw_world_line D A
     
     # vertical lines
     array set A { X  0 Y  0 Z  0 }
     array set B { X  0 Y  0 Z 60 }
     draw_world_line A B
     array set A { X  0 Y 60 Z  0 }
     array set B { X  0 Y 60 Z 60 }
     draw_world_line A B
     array set A { X 60 Y 60 Z  0 }
     array set B { X 60 Y 60 Z 60 }
     draw_world_line A B
     array set A { X 60 Y  0 Z  0 }
     array set B { X 60 Y  0 Z 60 }
     draw_world_line A B
     
     .canvas itemconfigure Xaxis -arrow last -fill green
     .canvas itemconfigure Yaxis -arrow last -fill red
     .canvas itemconfigure Zaxis -arrow last -fill blue
</pre>
   <!-- page -->
<div class="node">
<a name="wireframe-intro-moving"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframe-intro-media">wireframe intro media</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframe-intro-world">wireframe intro world</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframe-intro">wireframe intro</a>

</div>

<h4 class="subsection">17.1.5 Drawing a in a moving frame</h4>

<p>Computing all the coordinates of a tridimensional scene with respect to
a single world frame is not user friendly; we define a reference frame,
called <dfn>moving frame</dfn>, with the same properties of the world frame,
but which we can move around with respect to the world frame.

   <p>We can convert moving frame coordinates to world coordinates and canvas
coordinates with the following procedures:

<pre class="example">     array set moving2world_parameters {
         dX          0.0
         dY          0.0
         dZ          0.0
         rotX        0.0
         rotY        0.0
         rotZ        0.0
     }
     proc moving2world { P_moving_var P_world_var } {
         global      moving2world_parameters
         upvar       $P_moving_var P_moving $P_world_var P_world
         rototranslation moving2world_parameters P_moving P_world
     }
     proc moving2canvas { P_moving_var P_canvas_var } {
         upvar       $P_moving_var P_moving $P_canvas_var P_canvas
         moving2world P_moving P_world
         world2plane  P_world  P_plane
         plane2canvas P_plane  P_canvas
     }
</pre>
   <p class="noindent">and we can draw moving frame axes with the following procedures:

<pre class="example">     proc draw_moving_axis { A_moving_var B_moving_var tag } {
         upvar       $A_moving_var A_moving $B_moving_var B_moving
         moving2canvas A_moving A_canvas
         moving2canvas B_moving B_canvas
         .canvas create line \
             $A_canvas(X) $A_canvas(Y)       \
             $B_canvas(X) $B_canvas(Y)       \
             -tag $tag
     }
     proc draw_moving_frame {} {
         global      canvas_width canvas_height
         set len \
             [expr {0.35*(($canvas_width&lt;$canvas_height)? \
                             $canvas_width : $canvas_height)}]
         set neg_len [expr {-($len)}]
     
         array set X_axis_A [list X $neg_len Y 0 Z 0]
         array set X_axis_B [list X $len     Y 0 Z 0]
         draw_moving_axis X_axis_A X_axis_B Xaxis
     
         array set Y_axis_A [list X 0 Y $neg_len Z 0]
         array set Y_axis_B [list X 0 Y $len     Z 0]
         draw_moving_axis Y_axis_A Y_axis_B Yaxis
     
         array set Z_axis_A [list X 0 Y 0 Z $neg_len]
         array set Z_axis_B [list X 0 Y 0 Z $len    ]
         draw_moving_axis Z_axis_A Z_axis_B Zaxis
     }
</pre>
   <p>From now on we assume that the procedures above are included in the
script's preamble.

   <p>The idea is to haul the moving frame to a position and draw a group of
elements using the moving coordinates, then haul the moving frame to
another position and draw another group of elements, and so on.  For
example, the following procedure draws a line using the current moving
coordinates:

<pre class="example">     proc draw_moving_line { A_moving_var B_moving_var } {
         upvar       $A_moving_var A_moving $B_moving_var B_moving
         moving2canvas A_moving A_canvas
         moving2canvas B_moving B_canvas
         .canvas create line \
             $A_canvas(X) $A_canvas(Y)       \
             $B_canvas(X) $B_canvas(Y)
     }
</pre>
   <p>The following script draws a cube using coordinates in the moving frame:

<pre class="example">     array set world2plane_parameters {
         rotX    -0.5
         rotY    -0.1
         rotZ    -1.8
     }
     array set moving2world_parameters {
         dX      60
         dY      60
         dZ      10
         rotX    -0.1
         rotY    -0.05
         rotZ    -0.1
     }
     draw_canvas_frame
     draw_plane_frame
     draw_world_frame
     draw_moving_frame
     
     # square on the XY world plane
     array set A { X  0 Y  0 Z  0 }
     array set B { X 60 Y  0 Z  0 }
     draw_moving_line A B
     array set C { X 60 Y 60 Z  0 }
     draw_moving_line B C
     array set D { X  0 Y 60 Z  0 }
     draw_moving_line C D
     draw_moving_line D A
     
     # square on the parallel to XY world plane
     array set A { X  0 Y  0 Z 100 }
     array set B { X 60 Y  0 Z 100 }
     draw_moving_line A B
     array set C { X 60 Y 60 Z 100 }
     draw_moving_line B C
     array set D { X  0 Y 60 Z 100 }
     draw_moving_line C D
     draw_moving_line D A
     
     # vertical lines
     array set A { X  0 Y  0 Z   0 }
     array set B { X  0 Y  0 Z 100 }
     draw_moving_line A B
     array set A { X  0 Y 60 Z   0 }
     array set B { X  0 Y 60 Z 100 }
     draw_moving_line A B
     array set A { X 60 Y 60 Z   0 }
     array set B { X 60 Y 60 Z 100 }
     draw_moving_line A B
     array set A { X 60 Y  0 Z   0 }
     array set B { X 60 Y  0 Z 100 }
     draw_moving_line A B
     
     .canvas itemconfigure Xaxis -arrow last -fill green
     .canvas itemconfigure Yaxis -arrow last -fill red
     .canvas itemconfigure Zaxis -arrow last -fill blue
</pre>
   <!-- page -->
<div class="node">
<a name="wireframe-intro-media"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframe-intro-coords">wireframe intro coords</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframe-intro-moving">wireframe intro moving</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframe-intro">wireframe intro</a>

</div>

<h4 class="subsection">17.1.6 Separating media commands</h4>

<p>It is easy to see how the code actually accessing the <acronym>TK</acronym> canvas
widget can be factored out from the previous procedures; the procedures
using the canvas command are:

<pre class="example">     draw_plane_axis
     draw_world_axis         draw_world_line
     draw_moving_axis        draw_moving_line
</pre>
   <p class="noindent">they can be rewritten as:

<pre class="example">     proc draw_media_line { A_var B_var tag } {
         upvar       $A_var A $B_var B
         .canvas create line $A(X) $A(Y) $B(X) $B(Y) -tag $tag
     }
     proc draw_plane_line { A_plane_var B_plane_var tag } {
         upvar       $A_plane_var A_plane $B_plane_var B_plane
         plane2canvas A_plane A_canvas
         plane2canvas B_plane B_canvas
         draw_media_line A_canvas B_canvas tag
     }
     proc draw_world_line { A_world_var B_world_var tag } {
         upvar       $A_world_var A_world $B_world_var B_world
         world2canvas A_world A_canvas
         world2canvas B_world B_canvas
         draw_media_line A_canvas B_canvas $tag
     }
     proc draw_moving_line { A_moving_var B_moving_var tag } {
         upvar       $A_moving_var A_moving $B_moving_var B_moving
         moving2canvas A_moving A_canvas
         moving2canvas B_moving B_canvas
         draw_media_line A_canvas B_canvas $tag
     }
     interp alias {} draw_plane_line  {} draw_plane_axis
     interp alias {} draw_world_line  {} draw_world_axis
     interp alias {} draw_moving_line {} draw_moving_axis
</pre>
   <p class="noindent">so that the following script draws the frames and the cube:

<pre class="example">     array set world2plane_parameters {
         rotX    -0.5
         rotY    -0.1
         rotZ    -1.8
     }
     array set moving2world_parameters {
         dX      60
         dY      60
         dZ      10
         rotX    -0.1
         rotY    -0.05
         rotZ    -0.1
     }
     draw_canvas_frame
     draw_plane_frame
     draw_world_frame
     draw_moving_frame
     
     # square on the XY world plane
     array set A { X  0 Y  0 Z  0 }
     array set B { X 60 Y  0 Z  0 }
     draw_moving_line A B Line
     array set C { X 60 Y 60 Z  0 }
     draw_moving_line B C Line
     array set D { X  0 Y 60 Z  0 }
     draw_moving_line C D Line
     draw_moving_line D A Line
     
     # square on the parallel to XY world plane
     array set A { X  0 Y  0 Z 100 }
     array set B { X 60 Y  0 Z 100 }
     draw_moving_line A B Line
     array set C { X 60 Y 60 Z 100 }
     draw_moving_line B C Line
     array set D { X  0 Y 60 Z 100 }
     draw_moving_line C D Line
     draw_moving_line D A Line
     
     # vertical lines
     array set A { X  0 Y  0 Z   0 }
     array set B { X  0 Y  0 Z 100 }
     draw_moving_line A B Line
     array set A { X  0 Y 60 Z   0 }
     array set B { X  0 Y 60 Z 100 }
     draw_moving_line A B Line
     array set A { X 60 Y 60 Z   0 }
     array set B { X 60 Y 60 Z 100 }
     draw_moving_line A B Line
     array set A { X 60 Y  0 Z   0 }
     array set B { X 60 Y  0 Z 100 }
     draw_moving_line A B Line
     
     .canvas itemconfigure Xaxis -arrow last -fill green
     .canvas itemconfigure Yaxis -arrow last -fill red
     .canvas itemconfigure Zaxis -arrow last -fill blue
     .canvas itemconfigure Line -fill black
</pre>
   <!-- page -->
<div class="node">
<a name="wireframe-intro-coords"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframe-intro-media">wireframe intro media</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframe-intro">wireframe intro</a>

</div>

<h4 class="subsection">17.1.7 Better coordinates handling</h4>

<p>Storing line coordinates in arrays makes handling of complex graphics
elements impossible; so rather than do:

<pre class="example">     array set P { X 1 Y 2 Z 3 }
     array set Q { X 4 Y 5 Z 6 }
</pre>
   <p class="noindent">coordinates can be stored in lists:

<pre class="example">     set PQ { { X 1 Y 2 Z 3 }
              { X 4 Y 5 Z 6 } }
</pre>
   <p class="noindent">so that they can be processed with <code>[foreach]</code>; then multiline
paths can be described by lists of lists, rather than:

<pre class="example">     array set P { X 1 Y 2 Z 3 }
     array set Q { X 4 Y 5 Z 6 }
     array set R { X 7 Y 8 Z 9 }
     draw_world_line P Q Line
     draw_world_line Q R Line
</pre>
   <p class="noindent">we can write:

<pre class="example">     set PQR { { X 1 Y 2 Z 3 }
               { X 4 Y 5 Z 6 }
               { X 7 Y 8 Z 9 } }
     draw_world_path PQR Line
</pre>
   <p class="noindent">and we can remove the coordinates names:

<pre class="example">     set PQR { { 1 2 3 }
               { 4 5 6 }
               { 7 8 9 } }
</pre>
   <p class="noindent">and since the coordinates always come in triplets:

<pre class="example">     set PQR { 1 2 3
               4 5 6
               7 8 9 }
</pre>
   <p class="noindent">so we can iterate over triplets with:

<pre class="example">     foreach { x y z } $coords { ... }
</pre>
   <p>This reorganisation puts us close to the code in the
<code>UTP::wireframe</code> package.

<!-- page -->
<div class="node">
<a name="wireframe-element"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframe-ops">wireframe ops</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframe-intro">wireframe intro</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframe">wireframe</a>

</div>

<h3 class="section">17.2 Format of the elements list</h3>

<p>The package operates upon lists of lists in which each sublist is the
description of a geometric object.  The format of the sublists is
private, but we can roughly thing of it as:

<pre class="example">     ELEMENT := { SUBLIST SUBLIST ... }
     SUBLIST := { COMMAND ... COORDS CACHED_COORDS SCENE_COORDS ... }
</pre>
   <p class="noindent">important components of sublists are:

     <dl>
<dt><var>command</var><dd>The name of the graphical element or an operation to be performed on the
internal state of the output media: <code>line</code>, <code>polygon</code>,
<code>text</code>, <code>tag</code>, <code>move</code>, <code>position</code>.

     <br><dt><var>shape coordinates</var><dd>A list of <code>UTP::hoco</code> coordinates representing the shape of the
geometric object; for example: the list of points defining a squared
path.

     <br><dt><var>internal transform</var><dd>A list of references to <code>UTP::hoco</code> dynamic transforms used to move
the element in the scene; they are meant to be used to move an object
with respect to another one.

     <p>For example, think about a robot arm with 3 links; we draw the
first a link, then with a rototranslation we move to its end and draw
the second link, then with a rototranslation we move to its end and draw
the third link; the rototranslations are internal transformations we may
want to dynamically update.

     <br><dt><var>cached coordinates</var><dd>A list of <code>UTP::hoco</code> coordinates representing the shape
coordinates after the internal transforms have been applied; these
coordinates are cached in the sublist, so that they do not need to be
recomputed whenever the point of view is changed without changing the
relative positions of the objects.

     <br><dt><var>scene coordinates</var><dd>A list of <code>UTP::hoco</code> coordinates representing the shape
coordinates after the internal and external transforms have been
applied; external transforms are used to select the point of view of the
scene; these coordinates are cached in the sublist so that they do not
need to be recomputed whenever the scene is repainted on a media without
changing the objects position nor the point of view.

     <br><dt><var>id</var><dd>A unique identifier that may be used to reference the element (for
example: to remove/update it in a <acronym>TK</acronym> canvas widget); by default the
procedures in this package will set this field to the empty string.

     <br><dt><var>tags</var><dd>A list of tags (example: <acronym>TK</acronym> tags) used to configure the element; some
tags are selected by the package's procedures, others may be selected by
the user of the package. 
</dl>

   <p>Elements lists can be concatenated to obtain a valid element list,
example:

<pre class="example">     set ell [concat \
         [make_an_element ...] \
         [make_another_element ...]]
</pre>
   <!--  -->
<h5 class="subsubheading">List manipulation procedures</h5>

<p>In the following descriptions <var>listVar</var> is the name of a variable
holding the list of elements, <var>elmIndex</var> is the index of the element
to handle.

<div class="defun">
&mdash; Alias: <b>utp_wireframe_set_command</b><var> listVar elmIndex newCmd<a name="index-utp_005fwireframe_005fset_005fcommand-416"></a></var><br>
&mdash; Alias: <b>utp_wireframe_get_command</b><var> listVar elmIndex<a name="index-utp_005fwireframe_005fget_005fcommand-417"></a></var><br>
<blockquote><p>Set/get an element command. 
</p></blockquote></div>

<div class="defun">
&mdash; Alias: <b>utp_wireframe_set_coords</b><var> listVar elmIndex newCoords<a name="index-utp_005fwireframe_005fset_005fcoords-418"></a></var><br>
&mdash; Alias: <b>utp_wireframe_get_coords</b><var> listVar elmIndex<a name="index-utp_005fwireframe_005fget_005fcoords-419"></a></var><br>
<blockquote><p>Set/get an element shape coords. 
</p></blockquote></div>

<div class="defun">
&mdash; Alias: <b>utp_wireframe_set_cached_coords</b><var> listVar elmIndex newCoords<a name="index-utp_005fwireframe_005fset_005fcached_005fcoords-420"></a></var><br>
&mdash; Alias: <b>utp_wireframe_get_cached_coords</b><var> listVar elmIndex<a name="index-utp_005fwireframe_005fget_005fcached_005fcoords-421"></a></var><br>
<blockquote><p>Set/get an element cached coords. 
</p></blockquote></div>

<div class="defun">
&mdash; Alias: <b>utp_wireframe_set_scene_coords</b><var> listVar elmIndex newCoords<a name="index-utp_005fwireframe_005fset_005fscene_005fcoords-422"></a></var><br>
&mdash; Alias: <b>utp_wireframe_get_scene_coords</b><var> listVar elmIndex<a name="index-utp_005fwireframe_005fget_005fscene_005fcoords-423"></a></var><br>
<blockquote><p>Set/get an element scene coords. 
</p></blockquote></div>

<div class="defun">
&mdash; Alias: <b>utp_wireframe_set_transforms</b><var> listVar elmIndex newTrans<a name="index-utp_005fwireframe_005fset_005ftransforms-424"></a></var><br>
&mdash; Alias: <b>utp_wireframe_get_transforms</b><var> listVar elmIndex<a name="index-utp_005fwireframe_005fget_005ftransforms-425"></a></var><br>
<blockquote><p>Set/get an element internal dynamic transform list. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_set_all_transforms</b><var> listVar newTrans<a name="index-utp_005fwireframe_005fset_005fall_005ftransforms-426"></a></var><br>
<blockquote><p>Set the internal transforms of all the elements. 
</p></blockquote></div>

<div class="defun">
&mdash; Alias: <b>utp_wireframe_set_id</b><var> listVar elmIndex newId<a name="index-utp_005fwireframe_005fset_005fid-427"></a></var><br>
&mdash; Alias: <b>utp_wireframe_get_id</b><var> listVar elmIndex<a name="index-utp_005fwireframe_005fget_005fid-428"></a></var><br>
<blockquote><p>Set/get an element id. 
</p></blockquote></div>

<div class="defun">
&mdash; Alias: <b>utp_wireframe_set_tags</b><var> listVar elmIndex newTags<a name="index-utp_005fwireframe_005fset_005ftags-429"></a></var><br>
&mdash; Alias: <b>utp_wireframe_get_tags</b><var> listVar elmIndex<a name="index-utp_005fwireframe_005fget_005ftags-430"></a></var><br>
<blockquote><p>Set/get an element tags. 
</p></blockquote></div>

<div class="defun">
&mdash; Alias: <b>utp_wireframe_set_opt</b><var> listVar elmIndex newOpt<a name="index-utp_005fwireframe_005fset_005fopt-431"></a></var><br>
&mdash; Alias: <b>utp_wireframe_get_opt</b><var> listVar elmIndex<a name="index-utp_005fwireframe_005fget_005fopt-432"></a></var><br>
<blockquote><p>Set/get an element optional value. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="wireframe-ops"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframe-templates">wireframe templates</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframe-element">wireframe element</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframe">wireframe</a>

</div>

<h3 class="section">17.3 Operations upon elements</h3>

<p>Remember that element lists are lists, so all the <acronym>TCL</acronym> list commands
can be used to manipulate them; example: elements lists may be
concatenated with a simple <code>[concat]</code>.

   <p>For all the procedures: the <var>ellVar</var> argument is the name of a
variable in the scope of the caller that holds the list of elements.

<div class="defun">
&mdash; Proc: <b>utp_wireframe_apply_shaping_transform</b><var> ellVar transform<a name="index-utp_005fwireframe_005fapply_005fshaping_005ftransform-433"></a></var><br>
<blockquote><p>Apply the <code>UTP::hoco</code> &ldquo;static&rdquo; transform to the shaping
coordinates and save the result in the shaping coordinates field
(see <a href="#hoco-procs-transform">hoco procs transform</a> for procedures used to generate static
transforms).  This procedure should be used to shape an element while
building it. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_apply_internal_transform</b><var> ellVar<a name="index-utp_005fwireframe_005fapply_005finternal_005ftransform-434"></a></var><br>
<blockquote><p>Apply the internal <code>UTP::hoco</code> dynamic transforms to the shaping
coordinates and save the result in the cached coordinates field
(see <a href="#hoco-dynamic">hoco dynamic</a> for procedures used to generate dynamic
transforms).  This procedure should be used to rebuild an element in a
scene after at least one internal dynamic transform has been updated.

        <p>The dynamic transforms must have been previously registered with
<code>[utp_wireframe_set_all_transforms]</code> or
<code>[utp_wireframe_set_transforms]</code>.  If no transforms are registered:
the shaping coordinates are copied into the cached coordinates field. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_apply_external_transform</b><var> ellVar transforms ?display_script?<a name="index-utp_005fwireframe_005fapply_005fexternal_005ftransform-435"></a></var><br>
<blockquote><p>Apply a list of <code>UTP::hoco</code> dynamic transforms to the cached
coordinates, and save the result in the scene coordinates field.  This
procedure should be used to compute the projection of geometric objects
onto the display plane (example: a <acronym>TK</acronym> canvas widget).

        <p>Internally, this function has a <code>[for]</code> loop over sublists;
<var>display_script</var>, if present, is executed once at each iteration
with two arguments appended: the name of the variable holding the
elements list, the index of the current sublist.

        <p><var>display_script</var> can be the name of a procedure like this:

     <pre class="example">          proc display_script { ellVar i } {
              upvar $ellVar ell
          
              do_something \
                  [utp_wireframe_get_command      ell $i] \
                  [utp_wireframe_get_scene_coords ell $i]
          }
</pre>
        <p class="noindent">its purpose is to display the object on the target media.  Its
invocation is embedded in this procedure to save an iteration upon the
elements list. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_apply_shaping_transform</b><var> ellVar element_index transform<a name="index-utp_005fwireframe_005fapply_005fshaping_005ftransform-436"></a></var><br>
&mdash; Proc: <b>utp_wireframe_apply_internal_transform</b><var> ellVar element_index<a name="index-utp_005fwireframe_005fapply_005finternal_005ftransform-437"></a></var><br>
&mdash; Proc: <b>utp_wireframe_apply_external_transform</b><var> ellVar element_index transforms ?display_script?<a name="index-utp_005fwireframe_005fapply_005fexternal_005ftransform-438"></a></var><br>
<blockquote><p>Like the above but process only the element at <var>element_index</var>. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="wireframe-templates"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframe-basic">wireframe basic</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframe-ops">wireframe ops</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframe">wireframe</a>

</div>

<h3 class="section">17.4 Element coordinates templates</h3>

<p>One and two dimensional elements are defined in the XY plane,
with unitary coordinates and &ldquo;direction&rdquo; from negative to positive;
see the line and square examples to make up an idea.

<div class="defun">
&mdash; Proc: <b>utp_wireframe_coords_line</b><var><a name="index-utp_005fwireframe_005fcoords_005fline-439"></a></var><br>
<blockquote><p>Return the coords of a line from <code>(-1, 0)</code> to <code>(1, 0)</code>.  That
is:

     <pre class="example">          {-1 0 0 1    1 0 0 1}
</pre>
        </blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_coords_square</b><var><a name="index-utp_005fwireframe_005fcoords_005fsquare-440"></a></var><br>
<blockquote><p>Return the coords of a square; that is:
     <pre class="example">          { 1 1 0 1   -1 1 0 1   -1 -1 0 1    1 -1 0 1 }
</pre>
        </blockquote></div>

   <p>The basic square:

<pre class="example">            Y ^
              |
     (-1,1) --+-- (1,1)
           |  |  |
        ---+--+--+---&gt; X
           |  |  |
            --+--
     (-1,-1)  |   (1,-1)
</pre>
   <div class="defun">
&mdash; Proc: <b>utp_wireframe_coords_tee</b><var><a name="index-utp_005fwireframe_005fcoords_005ftee-441"></a></var><br>
<blockquote><p>Returns the coords for a tee element. 
</p></blockquote></div>

   <p>The basic tee:

<pre class="example">            Y ^
              |  | (1,1)
     (-1,0)   |  |
        ---======+---&gt; X
              |  |
              |  | (1,-1)
</pre>
   <div class="defun">
&mdash; Proc: <b>utp_wireframe_coords_circle</b><var><a name="index-utp_005fwireframe_005fcoords_005fcircle-442"></a></var><br>
<blockquote><p>Return the coordinates for a polygon with 100 vertices; this is good for
&ldquo;small&rdquo; circles, for big ones use the polygon procedure with a bigger
number of points.  The first point is at <code>(0, 0, 0, 1)</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_coords_polygon</b><var> count<a name="index-utp_005fwireframe_005fcoords_005fpolygon-443"></a></var><br>
<blockquote><p>Return the coordinates of a regular polygon: a closed path of connected
lines of equal length.  It is the list of coordinates used to build a
path with the last point equal to the first; <var>count</var> is the number
of vertices: 3 yields a triangle, 4 yields a square, 5 a pentagon and so
on.  The first point is at <code>(0, 0, 0, 1)</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_coords_parametric</b><var> x_coords y_coords z_coords<a name="index-utp_005fwireframe_005fcoords_005fparametric-444"></a></var><br>
<blockquote><p>Return the coordinates of a parametric line by merging the lists of each
coordinates.  Example: to produce a helicoidal line:

     <pre class="example">          set hel_x {};set hel_y {};set hel_z {};
          for {set t 0.0} {$t &lt; 14.0} {set t [expr {$t+0.1}]} {
              lappend hel_x [expr {cos(double($t))}]
              lappend hel_y [expr {sin(double($t))}]
              lappend hel_z [expr {double($t)/10.0}]
          }
          
          set ell [utp_wireframe_path \
            [utp_wireframe_coords_parametric $hel_x $hel_y $hel_z] \
            [utp_hoco_transform_scale 20]
</pre>
        </blockquote></div>

<!-- page -->
<div class="node">
<a name="wireframe-basic"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframe-aggregate">wireframe aggregate</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframe-templates">wireframe templates</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframe">wireframe</a>

</div>

<h3 class="section">17.5 Basic elements</h3>

<p>These procedures return elements lists with a single element.  The
<var>transform</var> parameter is always a transformation, in the format
accepted by <code>[utp_hoco_transform_coords]</code> (see <a href="#hoco-procs-core">hoco procs core</a>), which may represent a roto&ndash;translation with scaling factor,
applied to the template element coordinates to shape it and position it
in space.

   <p>The model is this: we build a list of basic elements representing a
scene, then we hand the list to an &ldquo;interpreter&rdquo; which takes one
element at a time and places it into some sort of visualiser, for
example a <acronym>TK</acronym> canvas widget.

   <p>The interpreter must know what to do with all the element types
described in this section; unrecognised types should be ignored.  Each
interpreter can define its own basic elements, for example to select
colors, but the <code>tag</code> element can do much.

<!--  -->
<h5 class="subsubheading">Reference frames</h5>

<p>It is responsibility of the interpreter to keep track of the current
position and orientation of a reference frame used to place objects.

   <p>Usually there are three frames:

     <dl>
<dt><code>plane-&gt;canvas</code><dd>A frame used to represent position and orientation of bidimensional
objects on the bidimensional space used to display them.

     <br><dt><code>world-&gt;plane</code><dd>An absolute frame used to represent the position and orientation of the
tridimensional scene with respect to the <code>canvas</code>; the origin of
the frame may be placed on the canvas plane.

     <br><dt><code>current-&gt;world</code><dd>Has a position and orientation with respect to the <code>world</code> and is
used to place elements. 
</dl>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_move</b><var> transform<a name="index-utp_005fwireframe_005fmove-445"></a></var><br>
<blockquote><p>Return a <code>move</code> element; it is meant to move the
<code>current-&gt;world</code> position and orientation relative to itself. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_position</b><var> transform<a name="index-utp_005fwireframe_005fposition-446"></a></var><br>
<blockquote><p>Return a <code>position</code> element; it is meant to move the
<code>current-&gt;world</code> position and orientation in an absolute position
and orientation in the <code>world-&gt;plane</code> reference. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Lines, paths, figures</h5>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_line</b><var> transform ?tag <small class="dots">...</small>?<a name="index-utp_005fwireframe_005fline-447"></a></var><br>
<blockquote><p>Return a <code>line</code> element built from the line template.  Tags:
<code>line</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_path</b><var> coords transform ?tags <small class="dots">...</small>?<a name="index-utp_005fwireframe_005fpath-448"></a></var><br>
<blockquote><p>Return a <code>line</code> element built from <var>coords</var>; the square, cirle
and polygon templates can be used to produce the <var>coords</var>
parameter.  Tags: <code>line</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_polygon</b><var> coords transform ?tags <small class="dots">...</small>?<a name="index-utp_005fwireframe_005fpolygon-449"></a></var><br>
<blockquote><p>Return a <code>polygon</code> element built from <var>coords</var>; this element is
meant to create a colored polygon when projected onto a plane. 
<var>coords</var> must be a list of coordinates that describes the perimeter;
this procedure takes care of duplicating the first coordinates set (4
numbers) and append it at the end to close the path.  Tags:
<code>polygon</code>. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Text elements</h5>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_text</b><var> string transform ?tag <small class="dots">...</small>?<a name="index-utp_005fwireframe_005ftext-450"></a></var><br>
<blockquote><p>Return a text element.  The coords field represents the origin; the
<code>opt</code> field is the text string.  Tags: <code>text</code>. 
</p></blockquote></div>

   <p>The text anchor point is positioned at <code>(0, 0, 0, 1)</code>.  It is
responsibility of the interpreter to select the correct text font,
anchor point, etc.; an application specific tag may be defined by the
user to select text attributes.

<!--  -->
<h5 class="subsubheading">Elements configuration</h5>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_tag</b><var> tag <small class="dots">...</small><a name="index-utp_005fwireframe_005ftag-451"></a></var><br>
<blockquote><p>Build an element that just signals to activate a set of tags for the
subsequent elements. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="wireframe-aggregate"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframe-basic">wireframe basic</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframe">wireframe</a>

</div>

<h3 class="section">17.6 Aggregate elements</h3>

<p>The last argument, <var>tags</var>, is always a list of tags that is appended
to each element of the aggregate element; it can be an empty string.

<!--  -->
<h5 class="subsubheading">Frames</h5>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_frame</b><var> transform ?tags?<a name="index-utp_005fwireframe_005fframe-452"></a></var><br>
<blockquote><p>Return a reference frame; it is made up of 3 lines.  Two tags for each
line: <code>frame axisX</code>, <code>frame axisY</code>, <code>frame axisZ</code>. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Solids</h5>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_prism</b><var> transform ?tags?<a name="index-utp_005fwireframe_005fprism-453"></a></var><br>
<blockquote><p>Return a prism.  One tag for each face: <code>prism+X</code>, <code>prism-X</code>,
<code>prism+Y</code>, <code>prism-Y</code>, <code>prism+Z</code>, <code>prism-Z</code>. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Planes</h5>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_plane</b><var> xtick ytick transform ?tags?<a name="index-utp_005fwireframe_005fplane-454"></a></var><br>
<blockquote><p>Return a grid, meant to represent a plane.  <var>xtick</var> is a list of X
coordinates locating the vertical lines; <var>ytick</var> is a list of Y
coordinates locating the horizontal lines.  If <var>xtick</var> equals
<var>ytick</var> the grid is made up of squares; the tick numbers must be at
least 2, if both are two: the result is a square. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_workspace</b><var> xtick ytick ztick transform ?tags?<a name="index-utp_005fwireframe_005fworkspace-455"></a></var><br>
<blockquote><p>Wrapper for three invocations to <code>[utp_wireframe_plane]</code>.  The
result are three orthogonal planes meant to be used as 3D scene
workspace. 
</p></blockquote></div>

<!--  -->
<h5 class="subsubheading">Circles and spheres</h5>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_sphere_meridians</b><var> number transforms ?tags?<a name="index-utp_005fwireframe_005fsphere_005fmeridians-456"></a></var><br>
<blockquote><p>Return a list of elements representing <var>number</var> meridians of a
sphere. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_sphere_parallels</b><var> number transforms ?tags?<a name="index-utp_005fwireframe_005fsphere_005fparallels-457"></a></var><br>
<blockquote><p>Return a list of elements representing <var>number</var> parallels of a
sphere. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_sphere</b><var> parallels meridians transforms ?tags?<a name="index-utp_005fwireframe_005fsphere-458"></a></var><br>
<blockquote><p>Return a list of elements representing sphere with meridians and
parallels. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="wireframetk"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Package-License">Package License</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframe">wireframe</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">18 TK wireframe objects visualiser</h2>

<p>The <code>UTP::wireframe::tk</code> package is based upon the <code>UTP::hoco</code>
and <code>UTP::wireframe</code> packages and implements functions to display
graphical objects into a <acronym>TK</acronym> canvas widget.

<ul class="menu">
<li><a accesskey="1" href="#wireframetk-struct">wireframetk struct</a>:           Visualiser structure. 
<li><a accesskey="2" href="#wireframetk-populate">wireframetk populate</a>:         Populating a canvas with objects. 
<li><a accesskey="3" href="#wireframetk-update">wireframetk update</a>:           Updating a canvas. 
<li><a accesskey="4" href="#wireframetk-misc">wireframetk misc</a>:             Miscellaneous procedures. 
</ul>

<!-- page -->
<div class="node">
<a name="wireframetk-struct"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframetk-populate">wireframetk populate</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframetk">wireframetk</a>

</div>

<h3 class="section">18.1 Visualiser structure</h3>

<div class="defun">
&mdash; Struct: <b>utp_wireframe_tk_canvas_t</b><var><a name="index-utp_005fwireframe_005ftk_005fcanvas_005ft-459"></a></var><br>
<blockquote><p>Type of structure used to hold what is needed to draw graphical objects
on a <acronym>TK</acronym> canvas widget.  Fields:

          <dl>
<dt><code>canvas</code><dd>The pathname of the canvas widget.

          <br><dt><code>current_tags</code><dd>The current list of tags to apply to the objects; it is used until the
next <code>tag</code> element resets it.

          <br><dt><code>utp_hoco_transform_canvas_t plane2canvas</code><dd><code>UTP::hoco</code> dynamic transform used to convert real coordinates to
canvas coordinates.

          <br><dt><code>utp_hoco_transform_view_t world2plane</code><dd><code>UTP::hoco</code> dynamic transform used to select the point of view of
the scene.

          <br><dt><code>utp_hoco_transform_homogeneous_t moving2world</code><dd><code>UTP::hoco</code> dynamic transform used to select the current position
in the scene.

          <br><dt><code>utp_boolean_t allow_foreign_types</code><dd>A boolean value: if true sublists of unrecognised type are ignored, else
they cause an error to be thrown; the default set by
<code>[utp_wireframe_tk_canvas_init]</code> is true.

          <br><dt><code>utp_proc_t coords_to_canvas</code><dd>The name of a procedure used to normalise linaer coordinates right
before putting elements on a <acronym>TK</acronym> canvas widget.  Defaults to
<code>[utp_wireframe_tk_coords_to_pixels]</code>. 
</dl>

        <p>All the fields have to be configured/updated by direct access to the
field variables. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_tk_canvas_init</b><var> C<a name="index-utp_005fwireframe_005ftk_005fcanvas_005finit-460"></a></var><br>
<blockquote><p>Initialise to typical values the transform fields of a
<code>utp_wireframe_tk_canvas_t</code> structure. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="wireframetk-populate"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframetk-update">wireframetk update</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframetk-struct">wireframetk struct</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframetk">wireframetk</a>

</div>

<h3 class="section">18.2 Populating a canvas with objects</h3>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_tk_canvas_populate</b><var> C ellVar i<a name="index-utp_005fwireframe_005ftk_005fcanvas_005fpopulate-461"></a></var><br>
<blockquote><p>Add the <var>i</var>-th element of the list in <var>ellVar</var> to the canvas
whose context is described by the <code>utp_wireframe_tk_canvas_t</code>
structure <var>C</var>.

        <p>The following element types are supported: <code>line</code>, <code>text</code>,
<code>tag</code>, <code>polygon</code>, <code>move</code>, <code>position</code>.  If an unknown
object is found an error is raised only if the <var>C</var> field
<code>allow_foreign_types</code> is set to false.

        <p>The unique canvas identifier produced by the widget is stored in the
sublist, so that it can be used by other procedures to update the
coordinates or remove/configure the object.

        <p>A script formed by this procedure's name and the <var>C</var> argument can be
used as third argument to
<code>[utp_wireframe_apply_external_transform]</code> (see <a href="#wireframe-ops">wireframe ops</a>). 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="wireframetk-update"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#wireframetk-misc">wireframetk misc</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframetk-populate">wireframetk populate</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframetk">wireframetk</a>

</div>

<h3 class="section">18.3 Updating a canvas</h3>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_tk_canvas_update</b><var> C ellVar i<a name="index-utp_005fwireframe_005ftk_005fcanvas_005fupdate-462"></a></var><br>
<blockquote><p>Update the context described by the <code>utp_wireframe_tk_canvas_t</code>
structure <var>C</var> with new scene coordinates for the <var>i</var>-th element
of the list in <var>ellVar</var>.  The element is located with the identifier
from the sublist.

        <p>This procedure allows to move an object without deleting it; deleting
and recreating is slower and drops the tags that have no graphical
objects left in the canvas.

        <p>A script formed by this procedure's name and the <var>C</var> argument can be
used as third parameter to
<code>[utp_wireframe_apply_external_transform]</code> (<a href="#wireframe-ops">wireframe ops</a> for
details). 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="wireframetk-misc"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframetk-update">wireframetk update</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#wireframetk">wireframetk</a>

</div>

<h3 class="section">18.4 Miscellaneous procedures</h3>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_tk_coords_to_mm</b><var> coords<a name="index-utp_005fwireframe_005ftk_005fcoords_005fto_005fmm-463"></a></var><br>
<blockquote><p>Append a <code>m</code> to each number in <var>coords</var>, stating that the
dimension is millimetres.  This procedure can be used to normalise
coordinates right before drawing elements on a canvas widget. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_tk_coords_to_pixels</b><var> coords<a name="index-utp_005fwireframe_005ftk_005fcoords_005fto_005fpixels-464"></a></var><br>
<blockquote><p>Apply the <code>entier</code> math function then append a <code>p</code> to each
number in <var>coords</var>, stating that the dimension is pixels.  This
procedure can be used to normalise coordinates right before drawing
elements on a canvas widget.

        <p>This is the default value for the <code>coords_to_canvas</code> field of
<code>[utp_wireframe_tk_canvas_t]</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_tk_canvas_remove</b><var> C ellVar i<a name="index-utp_005fwireframe_005ftk_005fcanvas_005fremove-465"></a></var><br>
<blockquote><p>Remove the <var>I</var>-th element in <var>ellVar</var> from the context <var>C</var>. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_tk_canvas_query_option</b><var> C option<a name="index-utp_005fwireframe_005ftk_005fcanvas_005fquery_005foption-466"></a></var><br>
<blockquote><p>Remove the configured value for a <acronym>TK</acronym> option. 
</p></blockquote></div>

<div class="defun">
&mdash; Proc: <b>utp_wireframe_tk_canvas_tag_config</b><var> C tag <small class="dots">...</small><a name="index-utp_005fwireframe_005ftk_005fcanvas_005ftag_005fconfig-467"></a></var><br>
<blockquote><p>Configure a tag of the <acronym>TK</acronym> canvas. 
</p></blockquote></div>

<!-- page -->
<div class="node">
<a name="Package-License"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Documentation-License">Documentation License</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#wireframetk">wireframetk</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="appendix">Appendix A <acronym>GNU</acronym> General Public License</h2>

<!-- The GNU General Public License. -->
<div align="center">Version 3, 29 June 2007</div>

<!-- This file is intended to be included within another document, -->
<!-- hence no sectioning command or @node. -->
<pre class="display">     Copyright &copy; 2007 Free Software Foundation, Inc. <a href="http://fsf.org/">http://fsf.org/</a>
     
     Everyone is permitted to copy and distribute verbatim copies of this
     license document, but changing it is not allowed.
</pre>
   <h3 class="heading">Preamble</h3>

<p>The GNU General Public License is a free, copyleft license for
software and other kinds of works.

   <p>The licenses for most software and other practical works are designed
to take away your freedom to share and change the works.  By contrast,
the GNU General Public License is intended to guarantee your freedom
to share and change all versions of a program&mdash;to make sure it remains
free software for all its users.  We, the Free Software Foundation,
use the GNU General Public License for most of our software; it
applies also to any other work released this way by its authors.  You
can apply it to your programs, too.

   <p>When we speak of free software, we are referring to freedom, not
price.  Our General Public Licenses are designed to make sure that you
have the freedom to distribute copies of free software (and charge for
them if you wish), that you receive source code or can get it if you
want it, that you can change the software or use pieces of it in new
free programs, and that you know you can do these things.

   <p>To protect your rights, we need to prevent others from denying you
these rights or asking you to surrender the rights.  Therefore, you
have certain responsibilities if you distribute copies of the
software, or if you modify it: responsibilities to respect the freedom
of others.

   <p>For example, if you distribute copies of such a program, whether
gratis or for a fee, you must pass on to the recipients the same
freedoms that you received.  You must make sure that they, too,
receive or can get the source code.  And you must show them these
terms so they know their rights.

   <p>Developers that use the GNU GPL protect your rights with two steps:
(1) assert copyright on the software, and (2) offer you this License
giving you legal permission to copy, distribute and/or modify it.

   <p>For the developers' and authors' protection, the GPL clearly explains
that there is no warranty for this free software.  For both users' and
authors' sake, the GPL requires that modified versions be marked as
changed, so that their problems will not be attributed erroneously to
authors of previous versions.

   <p>Some devices are designed to deny users access to install or run
modified versions of the software inside them, although the
manufacturer can do so.  This is fundamentally incompatible with the
aim of protecting users' freedom to change the software.  The
systematic pattern of such abuse occurs in the area of products for
individuals to use, which is precisely where it is most unacceptable. 
Therefore, we have designed this version of the GPL to prohibit the
practice for those products.  If such problems arise substantially in
other domains, we stand ready to extend this provision to those
domains in future versions of the GPL, as needed to protect the
freedom of users.

   <p>Finally, every program is threatened constantly by software patents. 
States should not allow patents to restrict development and use of
software on general-purpose computers, but in those that do, we wish
to avoid the special danger that patents applied to a free program
could make it effectively proprietary.  To prevent this, the GPL
assures that patents cannot be used to render the program non-free.

   <p>The precise terms and conditions for copying, distribution and
modification follow.

<h3 class="heading">TERMS AND CONDITIONS</h3>

     <ol type=1 start=0>
<li>Definitions.

     <p>&ldquo;This License&rdquo; refers to version 3 of the GNU General Public License.

     <p>&ldquo;Copyright&rdquo; also means copyright-like laws that apply to other kinds
of works, such as semiconductor masks.

     <p>&ldquo;The Program&rdquo; refers to any copyrightable work licensed under this
License.  Each licensee is addressed as &ldquo;you&rdquo;.  &ldquo;Licensees&rdquo; and
&ldquo;recipients&rdquo; may be individuals or organizations.

     <p>To &ldquo;modify&rdquo; a work means to copy from or adapt all or part of the work
in a fashion requiring copyright permission, other than the making of
an exact copy.  The resulting work is called a &ldquo;modified version&rdquo; of
the earlier work or a work &ldquo;based on&rdquo; the earlier work.

     <p>A &ldquo;covered work&rdquo; means either the unmodified Program or a work based
on the Program.

     <p>To &ldquo;propagate&rdquo; a work means to do anything with it that, without
permission, would make you directly or secondarily liable for
infringement under applicable copyright law, except executing it on a
computer or modifying a private copy.  Propagation includes copying,
distribution (with or without modification), making available to the
public, and in some countries other activities as well.

     <p>To &ldquo;convey&rdquo; a work means any kind of propagation that enables other
parties to make or receive copies.  Mere interaction with a user
through a computer network, with no transfer of a copy, is not
conveying.

     <p>An interactive user interface displays &ldquo;Appropriate Legal Notices&rdquo; to
the extent that it includes a convenient and prominently visible
feature that (1) displays an appropriate copyright notice, and (2)
tells the user that there is no warranty for the work (except to the
extent that warranties are provided), that licensees may convey the
work under this License, and how to view a copy of this License.  If
the interface presents a list of user commands or options, such as a
menu, a prominent item in the list meets this criterion.

     <li>Source Code.

     <p>The &ldquo;source code&rdquo; for a work means the preferred form of the work for
making modifications to it.  &ldquo;Object code&rdquo; means any non-source form
of a work.

     <p>A &ldquo;Standard Interface&rdquo; means an interface that either is an official
standard defined by a recognized standards body, or, in the case of
interfaces specified for a particular programming language, one that
is widely used among developers working in that language.

     <p>The &ldquo;System Libraries&rdquo; of an executable work include anything, other
than the work as a whole, that (a) is included in the normal form of
packaging a Major Component, but which is not part of that Major
Component, and (b) serves only to enable use of the work with that
Major Component, or to implement a Standard Interface for which an
implementation is available to the public in source code form.  A
&ldquo;Major Component&rdquo;, in this context, means a major essential component
(kernel, window system, and so on) of the specific operating system
(if any) on which the executable work runs, or a compiler used to
produce the work, or an object code interpreter used to run it.

     <p>The &ldquo;Corresponding Source&rdquo; for a work in object code form means all
the source code needed to generate, install, and (for an executable
work) run the object code and to modify the work, including scripts to
control those activities.  However, it does not include the work's
System Libraries, or general-purpose tools or generally available free
programs which are used unmodified in performing those activities but
which are not part of the work.  For example, Corresponding Source
includes interface definition files associated with source files for
the work, and the source code for shared libraries and dynamically
linked subprograms that the work is specifically designed to require,
such as by intimate data communication or control flow between those
subprograms and other parts of the work.

     <p>The Corresponding Source need not include anything that users can
regenerate automatically from other parts of the Corresponding Source.

     <p>The Corresponding Source for a work in source code form is that same
work.

     <li>Basic Permissions.

     <p>All rights granted under this License are granted for the term of
copyright on the Program, and are irrevocable provided the stated
conditions are met.  This License explicitly affirms your unlimited
permission to run the unmodified Program.  The output from running a
covered work is covered by this License only if the output, given its
content, constitutes a covered work.  This License acknowledges your
rights of fair use or other equivalent, as provided by copyright law.

     <p>You may make, run and propagate covered works that you do not convey,
without conditions so long as your license otherwise remains in force. 
You may convey covered works to others for the sole purpose of having
them make modifications exclusively for you, or provide you with
facilities for running those works, provided that you comply with the
terms of this License in conveying all material for which you do not
control copyright.  Those thus making or running the covered works for
you must do so exclusively on your behalf, under your direction and
control, on terms that prohibit them from making any copies of your
copyrighted material outside their relationship with you.

     <p>Conveying under any other circumstances is permitted solely under the
conditions stated below.  Sublicensing is not allowed; section 10
makes it unnecessary.

     <li>Protecting Users' Legal Rights From Anti-Circumvention Law.

     <p>No covered work shall be deemed part of an effective technological
measure under any applicable law fulfilling obligations under article
11 of the WIPO copyright treaty adopted on 20 December 1996, or
similar laws prohibiting or restricting circumvention of such
measures.

     <p>When you convey a covered work, you waive any legal power to forbid
circumvention of technological measures to the extent such
circumvention is effected by exercising rights under this License with
respect to the covered work, and you disclaim any intention to limit
operation or modification of the work as a means of enforcing, against
the work's users, your or third parties' legal rights to forbid
circumvention of technological measures.

     <li>Conveying Verbatim Copies.

     <p>You may convey verbatim copies of the Program's source code as you
receive it, in any medium, provided that you conspicuously and
appropriately publish on each copy an appropriate copyright notice;
keep intact all notices stating that this License and any
non-permissive terms added in accord with section 7 apply to the code;
keep intact all notices of the absence of any warranty; and give all
recipients a copy of this License along with the Program.

     <p>You may charge any price or no price for each copy that you convey,
and you may offer support or warranty protection for a fee.

     <li>Conveying Modified Source Versions.

     <p>You may convey a work based on the Program, or the modifications to
produce it from the Program, in the form of source code under the
terms of section 4, provided that you also meet all of these
conditions:

          <ol type=a start=1>
<li>The work must carry prominent notices stating that you modified it,
and giving a relevant date.

          <li>The work must carry prominent notices stating that it is released
under this License and any conditions added under section 7.  This
requirement modifies the requirement in section 4 to &ldquo;keep intact all
notices&rdquo;.

          <li>You must license the entire work, as a whole, under this License to
anyone who comes into possession of a copy.  This License will
therefore apply, along with any applicable section 7 additional terms,
to the whole of the work, and all its parts, regardless of how they
are packaged.  This License gives no permission to license the work in
any other way, but it does not invalidate such permission if you have
separately received it.

          <li>If the work has interactive user interfaces, each must display
Appropriate Legal Notices; however, if the Program has interactive
interfaces that do not display Appropriate Legal Notices, your work
need not make them do so.
          </ol>

     <p>A compilation of a covered work with other separate and independent
works, which are not by their nature extensions of the covered work,
and which are not combined with it such as to form a larger program,
in or on a volume of a storage or distribution medium, is called an
&ldquo;aggregate&rdquo; if the compilation and its resulting copyright are not
used to limit the access or legal rights of the compilation's users
beyond what the individual works permit.  Inclusion of a covered work
in an aggregate does not cause this License to apply to the other
parts of the aggregate.

     <li>Conveying Non-Source Forms.

     <p>You may convey a covered work in object code form under the terms of
sections 4 and 5, provided that you also convey the machine-readable
Corresponding Source under the terms of this License, in one of these
ways:

          <ol type=a start=1>
<li>Convey the object code in, or embodied in, a physical product
(including a physical distribution medium), accompanied by the
Corresponding Source fixed on a durable physical medium customarily
used for software interchange.

          <li>Convey the object code in, or embodied in, a physical product
(including a physical distribution medium), accompanied by a written
offer, valid for at least three years and valid for as long as you
offer spare parts or customer support for that product model, to give
anyone who possesses the object code either (1) a copy of the
Corresponding Source for all the software in the product that is
covered by this License, on a durable physical medium customarily used
for software interchange, for a price no more than your reasonable
cost of physically performing this conveying of source, or (2) access
to copy the Corresponding Source from a network server at no charge.

          <li>Convey individual copies of the object code with a copy of the written
offer to provide the Corresponding Source.  This alternative is
allowed only occasionally and noncommercially, and only if you
received the object code with such an offer, in accord with subsection
6b.

          <li>Convey the object code by offering access from a designated place
(gratis or for a charge), and offer equivalent access to the
Corresponding Source in the same way through the same place at no
further charge.  You need not require recipients to copy the
Corresponding Source along with the object code.  If the place to copy
the object code is a network server, the Corresponding Source may be
on a different server (operated by you or a third party) that supports
equivalent copying facilities, provided you maintain clear directions
next to the object code saying where to find the Corresponding Source. 
Regardless of what server hosts the Corresponding Source, you remain
obligated to ensure that it is available for as long as needed to
satisfy these requirements.

          <li>Convey the object code using peer-to-peer transmission, provided you
inform other peers where the object code and Corresponding Source of
the work are being offered to the general public at no charge under
subsection 6d.

          </ol>

     <p>A separable portion of the object code, whose source code is excluded
from the Corresponding Source as a System Library, need not be
included in conveying the object code work.

     <p>A &ldquo;User Product&rdquo; is either (1) a &ldquo;consumer product&rdquo;, which means any
tangible personal property which is normally used for personal,
family, or household purposes, or (2) anything designed or sold for
incorporation into a dwelling.  In determining whether a product is a
consumer product, doubtful cases shall be resolved in favor of
coverage.  For a particular product received by a particular user,
&ldquo;normally used&rdquo; refers to a typical or common use of that class of
product, regardless of the status of the particular user or of the way
in which the particular user actually uses, or expects or is expected
to use, the product.  A product is a consumer product regardless of
whether the product has substantial commercial, industrial or
non-consumer uses, unless such uses represent the only significant
mode of use of the product.

     <p>&ldquo;Installation Information&rdquo; for a User Product means any methods,
procedures, authorization keys, or other information required to
install and execute modified versions of a covered work in that User
Product from a modified version of its Corresponding Source.  The
information must suffice to ensure that the continued functioning of
the modified object code is in no case prevented or interfered with
solely because modification has been made.

     <p>If you convey an object code work under this section in, or with, or
specifically for use in, a User Product, and the conveying occurs as
part of a transaction in which the right of possession and use of the
User Product is transferred to the recipient in perpetuity or for a
fixed term (regardless of how the transaction is characterized), the
Corresponding Source conveyed under this section must be accompanied
by the Installation Information.  But this requirement does not apply
if neither you nor any third party retains the ability to install
modified object code on the User Product (for example, the work has
been installed in ROM).

     <p>The requirement to provide Installation Information does not include a
requirement to continue to provide support service, warranty, or
updates for a work that has been modified or installed by the
recipient, or for the User Product in which it has been modified or
installed.  Access to a network may be denied when the modification
itself materially and adversely affects the operation of the network
or violates the rules and protocols for communication across the
network.

     <p>Corresponding Source conveyed, and Installation Information provided,
in accord with this section must be in a format that is publicly
documented (and with an implementation available to the public in
source code form), and must require no special password or key for
unpacking, reading or copying.

     <li>Additional Terms.

     <p>&ldquo;Additional permissions&rdquo; are terms that supplement the terms of this
License by making exceptions from one or more of its conditions. 
Additional permissions that are applicable to the entire Program shall
be treated as though they were included in this License, to the extent
that they are valid under applicable law.  If additional permissions
apply only to part of the Program, that part may be used separately
under those permissions, but the entire Program remains governed by
this License without regard to the additional permissions.

     <p>When you convey a copy of a covered work, you may at your option
remove any additional permissions from that copy, or from any part of
it.  (Additional permissions may be written to require their own
removal in certain cases when you modify the work.)  You may place
additional permissions on material, added by you to a covered work,
for which you have or can give appropriate copyright permission.

     <p>Notwithstanding any other provision of this License, for material you
add to a covered work, you may (if authorized by the copyright holders
of that material) supplement the terms of this License with terms:

          <ol type=a start=1>
<li>Disclaiming warranty or limiting liability differently from the terms
of sections 15 and 16 of this License; or

          <li>Requiring preservation of specified reasonable legal notices or author
attributions in that material or in the Appropriate Legal Notices
displayed by works containing it; or

          <li>Prohibiting misrepresentation of the origin of that material, or
requiring that modified versions of such material be marked in
reasonable ways as different from the original version; or

          <li>Limiting the use for publicity purposes of names of licensors or
authors of the material; or

          <li>Declining to grant rights under trademark law for use of some trade
names, trademarks, or service marks; or

          <li>Requiring indemnification of licensors and authors of that material by
anyone who conveys the material (or modified versions of it) with
contractual assumptions of liability to the recipient, for any
liability that these contractual assumptions directly impose on those
licensors and authors.
          </ol>

     <p>All other non-permissive additional terms are considered &ldquo;further
restrictions&rdquo; within the meaning of section 10.  If the Program as you
received it, or any part of it, contains a notice stating that it is
governed by this License along with a term that is a further
restriction, you may remove that term.  If a license document contains
a further restriction but permits relicensing or conveying under this
License, you may add to a covered work material governed by the terms
of that license document, provided that the further restriction does
not survive such relicensing or conveying.

     <p>If you add terms to a covered work in accord with this section, you
must place, in the relevant source files, a statement of the
additional terms that apply to those files, or a notice indicating
where to find the applicable terms.

     <p>Additional terms, permissive or non-permissive, may be stated in the
form of a separately written license, or stated as exceptions; the
above requirements apply either way.

     <li>Termination.

     <p>You may not propagate or modify a covered work except as expressly
provided under this License.  Any attempt otherwise to propagate or
modify it is void, and will automatically terminate your rights under
this License (including any patent licenses granted under the third
paragraph of section 11).

     <p>However, if you cease all violation of this License, then your license
from a particular copyright holder is reinstated (a) provisionally,
unless and until the copyright holder explicitly and finally
terminates your license, and (b) permanently, if the copyright holder
fails to notify you of the violation by some reasonable means prior to
60 days after the cessation.

     <p>Moreover, your license from a particular copyright holder is
reinstated permanently if the copyright holder notifies you of the
violation by some reasonable means, this is the first time you have
received notice of violation of this License (for any work) from that
copyright holder, and you cure the violation prior to 30 days after
your receipt of the notice.

     <p>Termination of your rights under this section does not terminate the
licenses of parties who have received copies or rights from you under
this License.  If your rights have been terminated and not permanently
reinstated, you do not qualify to receive new licenses for the same
material under section 10.

     <li>Acceptance Not Required for Having Copies.

     <p>You are not required to accept this License in order to receive or run
a copy of the Program.  Ancillary propagation of a covered work
occurring solely as a consequence of using peer-to-peer transmission
to receive a copy likewise does not require acceptance.  However,
nothing other than this License grants you permission to propagate or
modify any covered work.  These actions infringe copyright if you do
not accept this License.  Therefore, by modifying or propagating a
covered work, you indicate your acceptance of this License to do so.

     <li>Automatic Licensing of Downstream Recipients.

     <p>Each time you convey a covered work, the recipient automatically
receives a license from the original licensors, to run, modify and
propagate that work, subject to this License.  You are not responsible
for enforcing compliance by third parties with this License.

     <p>An &ldquo;entity transaction&rdquo; is a transaction transferring control of an
organization, or substantially all assets of one, or subdividing an
organization, or merging organizations.  If propagation of a covered
work results from an entity transaction, each party to that
transaction who receives a copy of the work also receives whatever
licenses to the work the party's predecessor in interest had or could
give under the previous paragraph, plus a right to possession of the
Corresponding Source of the work from the predecessor in interest, if
the predecessor has it or can get it with reasonable efforts.

     <p>You may not impose any further restrictions on the exercise of the
rights granted or affirmed under this License.  For example, you may
not impose a license fee, royalty, or other charge for exercise of
rights granted under this License, and you may not initiate litigation
(including a cross-claim or counterclaim in a lawsuit) alleging that
any patent claim is infringed by making, using, selling, offering for
sale, or importing the Program or any portion of it.

     <li>Patents.

     <p>A &ldquo;contributor&rdquo; is a copyright holder who authorizes use under this
License of the Program or a work on which the Program is based.  The
work thus licensed is called the contributor's &ldquo;contributor version&rdquo;.

     <p>A contributor's &ldquo;essential patent claims&rdquo; are all patent claims owned
or controlled by the contributor, whether already acquired or
hereafter acquired, that would be infringed by some manner, permitted
by this License, of making, using, or selling its contributor version,
but do not include claims that would be infringed only as a
consequence of further modification of the contributor version.  For
purposes of this definition, &ldquo;control&rdquo; includes the right to grant
patent sublicenses in a manner consistent with the requirements of
this License.

     <p>Each contributor grants you a non-exclusive, worldwide, royalty-free
patent license under the contributor's essential patent claims, to
make, use, sell, offer for sale, import and otherwise run, modify and
propagate the contents of its contributor version.

     <p>In the following three paragraphs, a &ldquo;patent license&rdquo; is any express
agreement or commitment, however denominated, not to enforce a patent
(such as an express permission to practice a patent or covenant not to
sue for patent infringement).  To &ldquo;grant&rdquo; such a patent license to a
party means to make such an agreement or commitment not to enforce a
patent against the party.

     <p>If you convey a covered work, knowingly relying on a patent license,
and the Corresponding Source of the work is not available for anyone
to copy, free of charge and under the terms of this License, through a
publicly available network server or other readily accessible means,
then you must either (1) cause the Corresponding Source to be so
available, or (2) arrange to deprive yourself of the benefit of the
patent license for this particular work, or (3) arrange, in a manner
consistent with the requirements of this License, to extend the patent
license to downstream recipients.  &ldquo;Knowingly relying&rdquo; means you have
actual knowledge that, but for the patent license, your conveying the
covered work in a country, or your recipient's use of the covered work
in a country, would infringe one or more identifiable patents in that
country that you have reason to believe are valid.

     <p>If, pursuant to or in connection with a single transaction or
arrangement, you convey, or propagate by procuring conveyance of, a
covered work, and grant a patent license to some of the parties
receiving the covered work authorizing them to use, propagate, modify
or convey a specific copy of the covered work, then the patent license
you grant is automatically extended to all recipients of the covered
work and works based on it.

     <p>A patent license is &ldquo;discriminatory&rdquo; if it does not include within the
scope of its coverage, prohibits the exercise of, or is conditioned on
the non-exercise of one or more of the rights that are specifically
granted under this License.  You may not convey a covered work if you
are a party to an arrangement with a third party that is in the
business of distributing software, under which you make payment to the
third party based on the extent of your activity of conveying the
work, and under which the third party grants, to any of the parties
who would receive the covered work from you, a discriminatory patent
license (a) in connection with copies of the covered work conveyed by
you (or copies made from those copies), or (b) primarily for and in
connection with specific products or compilations that contain the
covered work, unless you entered into that arrangement, or that patent
license was granted, prior to 28 March 2007.

     <p>Nothing in this License shall be construed as excluding or limiting
any implied license or other defenses to infringement that may
otherwise be available to you under applicable patent law.

     <li>No Surrender of Others' Freedom.

     <p>If conditions are imposed on you (whether by court order, agreement or
otherwise) that contradict the conditions of this License, they do not
excuse you from the conditions of this License.  If you cannot convey
a covered work so as to satisfy simultaneously your obligations under
this License and any other pertinent obligations, then as a
consequence you may not convey it at all.  For example, if you agree
to terms that obligate you to collect a royalty for further conveying
from those to whom you convey the Program, the only way you could
satisfy both those terms and this License would be to refrain entirely
from conveying the Program.

     <li>Use with the GNU Affero General Public License.

     <p>Notwithstanding any other provision of this License, you have
permission to link or combine any covered work with a work licensed
under version 3 of the GNU Affero General Public License into a single
combined work, and to convey the resulting work.  The terms of this
License will continue to apply to the part which is the covered work,
but the special requirements of the GNU Affero General Public License,
section 13, concerning interaction through a network will apply to the
combination as such.

     <li>Revised Versions of this License.

     <p>The Free Software Foundation may publish revised and/or new versions
of the GNU General Public License from time to time.  Such new
versions will be similar in spirit to the present version, but may
differ in detail to address new problems or concerns.

     <p>Each version is given a distinguishing version number.  If the Program
specifies that a certain numbered version of the GNU General Public
License &ldquo;or any later version&rdquo; applies to it, you have the option of
following the terms and conditions either of that numbered version or
of any later version published by the Free Software Foundation.  If
the Program does not specify a version number of the GNU General
Public License, you may choose any version ever published by the Free
Software Foundation.

     <p>If the Program specifies that a proxy can decide which future versions
of the GNU General Public License can be used, that proxy's public
statement of acceptance of a version permanently authorizes you to
choose that version for the Program.

     <p>Later license versions may give you additional or different
permissions.  However, no additional obligations are imposed on any
author or copyright holder as a result of your choosing to follow a
later version.

     <li>Disclaimer of Warranty.

     <p>THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY
APPLICABLE LAW.  EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT
HOLDERS AND/OR OTHER PARTIES PROVIDE THE PROGRAM &ldquo;AS IS&rdquo; WITHOUT
WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND
PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE PROGRAM PROVE
DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR OR
CORRECTION.

     <li>Limitation of Liability.

     <p>IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MODIFIES AND/OR
CONVEYS THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES
ARISING OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT
NOT LIMITED TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR
LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM
TO OPERATE WITH ANY OTHER PROGRAMS), EVEN IF SUCH HOLDER OR OTHER
PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.

     <li>Interpretation of Sections 15 and 16.

     <p>If the disclaimer of warranty and limitation of liability provided
above cannot be given local legal effect according to their terms,
reviewing courts shall apply local law that most closely approximates
an absolute waiver of all civil liability in connection with the
Program, unless a warranty or assumption of liability accompanies a
copy of the Program in return for a fee.

     </ol>

<h3 class="heading">END OF TERMS AND CONDITIONS</h3>

<h3 class="heading">How to Apply These Terms to Your New Programs</h3>

<p>If you develop a new program, and you want it to be of the greatest
possible use to the public, the best way to achieve this is to make it
free software which everyone can redistribute and change under these
terms.

   <p>To do so, attach the following notices to the program.  It is safest
to attach them to the start of each source file to most effectively
state the exclusion of warranty; and each file should have at least
the &ldquo;copyright&rdquo; line and a pointer to where the full notice is found.

<pre class="smallexample">     <var>one line to give the program's name and a brief idea of what it does.</var>
     Copyright (C) <var>year</var> <var>name of author</var>
     
     This program is free software: you can redistribute it and/or modify
     it under the terms of the GNU General Public License as published by
     the Free Software Foundation, either version 3 of the License, or (at
     your option) any later version.
     
     This program is distributed in the hope that it will be useful, but
     WITHOUT ANY WARRANTY; without even the implied warranty of
     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
     General Public License for more details.
     
     You should have received a copy of the GNU General Public License
     along with this program.  If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.
</pre>
   <p>Also add information on how to contact you by electronic and paper mail.

   <p>If the program does terminal interaction, make it output a short
notice like this when it starts in an interactive mode:

<pre class="smallexample">     <var>program</var> Copyright (C) <var>year</var> <var>name of author</var>
     This program comes with ABSOLUTELY NO WARRANTY; for details type &lsquo;<samp><span class="samp">show w</span></samp>&rsquo;.
     This is free software, and you are welcome to redistribute it
     under certain conditions; type &lsquo;<samp><span class="samp">show c</span></samp>&rsquo; for details.
</pre>
   <p>The hypothetical commands &lsquo;<samp><span class="samp">show w</span></samp>&rsquo; and &lsquo;<samp><span class="samp">show c</span></samp>&rsquo; should show
the appropriate parts of the General Public License.  Of course, your
program's commands might be different; for a GUI interface, you would
use an &ldquo;about box&rdquo;.

   <p>You should also get your employer (if you work as a programmer) or school,
if any, to sign a &ldquo;copyright disclaimer&rdquo; for the program, if necessary. 
For more information on this, and how to apply and follow the GNU GPL, see
<a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.

   <p>The GNU General Public License does not permit incorporating your
program into proprietary programs.  If your program is a subroutine
library, you may consider it more useful to permit linking proprietary
applications with the library.  If this is what you want to do, use
the GNU Lesser General Public License instead of this License.  But
first, please read <a href="http://www.gnu.org/philosophy/why-not-lgpl.html">http://www.gnu.org/philosophy/why-not-lgpl.html</a>.

<div class="node">
<a name="Documentation-License"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#References">References</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Package-License">Package License</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="appendix">Appendix B GNU Free Documentation License</h2>

<p><a name="index-FDL_002c-GNU-Free-Documentation-License-468"></a><div align="center">Version 1.3, 3 November 2008</div>

<!-- This file is intended to be included within another document, -->
<!-- hence no sectioning command or @node. -->
<pre class="display">     Copyright &copy; 2000, 2001, 2002, 2007, 2008 Free Software Foundation, Inc.
     <a href="http://fsf.org/">http://fsf.org/</a>
     
     Everyone is permitted to copy and distribute verbatim copies
     of this license document, but changing it is not allowed.
</pre>
     <ol type=1 start=0>
<li>PREAMBLE

     <p>The purpose of this License is to make a manual, textbook, or other
functional and useful document <dfn>free</dfn> in the sense of freedom: to
assure everyone the effective freedom to copy and redistribute it,
with or without modifying it, either commercially or noncommercially. 
Secondarily, this License preserves for the author and publisher a way
to get credit for their work, while not being considered responsible
for modifications made by others.

     <p>This License is a kind of &ldquo;copyleft&rdquo;, which means that derivative
works of the document must themselves be free in the same sense.  It
complements the GNU General Public License, which is a copyleft
license designed for free software.

     <p>We have designed this License in order to use it for manuals for free
software, because free software needs free documentation: a free
program should come with manuals providing the same freedoms that the
software does.  But this License is not limited to software manuals;
it can be used for any textual work, regardless of subject matter or
whether it is published as a printed book.  We recommend this License
principally for works whose purpose is instruction or reference.

     <li>APPLICABILITY AND DEFINITIONS

     <p>This License applies to any manual or other work, in any medium, that
contains a notice placed by the copyright holder saying it can be
distributed under the terms of this License.  Such a notice grants a
world-wide, royalty-free license, unlimited in duration, to use that
work under the conditions stated herein.  The &ldquo;Document&rdquo;, below,
refers to any such manual or work.  Any member of the public is a
licensee, and is addressed as &ldquo;you&rdquo;.  You accept the license if you
copy, modify or distribute the work in a way requiring permission
under copyright law.

     <p>A &ldquo;Modified Version&rdquo; of the Document means any work containing the
Document or a portion of it, either copied verbatim, or with
modifications and/or translated into another language.

     <p>A &ldquo;Secondary Section&rdquo; is a named appendix or a front-matter section
of the Document that deals exclusively with the relationship of the
publishers or authors of the Document to the Document's overall
subject (or to related matters) and contains nothing that could fall
directly within that overall subject.  (Thus, if the Document is in
part a textbook of mathematics, a Secondary Section may not explain
any mathematics.)  The relationship could be a matter of historical
connection with the subject or with related matters, or of legal,
commercial, philosophical, ethical or political position regarding
them.

     <p>The &ldquo;Invariant Sections&rdquo; are certain Secondary Sections whose titles
are designated, as being those of Invariant Sections, in the notice
that says that the Document is released under this License.  If a
section does not fit the above definition of Secondary then it is not
allowed to be designated as Invariant.  The Document may contain zero
Invariant Sections.  If the Document does not identify any Invariant
Sections then there are none.

     <p>The &ldquo;Cover Texts&rdquo; are certain short passages of text that are listed,
as Front-Cover Texts or Back-Cover Texts, in the notice that says that
the Document is released under this License.  A Front-Cover Text may
be at most 5 words, and a Back-Cover Text may be at most 25 words.

     <p>A &ldquo;Transparent&rdquo; copy of the Document means a machine-readable copy,
represented in a format whose specification is available to the
general public, that is suitable for revising the document
straightforwardly with generic text editors or (for images composed of
pixels) generic paint programs or (for drawings) some widely available
drawing editor, and that is suitable for input to text formatters or
for automatic translation to a variety of formats suitable for input
to text formatters.  A copy made in an otherwise Transparent file
format whose markup, or absence of markup, has been arranged to thwart
or discourage subsequent modification by readers is not Transparent. 
An image format is not Transparent if used for any substantial amount
of text.  A copy that is not &ldquo;Transparent&rdquo; is called &ldquo;Opaque&rdquo;.

     <p>Examples of suitable formats for Transparent copies include plain
<span class="sc">ascii</span> without markup, Texinfo input format, LaTeX input
format, <acronym>SGML</acronym> or <acronym>XML</acronym> using a publicly available
<acronym>DTD</acronym>, and standard-conforming simple <acronym>HTML</acronym>,
PostScript or <acronym>PDF</acronym> designed for human modification.  Examples
of transparent image formats include <acronym>PNG</acronym>, <acronym>XCF</acronym> and
<acronym>JPG</acronym>.  Opaque formats include proprietary formats that can be
read and edited only by proprietary word processors, <acronym>SGML</acronym> or
<acronym>XML</acronym> for which the <acronym>DTD</acronym> and/or processing tools are
not generally available, and the machine-generated <acronym>HTML</acronym>,
PostScript or <acronym>PDF</acronym> produced by some word processors for
output purposes only.

     <p>The &ldquo;Title Page&rdquo; means, for a printed book, the title page itself,
plus such following pages as are needed to hold, legibly, the material
this License requires to appear in the title page.  For works in
formats which do not have any title page as such, &ldquo;Title Page&rdquo; means
the text near the most prominent appearance of the work's title,
preceding the beginning of the body of the text.

     <p>The &ldquo;publisher&rdquo; means any person or entity that distributes copies
of the Document to the public.

     <p>A section &ldquo;Entitled XYZ&rdquo; means a named subunit of the Document whose
title either is precisely XYZ or contains XYZ in parentheses following
text that translates XYZ in another language.  (Here XYZ stands for a
specific section name mentioned below, such as &ldquo;Acknowledgements&rdquo;,
&ldquo;Dedications&rdquo;, &ldquo;Endorsements&rdquo;, or &ldquo;History&rdquo;.)  To &ldquo;Preserve the Title&rdquo;
of such a section when you modify the Document means that it remains a
section &ldquo;Entitled XYZ&rdquo; according to this definition.

     <p>The Document may include Warranty Disclaimers next to the notice which
states that this License applies to the Document.  These Warranty
Disclaimers are considered to be included by reference in this
License, but only as regards disclaiming warranties: any other
implication that these Warranty Disclaimers may have is void and has
no effect on the meaning of this License.

     <li>VERBATIM COPYING

     <p>You may copy and distribute the Document in any medium, either
commercially or noncommercially, provided that this License, the
copyright notices, and the license notice saying this License applies
to the Document are reproduced in all copies, and that you add no other
conditions whatsoever to those of this License.  You may not use
technical measures to obstruct or control the reading or further
copying of the copies you make or distribute.  However, you may accept
compensation in exchange for copies.  If you distribute a large enough
number of copies you must also follow the conditions in section 3.

     <p>You may also lend copies, under the same conditions stated above, and
you may publicly display copies.

     <li>COPYING IN QUANTITY

     <p>If you publish printed copies (or copies in media that commonly have
printed covers) of the Document, numbering more than 100, and the
Document's license notice requires Cover Texts, you must enclose the
copies in covers that carry, clearly and legibly, all these Cover
Texts: Front-Cover Texts on the front cover, and Back-Cover Texts on
the back cover.  Both covers must also clearly and legibly identify
you as the publisher of these copies.  The front cover must present
the full title with all words of the title equally prominent and
visible.  You may add other material on the covers in addition. 
Copying with changes limited to the covers, as long as they preserve
the title of the Document and satisfy these conditions, can be treated
as verbatim copying in other respects.

     <p>If the required texts for either cover are too voluminous to fit
legibly, you should put the first ones listed (as many as fit
reasonably) on the actual cover, and continue the rest onto adjacent
pages.

     <p>If you publish or distribute Opaque copies of the Document numbering
more than 100, you must either include a machine-readable Transparent
copy along with each Opaque copy, or state in or with each Opaque copy
a computer-network location from which the general network-using
public has access to download using public-standard network protocols
a complete Transparent copy of the Document, free of added material. 
If you use the latter option, you must take reasonably prudent steps,
when you begin distribution of Opaque copies in quantity, to ensure
that this Transparent copy will remain thus accessible at the stated
location until at least one year after the last time you distribute an
Opaque copy (directly or through your agents or retailers) of that
edition to the public.

     <p>It is requested, but not required, that you contact the authors of the
Document well before redistributing any large number of copies, to give
them a chance to provide you with an updated version of the Document.

     <li>MODIFICATIONS

     <p>You may copy and distribute a Modified Version of the Document under
the conditions of sections 2 and 3 above, provided that you release
the Modified Version under precisely this License, with the Modified
Version filling the role of the Document, thus licensing distribution
and modification of the Modified Version to whoever possesses a copy
of it.  In addition, you must do these things in the Modified Version:

          <ol type=A start=1>
<li>Use in the Title Page (and on the covers, if any) a title distinct
from that of the Document, and from those of previous versions
(which should, if there were any, be listed in the History section
of the Document).  You may use the same title as a previous version
if the original publisher of that version gives permission.

          <li>List on the Title Page, as authors, one or more persons or entities
responsible for authorship of the modifications in the Modified
Version, together with at least five of the principal authors of the
Document (all of its principal authors, if it has fewer than five),
unless they release you from this requirement.

          <li>State on the Title page the name of the publisher of the
Modified Version, as the publisher.

          <li>Preserve all the copyright notices of the Document.

          <li>Add an appropriate copyright notice for your modifications
adjacent to the other copyright notices.

          <li>Include, immediately after the copyright notices, a license notice
giving the public permission to use the Modified Version under the
terms of this License, in the form shown in the Addendum below.

          <li>Preserve in that license notice the full lists of Invariant Sections
and required Cover Texts given in the Document's license notice.

          <li>Include an unaltered copy of this License.

          <li>Preserve the section Entitled &ldquo;History&rdquo;, Preserve its Title, and add
to it an item stating at least the title, year, new authors, and
publisher of the Modified Version as given on the Title Page.  If
there is no section Entitled &ldquo;History&rdquo; in the Document, create one
stating the title, year, authors, and publisher of the Document as
given on its Title Page, then add an item describing the Modified
Version as stated in the previous sentence.

          <li>Preserve the network location, if any, given in the Document for
public access to a Transparent copy of the Document, and likewise
the network locations given in the Document for previous versions
it was based on.  These may be placed in the &ldquo;History&rdquo; section. 
You may omit a network location for a work that was published at
least four years before the Document itself, or if the original
publisher of the version it refers to gives permission.

          <li>For any section Entitled &ldquo;Acknowledgements&rdquo; or &ldquo;Dedications&rdquo;, Preserve
the Title of the section, and preserve in the section all the
substance and tone of each of the contributor acknowledgements and/or
dedications given therein.

          <li>Preserve all the Invariant Sections of the Document,
unaltered in their text and in their titles.  Section numbers
or the equivalent are not considered part of the section titles.

          <li>Delete any section Entitled &ldquo;Endorsements&rdquo;.  Such a section
may not be included in the Modified Version.

          <li>Do not retitle any existing section to be Entitled &ldquo;Endorsements&rdquo; or
to conflict in title with any Invariant Section.

          <li>Preserve any Warranty Disclaimers.
          </ol>

     <p>If the Modified Version includes new front-matter sections or
appendices that qualify as Secondary Sections and contain no material
copied from the Document, you may at your option designate some or all
of these sections as invariant.  To do this, add their titles to the
list of Invariant Sections in the Modified Version's license notice. 
These titles must be distinct from any other section titles.

     <p>You may add a section Entitled &ldquo;Endorsements&rdquo;, provided it contains
nothing but endorsements of your Modified Version by various
parties&mdash;for example, statements of peer review or that the text has
been approved by an organization as the authoritative definition of a
standard.

     <p>You may add a passage of up to five words as a Front-Cover Text, and a
passage of up to 25 words as a Back-Cover Text, to the end of the list
of Cover Texts in the Modified Version.  Only one passage of
Front-Cover Text and one of Back-Cover Text may be added by (or
through arrangements made by) any one entity.  If the Document already
includes a cover text for the same cover, previously added by you or
by arrangement made by the same entity you are acting on behalf of,
you may not add another; but you may replace the old one, on explicit
permission from the previous publisher that added the old one.

     <p>The author(s) and publisher(s) of the Document do not by this License
give permission to use their names for publicity for or to assert or
imply endorsement of any Modified Version.

     <li>COMBINING DOCUMENTS

     <p>You may combine the Document with other documents released under this
License, under the terms defined in section 4 above for modified
versions, provided that you include in the combination all of the
Invariant Sections of all of the original documents, unmodified, and
list them all as Invariant Sections of your combined work in its
license notice, and that you preserve all their Warranty Disclaimers.

     <p>The combined work need only contain one copy of this License, and
multiple identical Invariant Sections may be replaced with a single
copy.  If there are multiple Invariant Sections with the same name but
different contents, make the title of each such section unique by
adding at the end of it, in parentheses, the name of the original
author or publisher of that section if known, or else a unique number. 
Make the same adjustment to the section titles in the list of
Invariant Sections in the license notice of the combined work.

     <p>In the combination, you must combine any sections Entitled &ldquo;History&rdquo;
in the various original documents, forming one section Entitled
&ldquo;History&rdquo;; likewise combine any sections Entitled &ldquo;Acknowledgements&rdquo;,
and any sections Entitled &ldquo;Dedications&rdquo;.  You must delete all
sections Entitled &ldquo;Endorsements.&rdquo;

     <li>COLLECTIONS OF DOCUMENTS

     <p>You may make a collection consisting of the Document and other documents
released under this License, and replace the individual copies of this
License in the various documents with a single copy that is included in
the collection, provided that you follow the rules of this License for
verbatim copying of each of the documents in all other respects.

     <p>You may extract a single document from such a collection, and distribute
it individually under this License, provided you insert a copy of this
License into the extracted document, and follow this License in all
other respects regarding verbatim copying of that document.

     <li>AGGREGATION WITH INDEPENDENT WORKS

     <p>A compilation of the Document or its derivatives with other separate
and independent documents or works, in or on a volume of a storage or
distribution medium, is called an &ldquo;aggregate&rdquo; if the copyright
resulting from the compilation is not used to limit the legal rights
of the compilation's users beyond what the individual works permit. 
When the Document is included in an aggregate, this License does not
apply to the other works in the aggregate which are not themselves
derivative works of the Document.

     <p>If the Cover Text requirement of section 3 is applicable to these
copies of the Document, then if the Document is less than one half of
the entire aggregate, the Document's Cover Texts may be placed on
covers that bracket the Document within the aggregate, or the
electronic equivalent of covers if the Document is in electronic form. 
Otherwise they must appear on printed covers that bracket the whole
aggregate.

     <li>TRANSLATION

     <p>Translation is considered a kind of modification, so you may
distribute translations of the Document under the terms of section 4. 
Replacing Invariant Sections with translations requires special
permission from their copyright holders, but you may include
translations of some or all Invariant Sections in addition to the
original versions of these Invariant Sections.  You may include a
translation of this License, and all the license notices in the
Document, and any Warranty Disclaimers, provided that you also include
the original English version of this License and the original versions
of those notices and disclaimers.  In case of a disagreement between
the translation and the original version of this License or a notice
or disclaimer, the original version will prevail.

     <p>If a section in the Document is Entitled &ldquo;Acknowledgements&rdquo;,
&ldquo;Dedications&rdquo;, or &ldquo;History&rdquo;, the requirement (section 4) to Preserve
its Title (section 1) will typically require changing the actual
title.

     <li>TERMINATION

     <p>You may not copy, modify, sublicense, or distribute the Document
except as expressly provided under this License.  Any attempt
otherwise to copy, modify, sublicense, or distribute it is void, and
will automatically terminate your rights under this License.

     <p>However, if you cease all violation of this License, then your license
from a particular copyright holder is reinstated (a) provisionally,
unless and until the copyright holder explicitly and finally
terminates your license, and (b) permanently, if the copyright holder
fails to notify you of the violation by some reasonable means prior to
60 days after the cessation.

     <p>Moreover, your license from a particular copyright holder is
reinstated permanently if the copyright holder notifies you of the
violation by some reasonable means, this is the first time you have
received notice of violation of this License (for any work) from that
copyright holder, and you cure the violation prior to 30 days after
your receipt of the notice.

     <p>Termination of your rights under this section does not terminate the
licenses of parties who have received copies or rights from you under
this License.  If your rights have been terminated and not permanently
reinstated, receipt of a copy of some or all of the same material does
not give you any rights to use it.

     <li>FUTURE REVISIONS OF THIS LICENSE

     <p>The Free Software Foundation may publish new, revised versions
of the GNU Free Documentation License from time to time.  Such new
versions will be similar in spirit to the present version, but may
differ in detail to address new problems or concerns.  See
<a href="http://www.gnu.org/copyleft/">http://www.gnu.org/copyleft/</a>.

     <p>Each version of the License is given a distinguishing version number. 
If the Document specifies that a particular numbered version of this
License &ldquo;or any later version&rdquo; applies to it, you have the option of
following the terms and conditions either of that specified version or
of any later version that has been published (not as a draft) by the
Free Software Foundation.  If the Document does not specify a version
number of this License, you may choose any version ever published (not
as a draft) by the Free Software Foundation.  If the Document
specifies that a proxy can decide which future versions of this
License can be used, that proxy's public statement of acceptance of a
version permanently authorizes you to choose that version for the
Document.

     <li>RELICENSING

     <p>&ldquo;Massive Multiauthor Collaboration Site&rdquo; (or &ldquo;MMC Site&rdquo;) means any
World Wide Web server that publishes copyrightable works and also
provides prominent facilities for anybody to edit those works.  A
public wiki that anybody can edit is an example of such a server.  A
&ldquo;Massive Multiauthor Collaboration&rdquo; (or &ldquo;MMC&rdquo;) contained in the
site means any set of copyrightable works thus published on the MMC
site.

     <p>&ldquo;CC-BY-SA&rdquo; means the Creative Commons Attribution-Share Alike 3.0
license published by Creative Commons Corporation, a not-for-profit
corporation with a principal place of business in San Francisco,
California, as well as future copyleft versions of that license
published by that same organization.

     <p>&ldquo;Incorporate&rdquo; means to publish or republish a Document, in whole or
in part, as part of another Document.

     <p>An MMC is &ldquo;eligible for relicensing&rdquo; if it is licensed under this
License, and if all works that were first published under this License
somewhere other than this MMC, and subsequently incorporated in whole
or in part into the MMC, (1) had no cover texts or invariant sections,
and (2) were thus incorporated prior to November 1, 2008.

     <p>The operator of an MMC Site may republish an MMC contained in the site
under CC-BY-SA on the same site at any time before August 1, 2009,
provided the MMC is eligible for relicensing.

        </ol>

<h3 class="heading">ADDENDUM: How to use this License for your documents</h3>

<p>To use this License in a document you have written, include a copy of
the License in the document and put the following copyright and
license notices just after the title page:

<pre class="smallexample">       Copyright (C)  <var>year</var>  <var>your name</var>.
       Permission is granted to copy, distribute and/or modify this document
       under the terms of the GNU Free Documentation License, Version 1.3
       or any later version published by the Free Software Foundation;
       with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
       Texts.  A copy of the license is included in the section entitled ``GNU
       Free Documentation License''.
</pre>
   <p>If you have Invariant Sections, Front-Cover Texts and Back-Cover Texts,
replace the &ldquo;with<small class="dots">...</small>Texts.&rdquo; line with this:

<pre class="smallexample">         with the Invariant Sections being <var>list their titles</var>, with
         the Front-Cover Texts being <var>list</var>, and with the Back-Cover Texts
         being <var>list</var>.
</pre>
   <p>If you have Invariant Sections without Cover Texts, or some other
combination of the three, merge those two alternatives to suit the
situation.

   <p>If your document contains nontrivial examples of program code, we
recommend releasing these examples in parallel under your choice of
free software license, such as the GNU General Public License,
to permit their use in free software.

<!-- Local Variables: -->
<!-- ispell-local-pdict: "ispell-dict" -->
<!-- End: -->
<!-- page -->
<div class="node">
<a name="References"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Concept-Index">Concept Index</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Documentation-License">Documentation License</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="appendix">Appendix C Bibliography and references</h2>

<p class="noindent">Erich Gamma, Richard Helm, Ralph Johnson, John Vlissides. 
<em>Design Patterns</em>. Addison&ndash;Wesley, 1995.

<p class="noindent">Brent B. Welch. 
<em>Practical Programming in TCL and TK</em>. Prentice Hall, 1997.

<!-- page -->
<div class="node">
<a name="Concept-Index"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Function-Index">Function Index</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#References">References</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="appendix">Appendix D An entry for each concept</h2>

<ul class="index-cp" compact>
<li><a href="#index-FDL_002c-GNU-Free-Documentation-License-468">FDL, GNU Free Documentation License</a>: <a href="#Documentation-License">Documentation License</a></li>
   </ul><div class="node">
<a name="Function-Index"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Variable-Index">Variable Index</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Concept-Index">Concept Index</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="appendix">Appendix E An entry for each procedure</h2>



<ul class="index-fn" compact>
<li><a href="#index-acquire-245"><code>acquire</code></a>: <a href="#workers">workers</a></li>
<li><a href="#index-acquire-215"><code>acquire</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-attach-175"><code>attach</code></a>: <a href="#observer">observer</a></li>
<li><a href="#index-build_005fobject-237"><code>build_object</code></a>: <a href="#factory">factory</a></li>
<li><a href="#index-cancel-102"><code>cancel</code></a>: <a href="#event-source">event source</a></li>
<li><a href="#index-cancel_005fall-104"><code>cancel_all</code></a>: <a href="#event-source">event source</a></li>
<li><a href="#index-commit-251"><code>commit</code></a>: <a href="#workers">workers</a></li>
<li><a href="#index-commit-197"><code>commit</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-destroy_005fobject-239"><code>destroy_object</code></a>: <a href="#factory">factory</a></li>
<li><a href="#index-detach-177"><code>detach</code></a>: <a href="#observer">observer</a></li>
<li><a href="#index-dismiss-217"><code>dismiss</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-drop-213"><code>drop</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-dynamic_005fwind-75"><code>dynamic_wind</code></a>: <a href="#dynamic">dynamic</a></li>
<li><a href="#index-fill_005fto_005fmaximum-207"><code>fill_to_maximum</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-fill_005fto_005fwatermark-205"><code>fill_to_watermark</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-get_005fperiod-114"><code>get_period</code></a>: <a href="#periodic-scripts">periodic scripts</a></li>
<li><a href="#index-is_005f_005fnot_005fat_005fwatermark_005flevel-233"><code>is__not_at_watermark_level</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-is_005fabove_005fwatermark-229"><code>is_above_watermark</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-is_005fat_005fwatermark_005flevel-231"><code>is_at_watermark_level</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-is_005fbelow_005fwatermark-227"><code>is_below_watermark</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-is_005fempty-219"><code>is_empty</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-is_005ffull-223"><code>is_full</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-is_005fnot_005fempty-221"><code>is_not_empty</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-is_005fnot_005ffull-225"><code>is_not_full</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-name_005ft-11"><code>name_t</code></a>: <a href="#typedef-overview">typedef overview</a></li>
<li><a href="#index-name_005ft_005fvalue_005fis-12"><code>name_t_value_is</code></a>: <a href="#typedef-overview">typedef overview</a></li>
<li><a href="#index-name_005ft_005fvariable_005fis-13"><code>name_t_variable_is</code></a>: <a href="#typedef-overview">typedef overview</a></li>
<li><a href="#index-notify-179"><code>notify</code></a>: <a href="#observer">observer</a></li>
<li><a href="#index-proc-8"><code>proc</code></a>: <a href="#preprocessor-commands-procedures">preprocessor commands procedures</a></li>
<li><a href="#index-purge-209"><code>purge</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-put-211"><code>put</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-queue-100"><code>queue</code></a>: <a href="#event-source">event source</a></li>
<li><a href="#index-reinit-126"><code>reinit</code></a>: <a href="#timeouts">timeouts</a></li>
<li><a href="#index-release-247"><code>release</code></a>: <a href="#workers">workers</a></li>
<li><a href="#index-reset_005fobject-241"><code>reset_object</code></a>: <a href="#factory">factory</a></li>
<li><a href="#index-running-122"><code>running</code></a>: <a href="#timeouts">timeouts</a></li>
<li><a href="#index-schedule-108"><code>schedule</code></a>: <a href="#periodic-scripts">periodic scripts</a></li>
<li><a href="#index-set_005fcondition-110"><code>set_condition</code></a>: <a href="#periodic-scripts">periodic scripts</a></li>
<li><a href="#index-set_005fperiod-112"><code>set_period</code></a>: <a href="#periodic-scripts">periodic scripts</a></li>
<li><a href="#index-start-118"><code>start</code></a>: <a href="#timeouts">timeouts</a></li>
<li><a href="#index-stop-120"><code>stop</code></a>: <a href="#timeouts">timeouts</a></li>
<li><a href="#index-triggered-124"><code>triggered</code></a>: <a href="#timeouts">timeouts</a></li>
<li><a href="#index-unwind_005fprotect-76"><code>unwind_protect</code></a>: <a href="#dynamic">dynamic</a></li>
<li><a href="#index-utp_005falias-340"><code>utp_alias</code></a>: <a href="#misc-base">misc base</a></li>
<li><a href="#index-utp_005falias-6"><code>utp_alias</code></a>: <a href="#preprocessor-commands-special">preprocessor commands special</a></li>
<li><a href="#index-utp_005fcache_005facquire-214"><code>utp_cache_acquire</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fconfig_005fcommit-196"><code>utp_cache_config_commit</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fconfig_005fget_005fmaximum-201"><code>utp_cache_config_get_maximum</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fconfig_005fget_005fwatermark-199"><code>utp_cache_config_get_watermark</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fconfig_005finit-195"><code>utp_cache_config_init</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fconfig_005fset_005fmaximum-200"><code>utp_cache_config_set_maximum</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fconfig_005fset_005fwatermark-198"><code>utp_cache_config_set_watermark</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fconfig_005fvalidate-202"><code>utp_cache_config_validate</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fdismiss-216"><code>utp_cache_dismiss</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fdrop-212"><code>utp_cache_drop</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005ffill_005fto_005fmaximum-206"><code>utp_cache_fill_to_maximum</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005ffill_005fto_005fwatermark-204"><code>utp_cache_fill_to_watermark</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005finit-193"><code>utp_cache_init</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fis_005fabove_005fwatermark-228"><code>utp_cache_is_above_watermark</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fis_005fat_005fwatermark_005flevel-230"><code>utp_cache_is_at_watermark_level</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fis_005fbelow_005fwatermark-226"><code>utp_cache_is_below_watermark</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fis_005fempty-218"><code>utp_cache_is_empty</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fis_005ffull-222"><code>utp_cache_is_full</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fis_005fnot_005fat_005fwatermark_005flevel-232"><code>utp_cache_is_not_at_watermark_level</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fis_005fnot_005fempty-220"><code>utp_cache_is_not_empty</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fis_005fnot_005ffull-224"><code>utp_cache_is_not_full</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fpurge-208"><code>utp_cache_purge</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005fput-210"><code>utp_cache_put</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fchannel_005fclose-268"><code>utp_channel_close</code></a>: <a href="#channel-basic">channel basic</a></li>
<li><a href="#index-utp_005fchannel_005fconfigure-279"><code>utp_channel_configure</code></a>: <a href="#channel-configure">channel configure</a></li>
<li><a href="#index-utp_005fchannel_005feof-274"><code>utp_channel_eof</code></a>: <a href="#channel-other">channel other</a></li>
<li><a href="#index-utp_005fchannel_005ffcopy_005fconfigure-280"><code>utp_channel_fcopy_configure</code></a>: <a href="#channel-configure">channel configure</a></li>
<li><a href="#index-utp_005fchannel_005fflush-273"><code>utp_channel_flush</code></a>: <a href="#channel-other">channel other</a></li>
<li><a href="#index-utp_005fchannel_005fgets-272"><code>utp_channel_gets</code></a>: <a href="#channel-other">channel other</a></li>
<li><a href="#index-utp_005fchannel_005fopen-267"><code>utp_channel_open</code></a>: <a href="#channel-basic">channel basic</a></li>
<li><a href="#index-utp_005fchannel_005fread-270"><code>utp_channel_read</code></a>: <a href="#channel-basic">channel basic</a></li>
<li><a href="#index-utp_005fchannel_005freadable_005fevent-276"><code>utp_channel_readable_event</code></a>: <a href="#channel-events">channel events</a></li>
<li><a href="#index-utp_005fchannel_005freadnum-271"><code>utp_channel_readnum</code></a>: <a href="#channel-other">channel other</a></li>
<li><a href="#index-utp_005fchannel_005freset_005fevent_005fhandlers-278"><code>utp_channel_reset_event_handlers</code></a>: <a href="#channel-events">channel events</a></li>
<li><a href="#index-utp_005fchannel_005fseek-281"><code>utp_channel_seek</code></a>: <a href="#channel-seeking">channel seeking</a></li>
<li><a href="#index-utp_005fchannel_005ftell-282"><code>utp_channel_tell</code></a>: <a href="#channel-seeking">channel seeking</a></li>
<li><a href="#index-utp_005fchannel_005fwritable_005fevent-277"><code>utp_channel_writable_event</code></a>: <a href="#channel-events">channel events</a></li>
<li><a href="#index-utp_005fchannel_005fwrite-269"><code>utp_channel_write</code></a>: <a href="#channel-basic">channel basic</a></li>
<li><a href="#index-utp_005fchannel_005fwrite_005fand_005fflush-275"><code>utp_channel_write_and_flush</code></a>: <a href="#channel-other">channel other</a></li>
<li><a href="#index-utp_005fdelete_005fproc-344"><code>utp_delete_proc</code></a>: <a href="#misc-procedures">misc procedures</a></li>
<li><a href="#index-utp_005fdialog_005finit-161"><code>utp_dialog_init</code></a>: <a href="#dialog">dialog</a></li>
<li><a href="#index-utp_005fdialog_005fnotify-163"><code>utp_dialog_notify</code></a>: <a href="#dialog">dialog</a></li>
<li><a href="#index-utp_005fdialog_005fquestion_005fyes_005for_005fno-162"><code>utp_dialog_question_yes_or_no</code></a>: <a href="#dialog">dialog</a></li>
<li><a href="#index-utp_005ferror_005fcatch_005flogic-357"><code>utp_error_catch_logic</code></a>: <a href="#misc-error">misc error</a></li>
<li><a href="#index-utp_005ferror_005fcatch_005fruntime-358"><code>utp_error_catch_runtime</code></a>: <a href="#misc-error">misc error</a></li>
<li><a href="#index-utp_005ferror_005flogic-355"><code>utp_error_logic</code></a>: <a href="#misc-error">misc error</a></li>
<li><a href="#index-utp_005ferror_005fruntime-356"><code>utp_error_runtime</code></a>: <a href="#misc-error">misc error</a></li>
<li><a href="#index-utp_005ferror_005ftest_005flogic-360"><code>utp_error_test_logic</code></a>: <a href="#misc-error">misc error</a></li>
<li><a href="#index-utp_005ferror_005ftest_005fruntime-359"><code>utp_error_test_runtime</code></a>: <a href="#misc-error">misc error</a></li>
<li><a href="#index-utp_005feval_005fexpr_005flist-364"><code>utp_eval_expr_list</code></a>: <a href="#misc-math">misc math</a></li>
<li><a href="#index-utp_005feval_005fscript-338"><code>utp_eval_script</code></a>: <a href="#misc-base">misc base</a></li>
<li><a href="#index-utp_005fevent_005fsource_005fcancel-101"><code>utp_event_source_cancel</code></a>: <a href="#event-source">event source</a></li>
<li><a href="#index-utp_005fevent_005fsource_005fcancel_005fall-103"><code>utp_event_source_cancel_all</code></a>: <a href="#event-source">event source</a></li>
<li><a href="#index-utp_005fevent_005fsource_005fqueue-99"><code>utp_event_source_queue</code></a>: <a href="#event-source">event source</a></li>
<li><a href="#index-utp_005ffactory_005fbuild_005fobject-236"><code>utp_factory_build_object</code></a>: <a href="#factory">factory</a></li>
<li><a href="#index-utp_005ffactory_005fdestroy_005fobject-238"><code>utp_factory_destroy_object</code></a>: <a href="#factory">factory</a></li>
<li><a href="#index-utp_005ffactory_005finit-235"><code>utp_factory_init</code></a>: <a href="#factory">factory</a></li>
<li><a href="#index-utp_005ffactory_005freset_005fobject-240"><code>utp_factory_reset_object</code></a>: <a href="#factory">factory</a></li>
<li><a href="#index-utp_005ffile_005fappend-286"><code>utp_file_append</code></a>: <a href="#file-rw">file rw</a></li>
<li><a href="#index-utp_005ffile_005fbackup-299"><code>utp_file_backup</code></a>: <a href="#file-misc">file misc</a></li>
<li><a href="#index-utp_005ffile_005fcreate-283"><code>utp_file_create</code></a>: <a href="#file-rw">file rw</a></li>
<li><a href="#index-utp_005ffile_005ffind-301"><code>utp_file_find</code></a>: <a href="#file-misc">file misc</a></li>
<li><a href="#index-utp_005ffile_005ffind_005fin_005fsearch_005fpath-296"><code>utp_file_find_in_search_path</code></a>: <a href="#file-load">file load</a></li>
<li><a href="#index-utp_005ffile_005fis_005fowned_005freadable_005fdirectory-291"><code>utp_file_is_owned_readable_directory</code></a>: <a href="#file-inspect">file inspect</a></li>
<li><a href="#index-utp_005ffile_005fis_005fowned_005freadable_005ffile-292"><code>utp_file_is_owned_readable_file</code></a>: <a href="#file-inspect">file inspect</a></li>
<li><a href="#index-utp_005ffile_005fis_005fowned_005fwritable_005fdirectory-289"><code>utp_file_is_owned_writable_directory</code></a>: <a href="#file-inspect">file inspect</a></li>
<li><a href="#index-utp_005ffile_005fis_005fowned_005fwritable_005ffile-290"><code>utp_file_is_owned_writable_file</code></a>: <a href="#file-inspect">file inspect</a></li>
<li><a href="#index-utp_005ffile_005fissubdir-288"><code>utp_file_issubdir</code></a>: <a href="#file-inspect">file inspect</a></li>
<li><a href="#index-utp_005ffile_005fload_005finput_005ffiles-297"><code>utp_file_load_input_files</code></a>: <a href="#file-load">file load</a></li>
<li><a href="#index-utp_005ffile_005fnormalise-293"><code>utp_file_normalise</code></a>: <a href="#file-norm">file norm</a></li>
<li><a href="#index-utp_005ffile_005fnormalise_005flink-294"><code>utp_file_normalise_link</code></a>: <a href="#file-norm">file norm</a></li>
<li><a href="#index-utp_005ffile_005fread-284"><code>utp_file_read</code></a>: <a href="#file-rw">file rw</a></li>
<li><a href="#index-utp_005ffile_005fsize-287"><code>utp_file_size</code></a>: <a href="#file-inspect">file inspect</a></li>
<li><a href="#index-utp_005ffile_005ftmpname-300"><code>utp_file_tmpname</code></a>: <a href="#file-misc">file misc</a></li>
<li><a href="#index-utp_005ffile_005fupdate_005fsearch_005fpath-295"><code>utp_file_update_search_path</code></a>: <a href="#file-load">file load</a></li>
<li><a href="#index-utp_005ffile_005fwrite-285"><code>utp_file_write</code></a>: <a href="#file-rw">file rw</a></li>
<li><a href="#index-utp_005ffile_005fwrite_005foutput-298"><code>utp_file_write_output</code></a>: <a href="#file-output">file output</a></li>
<li><a href="#index-utp_005fgetopts_005fdeclare-129"><code>utp_getopts_declare</code></a>: <a href="#getopts-parser">getopts parser</a></li>
<li><a href="#index-utp_005fgetopts_005fget_005flong_005foptions-132"><code>utp_getopts_get_long_options</code></a>: <a href="#getopts-help">getopts help</a></li>
<li><a href="#index-utp_005fgetopts_005fmake_005fusage_005fstring-131"><code>utp_getopts_make_usage_string</code></a>: <a href="#getopts-help">getopts help</a></li>
<li><a href="#index-utp_005fgetopts_005fparse-130"><code>utp_getopts_parse</code></a>: <a href="#getopts-parser">getopts parser</a></li>
<li><a href="#index-utp_005fgetopts_005fparse_005flist-128"><code>utp_getopts_parse_list</code></a>: <a href="#getopts-basic">getopts basic</a></li>
<li><a href="#index-utp_005fgetopts_005fparse_005ftoken-127"><code>utp_getopts_parse_token</code></a>: <a href="#getopts-basic">getopts basic</a></li>
<li><a href="#index-utp_005fhoco_005fdynamic_005fmake-414"><code>utp_hoco_dynamic_make</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005fdynamic_005fset-415"><code>utp_hoco_dynamic_set</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005fdynamic_005fupdate-413"><code>utp_hoco_dynamic_update</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005fmatrix_005fcanvas-382"><code>utp_hoco_matrix_canvas</code></a>: <a href="#hoco-procs-matrix">hoco procs matrix</a></li>
<li><a href="#index-utp_005fhoco_005fmatrix_005fdh-383"><code>utp_hoco_matrix_dh</code></a>: <a href="#hoco-procs-matrix">hoco procs matrix</a></li>
<li><a href="#index-utp_005fhoco_005fmatrix_005fhomogeneous-384"><code>utp_hoco_matrix_homogeneous</code></a>: <a href="#hoco-procs-matrix">hoco procs matrix</a></li>
<li><a href="#index-utp_005fhoco_005fmatrix_005fidentity-373"><code>utp_hoco_matrix_identity</code></a>: <a href="#hoco-procs-matrix">hoco procs matrix</a></li>
<li><a href="#index-utp_005fhoco_005fmatrix_005fnull-374"><code>utp_hoco_matrix_null</code></a>: <a href="#hoco-procs-matrix">hoco procs matrix</a></li>
<li><a href="#index-utp_005fhoco_005fmatrix_005fperspective-378"><code>utp_hoco_matrix_perspective</code></a>: <a href="#hoco-procs-matrix">hoco procs matrix</a></li>
<li><a href="#index-utp_005fhoco_005fmatrix_005frotation_005faround_005fx-379"><code>utp_hoco_matrix_rotation_around_x</code></a>: <a href="#hoco-procs-matrix">hoco procs matrix</a></li>
<li><a href="#index-utp_005fhoco_005fmatrix_005frotation_005faround_005fy-380"><code>utp_hoco_matrix_rotation_around_y</code></a>: <a href="#hoco-procs-matrix">hoco procs matrix</a></li>
<li><a href="#index-utp_005fhoco_005fmatrix_005frotation_005faround_005fz-381"><code>utp_hoco_matrix_rotation_around_z</code></a>: <a href="#hoco-procs-matrix">hoco procs matrix</a></li>
<li><a href="#index-utp_005fhoco_005fmatrix_005fscale-376"><code>utp_hoco_matrix_scale</code></a>: <a href="#hoco-procs-matrix">hoco procs matrix</a></li>
<li><a href="#index-utp_005fhoco_005fmatrix_005fshaping-377"><code>utp_hoco_matrix_shaping</code></a>: <a href="#hoco-procs-matrix">hoco procs matrix</a></li>
<li><a href="#index-utp_005fhoco_005fmatrix_005ftranslation-375"><code>utp_hoco_matrix_translation</code></a>: <a href="#hoco-procs-matrix">hoco procs matrix</a></li>
<li><a href="#index-utp_005fhoco_005fparameters_005fto_005ftransform_005fcanvas-394"><code>utp_hoco_parameters_to_transform_canvas</code></a>: <a href="#hoco-procs-params">hoco procs params</a></li>
<li><a href="#index-utp_005fhoco_005fparameters_005fto_005ftransform_005fdh-397"><code>utp_hoco_parameters_to_transform_dh</code></a>: <a href="#hoco-procs-params">hoco procs params</a></li>
<li><a href="#index-utp_005fhoco_005fparameters_005fto_005ftransform_005fhomogeneous-395"><code>utp_hoco_parameters_to_transform_homogeneous</code></a>: <a href="#hoco-procs-params">hoco procs params</a></li>
<li><a href="#index-utp_005fhoco_005fparameters_005fto_005ftransform_005fperspective-398"><code>utp_hoco_parameters_to_transform_perspective</code></a>: <a href="#hoco-procs-params">hoco procs params</a></li>
<li><a href="#index-utp_005fhoco_005fparameters_005fto_005ftransform_005fscale-399"><code>utp_hoco_parameters_to_transform_scale</code></a>: <a href="#hoco-procs-params">hoco procs params</a></li>
<li><a href="#index-utp_005fhoco_005fparameters_005fto_005ftransform_005fshaping-400"><code>utp_hoco_parameters_to_transform_shaping</code></a>: <a href="#hoco-procs-params">hoco procs params</a></li>
<li><a href="#index-utp_005fhoco_005fparameters_005fto_005ftransform_005fworkspace-396"><code>utp_hoco_parameters_to_transform_workspace</code></a>: <a href="#hoco-procs-params">hoco procs params</a></li>
<li><a href="#index-utp_005fhoco_005fto_005fcanvas-371"><code>utp_hoco_to_canvas</code></a>: <a href="#hoco-procs-core">hoco procs core</a></li>
<li><a href="#index-utp_005fhoco_005fto_005fcartesian-372"><code>utp_hoco_to_cartesian</code></a>: <a href="#hoco-procs-core">hoco procs core</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fcanvas-393"><code>utp_hoco_transform_canvas</code></a>: <a href="#hoco-procs-transform">hoco procs transform</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fcoords-370"><code>utp_hoco_transform_coords</code></a>: <a href="#hoco-procs-core">hoco procs core</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fdh-391"><code>utp_hoco_transform_dh</code></a>: <a href="#hoco-procs-transform">hoco procs transform</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fhomogeneous-392"><code>utp_hoco_transform_homogeneous</code></a>: <a href="#hoco-procs-transform">hoco procs transform</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fidentity-385"><code>utp_hoco_transform_identity</code></a>: <a href="#hoco-procs-transform">hoco procs transform</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fperspective-390"><code>utp_hoco_transform_perspective</code></a>: <a href="#hoco-procs-transform">hoco procs transform</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005frotation-389"><code>utp_hoco_transform_rotation</code></a>: <a href="#hoco-procs-transform">hoco procs transform</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fscale-386"><code>utp_hoco_transform_scale</code></a>: <a href="#hoco-procs-transform">hoco procs transform</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fshaping-387"><code>utp_hoco_transform_shaping</code></a>: <a href="#hoco-procs-transform">hoco procs transform</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005ftranslation-388"><code>utp_hoco_transform_translation</code></a>: <a href="#hoco-procs-transform">hoco procs transform</a></li>
<li><a href="#index-utp_005finclude-4"><code>utp_include</code></a>: <a href="#preprocessor-commands-special">preprocessor commands special</a></li>
<li><a href="#index-utp_005fini_005fmake_005fstring-135"><code>utp_ini_make_string</code></a>: <a href="#ini-files">ini files</a></li>
<li><a href="#index-utp_005fini_005fparse_005fline-133"><code>utp_ini_parse_line</code></a>: <a href="#ini-files">ini files</a></li>
<li><a href="#index-utp_005fini_005fparse_005fstring-134"><code>utp_ini_parse_string</code></a>: <a href="#ini-files">ini files</a></li>
<li><a href="#index-utp_005finvoke_005fscript_005fprocedure-341"><code>utp_invoke_script_procedure</code></a>: <a href="#misc-procedures">misc procedures</a></li>
<li><a href="#index-utp_005fiterator_005farray-167"><code>utp_iterator_array</code></a>: <a href="#iterator">iterator</a></li>
<li><a href="#index-utp_005fiterator_005fcomplintersect-171"><code>utp_iterator_complintersect</code></a>: <a href="#iterator">iterator</a></li>
<li><a href="#index-utp_005fiterator_005fdifference-170"><code>utp_iterator_difference</code></a>: <a href="#iterator">iterator</a></li>
<li><a href="#index-utp_005fiterator_005fintersection-169"><code>utp_iterator_intersection</code></a>: <a href="#iterator">iterator</a></li>
<li><a href="#index-utp_005fiterator_005flist-166"><code>utp_iterator_list</code></a>: <a href="#iterator">iterator</a></li>
<li><a href="#index-utp_005fiterator_005fnext-165"><code>utp_iterator_next</code></a>: <a href="#iterator">iterator</a></li>
<li><a href="#index-utp_005fiterator_005funion-168"><code>utp_iterator_union</code></a>: <a href="#iterator">iterator</a></li>
<li><a href="#index-utp_005flayout_005fconfigure-368"><code>utp_layout_configure</code></a>: <a href="#layout">layout</a></li>
<li><a href="#index-utp_005flayout_005fexpand-369"><code>utp_layout_expand</code></a>: <a href="#layout">layout</a></li>
<li><a href="#index-utp_005flayout_005finit-367"><code>utp_layout_init</code></a>: <a href="#layout">layout</a></li>
<li><a href="#index-utp_005flist_005fbuild-346"><code>utp_list_build</code></a>: <a href="#misc-list">misc list</a></li>
<li><a href="#index-utp_005flist_005fcompletion-353"><code>utp_list_completion</code></a>: <a href="#misc-list">misc list</a></li>
<li><a href="#index-utp_005flist_005fmap-352"><code>utp_list_map</code></a>: <a href="#misc-list">misc list</a></li>
<li><a href="#index-utp_005flist_005fremove_005fduplicates-347"><code>utp_list_remove_duplicates</code></a>: <a href="#misc-list">misc list</a></li>
<li><a href="#index-utp_005flist_005fvariable_005fappend_005fitem_005fif_005funique-348"><code>utp_list_variable_append_item_if_unique</code></a>: <a href="#misc-list">misc list</a></li>
<li><a href="#index-utp_005flist_005fvariable_005fdelete_005fitem-349"><code>utp_list_variable_delete_item</code></a>: <a href="#misc-list">misc list</a></li>
<li><a href="#index-utp_005flist_005fvariable_005fdelete_005frange-350"><code>utp_list_variable_delete_range</code></a>: <a href="#misc-list">misc list</a></li>
<li><a href="#index-utp_005flist_005fvariable_005fmap-351"><code>utp_list_variable_map</code></a>: <a href="#misc-list">misc list</a></li>
<li><a href="#index-utp_005flockfile_005fcreate-304"><code>utp_lockfile_create</code></a>: <a href="#lock-files">lock files</a></li>
<li><a href="#index-utp_005flockfile_005fdelete-305"><code>utp_lockfile_delete</code></a>: <a href="#lock-files">lock files</a></li>
<li><a href="#index-utp_005flockfile_005fexists-306"><code>utp_lockfile_exists</code></a>: <a href="#lock-files">lock files</a></li>
<li><a href="#index-utp_005flockfile_005finit-303"><code>utp_lockfile_init</code></a>: <a href="#lock-files">lock files</a></li>
<li><a href="#index-utp_005fmacro-3"><code>utp_macro</code></a>: <a href="#preprocessor-commands-special">preprocessor commands special</a></li>
<li><a href="#index-utp_005fmain-324"><code>utp_main</code></a>: <a href="#main-interface">main interface</a></li>
<li><a href="#index-utp_005fmain_005faccess_005farguments-331"><code>utp_main_access_arguments</code></a>: <a href="#main-variables">main variables</a></li>
<li><a href="#index-utp_005fmain_005faccess_005fenv-332"><code>utp_main_access_env</code></a>: <a href="#main-variables">main variables</a></li>
<li><a href="#index-utp_005fmain_005faccess_005foptions-330"><code>utp_main_access_options</code></a>: <a href="#main-variables">main variables</a></li>
<li><a href="#index-utp_005fmain_005faccess_005fpwd-333"><code>utp_main_access_pwd</code></a>: <a href="#main-variables">main variables</a></li>
<li><a href="#index-utp_005fmain_005faccess_005ftask-334"><code>utp_main_access_task</code></a>: <a href="#main-variables">main variables</a></li>
<li><a href="#index-utp_005fmain_005faccess_005ftoken-328"><code>utp_main_access_token</code></a>: <a href="#main-variables">main variables</a></li>
<li><a href="#index-utp_005fmain_005fafter-335"><code>utp_main_after</code></a>: <a href="#main-loop">main loop</a></li>
<li><a href="#index-utp_005fmain_005fenter_005floop-337"><code>utp_main_enter_loop</code></a>: <a href="#main-loop">main loop</a></li>
<li><a href="#index-utp_005fmain_005fexit-325"><code>utp_main_exit</code></a>: <a href="#main-interface">main interface</a></li>
<li><a href="#index-utp_005fmain_005fexit_005ftrigger-336"><code>utp_main_exit_trigger</code></a>: <a href="#main-loop">main loop</a></li>
<li><a href="#index-utp_005fmain_005foption_005fdebugging-314"><code>utp_main_option_debugging</code></a>: <a href="#main-options">main options</a></li>
<li><a href="#index-utp_005fmain_005foption_005finteractive-313"><code>utp_main_option_interactive</code></a>: <a href="#main-options">main options</a></li>
<li><a href="#index-utp_005fmain_005foption_005ftesting-312"><code>utp_main_option_testing</code></a>: <a href="#main-options">main options</a></li>
<li><a href="#index-utp_005fmain_005fset_005fauthor-316"><code>utp_main_set_author</code></a>: <a href="#main-infos">main infos</a></li>
<li><a href="#index-utp_005fmain_005fset_005fcopyright_005fyears-317"><code>utp_main_set_copyright_years</code></a>: <a href="#main-infos">main infos</a></li>
<li><a href="#index-utp_005fmain_005fset_005fprogname-315"><code>utp_main_set_progname</code></a>: <a href="#main-infos">main infos</a></li>
<li><a href="#index-utp_005fmain_005fset_005fstderr-322"><code>utp_main_set_stderr</code></a>: <a href="#main-infos">main infos</a></li>
<li><a href="#index-utp_005fmain_005fset_005fstdin-320"><code>utp_main_set_stdin</code></a>: <a href="#main-infos">main infos</a></li>
<li><a href="#index-utp_005fmain_005fset_005fstdout-321"><code>utp_main_set_stdout</code></a>: <a href="#main-infos">main infos</a></li>
<li><a href="#index-utp_005fmain_005fset_005fusage-319"><code>utp_main_set_usage</code></a>: <a href="#main-infos">main infos</a></li>
<li><a href="#index-utp_005fmain_005fset_005fversion-318"><code>utp_main_set_version</code></a>: <a href="#main-infos">main infos</a></li>
<li><a href="#index-utp_005fmain_005fswitch_005ftoken-329"><code>utp_main_switch_token</code></a>: <a href="#main-variables">main variables</a></li>
<li><a href="#index-utp_005fmath_005fdeg2rad-361"><code>utp_math_deg2rad</code></a>: <a href="#misc-math">misc math</a></li>
<li><a href="#index-utp_005fmath_005fmax-365"><code>utp_math_max</code></a>: <a href="#misc-math">misc math</a></li>
<li><a href="#index-utp_005fmath_005fmin-366"><code>utp_math_min</code></a>: <a href="#misc-math">misc math</a></li>
<li><a href="#index-utp_005fmath_005frad2deg-362"><code>utp_math_rad2deg</code></a>: <a href="#misc-math">misc math</a></li>
<li><a href="#index-utp_005fmath_005fsin_005fcos-363"><code>utp_math_sin_cos</code></a>: <a href="#misc-math">misc math</a></li>
<li><a href="#index-utp_005fmaybe_005fmain-323"><code>utp_maybe_main</code></a>: <a href="#main-interface">main interface</a></li>
<li><a href="#index-utp_005fmaybe_005fmain-5"><code>utp_maybe_main</code></a>: <a href="#preprocessor-commands-special">preprocessor commands special</a></li>
<li><a href="#index-utp_005fmessage_005fadd_005fchannel-139"><code>utp_message_add_channel</code></a>: <a href="#channel-message-init">channel message init</a></li>
<li><a href="#index-utp_005fmessage_005fdebug-156"><code>utp_message_debug</code></a>: <a href="#channel-message-write">channel message write</a></li>
<li><a href="#index-utp_005fmessage_005fdisable_005fdebugging-145"><code>utp_message_disable_debugging</code></a>: <a href="#channel-message-config">channel message config</a></li>
<li><a href="#index-utp_005fmessage_005fdisable_005fmessages-143"><code>utp_message_disable_messages</code></a>: <a href="#channel-message-config">channel message config</a></li>
<li><a href="#index-utp_005fmessage_005fdisable_005fverbose-147"><code>utp_message_disable_verbose</code></a>: <a href="#channel-message-config">channel message config</a></li>
<li><a href="#index-utp_005fmessage_005fdrop_005fchannel-140"><code>utp_message_drop_channel</code></a>: <a href="#channel-message-init">channel message init</a></li>
<li><a href="#index-utp_005fmessage_005fenable_005fdebugging-144"><code>utp_message_enable_debugging</code></a>: <a href="#channel-message-config">channel message config</a></li>
<li><a href="#index-utp_005fmessage_005fenable_005fmessages-142"><code>utp_message_enable_messages</code></a>: <a href="#channel-message-config">channel message config</a></li>
<li><a href="#index-utp_005fmessage_005fenable_005fverbose-146"><code>utp_message_enable_verbose</code></a>: <a href="#channel-message-config">channel message config</a></li>
<li><a href="#index-utp_005fmessage_005ferror-153"><code>utp_message_error</code></a>: <a href="#channel-message-write">channel message write</a></li>
<li><a href="#index-utp_005fmessage_005ferrorinfo-154"><code>utp_message_errorinfo</code></a>: <a href="#channel-message-write">channel message write</a></li>
<li><a href="#index-utp_005fmessage_005fget_005fprefix-149"><code>utp_message_get_prefix</code></a>: <a href="#channel-message-config">channel message config</a></li>
<li><a href="#index-utp_005fmessage_005fget_005fverbosity-151"><code>utp_message_get_verbosity</code></a>: <a href="#channel-message-config">channel message config</a></li>
<li><a href="#index-utp_005fmessage_005finit-138"><code>utp_message_init</code></a>: <a href="#channel-message-init">channel message init</a></li>
<li><a href="#index-utp_005fmessage_005freplace_005fchannel-141"><code>utp_message_replace_channel</code></a>: <a href="#channel-message-init">channel message init</a></li>
<li><a href="#index-utp_005fmessage_005fset_005fprefix-148"><code>utp_message_set_prefix</code></a>: <a href="#channel-message-config">channel message config</a></li>
<li><a href="#index-utp_005fmessage_005fset_005fverbosity-150"><code>utp_message_set_verbosity</code></a>: <a href="#channel-message-config">channel message config</a></li>
<li><a href="#index-utp_005fmessage_005fstring-158"><code>utp_message_string</code></a>: <a href="#channel-message-write">channel message write</a></li>
<li><a href="#index-utp_005fmessage_005fswitch_005ferror_005fcode-159"><code>utp_message_switch_error_code</code></a>: <a href="#channel-message-write">channel message write</a></li>
<li><a href="#index-utp_005fmessage_005fswitch_005ftoken-137"><code>utp_message_switch_token</code></a>: <a href="#channel-message-init">channel message init</a></li>
<li><a href="#index-utp_005fmessage_005fverbose-157"><code>utp_message_verbose</code></a>: <a href="#channel-message-write">channel message write</a></li>
<li><a href="#index-utp_005fmessage_005fwarning-155"><code>utp_message_warning</code></a>: <a href="#channel-message-write">channel message write</a></li>
<li><a href="#index-utp_005fmessage_005fwrite-152"><code>utp_message_write</code></a>: <a href="#channel-message-write">channel message write</a></li>
<li><a href="#index-utp_005fobserver_005fattach-174"><code>utp_observer_attach</code></a>: <a href="#observer">observer</a></li>
<li><a href="#index-utp_005fobserver_005fdetach-176"><code>utp_observer_detach</code></a>: <a href="#observer">observer</a></li>
<li><a href="#index-utp_005fobserver_005finit-173"><code>utp_observer_init</code></a>: <a href="#observer">observer</a></li>
<li><a href="#index-utp_005fobserver_005fnotify-178"><code>utp_observer_notify</code></a>: <a href="#observer">observer</a></li>
<li><a href="#index-utp_005foption_005fget-266"><code>utp_option_get</code></a>: <a href="#option">option</a></li>
<li><a href="#index-utp_005foption_005fset-265"><code>utp_option_set</code></a>: <a href="#option">option</a></li>
<li><a href="#index-utp_005foption_005fswitch_005ftoken-264"><code>utp_option_switch_token</code></a>: <a href="#option">option</a></li>
<li><a href="#index-utp_005fparameter-77"><code>utp_parameter</code></a>: <a href="#dynamic">dynamic</a></li>
<li><a href="#index-utp_005fparametrise-79"><code>utp_parametrise</code></a>: <a href="#dynamic">dynamic</a></li>
<li><a href="#index-utp_005fperiodic_005fscript_005fget_005fperiod-113"><code>utp_periodic_script_get_period</code></a>: <a href="#periodic-scripts">periodic scripts</a></li>
<li><a href="#index-utp_005fperiodic_005fscript_005finit-106"><code>utp_periodic_script_init</code></a>: <a href="#periodic-scripts">periodic scripts</a></li>
<li><a href="#index-utp_005fperiodic_005fscript_005fschedule-107"><code>utp_periodic_script_schedule</code></a>: <a href="#periodic-scripts">periodic scripts</a></li>
<li><a href="#index-utp_005fperiodic_005fscript_005fset_005fcondition-109"><code>utp_periodic_script_set_condition</code></a>: <a href="#periodic-scripts">periodic scripts</a></li>
<li><a href="#index-utp_005fperiodic_005fscript_005fset_005fperiod-111"><code>utp_periodic_script_set_period</code></a>: <a href="#periodic-scripts">periodic scripts</a></li>
<li><a href="#index-utp_005fqueue_005fdrop-92"><code>utp_queue_drop</code></a>: <a href="#queue">queue</a></li>
<li><a href="#index-utp_005fqueue_005fis_005fempty-96"><code>utp_queue_is_empty</code></a>: <a href="#queue">queue</a></li>
<li><a href="#index-utp_005fqueue_005fis_005fnot_005fempty-97"><code>utp_queue_is_not_empty</code></a>: <a href="#queue">queue</a></li>
<li><a href="#index-utp_005fqueue_005flength-94"><code>utp_queue_length</code></a>: <a href="#queue">queue</a></li>
<li><a href="#index-utp_005fqueue_005fpop-90"><code>utp_queue_pop</code></a>: <a href="#queue">queue</a></li>
<li><a href="#index-utp_005fqueue_005fpurge-95"><code>utp_queue_purge</code></a>: <a href="#queue">queue</a></li>
<li><a href="#index-utp_005fqueue_005fpush-89"><code>utp_queue_push</code></a>: <a href="#queue">queue</a></li>
<li><a href="#index-utp_005fqueue_005fsize-93"><code>utp_queue_size</code></a>: <a href="#queue">queue</a></li>
<li><a href="#index-utp_005fqueue_005ftop-91"><code>utp_queue_top</code></a>: <a href="#queue">queue</a></li>
<li><a href="#index-utp_005fregexp_005farray-354"><code>utp_regexp_array</code></a>: <a href="#misc-regexps">misc regexps</a></li>
<li><a href="#index-utp_005fsave_005fexcursion-345"><code>utp_save_excursion</code></a>: <a href="#misc-procedures">misc procedures</a></li>
<li><a href="#index-utp_005fscript_005feval-339"><code>utp_script_eval</code></a>: <a href="#misc-base">misc base</a></li>
<li><a href="#index-utp_005fscript_005for_005ffalse-343"><code>utp_script_or_false</code></a>: <a href="#misc-procedures">misc procedures</a></li>
<li><a href="#index-utp_005fscript_005for_005ftrue-342"><code>utp_script_or_true</code></a>: <a href="#misc-procedures">misc procedures</a></li>
<li><a href="#index-utp_005fsm_005fenter_005fcurrent-258"><code>utp_sm_enter_current</code></a>: <a href="#sm">sm</a></li>
<li><a href="#index-utp_005fsm_005fget_005fcurrent-259"><code>utp_sm_get_current</code></a>: <a href="#sm">sm</a></li>
<li><a href="#index-utp_005fsm_005fnode_005fvalue-261"><code>utp_sm_node_value</code></a>: <a href="#sm">sm</a></li>
<li><a href="#index-utp_005fsm_005fregister_005fnode-255"><code>utp_sm_register_node</code></a>: <a href="#sm">sm</a></li>
<li><a href="#index-utp_005fsm_005fregister_005ftransition-256"><code>utp_sm_register_transition</code></a>: <a href="#sm">sm</a></li>
<li><a href="#index-utp_005fsm_005fset_005fcurrent-257"><code>utp_sm_set_current</code></a>: <a href="#sm">sm</a></li>
<li><a href="#index-utp_005fsm_005ftransition-260"><code>utp_sm_transition</code></a>: <a href="#sm">sm</a></li>
<li><a href="#index-utp_005fsm_005ftransition_005fvalue-262"><code>utp_sm_transition_value</code></a>: <a href="#sm">sm</a></li>
<li><a href="#index-utp_005fstack_005fdrop-83"><code>utp_stack_drop</code></a>: <a href="#stack">stack</a></li>
<li><a href="#index-utp_005fstack_005fis_005fempty-87"><code>utp_stack_is_empty</code></a>: <a href="#stack">stack</a></li>
<li><a href="#index-utp_005fstack_005fis_005fnot_005fempty-88"><code>utp_stack_is_not_empty</code></a>: <a href="#stack">stack</a></li>
<li><a href="#index-utp_005fstack_005flength-85"><code>utp_stack_length</code></a>: <a href="#stack">stack</a></li>
<li><a href="#index-utp_005fstack_005fpop-81"><code>utp_stack_pop</code></a>: <a href="#stack">stack</a></li>
<li><a href="#index-utp_005fstack_005fpurge-86"><code>utp_stack_purge</code></a>: <a href="#stack">stack</a></li>
<li><a href="#index-utp_005fstack_005fpush-80"><code>utp_stack_push</code></a>: <a href="#stack">stack</a></li>
<li><a href="#index-utp_005fstack_005fsize-84"><code>utp_stack_size</code></a>: <a href="#stack">stack</a></li>
<li><a href="#index-utp_005fstack_005ftop-82"><code>utp_stack_top</code></a>: <a href="#stack">stack</a></li>
<li><a href="#index-utp_005fstruct-68"><code>utp_struct</code></a>: <a href="#struct-procs">struct procs</a></li>
<li><a href="#index-utp_005fstruct-9"><code>utp_struct</code></a>: <a href="#preprocessor-commands-struct">preprocessor commands struct</a></li>
<li><a href="#index-utp_005fstruct_005fcopy-69"><code>utp_struct_copy</code></a>: <a href="#struct-procs">struct procs</a></li>
<li><a href="#index-utp_005fstruct_005fduplicate-70"><code>utp_struct_duplicate</code></a>: <a href="#struct-procs">struct procs</a></li>
<li><a href="#index-utp_005ftask_005falloc_005fswitch_005finit-185"><code>utp_task_alloc_switch_init</code></a>: <a href="#task-interface">task interface</a></li>
<li><a href="#index-utp_005ftask_005fcd-189"><code>utp_task_cd</code></a>: <a href="#task-interface">task interface</a></li>
<li><a href="#index-utp_005ftask_005fglobal-186"><code>utp_task_global</code></a>: <a href="#task-interface">task interface</a></li>
<li><a href="#index-utp_005ftask_005fglobget-191"><code>utp_task_globget</code></a>: <a href="#task-interface">task interface</a></li>
<li><a href="#index-utp_005ftask_005fglobname-187"><code>utp_task_globname</code></a>: <a href="#task-interface">task interface</a></li>
<li><a href="#index-utp_005ftask_005fglobset-190"><code>utp_task_globset</code></a>: <a href="#task-interface">task interface</a></li>
<li><a href="#index-utp_005ftask_005finit-184"><code>utp_task_init</code></a>: <a href="#task-interface">task interface</a></li>
<li><a href="#index-utp_005ftask_005fswitch_005fcommand-183"><code>utp_task_switch_command</code></a>: <a href="#task-token">task token</a></li>
<li><a href="#index-utp_005ftask_005fswitch_005ftoken-182"><code>utp_task_switch_token</code></a>: <a href="#task-token">task token</a></li>
<li><a href="#index-utp_005ftask_005fvwait-188"><code>utp_task_vwait</code></a>: <a href="#task-interface">task interface</a></li>
<li><a href="#index-utp_005ftimeout_005finit-116"><code>utp_timeout_init</code></a>: <a href="#timeouts">timeouts</a></li>
<li><a href="#index-utp_005ftimeout_005freinit-125"><code>utp_timeout_reinit</code></a>: <a href="#timeouts">timeouts</a></li>
<li><a href="#index-utp_005ftimeout_005frunning-121"><code>utp_timeout_running</code></a>: <a href="#timeouts">timeouts</a></li>
<li><a href="#index-utp_005ftimeout_005fstart-117"><code>utp_timeout_start</code></a>: <a href="#timeouts">timeouts</a></li>
<li><a href="#index-utp_005ftimeout_005fstop-119"><code>utp_timeout_stop</code></a>: <a href="#timeouts">timeouts</a></li>
<li><a href="#index-utp_005ftimeout_005ftriggered-123"><code>utp_timeout_triggered</code></a>: <a href="#timeouts">timeouts</a></li>
<li><a href="#index-utp_005ftoken_005fmap_005faccess-73"><code>utp_token_map_access</code></a>: <a href="#token-map">token map</a></li>
<li><a href="#index-utp_005ftoken_005fmap_005faliases-74"><code>utp_token_map_aliases</code></a>: <a href="#token-map">token map</a></li>
<li><a href="#index-utp_005ftoken_005fmap_005fdeclare-71"><code>utp_token_map_declare</code></a>: <a href="#token-map">token map</a></li>
<li><a href="#index-utp_005ftoken_005fmap_005fforget-72"><code>utp_token_map_forget</code></a>: <a href="#token-map">token map</a></li>
<li><a href="#index-utp_005ftypedef-10"><code>utp_typedef</code></a>: <a href="#typedef-overview">typedef overview</a></li>
<li><a href="#index-utp_005ftypedef-7"><code>utp_typedef</code></a>: <a href="#preprocessor-commands-types">preprocessor commands types</a></li>
<li><a href="#index-utp_005fverb-2"><code>utp_verb</code></a>: <a href="#preprocessor-commands-special">preprocessor commands special</a></li>
<li><a href="#index-utp_005fverbatim-1"><code>utp_verbatim</code></a>: <a href="#preprocessor-commands-special">preprocessor commands special</a></li>
<li><a href="#index-utp_005fwireframe_005fapply_005fexternal_005ftransform-435"><code>utp_wireframe_apply_external_transform</code></a>: <a href="#wireframe-ops">wireframe ops</a></li>
<li><a href="#index-utp_005fwireframe_005fapply_005finternal_005ftransform-434"><code>utp_wireframe_apply_internal_transform</code></a>: <a href="#wireframe-ops">wireframe ops</a></li>
<li><a href="#index-utp_005fwireframe_005fapply_005fshaping_005ftransform-433"><code>utp_wireframe_apply_shaping_transform</code></a>: <a href="#wireframe-ops">wireframe ops</a></li>
<li><a href="#index-utp_005fwireframe_005fcoords_005fcircle-442"><code>utp_wireframe_coords_circle</code></a>: <a href="#wireframe-templates">wireframe templates</a></li>
<li><a href="#index-utp_005fwireframe_005fcoords_005fline-439"><code>utp_wireframe_coords_line</code></a>: <a href="#wireframe-templates">wireframe templates</a></li>
<li><a href="#index-utp_005fwireframe_005fcoords_005fparametric-444"><code>utp_wireframe_coords_parametric</code></a>: <a href="#wireframe-templates">wireframe templates</a></li>
<li><a href="#index-utp_005fwireframe_005fcoords_005fpolygon-443"><code>utp_wireframe_coords_polygon</code></a>: <a href="#wireframe-templates">wireframe templates</a></li>
<li><a href="#index-utp_005fwireframe_005fcoords_005fsquare-440"><code>utp_wireframe_coords_square</code></a>: <a href="#wireframe-templates">wireframe templates</a></li>
<li><a href="#index-utp_005fwireframe_005fcoords_005ftee-441"><code>utp_wireframe_coords_tee</code></a>: <a href="#wireframe-templates">wireframe templates</a></li>
<li><a href="#index-utp_005fwireframe_005fframe-452"><code>utp_wireframe_frame</code></a>: <a href="#wireframe-aggregate">wireframe aggregate</a></li>
<li><a href="#index-utp_005fwireframe_005fget_005fcached_005fcoords-421"><code>utp_wireframe_get_cached_coords</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fget_005fcommand-417"><code>utp_wireframe_get_command</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fget_005fcoords-419"><code>utp_wireframe_get_coords</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fget_005fid-428"><code>utp_wireframe_get_id</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fget_005fopt-432"><code>utp_wireframe_get_opt</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fget_005fscene_005fcoords-423"><code>utp_wireframe_get_scene_coords</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fget_005ftags-430"><code>utp_wireframe_get_tags</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fget_005ftransforms-425"><code>utp_wireframe_get_transforms</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fline-447"><code>utp_wireframe_line</code></a>: <a href="#wireframe-basic">wireframe basic</a></li>
<li><a href="#index-utp_005fwireframe_005fmove-445"><code>utp_wireframe_move</code></a>: <a href="#wireframe-basic">wireframe basic</a></li>
<li><a href="#index-utp_005fwireframe_005fpath-448"><code>utp_wireframe_path</code></a>: <a href="#wireframe-basic">wireframe basic</a></li>
<li><a href="#index-utp_005fwireframe_005fplane-454"><code>utp_wireframe_plane</code></a>: <a href="#wireframe-aggregate">wireframe aggregate</a></li>
<li><a href="#index-utp_005fwireframe_005fpolygon-449"><code>utp_wireframe_polygon</code></a>: <a href="#wireframe-basic">wireframe basic</a></li>
<li><a href="#index-utp_005fwireframe_005fposition-446"><code>utp_wireframe_position</code></a>: <a href="#wireframe-basic">wireframe basic</a></li>
<li><a href="#index-utp_005fwireframe_005fprism-453"><code>utp_wireframe_prism</code></a>: <a href="#wireframe-aggregate">wireframe aggregate</a></li>
<li><a href="#index-utp_005fwireframe_005fset_005fall_005ftransforms-426"><code>utp_wireframe_set_all_transforms</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fset_005fcached_005fcoords-420"><code>utp_wireframe_set_cached_coords</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fset_005fcommand-416"><code>utp_wireframe_set_command</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fset_005fcoords-418"><code>utp_wireframe_set_coords</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fset_005fid-427"><code>utp_wireframe_set_id</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fset_005fopt-431"><code>utp_wireframe_set_opt</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fset_005fscene_005fcoords-422"><code>utp_wireframe_set_scene_coords</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fset_005ftags-429"><code>utp_wireframe_set_tags</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fset_005ftransforms-424"><code>utp_wireframe_set_transforms</code></a>: <a href="#wireframe-element">wireframe element</a></li>
<li><a href="#index-utp_005fwireframe_005fsphere-458"><code>utp_wireframe_sphere</code></a>: <a href="#wireframe-aggregate">wireframe aggregate</a></li>
<li><a href="#index-utp_005fwireframe_005fsphere_005fmeridians-456"><code>utp_wireframe_sphere_meridians</code></a>: <a href="#wireframe-aggregate">wireframe aggregate</a></li>
<li><a href="#index-utp_005fwireframe_005fsphere_005fparallels-457"><code>utp_wireframe_sphere_parallels</code></a>: <a href="#wireframe-aggregate">wireframe aggregate</a></li>
<li><a href="#index-utp_005fwireframe_005ftag-451"><code>utp_wireframe_tag</code></a>: <a href="#wireframe-basic">wireframe basic</a></li>
<li><a href="#index-utp_005fwireframe_005ftext-450"><code>utp_wireframe_text</code></a>: <a href="#wireframe-basic">wireframe basic</a></li>
<li><a href="#index-utp_005fwireframe_005ftk_005fcanvas_005finit-460"><code>utp_wireframe_tk_canvas_init</code></a>: <a href="#wireframetk-struct">wireframetk struct</a></li>
<li><a href="#index-utp_005fwireframe_005ftk_005fcanvas_005fpopulate-461"><code>utp_wireframe_tk_canvas_populate</code></a>: <a href="#wireframetk-populate">wireframetk populate</a></li>
<li><a href="#index-utp_005fwireframe_005ftk_005fcanvas_005fquery_005foption-466"><code>utp_wireframe_tk_canvas_query_option</code></a>: <a href="#wireframetk-misc">wireframetk misc</a></li>
<li><a href="#index-utp_005fwireframe_005ftk_005fcanvas_005fremove-465"><code>utp_wireframe_tk_canvas_remove</code></a>: <a href="#wireframetk-misc">wireframetk misc</a></li>
<li><a href="#index-utp_005fwireframe_005ftk_005fcanvas_005ftag_005fconfig-467"><code>utp_wireframe_tk_canvas_tag_config</code></a>: <a href="#wireframetk-misc">wireframetk misc</a></li>
<li><a href="#index-utp_005fwireframe_005ftk_005fcanvas_005fupdate-462"><code>utp_wireframe_tk_canvas_update</code></a>: <a href="#wireframetk-update">wireframetk update</a></li>
<li><a href="#index-utp_005fwireframe_005ftk_005fcoords_005fto_005fmm-463"><code>utp_wireframe_tk_coords_to_mm</code></a>: <a href="#wireframetk-misc">wireframetk misc</a></li>
<li><a href="#index-utp_005fwireframe_005ftk_005fcoords_005fto_005fpixels-464"><code>utp_wireframe_tk_coords_to_pixels</code></a>: <a href="#wireframetk-misc">wireframetk misc</a></li>
<li><a href="#index-utp_005fwireframe_005fworkspace-455"><code>utp_wireframe_workspace</code></a>: <a href="#wireframe-aggregate">wireframe aggregate</a></li>
<li><a href="#index-utp_005fworkers_005facquire-244"><code>utp_workers_acquire</code></a>: <a href="#workers">workers</a></li>
<li><a href="#index-utp_005fworkers_005fconfig_005fcommit-250"><code>utp_workers_config_commit</code></a>: <a href="#workers">workers</a></li>
<li><a href="#index-utp_005fworkers_005fconfig_005fget_005fperiod-253"><code>utp_workers_config_get_period</code></a>: <a href="#workers">workers</a></li>
<li><a href="#index-utp_005fworkers_005fconfig_005finit-249"><code>utp_workers_config_init</code></a>: <a href="#workers">workers</a></li>
<li><a href="#index-utp_005fworkers_005fconfig_005fset_005fperiod-252"><code>utp_workers_config_set_period</code></a>: <a href="#workers">workers</a></li>
<li><a href="#index-utp_005fworkers_005finit-243"><code>utp_workers_init</code></a>: <a href="#workers">workers</a></li>
<li><a href="#index-utp_005fworkers_005frelease-246"><code>utp_workers_release</code></a>: <a href="#workers">workers</a></li>
<li><a href="#index-utp_005fxmlpp_005fiterator_005fbody-309"><code>utp_xmlpp_iterator_body</code></a>: <a href="#xmlpp">xmlpp</a></li>
<li><a href="#index-utp_005fxmlpp_005fiterator_005fbody_005fnext-310"><code>utp_xmlpp_iterator_body_next</code></a>: <a href="#xmlpp">xmlpp</a></li>
<li><a href="#index-utp_005fxmlpp_005fparse0-311"><code>utp_xmlpp_parse0</code></a>: <a href="#xmlpp">xmlpp</a></li>
<li><a href="#index-utp_005fxmlpp_005fparse_005fdoctype-308"><code>utp_xmlpp_parse_doctype</code></a>: <a href="#xmlpp">xmlpp</a></li>
<li><a href="#index-utp_005fxmlpp_005fparse_005fprolog-307"><code>utp_xmlpp_parse_prolog</code></a>: <a href="#xmlpp">xmlpp</a></li>
<li><a href="#index-validate-203"><code>validate</code></a>: <a href="#cache">cache</a></li>
   </ul><div class="node">
<a name="Variable-Index"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Type-Index">Type Index</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Function-Index">Function Index</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="appendix">Appendix F An entry for each variable</h2>



<ul class="index-vr" compact>
<li><a href="#index-utp_005fmain_005ftoken-327"><code>utp_main_token</code></a>: <a href="#main-variables">main variables</a></li>
<li><a href="#index-utp_005ftask_005ftoken-181"><code>utp_task_token</code></a>: <a href="#task-token">task token</a></li>
   </ul><div class="node">
<a name="Type-Index"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Variable-Index">Variable Index</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="appendix">Appendix G An entry for each type</h2>



<ul class="index-tp" compact>
<li><a href="#index-utp_005falnum_005ft-14"><code>utp_alnum_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005falpha_005ft-15"><code>utp_alpha_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fany_005ft-41"><code>utp_any_t</code></a>: <a href="#typedef-objects">typedef objects</a></li>
<li><a href="#index-utp_005farray_005ft-44"><code>utp_array_t</code></a>: <a href="#typedef-objects">typedef objects</a></li>
<li><a href="#index-utp_005fascii_005ft-16"><code>utp_ascii_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fboolean_005ft-17"><code>utp_boolean_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fcache_005fconfig_005ft-194"><code>utp_cache_config_t</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fcache_005ft-192"><code>utp_cache_t</code></a>: <a href="#cache">cache</a></li>
<li><a href="#index-utp_005fchannel_005ft-45"><code>utp_channel_t</code></a>: <a href="#typedef-objects">typedef objects</a></li>
<li><a href="#index-utp_005fcontrol_005ft-18"><code>utp_control_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fdialog_005ft-160"><code>utp_dialog_t</code></a>: <a href="#dialog">dialog</a></li>
<li><a href="#index-utp_005fdigit_005ft-19"><code>utp_digit_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fdouble_005ft-20"><code>utp_double_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fevent_005fsource_005ft-98"><code>utp_event_source_t</code></a>: <a href="#event-source">event source</a></li>
<li><a href="#index-utp_005ffactory_005ft-234"><code>utp_factory_t</code></a>: <a href="#factory">factory</a></li>
<li><a href="#index-utp_005ffraction_005ft-66"><code>utp_fraction_t</code></a>: <a href="#typedef-misc">typedef misc</a></li>
<li><a href="#index-utp_005fgraph_005ft-21"><code>utp_graph_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fcanvas_005ft-401"><code>utp_hoco_transform_canvas_t</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fdh_005ft-404"><code>utp_hoco_transform_dh_t</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fhomogeneous_005ft-402"><code>utp_hoco_transform_homogeneous_t</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fperspective_005ft-406"><code>utp_hoco_transform_perspective_t</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005frotation_005fx_005ft-410"><code>utp_hoco_transform_rotation_x_t</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005frotation_005fy_005ft-411"><code>utp_hoco_transform_rotation_y_t</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005frotation_005fz_005ft-412"><code>utp_hoco_transform_rotation_z_t</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fscale_005ft-405"><code>utp_hoco_transform_scale_t</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fshaping_005ft-407"><code>utp_hoco_transform_shaping_t</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005ftranslation_005ft-409"><code>utp_hoco_transform_translation_t</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fview_005ft-408"><code>utp_hoco_transform_view_t</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fhoco_005ftransform_005fworkspace_005ft-403"><code>utp_hoco_transform_workspace_t</code></a>: <a href="#hoco-dynamic">hoco dynamic</a></li>
<li><a href="#index-utp_005fint_005ft-40"><code>utp_int_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005finteger_005ft-22"><code>utp_integer_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005finterp_005ft-49"><code>utp_interp_t</code></a>: <a href="#typedef-objects">typedef objects</a></li>
<li><a href="#index-utp_005fiterator_005ft-164"><code>utp_iterator_t</code></a>: <a href="#iterator">iterator</a></li>
<li><a href="#index-utp_005flist_005ft-43"><code>utp_list_t</code></a>: <a href="#typedef-objects">typedef objects</a></li>
<li><a href="#index-utp_005flockfile_005ft-302"><code>utp_lockfile_t</code></a>: <a href="#lock-files">lock files</a></li>
<li><a href="#index-utp_005flower_005ft-23"><code>utp_lower_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fmain_005ft-326"><code>utp_main_t</code></a>: <a href="#main-variables">main variables</a></li>
<li><a href="#index-utp_005fmessage_005ft-136"><code>utp_message_t</code></a>: <a href="#channel-message-init">channel message init</a></li>
<li><a href="#index-utp_005fndouble_005ft-63"><code>utp_ndouble_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fnegative_005ft-51"><code>utp_negative_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fninteger_005ft-57"><code>utp_ninteger_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fnzdouble_005ft-64"><code>utp_nzdouble_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fnzint_005ft-60"><code>utp_nzint_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fnzinteger_005ft-59"><code>utp_nzinteger_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fobserver_005ft-172"><code>utp_observer_t</code></a>: <a href="#observer">observer</a></li>
<li><a href="#index-utp_005foption_005fdb_005ft-263"><code>utp_option_db_t</code></a>: <a href="#option">option</a></li>
<li><a href="#index-utp_005fpdouble_005ft-61"><code>utp_pdouble_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fperiodic_005fscript_005ft-105"><code>utp_periodic_script_t</code></a>: <a href="#periodic-scripts">periodic scripts</a></li>
<li><a href="#index-utp_005fpint_005ft-53"><code>utp_pint_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fpinteger_005ft-52"><code>utp_pinteger_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fpositive_005ft-50"><code>utp_positive_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fproc_005ft-48"><code>utp_proc_t</code></a>: <a href="#typedef-objects">typedef objects</a></li>
<li><a href="#index-utp_005fprogram_005ft-65"><code>utp_program_t</code></a>: <a href="#typedef-misc">typedef misc</a></li>
<li><a href="#index-utp_005fpzdouble_005ft-62"><code>utp_pzdouble_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fpzint_005ft-55"><code>utp_pzint_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fpzinteger_005ft-54"><code>utp_pzinteger_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005frange_005ft-67"><code>utp_range_t</code></a>: <a href="#typedef-misc">typedef misc</a></li>
<li><a href="#index-utp_005freference_005ft-47"><code>utp_reference_t</code></a>: <a href="#typedef-objects">typedef objects</a></li>
<li><a href="#index-utp_005fscript_005ft-46"><code>utp_script_t</code></a>: <a href="#typedef-objects">typedef objects</a></li>
<li><a href="#index-utp_005fsm_005ft-254"><code>utp_sm_t</code></a>: <a href="#sm">sm</a></li>
<li><a href="#index-utp_005fstring_005ft-42"><code>utp_string_t</code></a>: <a href="#typedef-objects">typedef objects</a></li>
<li><a href="#index-utp_005ftask_005ft-180"><code>utp_task_t</code></a>: <a href="#task-token">task token</a></li>
<li><a href="#index-utp_005ftimeout_005ft-115"><code>utp_timeout_t</code></a>: <a href="#timeouts">timeouts</a></li>
<li><a href="#index-utp_005funsigned_005ft-56"><code>utp_unsigned_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fupper_005ft-24"><code>utp_upper_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fwireframe_005ftk_005fcanvas_005ft-459"><code>utp_wireframe_tk_canvas_t</code></a>: <a href="#wireframetk-struct">wireframetk struct</a></li>
<li><a href="#index-utp_005fwordchar_005ft-25"><code>utp_wordchar_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fworkers_005fconfig_005ft-248"><code>utp_workers_config_t</code></a>: <a href="#workers">workers</a></li>
<li><a href="#index-utp_005fworkers_005ft-242"><code>utp_workers_t</code></a>: <a href="#workers">workers</a></li>
<li><a href="#index-utp_005fxdigit_005ft-26"><code>utp_xdigit_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fzalnum_005ft-27"><code>utp_zalnum_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fzalpha_005ft-28"><code>utp_zalpha_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fzascii_005ft-29"><code>utp_zascii_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fzboolean_005ft-30"><code>utp_zboolean_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fzcontrol_005ft-31"><code>utp_zcontrol_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fzdigit_005ft-32"><code>utp_zdigit_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fzdouble_005ft-33"><code>utp_zdouble_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fzgraph_005ft-34"><code>utp_zgraph_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fzint_005ft-58"><code>utp_zint_t</code></a>: <a href="#typedef-number">typedef number</a></li>
<li><a href="#index-utp_005fzinteger_005ft-35"><code>utp_zinteger_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fzlower_005ft-36"><code>utp_zlower_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fzupper_005ft-37"><code>utp_zupper_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fzwordchar_005ft-38"><code>utp_zwordchar_t</code></a>: <a href="#typedef-string">typedef string</a></li>
<li><a href="#index-utp_005fzxdigit_005ft-39"><code>utp_zxdigit_t</code></a>: <a href="#typedef-string">typedef string</a></li>
   </ul>
<div class="contents">
<h2>Table of Contents</h2>
<ul>
<li><a name="toc_Top" href="#Top">Useless TCL Packages</a>
<li><a name="toc_overview" href="#overview">1 Introduction to <acronym>UTP</acronym></a>
<ul>
<li><a href="#overview-error">1.1 Philosophy of error handling</a>
</li></ul>
<li><a name="toc_preprocessor" href="#preprocessor">2 Preprocessing <acronym>UTP</acronym> source files</a>
<ul>
<li><a href="#preprocessor-overview">2.1 Overview of preprocessing</a>
<li><a href="#preprocessor-usage">2.2 How to use the preprocessor</a>
<li><a href="#preprocessor-commands">2.3 What's evaluated by the preprocessor</a>
<ul>
<li><a href="#preprocessor-commands-special">2.3.1 Some special commands</a>
<li><a href="#preprocessor-commands-types">2.3.2 Types definition</a>
<li><a href="#preprocessor-commands-procedures">2.3.3 Typed procedures</a>
<li><a href="#preprocessor-commands-struct">2.3.4 Structure definition</a>
</li></ul>
<li><a href="#preprocessor-expansion">2.4 Processing by regular expressions</a>
</li></ul>
<li><a name="toc_typedef" href="#typedef">3 Declaring data types</a>
<ul>
<li><a href="#typedef-overview">3.1 Overview of the type system</a>
<li><a href="#typedef-string">3.2 String based types</a>
<li><a href="#typedef-objects">3.3 <acronym>TCL</acronym> object types</a>
<li><a href="#typedef-number">3.4 Number based types</a>
<li><a href="#typedef-misc">3.5 Miscellaneous values</a>
</li></ul>
<li><a name="toc_struct" href="#struct">4 Declaring structures</a>
<ul>
<li><a href="#struct-vars">4.1 Structure variables</a>
<li><a href="#struct-usage">4.2 Using <acronym>UTP</acronym> structures</a>
<li><a href="#struct-procs">4.3 Defining and declaring structures</a>
</li></ul>
<li><a name="toc_token" href="#token">5 Managing global symbols to store data</a>
<ul>
<li><a href="#token-explicit">5.1 Using explicit token variables</a>
<li><a href="#token-implicit">5.2 Using implicit token variables</a>
<li><a href="#token-map">5.3 Storing tokens in an associative array</a>
</li></ul>
<li><a name="toc_dynamic" href="#dynamic">6 Handling dynamic environment</a>
<li><a name="toc_containers" href="#containers">7 Collecting data</a>
<ul>
<li><a href="#stack">7.1 List as stack</a>
<li><a href="#queue">7.2 List as queue</a>
</li></ul>
<li><a name="toc_events" href="#events">8 Handling the event loop</a>
<ul>
<li><a href="#event-source">8.1 Event sources</a>
<li><a href="#periodic-scripts">8.2 Evaluating scripts periodically</a>
<ul>
<li><a href="#periodic-scripts-diagram">8.2.1 Block diagram</a>
</li></ul>
<li><a href="#timeouts">8.3 Setting timeouts</a>
</li></ul>
<li><a name="toc_user-interface" href="#user-interface">9 Interfacing with the user</a>
<ul>
<li><a href="#getopts">9.1 Parsing options from the command line</a>
<ul>
<li><a href="#getopts-intro">9.1.1 The format of recognised options</a>
<li><a href="#getopts-basic">9.1.2 Low level procedures</a>
<li><a href="#getopts-parser">9.1.3 Options declaration and parsing</a>
<li><a href="#getopts-help">9.1.4 Building the help screen</a>
</li></ul>
<li><a href="#ini-files">9.2 Parsing <code>.INI</code> configuration files</a>
<li><a href="#channel-message">9.3 Writing messages into a channel</a>
<ul>
<li><a href="#channel-message-init">9.3.1 Initialisation and finalisation</a>
<li><a href="#channel-message-config">9.3.2 Configuration</a>
<li><a href="#channel-message-write">9.3.3 Writing messages</a>
</li></ul>
<li><a href="#dialog">9.4 Asking questions</a>
</li></ul>
<li><a name="toc_design" href="#design">10 Packages implementing design strategies</a>
<ul>
<li><a href="#iterator">10.1 Iteration procedures</a>
<li><a href="#observer">10.2 The Observer design pattern</a>
<li><a href="#task">10.3 Handling job private variables</a>
<ul>
<li><a href="#task-token">10.3.1 Token hanling</a>
<li><a href="#task-interface">10.3.2 Interface procedures</a>
<li><a href="#task-examples">10.3.3 Usage examples</a>
</li></ul>
<li><a href="#cache">10.4 Caching objects</a>
<li><a href="#factory">10.5 Object factory</a>
<li><a href="#workers">10.6 Using a pool of worker items</a>
<li><a href="#sm">10.7 Managing state machines</a>
<li><a href="#option">10.8 Handling tables of options</a>
</li></ul>
<li><a name="toc_file" href="#file">11 File related packages</a>
<ul>
<li><a href="#channel">11.1 Chennel related procedures</a>
<ul>
<li><a href="#channel-basic">11.1.1 Basic channel operations</a>
<li><a href="#channel-other">11.1.2 Other non&ndash;basic operations</a>
<li><a href="#channel-events">11.1.3 Event handlers for channel events</a>
<li><a href="#channel-configure">11.1.4 Configuring a channel</a>
<li><a href="#channel-seeking">11.1.5 Moving the pointer</a>
</li></ul>
<li><a href="#file-procs">11.2 File related procedures</a>
<ul>
<li><a href="#file-rw">11.2.1 Reading and writing</a>
<li><a href="#file-inspect">11.2.2 Inspection</a>
<li><a href="#file-norm">11.2.3 Normalisation</a>
<li><a href="#file-load">11.2.4 Loading input files</a>
<li><a href="#file-output">11.2.5 Output files</a>
<li><a href="#file-misc">11.2.6 Miscellaneous</a>
</li></ul>
<li><a href="#lock-files">11.3 Creating lock files</a>
</li></ul>
<li><a name="toc_parsers" href="#parsers">12 Parsing languages and files</a>
<ul>
<li><a href="#xmlpp">12.1 A simple <acronym>XML</acronym> parser</a>
</li></ul>
<li><a name="toc_main" href="#main">13 Command line script infrastructure</a>
<ul>
<li><a href="#main-usage">13.1 How to use the module</a>
<li><a href="#main-options">13.2 Predefined options</a>
<li><a href="#main-infos">13.3 Script meta informations</a>
<li><a href="#main-interface">13.4 Interface procedures</a>
<li><a href="#main-variables">13.5 Script state variables</a>
<li><a href="#main-loop">13.6 Event loop interaction</a>
<li><a href="#main-exit">13.7 Exit codes</a>
</li></ul>
<li><a name="toc_misc" href="#misc">14 Miscellaneous procedures</a>
<ul>
<li><a href="#misc-base">14.1 Basic procedures</a>
<li><a href="#misc-procedures">14.2 Handling procedures</a>
<li><a href="#misc-list">14.3 List procedures</a>
<li><a href="#misc-regexps">14.4 Handling regular expressions</a>
<li><a href="#misc-error">14.5 Error procedures</a>
<li><a href="#misc-math">14.6 Mathematical procedures</a>
</li></ul>
<li><a name="toc_layout" href="#layout">15 Managing directory layouts</a>
<li><a name="toc_hoco" href="#hoco">16 The homogeneous coordinates package</a>
<ul>
<li><a href="#hoco-transform">16.1 Format of a transformation list</a>
<ul>
<li><a href="#hoco-transform-elem">16.1.1 Elementary transformation matrices</a>
<li><a href="#hoco-transform-modeling">16.1.2 Modeling templates</a>
<li><a href="#hoco-transform-format">16.1.3 Transform format</a>
</li></ul>
<li><a href="#hoco-procs">16.2 Transformation procedures</a>
<ul>
<li><a href="#hoco-procs-core">16.2.1 Core procedures</a>
<li><a href="#hoco-procs-matrix">16.2.2 Basic matrices</a>
<li><a href="#hoco-procs-transform">16.2.3 Basic transforms</a>
<li><a href="#hoco-procs-params">16.2.4 Transforms from parameters</a>
</li></ul>
<li><a href="#hoco-dynamic">16.3 Dynamic transformations</a>
</li></ul>
<li><a name="toc_wireframe" href="#wireframe">17 Wireframe objects</a>
<ul>
<li><a href="#wireframe-intro">17.1 Introduction to graphics model</a>
<ul>
<li><a href="#wireframe-intro-preamble">17.1.1 Scripts preamble and tail</a>
<li><a href="#wireframe-intro-canvas">17.1.2 Drawing on a canvas widget</a>
<li><a href="#wireframe-intro-plane">17.1.3 Drawing on a plane</a>
<li><a href="#wireframe-intro-world">17.1.4 Drawing a world</a>
<li><a href="#wireframe-intro-moving">17.1.5 Drawing a in a moving frame</a>
<li><a href="#wireframe-intro-media">17.1.6 Separating media commands</a>
<li><a href="#wireframe-intro-coords">17.1.7 Better coordinates handling</a>
</li></ul>
<li><a href="#wireframe-element">17.2 Format of the elements list</a>
<li><a href="#wireframe-ops">17.3 Operations upon elements</a>
<li><a href="#wireframe-templates">17.4 Element coordinates templates</a>
<li><a href="#wireframe-basic">17.5 Basic elements</a>
<li><a href="#wireframe-aggregate">17.6 Aggregate elements</a>
</li></ul>
<li><a name="toc_wireframetk" href="#wireframetk">18 TK wireframe objects visualiser</a>
<ul>
<li><a href="#wireframetk-struct">18.1 Visualiser structure</a>
<li><a href="#wireframetk-populate">18.2 Populating a canvas with objects</a>
<li><a href="#wireframetk-update">18.3 Updating a canvas</a>
<li><a href="#wireframetk-misc">18.4 Miscellaneous procedures</a>
</li></ul>
<li><a name="toc_Package-License" href="#Package-License">Appendix A <acronym>GNU</acronym> General Public License</a>
<li><a name="toc_Documentation-License" href="#Documentation-License">Appendix B GNU Free Documentation License</a>
<li><a name="toc_References" href="#References">Appendix C Bibliography and references</a>
<li><a name="toc_Concept-Index" href="#Concept-Index">Appendix D An entry for each concept</a>
<li><a name="toc_Function-Index" href="#Function-Index">Appendix E An entry for each procedure</a>
<li><a name="toc_Variable-Index" href="#Variable-Index">Appendix F An entry for each variable</a>
<li><a name="toc_Type-Index" href="#Type-Index">Appendix G An entry for each type</a>
</li></ul>
</div>

<div class="footnote">
<hr>
<a name="texinfo-footnotes-in-document"></a><h4>Footnotes</h4><p class="footnote"><small>[<a name="fn-1" href="#fnd-1">1</a>]</small> <a href="http://wiki.tcl.tk/">http://wiki.tcl.tk/</a></p>

   <p class="footnote"><small>[<a name="fn-2" href="#fnd-2">2</a>]</small> Yes,
yes<small class="dots">...</small> the mother of all the evil.</p>

   <hr></div>

</body></html>

