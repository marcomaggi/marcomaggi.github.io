<html lang="en">
<head>
<title>contracts - Nausicaa for Scheme</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="Nausicaa for Scheme">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="prev" href="assertions.html#assertions" title="assertions">
<link rel="next" href="makers.html#makers" title="makers">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
This document describes version 0.2d3 of Nausicaa/Scheme, a set of
Scheme libraries defining a slightly modified R6RS Scheme language
and augmenting the features of the base and standard R6RS libraries.

The project home page of Nausicaa is at:

             `http://marcomaggi.github.com/nausicaa.html'


development of Nausicaa takes place at:

               `http://github.com/marcomaggi/nausicaa/'


Copyright (C) 2008, 2009, 2010 by Marco Maggi.

Copyright (C) 1996, 1997, 2000, 2001, 2002, 2003, 2004, 2005
Free Software Foundation.

Copyright (C) 1996, 1999-2005 Dorai Sitaram.

Copyright (C) 1998 Oleg Kiselyov.

Copyright (C) 1998, 1999, 2000 Olin Shivers.

Copyright (C) 1999 John David Stone.

Copyright (C) 1999, 2002 Marc Feeley.

Copyright (C) 2001, 2009 Danny Dube'

Copyright (C) 2002 Dr. Mirko Luedde.

Copyright (C) 2002, 2003, 2005, 2006 Sebastian Egner.

Copyright (C) 2003 Ray Dillinger.

Copyright (C) 2003 Taylor Campbell.

Copyright (C) 2005 Jens Axel Soegaard.

Copyright (C) 2005-2009 Alex Shinn.

Copyright (C) 2008 Taro Minowa (Higepon).

Copyright (C) 2005-2008 Dominique Boucher.

Copyright (C) 2004, 2005 Tony Garnock-Jones

Copyright (C) 2005 LShift Ltd.

Copyright (C) 2007, 2008 Philip L. Bewig.

Copyright (C) 2000 Will Fitzgerald.

Copyright (C) 2000 Neodesic Corporation.

Copyright (C) 2000-2006 Joachim Henke.

     Permission is granted to copy, distribute and/or modify this
     document under the terms of the GNU Free Documentation License,
     Version 1.3 or any later version published by the Free Software
     Foundation; with no Invariant Sections being ``GNU Free
     Documentation License'' and ``GNU General Public License'', no
     Front--Cover Texts, and no Back--Cover Texts.  A copy of the
     license is included in the section entitled ``GNU Free
     Documentation License''.

This document embeds an unofficial assemblage of several documents
reformatted in Texinfo; the reformatting author and maintainer is
Marco Maggi <marco.maggi-ipsu@poste.it>.  See the appendix ``Credits'' for
the list of original documents and their authors.  See also the
`README' and `CREDITS' files for additional attributions.-->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<a name="contracts"></a>
<p>
Next:&nbsp;<a rel="next" accesskey="n" href="makers.html#makers">makers</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="assertions.html#assertions">assertions</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="index.html#Top">Top</a>
<hr>
</div>

<h2 class="chapter">18 Function call contracts</h2>

<p>The library <code>(contracts)</code> provides ways to use macro identifiers
to validate the arguments and return values of functions; the concept is
to include the validation code at the call site (rather than in the body
of the function) to allow the construction of better error messages and
debugging informations.

   <p>Extensive use of contracts significantly increases the size of the
expanded code; for this reason the <code>(contracts)</code> library excludes
its features at expansion time when the <code>enable-contracts?</code>
parameter from the <code>(configuration)</code> library is set to false.

<div class="defun">
&mdash; Syntax: <b>define-contract</b><var> keyword subject contract<a name="index-define_002dcontract-1055"></a></var><br>
&mdash; Auxiliary Syntax: <b>-&gt;</b><var><a name="index-g_t_002d_003e-1056"></a></var><br>
<blockquote><p>Define an identifier syntax <var>keyword</var> which can be used in place of the
identifier <var>subject</var> to reference a variable, function or macro. 
<var>contract</var> can be one among:

     <pre class="example">          (<var>arg-predicate</var> ... -&gt; <var>ret-predicate</var> ...)
          (<var>arg-predicate</var> ... -&gt;)
          (<var>arg-predicate</var> ...)
          (-&gt; <var>ret-predicate</var> ...)
          <var>predicate</var>
</pre>
        <p class="noindent">where <var>predicate</var>, <var>arg-predicate</var> and <var>ret-predicate</var> are
identifiers; in the last case the contract is for a variable, in the
other cases it is for a function or macro.

        <p>The contract for a variable validates the value using the selected
<var>predicate</var> whenever the variable is accessed or mutated.  When a
variable is accessed: <var>subject</var> is referenced only once.  When a
variable is mutated: its new value's expression is evaluated only once. 
Notice that the contract is <strong>not</strong> enforced for the initialisation
value bound to <var>subject</var>.

        <p>The contract for a function or macro validates the arguments with the
functions bound to <var>arg-predicate</var> and validates the return values
with the functions bound to <var>ret-predicate</var>; the function or macro
bound to <var>subject</var> must accept a number of arguments equal to the
number of <var>arg-predicate</var> identifiers and return a number of values
equal to the number of <var>ret-predicate</var> identifiers; a function can
have no arguments and no return values; notice that a function
referenced through an identifier syntax cannot take a &ldquo;rest&rdquo; argument. 
When applying the function or macro, <var>subject</var> is referenced only
once.

        <p>If a predicate returns false: a non&ndash;continuable exception is raised
with types <code>&amp;contract-violation</code>, <code>&amp;message</code> and
<code>&amp;irritants</code>.  The <code>&amp;irritants</code> condition object holds
a list with a single item: the offending value.

        <p>Example of variable with contract:

     <pre class="example">          (import (rnrs) (contracts))
          
          (define-contract alpha %alpha integer?)
          (define %alpha 123)
          
          alpha &rArr; 123
          
          (begin
            (set! alpha 456)
            alpha) &rArr; 456
          
          (set! alpha #\a) error--&gt; assertion violation
</pre>
        <p>Example of function with contract:

     <pre class="example">          (import (rnrs) (contracts))
          
          (define (%doit a b c)
            (list a b c))
          
          (define-contract doit
              %doit
            (integer? string? symbol? -&gt; list?))
          
          (doit 1 "two" 'three) &rArr; (1 "two" 'three)
</pre>
        <p>Notice that it is possible to define a contract for a function, then use
it or not in its own body, recursively:

     <pre class="example">          (define-contract alpha
              %alpha
            (integer? -&gt; integer?))
          
          (define (%alpha n)
            ;; recursive use without contract
            (if (zero? n)
                1
              (%alpha (- n 1))))
          
          (define-contract beta
              %beta
            (integer? -&gt; integer?))
          
          (define (%beta n)
            ;; recursive use with contract
            (if (zero? n)
                1
              (beta (- n 1))))
</pre>
        <p>The fact that a function with a contract does not support the &ldquo;rest&rdquo;
argument is a bit annoying; we can overcome this limitation as follows:

     <pre class="example">          (import (rnrs) (contracts))
          
          (define-contract doit
              %doit
            (integer? integers? -&gt; vector?))
          
          (define (integers? ell)
            (for-all integer? ell))
          
          (define (%doit n ell)
            (vector n ell))
          
          (doit 1 (list 2 3 4))
          &rArr; #(1 (2 3 4))
          
          (apply (lambda (n . args)
                   (doit n args))
                 '(1 2 3 4))
          &rArr; #(1 (2 3 4))
</pre>
        <p class="noindent">it involves an ugly notation, but it works. 
</p></blockquote></div>

<div class="defun">
&mdash; Syntax: <b>let-contract</b> ((<var>keyword subject contract</var>)<var> ...</var>)<var> body0 body ...<a name="index-let_002dcontract-1057"></a></var><br>
&mdash; Auxiliary Syntax: <b>-&gt;</b><var><a name="index-g_t_002d_003e-1058"></a></var><br>
<blockquote><p>Does the same job of <code>define-contract</code> but with a syntax similar to
<code>let-syntax</code>; the relation between <code>let-contract</code> and
<code>define-contract</code> is the same as the relation between
<code>let-syntax</code> and <code>define-syntax</code>.

        <p>Notice the <code>let-contract</code> expands into a single <code>let-syntax</code>
form. 
</p></blockquote></div>

<div class="defun">
&mdash; Syntax: <b>define/contract</b> (<var>keyword . args</var>)<var> contract body0 body ...<a name="index-define_002fcontract-1059"></a></var><br>
&mdash; Syntax: <b>define/contract</b><var> keyword contract expression<a name="index-define_002fcontract-1060"></a></var><br>
&mdash; Syntax: <b>define/contract</b><var> keyword contract<a name="index-define_002fcontract-1061"></a></var><br>
&mdash; Auxiliary Syntax: <b>-&gt;</b><var><a name="index-g_t_002d_003e-1062"></a></var><br>
<blockquote><p>Define a new variable and a contract for its value, or a function and a
contract for its arguments and return values.  The first form is
equivalent to:

     <pre class="example">          (define-contract <var>keyword</var>
              keyword
            <var>contract</var>)
          
          (define (keyword . <var>args</var>)
            <var>body0</var> <var>body</var> ...)
</pre>
        <p class="noindent">and notice that the defined function can reference itself recursively
with the <var>keyword</var> identifier, so, internally, it has to satisfy its
contract.  The second form is equivalent to:

     <pre class="example">          (define-contract <var>keyword</var>
              keyword
            <var>contract</var>)
          
          (define keyword <var>expression</var>)
</pre>
        <p class="noindent">and the third to:

     <pre class="example">          (define-contract <var>keyword</var>
              keyword
            <var>contract</var>)
          
          (define keyword)
</pre>
        </blockquote></div>

<div class="defun">
&mdash; Syntax: <b>with-outer-contracts</b> ((<var>keyword contract</var>)<var> ...</var>)<var> body0 body ...<a name="index-with_002douter_002dcontracts-1063"></a></var><br>
&mdash; Auxiliary Syntax: <b>-&gt;</b><var><a name="index-g_t_002d_003e-1064"></a></var><br>
<blockquote><p>Expand to a sequence of contract definitions of the form:

     <pre class="example">          (define-contract <var>keyword</var> subject <var>contract</var>)
          ...
</pre>
        <p class="noindent">followed by the <var>body</var> forms in which the occurrences of the
identifiers <var>keyword</var> have been substituted with the automatically
generated identifiers <code>subject</code>.

        <p>This allows functions defined in the <var>body</var> form to call each other
without enforcing the contracts, while other functions referencing
<var>keyword</var> will be subjected to the contracts. 
</p></blockquote></div>

<div class="defun">
&mdash; Condition Type: <b>&amp;contract-violation</b><var><a name="index-g_t_0026contract_002dviolation-1065"></a></var><br>
<blockquote><p>Condition object type used to signal a contract violation. 
</p></blockquote></div>

<div class="defun">
&mdash; Function: <b>make-contract-violation-condition</b><var> subject<a name="index-make_002dcontract_002dviolation_002dcondition-1066"></a></var><br>
<blockquote><p>Build and return a new condition object of type
<code>&amp;contract-violation</code>.  <var>subject</var> must be a symbol
representing the subject of the contract. 
</p></blockquote></div>

<div class="defun">
&mdash; Function: <b>contract-violation?</b><var> obj<a name="index-contract_002dviolation_003f-1067"></a></var><br>
<blockquote><p>Return true if <var>obj</var> is a condition object of type
<code>&amp;contract-violation</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Function: <b>condition-contract-violation/subject</b><var> condition<a name="index-condition_002dcontract_002dviolation_002fsubject-1068"></a></var><br>
<blockquote><p>Given an argument of type <code>&amp;contract-violation</code> return the
value of the <code>subject</code> field. 
</p></blockquote></div>

<!-- end of file -->
   </body></html>

